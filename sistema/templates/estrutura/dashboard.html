{% extends 'estrutura/base.html' %}

{% block conteudo %}
{% include 'estrutura/header.html' %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/cards-dashboard.css') }}">

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">bem-vindo</div>
          <h2 class="page-title">
            {{ current_user.nome }} {{ current_user.sobrenome[0] }}.
          </h2>
        </div>
        <div class="col-12 col-md-auto ms-auto d-print-none">
          <a href="#" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modal-report">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-adjustments">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 10a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
              <path d="M6 4v4" />
              <path d="M6 12v8" />
              <path d="M10 16a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
              <path d="M12 4v10" />
              <path d="M12 18v2" />
              <path d="M16 7a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
              <path d="M18 4v1" />
              <path d="M18 9v11" />
            </svg>
            Customizar Informa√ß√µes
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Page body -->
  <div class="page-body">
    <div class="container-xl">

      <!-- Se√ß√£o de An√°lise de Produ√ß√£o -->
      <div class="dashboard-section">
        {% if mostrar_linhas_graficas %}
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="glass-card chart-container">
              <div class="chart-header">
                <h3 class="chart-title">
                  Gr√°fico demonstrativo de entrega de produtos - {{ '%02d' % mes
                  }}/{{ ano }}.
                </h3>
              </div>
              <div class="chart-body">
                <div id="chart-toneladas-por-dia"></div>
              </div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="glass-card chart-container">
              <div class="chart-header">
                <h3 class="chart-title">
                  Toneladas no m√™s por produto - {{ '%02d' % mes }}/{{ ano }}.
                </h3>
              </div>
              <div class="chart-body">
                <div id="chart-barra-acumulado-produtos"></div>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="empty-state">
          <div class="empty-icon w-100">üìä</div>
          <div class="empty-title">N√£o h√° dados a serem exibidos</div>
          <div class="empty-text">
            Os gr√°ficos de produ√ß√£o aparecer√£o aqui assim que houver registros
            de entrega para o per√≠odo selecionado.
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Se√ß√£o de Controle de Estoque -->
      <div class="dashboard-section">
        {% if valores_contra_acumulados %}
        <div class="glass-card chart-container">
          <div class="chart-header">
            <h3 class="chart-title">
              Rela√ß√£o Entrada X Sa√≠da estoque ‚Äì Acumulado geral
            </h3>
          </div>
          <div class="chart-body">
            <div id="chart-barra-vertical-grouped-produtos"></div>
          </div>
        </div>
        {% else %}
        <div class="empty-state">
          <div class="empty-icon w-100">üì¶</div>
          <div class="empty-title">Dados de Estoque Indispon√≠veis</div>
          <div class="empty-text">
            Os relat√≥rios de movimenta√ß√£o de estoque ser√£o exibidos quando
            houver registros de entrada e sa√≠da.
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Se√ß√£o de Ranking -->
      <div class="dashboard-section">
        {% if tem_pontuacao %}
        <div class="glass-card chart-container">
          <div class="chart-header">
            <h3 class="chart-title">
              Ranking de <strong>produtividade</strong> por usu√°rio - {{ '%02d'
              % mes }}/{{ ano }}
            </h3>
          </div>
          <div class="chart-body">
            <div id="chart-pontuacao-usuario"></div>
          </div>
        </div>
        {% else %}
        <div class="empty-state">
          <div class="empty-icon w-100">üèÜ</div>
          <div class="empty-title">N√£o h√° dados a serem exibidos</div>
          <div class="empty-text">
            O gr√°fico de pontua√ß√£o de usu√°rio aparecer√° aqui assim que houver
            registros.
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Se√ß√£o de Alertas -->
      <div class="dashboard-section">
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <div class="stat-card">
              <div class="stat-content">
                <div class="stat-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                    <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h6l6 6v10a2 2 0 0 1 -2 2z"></path>
                    <path d="M12 12l0 .01"></path>
                    <path d="M9 15h6"></path>
                    <path d="M9 12h0.01"></path>
                    <path d="M15 12h0.01"></path>
                  </svg>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Cargas sem NF</div>
                  <div class="stat-value">{{ nfs_nao_emitidas | length }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="stat-card">
              <div class="stat-content">
                <div class="stat-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 5l0 2"></path>
                    <path d="M15 11l0 2"></path>
                    <path d="M15 17l0 2"></path>
                    <path
                      d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-3a2 2 0 0 0 0 -4v-3a2 2 0 0 1 2 -2">
                    </path>
                  </svg>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Cargas sem Ticket</div>
                  <div class="stat-value">{{ tickets_nao_lancados | length
                    }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="stat-card">
              <div class="stat-content">
                <div class="stat-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 21v-4"></path>
                    <path d="M12 13v-4"></path>
                    <path d="M12 5v-2"></path>
                    <path d="M10 12h4"></path>
                    <path d="M4 8v-2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-8"></path>
                    <path d="M3 12h1"></path>
                  </svg>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Cargas sem Origem</div>
                  <div class="stat-value">{{ cargasOrigemNaoIdentificada |
                    length
                    }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="stat-card">
              <div class="stat-content">
                <div class="stat-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 21v-4"></path>
                    <path d="M12 13v-4"></path>
                    <path d="M12 5v-2"></path>
                    <path d="M10 12h4"></path>
                    <path d="M4 8v-2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-8"></path>
                    <path d="M3 12h1"></path>
                  </svg>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Cargas sem Contra Nota</div>
                  <div class="stat-value">{{ nfContraNota | length }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Filtro -->
  <div class="modal modal-blur fade" id="modal-report" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="display: grid;">
      <form id="filtroForm" method="get">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Customizar dados</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-8 mb-3 mb-3">
                <!-- Seletor de empresa -->
                <label class="form-label" for="selectEmpresa"><strong>Empresa
                    Emissora:</strong></label>
                <select id="selectEmpresa" name="empresa_emissora_id" class="form-select">
                  {% for emp in empresas_emissoras %}
                  <option value="{{ emp.id }}" {% if emp.id==empresa_selecionada_id %}selected{% endif %}>
                    {{ emp.identificacao }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label" for="selectMes"><strong>M√™s:</strong></label>
                <input type="month" id="selectMes" name="mesano" class="form-control"
                  value="{{ '%04d-%02d'|format(ano, mes) }}">
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <a href="{{url_for('principal')}}" class="btn btn-link link-secondary btn-3">
              Limpar Filtros
            </a>
            <button type="submit" class="btn btn-primary btn-5 ms-auto" data-bs-dismiss="modal">
              <!-- Download SVG icon from http://tabler.io/icons/icon/plus -->
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-2">
                <path d="M12 5l0 14" />
                <path d="M5 12l14 0" />
              </svg>
              Aplicar modifica√ß√£o
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // dispara o submit do mesmo form ao mudar m√™s ou empresa
    document.getElementById('selectMes').addEventListener('change', () => {
      document.getElementById('filtroForm').submit();
    });
    document.getElementById('selectEmpresa').addEventListener('change', () => {
      document.getElementById('filtroForm').submit();
    });
  </script>

  <!-- Scripts originais dos gr√°ficos mantidos -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!window.ApexCharts) return;

      new ApexCharts(
        document.getElementById("chart-toneladas-por-dia"),
        {
          chart: {
            type: "bar",
            stacked: true,
            height: 400,
            toolbar: { show: false },
            animations: { 
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              }
            },
            fontFamily: 'Inter, sans-serif',
            background: 'transparent'
          },
          plotOptions: {
            bar: {
              horizontal: false,
              borderRadius: 6,
              columnWidth: "70%",
              borderRadiusApplication: 'end'
            }
          },
          dataLabels: { enabled: false },
          series: [
            { name: "Eucalipto Torete", data: {{ dados_front.eucalipto_torete | tojson }} },
      { name: "Pinus Torete", data: {{ dados_front.pinus_torete | tojson }} },
      { name: "Pinus 18-25", data: {{ dados_front.pinus_18_25 | tojson }} },
      { name: "Pinus 25-32", data: {{ dados_front.pinus_25_32 | tojson }} },
      { name: "Pinus 33+", data: {{ dados_front.pinus_33_mais | tojson }} },
      { name: "Biomassa", data: {{ dados_front.cavaco | tojson }} }
      ],
      xaxis: {
      categories: {{ labels | tojson }},
      title: { 
        text: "Dias do M√™s",
        style: {
          fontSize: '13px',
          fontWeight: 600,
          color: '#1b3a2e'
        }
      },
      labels: {
        style: {
          fontSize: '12px',
          fontWeight: 500
        }
      },
      axisBorder: {
        show: true,
        color: '#e2e8f0'
      }
      },
      yaxis: {
      title: { 
        text: "Toneladas",
        style: {
          fontSize: '13px',
          fontWeight: 600,
          color: '#1b3a2e'
        }
      },
      labels: {
        formatter: function (value) {
          return value.toFixed(2);
        },
        style: {
          fontSize: '12px',
          fontWeight: 500
        }
      }
    },
      colors: ["#1b5e20", "#e65100", "#fb8c00", "#ffb74d", "#ffe0b2", "#04BFAD"],
      tooltip: {
      shared: true,
      intersect: false,
      theme: 'light',
      style: {
        fontSize: '13px',
        fontFamily: 'Inter, sans-serif'
      },
      y: {
        formatter: function (val) {
          return val.toFixed(2) + " toneladas";
        }
      }
    },
      legend: {
      position: "top",
      horizontalAlign: "center",
      markers: { 
        radius: 12,
        offsetX: -3
      },
      fontSize: '13px',
      fontWeight: 500,
      itemMargin: {
        horizontal: 12,
        vertical: 8
      }
    },
      grid: {
      borderColor: "#e2e8f0",
      strokeDashArray: 3,
      xaxis: {
        lines: {
          show: false
        }
      },
      yaxis: {
        lines: {
          show: true
        }
      },
      padding: {
        top: 0,
        right: 10,
        bottom: 0,
        left: 10
      }
    }
    }
    ).render();
});
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!window.ApexCharts) return;

      new ApexCharts(
        document.getElementById("chart-barra-acumulado-produtos"),
        {
          chart: { 
            type: "bar", 
            height: 400,
            toolbar: { show: false },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800,
              animateGradually: {
                enabled: true,
                delay: 150
              }
            },
            fontFamily: 'Inter, sans-serif'
          },
          plotOptions: {
            bar: {
              distributed: true,
              borderRadius: 8,
              columnWidth: "60%",
              dataLabels: { position: "top" }
            }
          },
          xaxis: {
            categories: {{ produtos_labels | tojson }},
      labels: { 
        style: { 
          fontSize: "12px",
          fontWeight: 500
        } 
      },
      axisBorder: {
        show: true,
        color: '#e2e8f0'
      }
      },
      yaxis: {
      title: { 
        text: "Toneladas",
        style: {
          fontSize: '13px',
          fontWeight: 600,
          color: '#1b3a2e'
        }
      },
      labels: {
        formatter: function (value) {
          return value.toFixed(2);
        },
        style: {
          fontSize: '12px',
          fontWeight: 500
        }
      }
    },
      series: [
      { name: "Toneladas", data: {{ valores_acumulados | tojson }} }
    ],
      colors: ["#aed581", "#81d4fa", "#fff176", "#4dd0e1", "#ffcc80", "#04BFAD"],
      dataLabels: {
      enabled: true,
      formatter: function (val) { return val.toFixed(2) + " t"; },
      offsetY: -25,
      style: {
        fontSize: "12px",
        fontWeight: 700,
        colors: ["#1b3a2e"]
      },
      background: {
        enabled: true,
        foreColor: '#fff',
        borderRadius: 4,
        padding: 6,
        opacity: 0.9,
        borderWidth: 0
      }
    },
      tooltip: {
      theme: 'light',
      style: {
        fontSize: '13px',
        fontFamily: 'Inter, sans-serif'
      },
      y: {
        formatter: function (val) {
          return val.toFixed(2) + " toneladas";
        }
      }
    },
      legend: { show: false },
      grid: {
      borderColor: "#e2e8f0",
      strokeDashArray: 3,
      xaxis: {
        lines: {
          show: false
        }
      },
      padding: {
        top: 0,
        right: 10,
        bottom: 0,
        left: 10
      }
    }
    }
    ).render();
});
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!window.ApexCharts) return;

      const options = {
        chart: {
          type: "line",
          height: 450,
          toolbar: {
            show: true,
            tools: {
              download: true,
              selection: true,
              zoom: true,
              zoomin: true,
              zoomout: true,
              pan: true,
              reset: true
            },
            export: {
              csv: { filename: "ranking_usuarios_mes" },
              svg: { filename: "ranking_usuarios_mes" },
              png: { filename: "ranking_usuarios_mes" }
            }
          },
          animations: { 
            enabled: true,
            easing: 'easeinout',
            speed: 800
          },
          dropShadow: {
            enabled: true,
            top: 3,
            left: 2,
            blur: 5,
            opacity: 0.15
          },
          fontFamily: 'Inter, sans-serif'
        },
        stroke: { 
          curve: "smooth", 
          width: 3
        },
        markers: { 
          size: 5,
          strokeWidth: 2,
          strokeColors: '#fff',
          hover: { 
            size: 7,
            sizeOffset: 2
          }
        },
        dataLabels: {
          enabled: true,
          offsetY: -10,
          formatter: function (val, opts) {
            const point = opts.w.config.series[opts.seriesIndex]
              .data[opts.dataPointIndex];
            return point.label || "";
          },
          style: { 
            fontSize: "11px", 
            fontWeight: 700,
            colors: ["#1b3a2e"]
          },
          background: {
            enabled: true,
            foreColor: "#fff",
            padding: 6,
            borderRadius: 6,
            borderWidth: 0,
            opacity: 0.95,
            dropShadow: {
              enabled: true,
              top: 1,
              left: 1,
              blur: 2,
              opacity: 0.2
            }
          }
        },
        series: {{ dados_usuarios_front | tojson
    }},
      xaxis: {
      categories: {{ labels | tojson }},
      title: {
      text: "Dias do M√™s",
      style: { 
        fontSize: "13px", 
        fontWeight: 600, 
        color: "#1b3a2e" 
      }
    },
      labels: { 
        style: { 
          fontSize: "12px", 
          fontFamily: "Inter, sans-serif",
          fontWeight: 500
        } 
      },
      axisTicks: { show: false },
      axisBorder: { 
        show: true, 
        color: "#e2e8f0" 
      }
        },
      yaxis: {
      title: {
        text: "Pontos Acumulados",
        style: { 
          fontSize: "13px", 
          fontWeight: 600, 
          color: "#1b3a2e" 
        }
      },
      labels: { 
        formatter: (v) => v.toFixed(1), 
        style: { 
          fontSize: "12px",
          fontWeight: 500
        } 
      }
    },
      tooltip: {
      shared: true,
      intersect: false,
      theme: "light",
      style: {
        fontSize: '13px',
        fontFamily: 'Inter, sans-serif'
      },
      y: { 
        formatter: (v) => v.toFixed(1) + " pontos" 
      }
    },
      legend: {
      show: true,
      position: "bottom",
      horizontalAlign: "center",
      fontSize: "13px",
      fontWeight: 500,
      itemMargin: { 
        horizontal: 12, 
        vertical: 8
      },
      markers: {
        radius: 12
      }
    },
      grid: {
      borderColor: "#e2e8f0",
      strokeDashArray: 3,
      xaxis: {
        lines: {
          show: false
        }
      },
      padding: { 
        top: 0, 
        right: 10, 
        bottom: 0, 
        left: 10 
      }
    },
      responsive: [
      {
        breakpoint: 768,
        options: {
          chart: { height: 360 },
          legend: { position: "bottom" }
        }
      }
    ]
      };

    new ApexCharts(
      document.querySelector("#chart-pontuacao-usuario"),
      options
    ).render();
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!window.ApexCharts) return;

      const seriesData = [
        {% for label in produtos_labels %}
        {
        x: "{{ label }}",
        y: {{ valores_contra_acumulados[loop.index0] }},
      goals: [
      {
        name: "Vendido",
        value: {{ valores_acumulados_mes[loop.index0] }},
      strokeHeight: 6,
      strokeColor: "#ff9500"
            }
    ]
        }{% if not loop.last %}, {% endif %}
    {% endfor %}
      ];

    new ApexCharts(
      document.querySelector("#chart-barra-vertical-grouped-produtos"),
      {
        series: [{ name: "Contra nota", data: seriesData }],
        chart: { 
          type: "bar", 
          height: 350,
          toolbar: { show: false },
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 800
          },
          fontFamily: 'Inter, sans-serif'
        },
        plotOptions: {
          bar: { 
            columnWidth: "65%", 
            borderRadius: 8,
            borderRadiusApplication: 'end'
          }
        },
        colors: ["#81d4fa"],
        dataLabels: { enabled: false },
        annotations: {
          points: seriesData.map((pt) => ({
            x: pt.x,
            y: pt.goals[0].value,
            marker: { size: 0 },
            label: {
              text: (pt.y - pt.goals[0].value).toFixed(2) + " t",
              offsetY: -10,
              style: {
                fontSize: "12px",
                fontWeight: 700,
                color: "#1b3a2e",
                background: "transparent"
              }
            }
          }))
        },
        xaxis: {
          labels: {
            style: {
              fontSize: '12px',
              fontWeight: 500
            }
          },
          axisBorder: {
            show: true,
            color: '#e2e8f0'
          }
        },
        yaxis: {
          title: {
            text: "Toneladas",
            style: {
              fontSize: '13px',
              fontWeight: 600,
              color: '#1b3a2e'
            }
          },
          labels: {
            style: {
              fontSize: '12px',
              fontWeight: 500
            }
          }
        },
        tooltip: {
          theme: 'light',
          style: {
            fontSize: '13px',
            fontFamily: 'Inter, sans-serif'
          }
        },
        legend: {
          show: true,
          showForSingleSeries: true,
          customLegendItems: ["ENTRADA (Contra nota)", "SA√çDA (NF sa√≠da)"],
          markers: { 
            fillColors: ["#81d4fa", "#ff9500"],
            radius: 12
          },
          fontSize: '13px',
          fontWeight: 500,
          itemMargin: {
            horizontal: 12,
            vertical: 8
          }
        },
        grid: {
          borderColor: "#e2e8f0",
          strokeDashArray: 3,
          xaxis: {
            lines: {
              show: false
            }
          },
          padding: {
            top: 0,
            right: 10,
            bottom: 0,
            left: 10
          }
        }
      }
    ).render();
    });
  </script>

  {% include 'estrutura/footer.html' %}
</div>
{% endblock conteudo %}