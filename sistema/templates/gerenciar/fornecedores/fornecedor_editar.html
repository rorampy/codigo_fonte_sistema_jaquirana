{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}
<link href="{{ url_for('static', filename='css/cadastro-veiculo.css') }}" rel="stylesheet" />
<style>
  .florestaSim {
    display: none;
  }
</style>
<div class="page-wrapper">
  <!-- Page header -->
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Page pre-title -->
          <div class="page-pretitle">
            Fornecedor
          </div>
          <h2 class="page-title">
            Editar
          </h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Page body -->
  <div class="page-body">
    <div class="container-xl">

      {% include 'estrutura/mensagens_flash.html' %}

      <div class="col-12">
        <form class="card" action="{{ url_for('editar_fornecedor', id=fornecedor.id) }}" method="POST" enctype="multipart/form-data">
          <div class="card-body">
            <!-- Imposto Funrural ou Senar -->

            <div class="row">
              <h3 class="text-primary">Informações Iniciais</h3>
              <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <div class="form-label">Contribuição Social</div>
                  <div>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="tipoContribuicao" value="funrural" {% if
                        dados_corretos['tipoContribuicao']=='funrural' or not dados_corretos['tipoContribuicao']
                        %}checked{% endif %}>
                      <span class="form-check-label">Funrural</span>
                    </label>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="tipoContribuicao" value="senar" {% if
                        dados_corretos['tipoContribuicao']=='senar' %}checked{% endif %}>
                      <span class="form-check-label">Senar</span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="col-sm-8 col-md-8 grupoSenar">
                <div class="mb-3">
                  <label class="form-label required">Declaração Senar</label>
                  <input type="file" name="declaracaoSenar" value="{{ dados_corretos['declaracaoSenar'] }}" class="form-control {% if 'declaracaoSenar' in campos_obrigatorios or 'declaracaoSenar' in campos_erros %}
                            is-invalid
                          {% endif %}" accept=".pdf, .jpg, .png">
                  <div class="invalid-feedback">
                    {% if 'declaracaoSenar' in
                    campos_obrigatorios %}
                    {{ campos_obrigatorios['declaracaoSenar']
                    }}
                    {% elif 'declaracaoSenar' in campos_erros
                    %}
                    {{ campos_erros['declaracaoSenar'] }}
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-sm-2 col-md-2 grupoSenar">
                <div class="mb-3">
                  <label class="form-label required">Imposto Senar
                    <small>(%)</small></label>
                  <input name="declaracaoSenar" class="form-control" value="0.2" readonly disabled>
                </div>
              </div>
            </div>

            <div class="col-sm-2 col-md-2">
              <div class="mb-3">
                <div class="form-label">Floresta</div>
                <div>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="classeFornecedor" value="nao" {% if
                      dados_corretos['classeFornecedor']=='nao' or not dados_corretos['classeFornecedor'] %}checked{%
                      endif %}>
                    <span class="form-check-label">Não</span>
                  </label>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="classeFornecedor" value="sim" {% if
                      dados_corretos['classeFornecedor']=='sim' %}checked{% endif %}>
                    <span class="form-check-label">Sim</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12 col-md-2 florestaSim">
                <div class="mb-3">
                  <label class="form-label required">Valor Contrato</label>
                  <input type="text" name="valorContrato" value="{{ dados_corretos['valorContrato'] }}" class="form-control {% if 'valorContrato' in campos_obrigatorios or 'valorContrato' in campos_erros %}
                            is-invalid
                          {% endif %} campo-moeda-brl">
                  <div class="invalid-feedback">
                    {% if 'valorContrato' in
                    campos_obrigatorios %}
                    {{ campos_obrigatorios['valorContrato']
                    }}
                    {% elif 'valorContrato' in campos_erros
                    %}
                    {{ campos_erros['valorContrato'] }}
                    {% endif %}
                  </div>
                </div>
              </div>

              <!--NOVO CAMPO: Estimativa Toneladas-->

              <div class="col-12 col-md-2 florestaSim">
                <div class="mb-3">
                  <label class="form-label required">Estimativa Toneladas</label>
                  <input type="text" name="estimativaTonelada" value="{{ dados_corretos['estimativaTonelada'] }}" class="form-control {% if 'estimativaTonelada' in campos_obrigatorios or 'estimativaTonelada' in campos_erros %}
                  is-invalid 
                  {% endif %} campo-float " placeholder="Ex: 1000.23">
                  <div class="invalid-feedback">
                    {% if 'estimativaTonelada' in campos_obrigatorios %}
                    {{ campos_obrigatorios['estimativaTonelada'] }}
                    {% elif 'estimativaTonelada' in campos_erros %}
                    {{ campos_erros['estimativaTonelada'] }}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div class="col-sm-2 col-md-2">
              <div class="mb-3">
                <div class="form-label">Controle Entrada</div>
                <div>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="controleEntrada" value="nao" {% if
                      dados_corretos['controleEntrada']=='nao' %}checked{% endif %}>
                    <span class="form-check-label">Não</span>
                  </label>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="controleEntrada" value="sim" {% if
                      dados_corretos['controleEntrada']=='sim' or not dados_corretos['controleEntrada'] %}checked{%
                      endif %}>
                    <span class="form-check-label">Sim</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-6 col-md-6">
                <div class="mb-3">
                  <div class="form-label">Tipo de Cadastro</div>
                  <div>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="tipoCadastro" value="cpf" {% if
                        dados_corretos['tipoCadastro']=='cpf' or not dados_corretos['tipoCadastro'] %}checked{% endif
                        %}>
                      <span class="form-check-label">Por
                        CPF</span>
                    </label>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="tipoCadastro" value="cnpj" {% if
                        dados_corretos['tipoCadastro']=='cnpj' %}checked{% endif %}>
                      <span class="form-check-label">Por
                        CNPJ</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cadastro Financeiro - Automático -->
            <div class="row mb-3">
              <div class="col-sm-6 col-md-6">
                <div class="mb-3">
                  <div class="form-label">Cadastrar em Pessoas Financeiro</div>
                  <div>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="criarPessoaFinanceiro" value="sim" {% if
                        dados_corretos['criarPessoaFinanceiro']=='sim' or not dados_corretos['criarPessoaFinanceiro'] %}
                        checked {% endif %}>
                      <span class="form-check-label"><strong>Sim</strong> - Criar cadastro financeiro
                        automaticamente</span>
                    </label>

                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="criarPessoaFinanceiro" value="nao" {% if
                        dados_corretos['criarPessoaFinanceiro']=='nao' %} checked {% endif %}>
                      <span class="form-check-label"><strong>Não</strong> - Cadastrar apenas como fornecedor</span>
                    </label>
                  </div>
                  <small class="form-hint">
                    Escolha esta opção caso deseje que o sistema gere <span
                      style="font-weight: bold; font-style: italic;">automaticamente</span> o registro financeiro
                    associado a
                    esta pessoa.
                  </small>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-8 col-md-8 grupoCPF">
                <div class="mb-3">
                  <label class="form-label required">Nome
                    Completo</label>
                  <input type="text" name="nomeCompleto" value="{{ dados_corretos['nomeCompleto'] }}" class="form-control {% if 'nomeCompleto' in campos_obrigatorios or 'nomeCompleto' in campos_erros %}
                            is-invalid
                          {% endif %}">
                  <div class="invalid-feedback">
                    {% if 'nomeCompleto' in
                    campos_obrigatorios %}
                    {{ campos_obrigatorios['nomeCompleto']
                    }}
                    {% elif 'nomeCompleto' in campos_erros
                    %}
                    {{ campos_erros['nomeCompleto'] }}
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-sm-8 col-md-8 grupoCNPJ">
                <div class="mb-3">
                  <label class="form-label required">Razão
                    Social</label>
                  <input type="text" name="razaoSocial" value="{{ dados_corretos['razaoSocial'] }}" class="form-control {% if 'razaoSocial' in campos_obrigatorios or 'razaoSocial' in campos_erros %}
                            is-invalid
                          {% endif %}">
                  <div class="invalid-feedback">
                    {% if 'razaoSocial' in
                    campos_obrigatorios %}
                    {{ campos_obrigatorios['razaoSocial'] }}
                    {% elif 'razaoSocial' in campos_erros %}
                    {{ campos_erros['razaoSocial'] }}
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-sm-2 col-md-2 grupoCPF">
                <div class="mb-3">
                  <label class="form-label required">CPF</label>
                  <input type="text" name="cpf" value="{{ dados_corretos['cpf'] }}" data-mask="000.000.000-00"
                    placeholder="xxx.xxx.xxx-xx" data-mask-visible="true" autocomplete="off" class="form-control {% if 'cpf' in campos_obrigatorios or 'cpf' in campos_erros %}
                          is-invalid
                        {% endif %}">
                  <div class="invalid-feedback">
                    {% if 'cpf' in campos_obrigatorios %}
                    {{ campos_obrigatorios['cpf'] }}
                    {% elif 'cpf' in campos_erros %}
                    {{ campos_erros['cpf'] }}
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-sm-2 col-md-2 grupoCNPJ">
                <div class="mb-3">
                  <label class="form-label required">CNPJ</label>
                  <input type="text" name="cnpj" value="{{ dados_corretos['cnpj'] }}" data-mask="00.000.000/0000-00"
                    placeholder="xx.xxx.xxx/xxxx-xx" data-mask-visible="true" autocomplete="off" class="form-control {% if 'cnpj' in campos_obrigatorios or 'cnpj' in campos_erros %}
                          is-invalid
                        {% endif %}">
                  <div class="invalid-feedback">
                    {% if 'cnpj' in campos_obrigatorios %}
                    {{ campos_obrigatorios['cnpj'] }}
                    {% elif 'cnpj' in campos_erros %}
                    {{ campos_erros['cnpj'] }}
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <label class="form-label required">Telefone</label>
                  <input type="text" name="telefone" value="{{ dados_corretos['telefone'] }}"
                    data-mask="(00) 0 0000-0000" placeholder="(xx) x xxxx-xxxx" data-mask-visible="true"
                    autocomplete="off"
                    class="form-control {% if 'telefone' in campos_obrigatorios %}is-invalid{% endif %}">
                  <div class="invalid-feedback">
                    {% if 'telefone' in campos_obrigatorios
                    %}
                    {{ campos_obrigatorios['telefone'] }}
                    {% elif 'telefone' in campos_erros %}
                    {{ campos_erros['telefone'] }}
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-sm-4 col-md-4">
                <div class="mb-3">
                  <label class="form-label">Contrato Fornecedor</label>
                  <input type="file" name="contratoFornecedor" class="form-control contratoFornecedor {% if 'contratoFornecedor' in campos_obrigatorios or 'contratoFornecedor' in campos_erros %}
                            is-invalid
                          {% endif %}" accept=".pdf">
                  <div class="invalid-feedback">
                    {% if 'contratoFornecedor' in
                    campos_obrigatorios %}
                    {{ campos_obrigatorios['contratoFornecedor']
                    }}
                    {% elif 'contratoFornecedor' in campos_erros
                    %}
                    {{ campos_erros['contratoFornecedor'] }}
                    {% endif %}
                  </div>
                </div>
              </div>

              {%if tags %}
              <h3 class="text-primary mb-4">Informações de Tags</h3>
              <div class="row">
                <div class="col-12 mb-3">
                  <div class="mb-3">
                    <label class="form-label">Selecione as tags</label>
                    <div class="form-selectgroup">
                      {% for tag in tags %}
                      <label class="form-selectgroup-item">
                        <input type="checkbox" name="tags_fornecedor" value="{{ tag.id }}"
                          class="form-selectgroup-input" {% if tag.id in tags_fornecedor_selecionadas %}checked{% endif %}>
                        <span class="form-selectgroup-label">{{ tag.nome_tag }}</span>
                      </label>
                      {%endfor%}
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              <h3 class="text-primary mb-4">Informações Bancárias</h3>
              <div class="row">
                <div class="col-12 col-sm-12 col-md-3 mb-3">
                  <label class="form-label">Selecione um banco</label>
                  <select name="instituicao_financeira" class="form-select">
                    <option value>Selecione</option>
                    {% for banco in bancos %}
                    <option value="{{ banco.id }}" {% if banco.id==dados_corretos['instituicao_financeira'] %}selected{%
                      endif %}>{{ banco.nome }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-12 col-sm-12 col-md-3 mb-3">
                  <label class="form-label">Agência</label>
                  <input type="text" name="agencia_bancaria" class="form-control"
                    value="{{ dados_corretos['agencia_bancaria'] }}">
                  <div class="invalid-feedback">
                    {% if 'agencia_bancaria' in campos_obrigatorios %}
                    {{ campos_obrigatorios['agencia_bancaria'] }}
                    {% elif 'agencia_bancaria' in campos_erros %}
                    {{ campos_erros['agencia_bancaria'] }}
                    {% endif %}
                  </div>
                </div>

                <div class="col-12 col-sm-12 col-md-3 mb-3">
                  <label class="form-label">Conta</label>
                  <input type="text" name="conta_bancaria" class="form-control"
                    value="{{ dados_corretos['conta_bancaria'] }}">
                  <div class="invalid-feedback">
                    {% if 'conta_bancaria' in campos_obrigatorios %}
                    {{ campos_obrigatorios['conta_bancaria'] }}
                    {% elif 'conta_bancaria' in campos_erros %}
                    {{ campos_erros['conta_bancaria'] }}
                    {% endif %}
                  </div>
                </div>

                <div class="col-12 col-sm-12 col-md-3 mb-3">
                  <label class="form-label">Chave PIX</label>
                  <input type="text" name="chave_pix" class="form-control" value="{{ dados_corretos['chave_pix'] }}">
                  <div class="invalid-feedback">
                    {% if 'chave_pix' in campos_obrigatorios %}
                    {{ campos_obrigatorios['chave_pix'] }}
                    {% elif 'chave_pix' in campos_erros %}
                    {{ campos_erros['chave_pix'] }}
                    {% endif %}
                  </div>
                </div>

              </div>

              <h3 class="text-primary mb-4">Preços de custo por Bitola</h3>
              <div class="row">

                {% for produto_id, produto_data in produtos_bitolas.items() %}
                <!-- {{ produto_data.nome }} -->
                <div class="col-md-12">
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header text-dark">
                      <strong>{{ produto_data.nome }}</strong>
                    </div>
                    <div class="card-body">

                      {% for loop_index in range(produto_data.bitolas|length) %}
                      {% set bitola = produto_data.bitolas[loop_index] %}
                      {% set nome_produto_lower = produto_data.nome.lower() %}
                      {% if nome_produto_lower == 'eucalipto' %}
                        {% set prefix = 'euca' %}
                      {% elif nome_produto_lower == 'pinus' %}
                        {% set prefix = 'pinus' %}
                      {% elif nome_produto_lower == 'biomassa' %}
                        {% set prefix = 'bio' %}
                      {% else %}
                        {% set prefix = nome_produto_lower[:5] %}
                      {% endif %}
                      
                      <!-- Bitola {{ loop_index + 1 }} {{ produto_data.nome }} -->
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">{% if produto_data.nome == 'Biomassa' %}Tipo{% else %}Bitola{% endif %}</label>
                          <input type="text" name="{{ prefix }}BitolaId{{ loop_index + 1 }}" value="{{ bitola.nome }}" disabled
                            class="form-control {% if prefix + 'BitolaId' + (loop_index + 1)|string in campos_obrigatorios %}is-invalid{% endif %}">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Preço Custo {% if produto_data.nome == 'Biomassa' %}(Ton.){% else %}Bitola (Ton.){% endif %}</label>
                          <input type="text" name="{{ prefix }}PrecoCusto{{ loop_index + 1 }}" value="{{ dados_corretos[prefix + 'PrecoCusto' + (loop_index + 1)|string] }}"
                            class="form-control campo-moeda-brl {% if prefix + 'PrecoCusto' + (loop_index + 1)|string in campos_obrigatorios %}is-invalid{% endif %}">
                        </div>
                      </div>
                      {% endfor %}

                    </div>
                  </div>
                </div>
                {% endfor %}

              </div>

              <!-- Nova implementação adicionando custo de extração se houver -->

              <h3 class="text-primary mb-4">Custo de extração</h3>
              <div class="row">
                <div class="col-sm-6 col-md-6">
                  <div class="mb-3">
                    <div class="form-label required">Possui custo de
                      extração?</div>
                    <div>
                      <label class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="custoExtracao" value="possui" {% if
                          dados_corretos['custoExtracao']=='possui' %}checked{% endif %}>
                        <span class="form-check-label">Sim</span>
                      </label>
                      <label class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="custoExtracao" value="nao_possui" {% if
                          dados_corretos['custoExtracao']=='nao_possui' or not dados_corretos['custoExtracao'] %}checked{% endif %}>
                        <span class="form-check-label">Não</span>
                      </label>
                    </div>
                  </div>
                </div>

                <div class="row">

                  <div class="row">
                    <div class="col-md-6 mb-4 grupoPossuiExtracao">
                      <label class="form-label required">Selecione um
                        extrator</label>
                      <select type="text" id="selectExtrator" name="extratorNome"
                        class="form-select {% if 'extratorNome' in campos_obrigatorios %}is-invalid{% endif %}">
                        <option value selected>Selecione...</option>
                        {%for e in extratores%}
                        <option value="{{e.id}}" {% if dados_corretos['extratorNome']==e.id %}selected{% endif %}>{{e.identificacao}}</option>
                        {%endfor%}
                      </select>
                      <div class="invalid-feedback">
                        {% if 'extratorNome' in campos_obrigatorios %}
                        {{ campos_obrigatorios['extratorNome'] }}
                        {% elif 'extratorNome' in campos_erros %}
                        {{ campos_erros['extratorNome'] }}
                        {% endif %}
                      </div>
                    </div>
                  </div>

                  {% for produto_id, produto_data in produtos_bitolas.items() %}
                  <!-- {{ produto_data.nome }} -->
                  <div class="col-md-12 grupoPossuiExtracao">
                    <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header text-dark">
                        <strong>{{ produto_data.nome }}</strong>
                      </div>
                      <div class="card-body">

                        {% for loop_index in range(produto_data.bitolas|length) %}
                        {% set bitola = produto_data.bitolas[loop_index] %}
                        {% set nome_produto_lower = produto_data.nome.lower() %}
                        {% if nome_produto_lower == 'eucalipto' %}
                          {% set prefix = 'euca' %}
                        {% elif nome_produto_lower == 'pinus' %}
                          {% set prefix = 'pinus' %}
                        {% elif nome_produto_lower == 'biomassa' %}
                          {% set prefix = 'bio' %}
                        {% else %}
                          {% set prefix = nome_produto_lower[:5] %}
                        {% endif %}
                        
                        <!-- Bitola {{ loop_index + 1 }} {{ produto_data.nome }} -->
                        <div class="row mb-3">
                          <div class="col-md-4">
                            <label class="form-label">{% if produto_data.nome == 'Biomassa' %}Tipo{% else %}Bitola{% endif %}</label>
                            <input type="text" name="{{ prefix }}BitolaId{{ loop_index + 1 }}" value="{{ bitola.nome }}" disabled
                              class="form-control {% if prefix + 'BitolaId' + (loop_index + 1)|string in campos_obrigatorios %}is-invalid{% endif %}">
                          </div>
                          <div class="col-md-8">
                            <label class="form-label">Custo de Extração (Ton.)</label>
                            <input type="text" name="{{ prefix }}CustoExtracao{{ loop_index + 1 }}"
                              value="{{ dados_corretos[prefix + 'CustoExtracao' + (loop_index + 1)|string] }}"
                              class="form-control campo-moeda-brl {% if prefix + 'CustoExtracao' + (loop_index + 1)|string in campos_obrigatorios %}is-invalid{% endif %}">
                          </div>
                        </div>
                        {% endfor %}

                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>


              <!-- Nova implementação adicionando madeira posta se houver -->

              <h3 class="text-primary mb-4">Madeira Posta</h3>

              <div class="mb-3">
                <!-- Radio: Possui / Não possui madeira posta -->
                <div class="form-label required">Possui madeira posta?</div>
                <label class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="madeiraPosta" value="possui" {% if
                    dados_corretos['madeiraPosta']=='possui' %}checked{% endif %}>
                  <span class="form-check-label">Sim</span>
                </label>
                <label class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="madeiraPosta" value="nao_possui" {% if
                    dados_corretos['madeiraPosta']=='nao_possui' or not dados_corretos['madeiraPosta'] %}checked{% endif %}>
                  <span class="form-check-label">Não</span>
                </label>
              </div>

              <!-- Container principal que agrupa todos os blocos de “Madeira Posta” -->
              <div id="container-madeira-posta">
                <!-- Bloco “modelo” (será clonado) -->
                <div class="row mb-3 madeira-item">

                  <!-- SELECIONAR CLIENTE -->
                  <div class="col-md-6 mb-4 grupoPossuiMadeiraPosta">
                    <label class="form-label required">Selecione um
                      cliente</label>
                    <select name="clienteMadeiraPosta[]"
                      class="form-select {% if 'clienteMadeiraPosta' in campos_obrigatorios %}is-invalid{% endif %}">
                      <option value selected>Selecione...</option>
                      {% for c in clientes %}
                      <option value="{{ c.id }}" {% if dados_corretos['clienteMadeiraPosta'] is defined and
                        dados_corretos['clienteMadeiraPosta']==c.id %}selected{% endif %}>
                        {{ c.identificacao }}
                      </option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                      {% if 'clienteMadeiraPosta' in campos_obrigatorios %}
                      {{ campos_obrigatorios['clienteMadeiraPosta'] }}
                      {% elif 'clienteMadeiraPosta' in campos_erros %}
                      {{ campos_erros['clienteMadeiraPosta'] }}
                      {% endif %}
                    </div>
                  </div>

                  <!-- SELECIONAR TRANSPORTADORA -->
                  <div class="col-md-6 mb-4 grupoPossuiMadeiraPosta">
                    <label class="form-label">Vincular Transportadora</label>
                    <select name="transportadoraMadeiraPosta[]"
                      class="form-select {% if 'transportadoraMadeiraPosta' in campos_obrigatorios %}is-invalid{% endif %}">
                      <option value selected>Selecione...</option>
                      {% for t in transportadoras %}
                      <option value="{{ t.id }}" {% if dados_corretos['transportadoraMadeiraPosta'] is defined and
                        dados_corretos['transportadoraMadeiraPosta']==t.id %}selected{% endif %}>
                        {{ t.identificacao }}
                      </option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                      {% if 'transportadoraMadeiraPosta' in campos_obrigatorios %}
                      {{ campos_obrigatorios['transportadoraMadeiraPosta'] }}
                      {% elif 'transportadoraMadeiraPosta' in campos_erros %}
                      {{ campos_erros['transportadoraMadeiraPosta'] }}
                      {% endif %}
                    </div>
                  </div>

                  <div class="row">
                    <!-- PRODUTOS MADEIRA POSTA - DINÂMICO -->
                    {% for produto_id, produto_data in produtos_bitolas.items() %}
                    <div class="col-md-12 grupoPossuiMadeiraPosta">
                      <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header text-dark">
                          <strong>{{ produto_data.nome }}</strong>
                        </div>
                        <div class="card-body">
                          
                          {% for bitola in produto_data.bitolas %}
                          <div class="row mb-3">
                            <div class="col-md-4">
                              <label class="form-label">{% if produto_data.nome == 'Biomassa' %}Tipo{% else %}Bitola{% endif %}</label>
                              <input type="text" value="{{ bitola.nome }}" disabled class="form-control">
                            </div>
                            <div class="col-md-8">
                              <label class="form-label">Preço Madeira Posta
                                {% if produto_data.nome != 'Biomassa' %}Bitola{% endif %}
                                (Ton.)</label>
                              <input type="text" 
                                name="{{ produto_data.nome.lower() }}MadeiraPosta{{ loop.index }}[]"
                                value="{{ dados_corretos[produto_data.nome.lower() + 'MadeiraPosta' + loop.index|string] or '' }}"
                                class="form-control campo-moeda-brl {% if produto_data.nome.lower() + 'MadeiraPosta' + loop.index|string in campos_obrigatorios %}is-invalid{% endif %}">
                            </div>
                          </div>
                          {% endfor %}

                        </div>
                      </div>
                    </div>
                    {% endfor %}
                    <!-- BOTÕES DE ADICIONAR / REMOVER (ao final do bloco) -->
                    <div class="col-md-12 d-flex justify-content-center mb-4">
                      <button type="button" class="btn btn-danger btn-remover me-2" disabled>
                        <!-- ícone de lixeira -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icon-tabler-trash">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 7l16 0" />
                          <path d="M10 11l0 6" />
                          <path d="M14 11l0 6" />
                          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                        </svg>
                      </button>
                      <button type="button" class="btn btn-primary btn-adicionar">
                        <!-- ícone de + -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icon-tabler-plus">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M12 5l0 14" />
                          <path d="M5 12l14 0" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Mensagem de erro geral (opcional) -->
                <div class="invalid-feedback d-block">
                  {% if 'madeiraPosta' in campos_obrigatorios %}
                  {{ campos_obrigatorios['madeiraPosta'] }}
                  {% elif 'madeiraPosta' in campos_erros %}
                  {{ campos_erros['madeiraPosta'] }}
                  {% endif %}
                </div>

              </div>

              <!-- ========== SEÇÃO DE COMISSIONADOS ========== -->
              <h3 class="text-primary mb-3">Comissionados</h3>

              <div class="mb-3">
                <div class="form-label required">Possui comissionado?</div>
                <label class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="possuiComissionado" value="possui" {% if
                    dados_corretos['possuiComissionado']=='possui' %}checked{% endif %}>
                  <span class="form-check-label">Sim</span>
                </label>
                <label class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="possuiComissionado" value="nao_possui" {% if
                    dados_corretos['possuiComissionado']=='nao_possui' or not dados_corretos['possuiComissionado']
                    %}checked{% endif %}>
                  <span class="form-check-label">Não</span>
                </label>
              </div>

              <div class="row">
                <!-- Container principal que agrupa todos os blocos de "Comissionados" -->
                <div id="container-comissionados">
                  
                  {% if dados_corretos.get('comissionados') and dados_corretos['comissionados']|length > 0 %}
                    <!-- Renderizar comissionados existentes -->
                    {% for comiss in dados_corretos['comissionados'] %}
                    <div class="row mb-3 comissionado-item grupoPossuiComissionado">

                      <!-- SELECIONAR COMISSIONADO -->
                      <div class="col-md-4 mb-4">
                        <label class="form-label">Selecione um Comissionado</label>
                        <select name="comissionados[]" class="form-select">
                          <option value>Selecione...</option>
                          {% for c in comissionados %}
                          <option value="{{ c.id }}" {% if c.id == comiss.id %}selected{% endif %}>{{ c.identificacao }}</option>
                          {% endfor %}
                        </select>
                      </div>

                      <!-- TIPO COMISSÃO -->
                      <div class="col-md-2 mb-4">
                        <label class="form-label">Tipo</label>
                        <select name="tipoComissao[]" class="form-select tipo-comissao-select">
                          <option value="valor" {% if comiss.tipo == 'valor' %}selected{% endif %}>Valor (R$/ton)</option>
                          <option value="porcentagem" {% if comiss.tipo == 'porcentagem' %}selected{% endif %}>Porcentagem (%)</option>
                        </select>
                      </div>

                      <!-- VALOR COMISSÃO -->
                      <div class="col-md-4 mb-4">
                        <label class="form-label valor-label">
                          {% if comiss.tipo == 'porcentagem' %}Porcentagem (%){% else %}Valor Comissão/Ton{% endif %}
                        </label>
                        <input type="text" name="valorComissaoTon[]" 
                          class="form-control {% if comiss.tipo == 'porcentagem' %}campo-float{% else %}campo-moeda-brl{% endif %} valor-input"
                          value="{{ comiss.valor }}"
                          placeholder="{% if comiss.tipo == 'porcentagem' %}0.00{% else %}R$ 0,00{% endif %}">
                      </div>

                      <!-- BOTÕES -->
                      <div class="col-md-2 mb-4 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-remover me-2" {% if loop.first and loop.length == 1 %}disabled{% endif %}>
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icon-tabler-trash">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M4 7l16 0" />
                            <path d="M10 11l0 6" />
                            <path d="M14 11l0 6" />
                            <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                            <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                          </svg>
                        </button>
                        <button type="button" class="btn btn-primary btn-adicionar-comissionado">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icon-tabler-plus">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M12 5l0 14" />
                            <path d="M5 12l14 0" />
                          </svg>
                        </button>
                      </div>

                    </div>
                    {% endfor %}
                  {% else %}
                    <!-- Bloco "modelo" (será clonado quando não há comissionados) -->
                    <div class="row mb-3 comissionado-item grupoPossuiComissionado">

                      <!-- SELECIONAR COMISSIONADO -->
                      <div class="col-md-4 mb-4">
                        <label class="form-label">Selecione um Comissionado</label>
                        <select name="comissionados[]" class="form-select">
                          <option value>Selecione...</option>
                          {% for c in comissionados %}
                          <option value="{{ c.id }}">{{ c.identificacao }}</option>
                          {% endfor %}
                        </select>
                      </div>

                      <!-- TIPO COMISSÃO -->
                      <div class="col-md-2 mb-4">
                        <label class="form-label">Tipo</label>
                        <select name="tipoComissao[]" class="form-select tipo-comissao-select">
                          <option value="valor" selected>Valor (R$/ton)</option>
                          <option value="porcentagem">Porcentagem (%)</option>
                        </select>
                      </div>

                      <!-- VALOR COMISSÃO -->
                      <div class="col-md-4 mb-4">
                        <label class="form-label valor-label">Valor Comissão/Ton</label>
                        <input type="text" name="valorComissaoTon[]" class="form-control campo-moeda-brl valor-input"
                          placeholder="R$ 0,00">
                      </div>

                      <!-- BOTÕES -->
                      <div class="col-md-2 mb-4 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-remover me-2" disabled>
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icon-tabler-trash">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M4 7l16 0" />
                            <path d="M10 11l0 6" />
                            <path d="M14 11l0 6" />
                            <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                            <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                          </svg>
                        </button>
                        <button type="button" class="btn btn-primary btn-adicionar-comissionado">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icon-tabler-plus">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M12 5l0 14" />
                            <path d="M5 12l14 0" />
                          </svg>
                        </button>
                      </div>

                    </div>
                  {% endif %}
                </div>
              </div>
              <!-- ========== /SEÇÃO DE COMISSIONADOS ========== -->

            </div>
            <div class="card-footer text-center text-md-end">
              <a href="{{ url_for('listar_fornecedores') }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="24"
                  height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M5 12l14 0"></path>
                  <path d="M5 12l6 6"></path>
                  <path d="M5 12l6 -6"></path>
                </svg>
                Voltar
              </a>
              <button type="submit" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-edit" width="24" height="24"
                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path>
                  <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path>
                  <path d="M16 5l3 3"></path>
                </svg>
                Atualizar
              </button>
            </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Oculta exibe campos a partir da radio e também limpa a tela não usada -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {


      function limparCampos(grupoClasse) {
        document.querySelectorAll('.' + grupoClasse + ' input[type="text"]').forEach(function (input) {
          input.value = '';
        });
      }

      function alternarCampos() {
        var radioFunrural = document.querySelector('input[name="tipoContribuicao"][value="funrural"]');

        var grupoSenar = document.querySelectorAll('.grupoSenar');

        if (radioFunrural.checked) {
          grupoSenar.forEach(el => el.style.display = 'none');
          limparCampos('grupoSenar');
        } else {
          grupoSenar.forEach(el => el.style.display = 'block');
        }
      }

      document.querySelectorAll('input[name="tipoContribuicao"]').forEach(radio => {
        radio.addEventListener('change', alternarCampos);
      });

      alternarCampos(); // Configura o estado inicial dos campos

      // Controle do campo Valor Contrato para Floresta
      function alternarCampoFloresta() {
        var radioFlorestaSimInput = document.querySelector('input[name="classeFornecedor"][value="sim"]');
        var campoValorContrato = document.querySelectorAll('.florestaSim');

        if (radioFlorestaSimInput && radioFlorestaSimInput.checked) {
          // Mostra o campo Valor Contrato
          campoValorContrato.forEach(el => el.style.display = 'block');
        } else {
          // Esconde o campo Valor Contrato
          campoValorContrato.forEach(el => el.style.display = 'none');
          // Limpa o valor do campo quando oculto
          document.querySelectorAll('.florestaSim input[type="text"]').forEach(function (input) {
            input.value = '';
          });
        }
      }

      // Event listeners para os radio buttons de Floresta
      document.querySelectorAll('input[name="classeFornecedor"]').forEach(radio => {
        radio.addEventListener('change', alternarCampoFloresta);
      });

      // Configura o estado inicial do campo Floresta
      alternarCampoFloresta();
    });
  </script>

  <!-- Oculta exibe campos a partir da radio e também limpa a tela não usada -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function limparCampos(grupoClasse) {
        document.querySelectorAll('.' + grupoClasse + ' input[type="text"]').forEach(function (input) {
          input.value = '';
        });
      }

      function alternarCampos() {
        var radioCPF = document.querySelector('input[name="tipoCadastro"][value="cpf"]');

        var grupoCPF = document.querySelectorAll('.grupoCPF');
        var grupoCNPJ = document.querySelectorAll('.grupoCNPJ');

        if (radioCPF.checked) {
          grupoCPF.forEach(el => el.style.display = 'block');
          grupoCNPJ.forEach(el => el.style.display = 'none');
          limparCampos('grupoCNPJ'); // Limpa campos do grupo CNPJ
        } else {
          grupoCPF.forEach(el => el.style.display = 'none');
          grupoCNPJ.forEach(el => el.style.display = 'block');
          limparCampos('grupoCPF'); // Limpa campos do grupo CPF
        }
      }

      document.querySelectorAll('input[name="tipoCadastro"]').forEach(radio => {
        radio.addEventListener('change', alternarCampos);
      });

      alternarCampos(); // Configura o estado inicial dos campos
    });
  </script>

  <!-- GRUPO DE EXTRAÇÃO -->

  <!-- Oculta exibe campos a partir da radio e também limpa a tela não usada -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {


      function alternarCampos() {
        var radioPossui = document.querySelector('input[name="custoExtracao"][value="possui"]');
        var grupoPossuiExtracao = document.querySelectorAll('.grupoPossuiExtracao');

        if (radioPossui && radioPossui.checked) {
          grupoPossuiExtracao.forEach(el => el.style.display = 'block');
        } else {
          grupoPossuiExtracao.forEach(el => el.style.display = 'none');
        }
      }

      // Verificação inicial baseada nos dados do backend
      setTimeout(() => {
        const valorCustoExtracao = '{{ dados_corretos.custoExtracao }}';
        if (valorCustoExtracao === 'possui') {
          const radioPossui = document.querySelector('input[name="custoExtracao"][value="possui"]');
          if (radioPossui && !radioPossui.checked) {
            radioPossui.checked = true;
          }
        }
        alternarCampos();
      }, 100);

      document.querySelectorAll('input[name="custoExtracao"]').forEach(radio => {
        radio.addEventListener('change', alternarCampos);
      });

      alternarCampos(); // Configura o estado inicial dos campos
    });
  </script>

  <!-- GRUPO DE MADEIRA POSTA -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const container = document.getElementById('container-madeira-posta');

      // 1) alterna visibilidade dos blocos conforme radio “possui” / “não possui”
      function alternarCampos() {
        const radioPossui = document.querySelector('input[name="madeiraPosta"][value="possui"]');
        const blocos = container.querySelectorAll('.madeira-item');
        if (radioPossui.checked) {
          blocos.forEach(el => el.style.display = 'flex');
        } else {
          blocos.forEach(el => el.style.display = 'none');
        }
        // após mostrar / esconder, forçar atualização das options
        atualizarTodosSelects();
      }

      document.querySelectorAll('input[name="madeiraPosta"]').forEach(radio => {
        radio.addEventListener('change', alternarCampos);
      });
      alternarCampos(); // estado inicial

      function obterSelecionados() {
        return { clientesSelecionados: new Set(), transportadorasSelecionadas: new Set() };
      }

      function atualizarTodosSelects() {
        const { clientesSelecionados, transportadorasSelecionadas } = obterSelecionados();
        container.querySelectorAll('select[name="clienteMadeiraPosta[]"]').forEach(select => {
          const atual = select.value;
          // Para cada option neste select: se o value estiver em “selecionados” e for diferente do atual, esconder/desabilitar
          Array.from(select.options).forEach(option => {
            if (!option.value) return; // primeira opção “Selecione...”
            if (option.value === atual) {
              // mantém habilitado
              option.disabled = false;
              option.hidden = false;
            } else if (clientesSelecionados.has(option.value)) {
              option.disabled = false;
              option.hidden = false;
            } else {
              option.disabled = false;
              option.hidden = false;
            }
          });
        });

        // Atualizar selects de transportadoras
        container.querySelectorAll('select[name="transportadoraMadeiraPosta[]"]').forEach(select => {
          const atual = select.value;
          Array.from(select.options).forEach(option => {
            if (!option.value) return; // primeira opção "Selecione..."
            if (option.value === atual) {
              // mantém habilitado
              option.disabled = false;
              option.hidden = false;
            } else if (transportadorasSelecionadas.has(option.value)) {
              option.disabled = false;
              option.hidden = false;
            } else {
              option.disabled = false;
              option.hidden = false;
            }
          });
        });
      }

      // 4) Função que adiciona um novo bloco clonando o primeiro e limpando campos
      function adicionarNovoBloco() {
        const blocoModelo = container.querySelector('.madeira-item');
        const novoBloco = blocoModelo.cloneNode(true);

        // limpar select de cliente
        const selectCliente = novoBloco.querySelector('select[name="clienteMadeiraPosta[]"]');
        if (selectCliente) {
          selectCliente.selectedIndex = 0;
        }

        // limpar select de transportadora
        const selectTransportadora = novoBloco.querySelector('select[name="transportadoraMadeiraPosta[]"]');
        if (selectTransportadora) {
          selectTransportadora.selectedIndex = 0;
        }

        // limpar inputs de preço e mascara
        novoBloco.querySelectorAll('input.campo-moeda-brl').forEach(input => {
          input.value = '';
          input.removeAttribute('data-mascara-aplicada');
        });

        // habilitar botão “remover”
        const btnRemover = novoBloco.querySelector('.btn-remover');
        if (btnRemover) {
          btnRemover.disabled = false;
        }

        container.appendChild(novoBloco);
        // reaplicar máscara e atualizar selects
        if (typeof aplicarMascaraMoeda === 'function') {
          aplicarMascaraMoeda();
        }
        atualizarTodosSelects();
        vincularChangeSelect(novoBloco);
      }

      // Vincula eventos de change nos selects
      function vincularChangeSelect(bloco) {
        const selectCliente = bloco.querySelector('select[name="clienteMadeiraPosta[]"]');
        if (selectCliente) selectCliente.addEventListener('change', atualizarTodosSelects);

        const selectTransportadora = bloco.querySelector('select[name="transportadoraMadeiraPosta[]"]');
        if (selectTransportadora) selectTransportadora.addEventListener('change', atualizarTodosSelects);
      }

      // Vincular eventos nos blocos existentes
      container.querySelectorAll('.madeira-item').forEach(bloco => {
        vincularChangeSelect(bloco);
      });

      // Gerencia clique em adicionar/remover blocos
      container.addEventListener('click', function (event) {
        if (event.target.closest('.btn-adicionar')) {
          adicionarNovoBloco();
        }
        if (event.target.closest('.btn-remover')) {
          const todosBlocos = container.querySelectorAll('.madeira-item');
          if (todosBlocos.length > 1) {
            const blocoAtual = event.target.closest('.madeira-item');
            blocoAtual.remove();
            atualizarTodosSelects();
          }
        }
      });

      // Inicializar máscaras e selects
      if (typeof aplicarMascaraMoeda === 'function') {
        aplicarMascaraMoeda();
      }
      atualizarTodosSelects();
      
      // Carregar dados para edição de madeira posta
      setTimeout(() => {
        const valorMadeiraPosta = '{{ dados_corretos.madeiraPosta }}';
        if (valorMadeiraPosta === 'possui') {
          criarBlocosMadeiraPostaEdicao();
        }
      }, 200);
      
      // Cria blocos de madeira posta para edição baseado nos dados do banco
      function criarBlocosMadeiraPostaEdicao() {
        const clientesMP = {{ dados_corretos.clienteMadeiraPosta | tojson }};
        const transportadorasMP = {{ dados_corretos.transportadoraMadeiraPosta | tojson }};
        
        // Obter estrutura dinâmica de produtos/bitolas do backend
        const produtosBitolas = {{ produtos_bitolas | tojson }};
        const dadosCorretos = {{ dados_corretos | tojson }};
        
        if (!clientesMP || clientesMP.length === 0) {
          return;
        }
        
        const primeiroBloco = container.querySelector('.madeira-item');
        
        // Criar um bloco para cada cliente
        for (let i = 0; i < clientesMP.length; i++) {
          let bloco;
          
          if (i === 0) {
            // Usar o primeiro bloco existente
            bloco = primeiroBloco;
          } else {
            // Clonar o primeiro bloco para os demais
            bloco = primeiroBloco.cloneNode(true);
            container.appendChild(bloco);
            
            // Habilitar botão remover para blocos adicionais
            const btnRemover = bloco.querySelector('.btn-remover');
            if (btnRemover) btnRemover.disabled = false;
          }
          
          // Preencher dados do bloco
          const selectCliente = bloco.querySelector('select[name="clienteMadeiraPosta[]"]');
          if (selectCliente && clientesMP[i]) {
            selectCliente.value = clientesMP[i];
          }
          
          const selectTransportadora = bloco.querySelector('select[name="transportadoraMadeiraPosta[]"]');
          if (selectTransportadora && transportadorasMP[i]) {
            selectTransportadora.value = transportadorasMP[i];
          }
          
          // Preencher preços dinamicamente baseado nos produtos/bitolas
          const preencherPreco = (nome, valor) => {
            const input = bloco.querySelector(`input[name="${nome}"]`);
            if (input && valor && valor > 0) {
              const valorFormatado = formatarMoedaLocal(valor / 100);
              input.value = valorFormatado;
            }
          };
          
          // Iterar por todos os produtos e suas bitolas
          Object.keys(produtosBitolas).forEach(produtoId => {
            const produto = produtosBitolas[produtoId];
            const produtoKey = produto.nome.toLowerCase();
            
            produto.bitolas.forEach((bitola, bitolaIndex) => {
              const nomeCampo = `${produtoKey}MadeiraPosta${bitolaIndex + 1}[]`;
              const valorCampo = dadosCorretos[`${produtoKey}MadeiraPosta${bitolaIndex + 1}`];
              
              if (valorCampo && Array.isArray(valorCampo) && valorCampo[i]) {
                preencherPreco(nomeCampo, valorCampo[i]);
              }
            });
          });
        }
        
        // Reaplicar máscara após preencher valores
        if (typeof aplicarMascaraMoeda === 'function') {
          aplicarMascaraMoeda();
        }
        atualizarTodosSelects();
      }
      
      // Função auxiliar para formatar valores monetários
      function formatarMoedaLocal(valor) {
        return 'R$ ' + valor.toLocaleString('pt-BR', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
    });
  </script>

  <!-- JavaScript para gestão dinâmica de comissionados -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const containerComissionados = document.getElementById('container-comissionados');
      if (!containerComissionados) return;

      // 0) Controle de visibilidade baseado no radio button
      function alternarCamposComissionados() {
        const radioPossui = document.querySelector('input[name="possuiComissionado"][value="possui"]');
        const gruposComissionado = document.querySelectorAll('.grupoPossuiComissionado');
        if (radioPossui && radioPossui.checked) {
          gruposComissionado.forEach(el => el.style.display = 'flex');
        } else {
          gruposComissionado.forEach(el => el.style.display = 'none');
        }
      }

      document.querySelectorAll('input[name="possuiComissionado"]').forEach(radio => {
        radio.addEventListener('change', alternarCamposComissionados);
      });
      alternarCamposComissionados(); // estado inicial

      // 1) Função para atualizar os botões remover (habilitar/desabilitar conforme quantidade)
      function atualizarBotoesRemoverComissionados() {
        const blocosComissionados = containerComissionados.querySelectorAll('.comissionado-item');
        blocosComissionados.forEach((bloco, index) => {
          const btnRemover = bloco.querySelector('.btn-remover');
          if (btnRemover) {
            btnRemover.disabled = blocosComissionados.length <= 1;
          }
        });
      }

      // 2) Função para alternar entre valor e porcentagem
      function alternarTipoComissao(bloco) {
        const selectTipo = bloco.querySelector('.tipo-comissao-select');
        let inputValor = bloco.querySelector('.valor-input');
        const labelValor = bloco.querySelector('.valor-label');
        
        if (selectTipo && inputValor && labelValor) {
          selectTipo.addEventListener('change', function() {
            // Atualizar referência do input
            inputValor = bloco.querySelector('.valor-input');
            
            // Limpar completamente o input
            inputValor.value = '';
            inputValor.removeAttribute('data-mascara-aplicada');
            
            // Remover evento de input antigo (máscara)
            const novoInput = inputValor.cloneNode(true);
            inputValor.parentNode.replaceChild(novoInput, inputValor);
            
            if (this.value === 'porcentagem') {
              // Mudar para porcentagem
              novoInput.classList.remove('campo-moeda-brl');
              novoInput.classList.add('campo-float');
              novoInput.placeholder = '0.00';
              novoInput.value = '';
              labelValor.textContent = 'Porcentagem (%)';
            } else {
              // Mudar para valor
              novoInput.classList.remove('campo-float');
              novoInput.classList.add('campo-moeda-brl');
              novoInput.placeholder = 'R$ 0,00';
              novoInput.value = '';
              labelValor.textContent = 'Valor Comissão/Ton';
            }
            
            // Reaplicar máscaras
            if (typeof aplicarMascaraMoeda === 'function') {
              aplicarMascaraMoeda();
            }
            if (typeof aplicarComportamentoCampoFloat === 'function') {
              aplicarComportamentoCampoFloat();
            }
          });
        }
      }

      // 3) Função para adicionar novo bloco de comissionado
      function adicionarNovoBlocoComissionado() {
        const blocoModelo = containerComissionados.querySelector('.comissionado-item');
        const novoBloco = blocoModelo.cloneNode(true);

        // Limpar valores dos campos
        const select = novoBloco.querySelector('select[name="comissionados[]"]');
        if (select) {
          select.selectedIndex = 0;
        }

        const selectTipo = novoBloco.querySelector('select[name="tipoComissao[]"]');
        if (selectTipo) {
          selectTipo.selectedIndex = 0;
        }

        const input = novoBloco.querySelector('input[name="valorComissaoTon[]"]');
        if (input) {
          input.value = '';
          input.removeAttribute('data-mascara-aplicada');
          input.classList.remove('campo-float');
          input.classList.add('campo-moeda-brl');
          input.placeholder = 'R$ 0,00';
        }

        const label = novoBloco.querySelector('.valor-label');
        if (label) {
          label.textContent = 'Valor Comissão/Ton';
        }

        // Habilitar botão "remover"
        const btnRemover = novoBloco.querySelector('.btn-remover');
        if (btnRemover) {
          btnRemover.disabled = false;
        }

        containerComissionados.appendChild(novoBloco);

        // Vincular evento de troca de tipo
        alternarTipoComissao(novoBloco);

        // Reaplicar máscara e atualizar botões
        if (typeof aplicarMascaraMoeda === 'function') {
          aplicarMascaraMoeda();
        }
        atualizarBotoesRemoverComissionados();
      }

      // 4) Gerencia clique em adicionar/remover blocos de comissionados
      containerComissionados.addEventListener('click', function (event) {
        if (event.target.closest('.btn-adicionar-comissionado')) {
          adicionarNovoBlocoComissionado();
        }
        if (event.target.closest('.btn-remover')) {
          const todosBlocos = containerComissionados.querySelectorAll('.comissionado-item');
          if (todosBlocos.length > 1) {
            const blocoAtual = event.target.closest('.comissionado-item');
            blocoAtual.remove();
            atualizarBotoesRemoverComissionados();
          }
        }
      });

      // 5) Ao inicializar, vincular eventos nos blocos existentes
      containerComissionados.querySelectorAll('.comissionado-item').forEach(bloco => {
        alternarTipoComissao(bloco);
      });

      // Estado inicial dos botões
      atualizarBotoesRemoverComissionados();
    });
  </script>

  <script>
    // Cria o TOM Select nos selects para melhor UX
    document.addEventListener('DOMContentLoaded', function () {
      // Configuração padrão do TomSelect
      const defaultConfig = {
        create: false,
        allowEmptyOption: true,
        sortField: {
          field: "text",
          direction: "asc"
        }
      };

      const selectors = [
        '#selectExtrator',
        'select[name="instituicao_financeira"]'
      ];

      // Inicializa TomSelect em cada elemento encontrado
      selectors.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
          new TomSelect(element, defaultConfig);
        }
      });

      // Pré-carregar dados para edição se necessário
      preCarregarDadosEdicao();
    });

    function preCarregarDadosEdicao() {
      const isEdicaoMode = window.location.pathname.includes('/editar/');
      if (!isEdicaoMode) return;
      
      // Atualizar visibilidade dos grupos baseado nos valores carregados
      setTimeout(() => {
        // Atualizar grupo de custo de extração
        const radioCustoExtracao = document.querySelector('input[name="custoExtracao"]:checked');
        if (radioCustoExtracao) {
          const grupoPossuiExtracao = document.querySelectorAll('.grupoPossuiExtracao');
          if (radioCustoExtracao.value === 'possui') {
            grupoPossuiExtracao.forEach(el => el.style.display = 'block');
          } else {
            grupoPossuiExtracao.forEach(el => el.style.display = 'none');
          }
        }
        
        // Atualizar grupo de madeira posta
        const radioMadeiraPosta = document.querySelector('input[name="madeiraPosta"]:checked');
        if (radioMadeiraPosta) {
          const blocosMadeiraPosta = document.querySelectorAll('.madeira-item');
          if (radioMadeiraPosta.value === 'possui') {
            blocosMadeiraPosta.forEach(el => el.style.display = 'flex');
          } else {
            blocosMadeiraPosta.forEach(el => el.style.display = 'none');
          }
        }
        
        // Atualizar grupo de comissionados
        const radioComissionado = document.querySelector('input[name="possuiComissionado"]:checked');
        if (radioComissionado) {
          const gruposComissionado = document.querySelectorAll('.grupoPossuiComissionado');
          if (radioComissionado.value === 'possui') {
            gruposComissionado.forEach(el => el.style.display = 'flex');
          } else {
            gruposComissionado.forEach(el => el.style.display = 'none');
          }
        }
      }, 100);
      
      // Aqui os dados são pré-carregados pelo backend através do dados_corretos
      // O JavaScript apenas garante que os campos dinâmicos sejam exibidos corretamente
      
      // Reaplicar máscaras nos campos carregados
      if (typeof aplicarMascaraMoeda === 'function') {
        aplicarMascaraMoeda();
      }
      if (typeof aplicarComportamentoCampoFloat === 'function') {
        aplicarComportamentoCampoFloat();
      }
    }
  </script>

  <script>
    // Script específico para corrigir problemas na edição
    document.addEventListener('DOMContentLoaded', function () {
      
      // Correção dos radio buttons para edição
      function corrigirRadioButtons() {
        const custoExtracaoValor = '{{ dados_corretos.custoExtracao }}';
        if (custoExtracaoValor === 'possui') {
          const radioExtracao = document.querySelector('input[name="custoExtracao"][value="possui"]');
          if (radioExtracao) {
            radioExtracao.checked = true;
            document.querySelectorAll('.grupoPossuiExtracao').forEach(el => {
              el.style.display = 'block';
            });
          }
        }
        
        const madeiraPostaValor = '{{ dados_corretos.madeiraPosta }}';
        if (madeiraPostaValor === 'possui') {
          const radioMadeira = document.querySelector('input[name="madeiraPosta"][value="possui"]');
          if (radioMadeira) {
            radioMadeira.checked = true;
            document.querySelectorAll('.madeira-item').forEach(el => {
              el.style.display = 'flex';
            });
          }
        }
      }
      
      // Executar correção com delay para garantir elementos prontos
      setTimeout(corrigirRadioButtons, 200);
      setTimeout(corrigirRadioButtons, 500);
    });
  </script>

  {% include 'estrutura/footer.html' %}

</div>

{% endblock conteudo %}