{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/extrato-credito-terceiros.css') }}">

<div class="page-wrapper">

  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle text-muted">FINANCEIRO / ADIANTAMENTOS</div>
          <h2 class="page-title fw-bold">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icon-tabler-wallet me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" />
              <path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" />
            </svg>
            Extrato de Crédito - Extrator
          </h2>
        </div>
        <div class="col-auto ms-auto">
          <a href="{{ url_for('lancar_credito_extrator', id=extrator.id) }}"
            class="btn btn-success d-flex align-items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icon-tabler-plus">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12 5l0 14" />
              <path d="M5 12l14 0" />
            </svg>
            Novo Lançamento
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body py-4">
    <div class="container-xl">

      {% include 'estrutura/mensagens_flash.html' %}

      <div class="row g-3 mb-4">

        <div class="col-md-6 col-lg-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <span class="avatar avatar-lg bg-orange-lt text-orange me-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-wheat-off">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M3 3l18 18" />
                    <path d="M12 21.5v-3.75" />
                    <path
                      d="M5.916 9.49l-.43 1.604c-.712 2.659 .866 5.392 3.524 6.104c.997 .268 1.994 .535 2.99 .802v-3.44c-.164 -2.105 -1.637 -3.879 -3.677 -4.426l-2.407 -.644" />
                    <path d="M10.249 4.251c.007 -.007 .014 -.014 .021 -.021l1.73 -1.73" />
                    <path d="M10.27 11.15c-.589 -.589 -1.017 -1.318 -1.246 -2.118" />
                    <path
                      d="M14.988 8.988c.229 -.834 .234 -1.713 .013 -2.549c-.221 -.836 -.659 -1.598 -1.271 -2.209l-1.73 -1.73" />
                    <path d="M16.038 10.037l2.046 -.547l.431 1.604c.142 .53 .193 1.063 .162 1.583" />
                    <path
                      d="M16.506 16.505c-.45 .307 -.959 .544 -1.516 .694c-.997 .268 -1.994 .535 -2.99 .801v-3.44c.055 -.708 .259 -1.379 .582 -1.978" />
                  </svg>
                </span>
                <div>
                  <div class="text-muted small text-uppercase fw-semibold">Extrator</div>
                  <h3 class="mb-0 fw-bold">{{ extrator.identificacao[:30] }}{% if extrator.identificacao|length > 30
                    %}...{% endif %}</h3>
                </div>
              </div>
              <div class="small text-muted">
                <div><strong>Documento:</strong> {{ extrator.numero_documento or 'Não informado' }}</div>
                <div><strong>Telefone:</strong> {{ extrator.telefone or 'Não informado' }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body d-flex flex-column justify-content-center">
              <div class="d-flex align-items-center">
                <span
                  class="avatar avatar-lg {{ 'bg-success text-white' if saldo > 0 else 'bg-danger text-white' if saldo < 0 else 'bg-azure text-white' }} me-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-tabler icon-tabler-wallet">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" />
                    <path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" />
                  </svg>
                </span>
                <div>
                  <div class="text-uppercase text-muted small fw-semibold">Saldo Atual</div>
                  <h2
                    class="mb-0 fw-bold {{ 'text-success' if saldo > 0 else 'text-danger' if saldo < 0 else 'text-azure' }}">
                    {{ saldo | formatar_float_para_brl }}
                  </h2>
                </div>
              </div>
              <div class="mt-3">
                {% if saldo > 0 %}
                <span class="badge bg-success-lt text-success">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                    <path d="M12 5l0 14" />
                    <path d="M18 11l-6 -6" />
                    <path d="M6 11l6 -6" />
                  </svg>
                  Crédito disponível
                </span>
                {% elif saldo < 0 %} <span class="badge bg-danger-lt text-danger">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                    <path d="M12 5l0 14" />
                    <path d="M18 13l-6 6" />
                    <path d="M6 13l6 6" />
                  </svg>
                  Débito pendente
                  </span>
                  {% else %}
                  <span class="badge bg-azure-lt text-azure">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-1">
                      <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
                      <path d="M12 8v4l2 2" />
                    </svg>
                    Saldo zerado
                  </span>
                  {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-12 col-lg-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <span class="avatar avatar-lg bg-azure-lt text-azure me-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-tabler icon-tabler-chart-bar">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <rect x="3" y="12" width="6" height="8" rx="1" />
                    <rect x="9" y="8" width="6" height="12" rx="1" />
                    <rect x="15" y="4" width="6" height="16" rx="1" />
                  </svg>
                </span>
                <div>
                  <div class="text-muted small text-uppercase fw-semibold">Movimentações</div>
                  <h3 class="mb-0 fw-bold">{{ extrato|length }} registros</h3>
                </div>
              </div>
              <div class="progress progress-sm">
                {% set total_entradas = extrato|selectattr('tipo_transacao', 'eq', 1)|list|length %}
                {% set total_saidas = extrato|selectattr('tipo_transacao', 'eq', 2)|list|length %}
                {% set total = total_entradas + total_saidas %}
                {% if total > 0 %}
                <div class="progress-bar bg-success" style="width: {{ (total_entradas / total * 100)|round }}%"></div>
                <div class="progress-bar bg-danger" style="width: {{ (total_saidas / total * 100)|round }}%"></div>
                {% endif %}
              </div>
              <div class="d-flex justify-content-between mt-2 small">
                <span class="text-success">▲ {{ total_entradas }} entradas</span>
                <span class="text-danger">▼ {{ total_saidas }} saídas</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if extrato %}
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h4 class="card-title mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icon-tabler-list-details me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M13 5h8" />
              <path d="M13 9h5" />
              <path d="M13 15h8" />
              <path d="M13 19h5" />
              <rect x="3" y="4" width="6" height="6" rx="1" />
              <rect x="3" y="14" width="6" height="6" rx="1" />
            </svg>
            Histórico de Movimentações
          </h4>
        </div>

        <div class="table-responsive">
          <table class="table table-vcenter card-table table-hover">
            <thead>
              <tr>
                <th style="width: 120px">Data</th>
                <th>Descrição</th>
                <th style="width: 100px" class="text-center">Tipo</th>
                <th style="width: 120px" class="text-center">Status</th>
                <th style="width: 150px" class="text-end">Valor</th>
                <th style="width: 80px" class="text-center">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for mov in extrato %}
              <tr>
                <td>
                  <span class="text-muted">
                    {{ mov.data_movimentacao | formatar_data_para_brl }}
                  </span>
                </td>
                <td>
                  <div class="fw-semibold">{{ mov.descricao[:60] if mov.descricao else 'Movimentação registrada' }}{% if
                    mov.descricao and mov.descricao|length > 60 %}...{% endif %}</div>
                  {% if mov.codigo_transacao %}
                  <small class="text-muted">Cód: {{ mov.codigo_transacao }}</small>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if mov.tipo_transacao == 1 %}
                  <span class="badge bg-success-lt text-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-1">
                      <path d="M12 5l0 14" />
                      <path d="M18 11l-6 -6" />
                      <path d="M6 11l6 -6" />
                    </svg>
                    Entrada
                  </span>
                  {% elif mov.tipo_transacao == 2 %}
                  <span class="badge bg-danger-lt text-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-1">
                      <path d="M12 5l0 14" />
                      <path d="M18 13l-6 6" />
                      <path d="M6 13l6 6" />
                    </svg>
                    Saída
                  </span>
                  {% elif mov.tipo_transacao == 3 or mov.tipo_transacao == 4 %}
                  <span class="badge bg-warning-lt text-warning">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-1">
                      <path d="M9 14l-4 -4l4 -4" />
                      <path d="M5 10h11a4 4 0 1 1 0 8h-1" />
                    </svg>
                    Estorno
                  </span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if mov.faturamento_origem and mov.faturamento_origem.situacao_pagamento_id %}
                    {% if mov.faturamento_origem.situacao_pagamento_id in [5, 8, 9, 10] %}
                      <span class="badge bg-green-lt" data-bs-toggle="tooltip" data-bs-placement="top" 
                        title="Cód: {{ mov.faturamento_origem.codigo_faturamento }}">{{ mov.faturamento_origem.situacao.situacao }}</span>
                    {% else %}
                      <span class="badge bg-red-lt" data-bs-toggle="tooltip" data-bs-placement="top" 
                        title="Cód: {{ mov.faturamento_origem.codigo_faturamento }}">{{ mov.faturamento_origem.situacao.situacao }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-dark-lt">Sem faturamento</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% set valor = mov.valor_original_100 or 0 %}
                  <span
                    class="fw-bold {{ 'text-success' if valor > 0 else 'text-danger' if valor < 0 else 'text-muted' }}">
                    {{ valor | formatar_float_para_brl }}
                  </span>
                </td>
                <td class="text-center">
                  {% set pode_editar = mov.tipo_transacao == 1 and (mov.valor_utilizado_100 == 0 or
                  mov.valor_utilizado_100 is none) %}
                  <div class="btn-group" role="group">
                    {% if pode_editar %}
                    
                    <a href="{{ url_for('editar_credito_extrator', credito_id=mov.id) }}"
                      class="btn btn-icon btn-ghost-primary btn" title="Editar lançamento">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icon-tabler-edit">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                        <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                        <path d="M16 5l3 3" />
                      </svg>
                    </a>
                    
                    <button type="button" class="btn btn-icon btn-ghost-danger btn" data-bs-toggle="modal"
                      data-bs-target="#modalExcluir" data-credito-id="{{ mov.id }}"
                      data-credito-descricao="{{ mov.descricao }}"
                      data-credito-valor="{{ valor | formatar_float_para_brl }}" title="Excluir lançamento">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icon-tabler-trash">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M4 7l16 0" />
                        <path d="M10 11l0 6" />
                        <path d="M14 11l0 6" />
                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                      </svg>
                    </button>
                    {% else %}
                    <span class="text-muted" title="Não pode ser editado/excluído (já utilizado)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icon-tabler-lock">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <rect x="5" y="11" width="14" height="10" rx="2" />
                        <circle cx="12" cy="16" r="1" />
                        <path d="M8 11v-4a4 4 0 0 1 8 0v4" />
                      </svg>
                    </span>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      
      <div class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
          <div class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icon-tabler-receipt-off text-muted">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 21v-16m2 -2h10a2 2 0 0 1 2 2v10m0 4.01v1.99l-3 -2l-2 2l-2 -2l-2 2l-2 -2l-3 2" />
              <path d="M11 7l4 0" />
              <path d="M9 11l2 0" />
              <path d="M13 15l2 0" />
              <path d="M15 11l0 .01" />
              <path d="M3 3l18 18" />
            </svg>
          </div>
          <h3 class="text-muted">Nenhuma movimentação encontrada</h3>
          <p class="text-muted mb-4">Este extrator ainda não possui lançamentos de crédito.</p>
        </div>
      </div>
      {% endif %}

      <div class="d-flex justify-content-between mt-4 mb-5">
        <a href="{{ url_for('saldo_extratores') }}"
          class="btn btn-outline-primary d-inline-flex align-items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2"
            stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M5 12l14 0"></path>
            <path d="M5 12l6 6"></path>
            <path d="M5 12l6 -6"></path>
          </svg>
          Voltar para Listagem
        </a>
      </div>

    </div>
  </div>

  <div class="modal modal-blur fade" id="modalExcluir" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
      <div class="modal-content">
        <form method="POST" id="formExcluir" action="">
          <input type="hidden" name="extrator_id" value="{{ extrator.id }}">
          <div class="modal-status bg-danger"></div>
          <div class="modal-body text-center py-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icon-tabler-alert-triangle text-danger mb-3">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12 9v4" />
              <path
                d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.875h16.214a1.914 1.914 0 0 0 1.636 -2.875l-8.106 -13.534a1.914 1.914 0 0 0 -3.274 0z" />
              <path d="M12 16h.01" />
            </svg>
            <h3 class="mb-2">Excluir Lançamento?</h3>
            <div class="text-muted mb-3">
              Você está prestes a excluir o lançamento:<br>
              <strong id="modalCreditoDescricao"></strong><br>
              <span class="badge badge-outline text-blue mt-2" id="modalCreditoValor"></span>
            </div>
            <div class="mb-3">
              <label class="form-label">Motivo da exclusão (opcional)</label>
              <textarea name="motivo" class="form-control" rows="2" placeholder="Informe o motivo..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                <path d="M4 7l16 0" />
                <path d="M10 11l0 6" />
                <path d="M14 11l0 6" />
                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
              </svg>
              Sim, Excluir
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      const modalExcluir = document.getElementById('modalExcluir');
      if (modalExcluir) {
        modalExcluir.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          const creditoId = button.getAttribute('data-credito-id');
          const creditoDescricao = button.getAttribute('data-credito-descricao');
          const creditoValor = button.getAttribute('data-credito-valor');

          document.getElementById('modalCreditoDescricao').textContent = creditoDescricao;
          document.getElementById('modalCreditoValor').textContent = creditoValor;
          document.getElementById('formExcluir').action = `/financeiro/extrato-terceiros/extratores/excluir-credito/${creditoId}`;
        });
      }
    });
  </script>

  {% include 'estrutura/footer.html' %}
</div>
{% endblock conteudo %}