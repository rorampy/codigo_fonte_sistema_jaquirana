{% extends 'estrutura/base.html' %}
{% block conteudo %}
<script defer
  src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% include 'estrutura/header.html' %}

<link rel="stylesheet"
  href="{{url_for('static', filename='css/listagem_importacao_ofx.css')}}">
<link rel="stylesheet"
  href="{{url_for('static', filename='css/conciliacao_performance.css')}}"
  media="screen">

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle text-muted">FINANCEIRO</div>
          <h2 class="page-title fw-bold display-6">CONCILIAÇÃO BANCÁRIA</h2>
          {% if arquivo_nome %}
          <div class="page-subtitle text-primary fw-semibold mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-file-import"
              aria-hidden="true">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M14 3v4a1 1 0 0 0 1 1h4" />
              <path
                d="M5 13v-8a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2h-5.5m-9.5 -2h7m-3 -3l3 3l-3 3" />
            </svg>
            {{ arquivo_nome }}
          </div>
          {% endif %}
        </div>
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <a href="{{ url_for('importar_ofx') }}"
              class="btn btn-outline-dark">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-2"
                width="16" height="16"
                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
                fill="none" stroke-linecap="round"
                stroke-linejoin="round" aria-hidden="true">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path
                  d="M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-12"></path>
                <path d="M9 15l3 -3l3 3"></path>
                <path d="M12 12l0 9"></path>
              </svg>
              Importar Novo OFX
            </a>
            <a href="{{ url_for('listagem_ofx') }}"
              class="btn btn-outline-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-list">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M9 6l11 0" />
                <path d="M9 12l11 0" />
                <path d="M9 18l11 0" />
                <path d="M5 6l0 .01" />
                <path d="M5 12l0 .01" />
                <path d="M5 18l0 .01" />
              </svg>
              Todos
            </a>
            <a href="{{ url_for('listagem_ofx', tipo_movimentacao='entrada') }}"
              class="btn btn-outline-success">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-trending-up">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M3 17l6 -6l4 4l8 -8" />
                <path d="M14 7l7 0l0 7" />
              </svg>
              Entradas
            </a>
            <a href="{{ url_for('listagem_ofx', tipo_movimentacao='saida') }}"
              class="btn btn-outline-danger">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-trending-down">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M3 7l6 6l4 -4l8 8" />
                <path d="M21 10l0 7l-7 0" />
              </svg>
              Saídas
            </a>
            <button type="button" class="btn" data-bs-toggle="modal"
              data-bs-target="#modalFiltros">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-filter">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
              </svg>
              Filtrar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      <div class="row mb-5">
        <div class="col-12">
          <div class="account-info-card">
            <div class="row align-items-center mb-4">
              <div class="col-auto">
                <div class="account-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" fill="none" stroke-linecap="round"
                    stroke-linejoin="round" aria-hidden="true">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path
                      d="M3 5m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z"></path>
                    <path d="M3 10l18 0"></path>
                    <path d="M7 15l.01 0"></path>
                    <path d="M11 15l2 0"></path>
                  </svg>
                </div>
              </div>
              <div class="col">
                <h3 class="account-title mb-0">Informações da Conta</h3>
              </div>
            </div>

            <div class="row">
              <div class="col-md-3 col-sm-6">
                <div class="detail-item">
                  <div class="detail-label">Banco</div>
                  <div class="detail-value">
                    {% if instituicao_info and instituicao_info.organization %}
                    {{ instituicao_info.organization | truncate(20, true) }}
                    {% elif conta_info and conta_info.bank_id %}
                    {{ conta_info.bank_id }}
                    {% else %}
                    N/A
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="detail-item">
                  <div class="detail-label">Agência</div>
                  <div class="detail-value">
                    {% if conta_info and conta_info.branch_id %}
                    {{ conta_info.branch_id }}
                    {% else %}
                    N/A
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="detail-item">
                  <div class="detail-label">Conta</div>
                  <div class="detail-value">
                    {% if conta_info and conta_info.account_id %}
                    {{ conta_info.account_id }}
                    {% else %}
                    N/A
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="detail-item">
                  <div class="detail-label">Período</div>
                  <div class="detail-value">
                    {% if periodo_info and periodo_info.primeira_transacao and
                    periodo_info.ultima_transacao %}
                    {{ periodo_info.primeira_transacao |
                    converte_data_para_datetime_converte_data_brl }} a {{
                    periodo_info.ultima_transacao |
                    converte_data_para_datetime_converte_data_brl }}
                    {% else %}
                    N/A
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-sm-6 col-lg-3">
          <div class="summary-card success">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag"
                    aria-hidden="true">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                    <path
                      d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" />
                  </svg>
                </div>
              </div>
              <div class="col">
                <div class="summary-content">
                  <div class="summary-label">Total Créditos</div>
                  <div class="summary-value">{{ estatisticas.creditos_formatado
                    if estatisticas else 'R$ 0,00' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-lg-3">
          <div class="summary-card danger">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag"
                    aria-hidden="true">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                    <path
                      d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" />
                  </svg>
                </div>
              </div>
              <div class="col">
                <div class="summary-content">
                  <div class="summary-label">Total Débitos</div>
                  <div class="summary-value">{{ estatisticas.debitos_formatado
                    if estatisticas else 'R$ 0,00' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-lg-3">
          <div class="summary-card primary">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag"
                    aria-hidden="true">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                    <path
                      d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" />
                  </svg>
                </div>
              </div>
              <div class="col">
                <div class="summary-content">
                  <div class="summary-label">Saldo Final</div>
                  <div class="summary-value">{{ estatisticas.saldo_formatado if
                    estatisticas else 'R$ 0,00' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-lg-3">
          <div class="summary-card info">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" fill="none" stroke-linecap="round"
                    stroke-linejoin="round" aria-hidden="true">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path
                      d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2"></path>
                    <path
                      d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z"></path>
                    <path d="M9 12l0 .01"></path>
                    <path d="M13 12l2 0"></path>
                    <path d="M9 16l0 .01"></path>
                    <path d="M13 16l2 0"></path>
                  </svg>
                </div>
              </div>
              <div class="col">
                <div class="summary-content">
                  <div class="summary-label">Transações</div>
                  <div class="summary-value">{{ total_transacoes if
                    total_transacoes else 0 }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card modern-main-card">
            <div class="card-body p-0">
              {% set filtered_transactions = [] %}
              {% for transacao in transacoes %}
              {% if (filtro_conciliado == 'sim' and transacao.conciliado) or
              (filtro_conciliado == 'nao' and not
              transacao.conciliado) %}
              {% set _ = filtered_transactions.append(transacao) %}
              {% endif %}
              {% endfor %}

              {% if filtered_transactions %}
              <div class="accordion accordion-flush" id="transactionsAccordion">
                {% for transacao in filtered_transactions %}
                <div class="accordion-item modern-accordion-item">
                  <h2 class="accordion-header" id="heading{{ transacao.id }}">
                    <button
                      class="accordion-button collapsed modern-accordion-btn"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse{{ transacao.id }}"
                      aria-expanded="false"
                      aria-controls="collapse{{ transacao.id }}"
                      data-transaction-id="{{ transacao.id }}"
                      data-value="{{ transacao.valor_formatado or 'R$ 0,00' }}"
                      data-date="{{ transacao.data_transacao.strftime('%d/%m/%Y') if transacao.data_transacao else 'N/A' }}"
                      data-description="{{ transacao.descricao_limpa or transacao.memo or 'Sem descrição' }}"
                      data-category="{{ transacao.categoria_automatica or '' }}"
                      data-is-credit="{{ 'true' if transacao.valor > 0 else 'false' }}"
                      data-fitid="{{ transacao.fitid or '' }}">

                      <div class="d-flex align-items-center w-100 me-3">
                        <div
                          class="avatar avatar-sm me-3 {{ 'bg-success-lt' if transacao.valor > 0 else 'bg-danger-lt' }}">
                          {% if transacao.valor > 0 %}
                          <svg xmlns="http://www.w3.org/2000/svg" width="16"
                            height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="icon text-success">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M12 5l0 14" />
                            <path d="M18 11l-6 -6" />
                            <path d="M6 11l6 -6" />
                          </svg>
                          {% else %}
                          <svg xmlns="http://www.w3.org/2000/svg" width="16"
                            height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="icon text-danger">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M12 5l0 14" />
                            <path d="M18 13l-6 6" />
                            <path d="M6 13l6 6" />
                          </svg>
                          {% endif %}
                        </div>

                        <div class="flex-fill">
                          <div
                            class="d-flex align-items-center justify-content-between">
                            <div>
                              <div class="mb-1">
                                <strong
                                  class="{{ 'text-success' if transacao.valor > 0 else 'text-danger' }} fs-5">
                                  {{ transacao.valor_formatado or 'R$ 0,00' }}
                                </strong>
                                <small class="text-muted ms-2">
                                  {{
                                  transacao.data_transacao.strftime('%d/%m/%Y')
                                  if transacao.data_transacao else
                                  'N/A' }} • {{
                                  transacao.fitid }}
                                </small>
                              </div>
                              <div class="text-muted small">
                                {{ transacao.descricao_limpa or transacao.memo
                                or 'Sem descrição' | truncate(60) }}
                              </div>
                            </div>

                            <div class="d-flex align-items-center">
                              {% if transacao.conciliado %}
                              <span class="badge bg-green-lt">
                                Conciliado
                              </span>
                              {% else %}
                              <span class="badge bg-yellow-lt">
                                Pendente
                              </span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </button>
                  </h2>

                  <div id="collapse{{ transacao.id }}"
                    class="accordion-collapse collapse"
                    aria-labelledby="heading{{ transacao.id }}"
                    data-bs-parent="#transactionsAccordion">
                    <div class="accordion-body modern-accordion-body">

                      {% if not transacao.conciliado %}
                      <ul class="nav nav-pills nav-fill mb-3 modern-nav-pills"
                        id="conciliationTabs{{ transacao.id }}"
                        role="tablist">
                        <li class="nav-item" role="presentation">
                          <button class="nav-link active"
                            id="suggestion-tab-{{ transacao.id }}"
                            data-bs-toggle="pill"
                            data-bs-target="#suggestion-{{ transacao.id }}"
                            type="button" role="tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16"
                              height="16" viewBox="0 0 24 24"
                              fill="none" stroke="currentColor" stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round" class="icon me-2">
                              <path stroke="none" d="M0 0h24v24H0z"
                                fill="none" />
                              <path
                                d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
                            </svg>
                            Sugestão
                          </button>
                        </li>
                        <li class="nav-item" role="presentation">
                          <button class="nav-link"
                            id="nova-movimentacao-tab-{{ transacao.id }}"
                            data-bs-toggle="modal"
                            data-bs-target="#modalNovaMovimentacao"
                            type="button"
                            onclick="initModalNovaMovimentacao({{ transacao.id }}, {{ (transacao.valor|abs * 100)|int }})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16"
                              height="16" viewBox="0 0 24 24"
                              fill="none" stroke="currentColor" stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round" class="icon me-2">
                              <path stroke="none" d="M0 0h24v24H0z"
                                fill="none" />
                              <path d="M12 5l0 14" />
                              <path d="M5 12l14 0" />
                            </svg>
                            Nova Movimentação
                          </button>
                        </li>
                        <li class="nav-item" role="presentation">
                          <button class="nav-link"
                            id="search-create-tab-{{ transacao.id }}"
                            data-bs-toggle="pill"
                            data-bs-target="#search-create-{{ transacao.id }}"
                            type="button" role="tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16"
                              height="16" viewBox="0 0 24 24"
                              fill="none" stroke="currentColor" stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round" class="icon me-2">
                              <path stroke="none" d="M0 0h24v24H0z"
                                fill="none" />
                              <path
                                d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                              <path d="M21 21l-6 -6" />
                            </svg>
                            Buscar
                          </button>
                        </li>
                      </ul>

                      <div class="tab-content modern-tab-content">
                        
                        <div class="tab-pane fade show active"
                          id="suggestion-{{ transacao.id }}" role="tabpanel">
                          
                          {% set sugestoes_transacao =
                          sugestoes_por_transacao.get(transacao.id, []) %}

                          <div class="suggestion-content-{{ transacao.id }}">
                            {% set sugestoes_transacao =
                            sugestoes_por_transacao.get(transacao.id, []) %}
                            {% if sugestoes_transacao %}
                            <div class="table-responsive">
                              <table class="table table-hover">
                                <thead class="bg-light">
                                  <tr>
                                    <th class="text-center py-3">Origem</th>
                                    <th class="text-center py-3">Valor</th>
                                    <th class="text-center py-3">Vencimento</th>
                                    <th class="text-center py-3">Pessoa
                                      Beneficiário</th>
                                    <th class="text-center py-3">Descrição</th>
                                    <th class="text-center py-3">Categorias</th>
                                    <th class="text-center py-3">Ações</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for sugestao in sugestoes_transacao %}
                                  <tr class="suggestion-row"
                                    data-agendamento-id="{{ sugestao.id }}"
                                    data-valor-centavos="{{ sugestao.valor_centavos }}">
                                    <td class="text-center py-3">
                                      {% if sugestao.origem == 'Faturamento' %}
                                      <span class="badge bg-primary-lt">{{
                                        sugestao.faturamento_codigo or
                                        'Faturamento'
                                        }}</span>
                                      {% else %}
                                      <span
                                        class="badge bg-secondary-lt">Lançamento
                                        Avulso</span>
                                      {% endif %}
                                    </td>
                                    <td class="text-center py-3">
                                      <strong class="fw-medium">{{
                                        sugestao.valor_formatado }}</strong>
                                    </td>
                                    <td class="text-center py-3">
                                      <span class="text-muted">{{
                                        sugestao.data_vencimento }}</span>
                                    </td>
                                    <td class="text-center py-3">
                                      {% set pessoa_truncada =
                                      sugestao.pessoa_nome[:20] + '...' if
                                      sugestao.pessoa_nome|length > 20 else
                                      sugestao.pessoa_nome %}
                                      <div class="fw-medium"
                                        title="{{ sugestao.pessoa_nome }}">{{
                                        pessoa_truncada }}
                                      </div>
                                    </td>
                                    <td class="text-center py-3">
                                      {% set descricao_truncada =
                                      sugestao.descricao[:20] + '...' if
                                      sugestao.descricao|length > 20 else
                                      sugestao.descricao %}
                                      <span title="{{ sugestao.descricao }}">{{
                                        descricao_truncada }}</span>
                                    </td>
                                    <td class="text-center py-3">
                                      <div
                                        class="d-flex flex-column align-items-center">
                                        {% if sugestao.categorias %}
                                        {% for categoria in sugestao.categorias
                                        %}
                                        {% set categoria_truncada =
                                        categoria[:25] + '...' if
                                        categoria|length > 25 else
                                        categoria %}
                                        <div
                                          class="badge bg-dark-lt mb-1 d-block mx-auto"
                                          style="font-size: 0.65rem;"
                                          title="{{ categoria }}">
                                          {{ categoria_truncada }}
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <div
                                          class="badge bg-secondary-lt mx-auto"
                                          style="font-size: 0.65rem;">Sem
                                          categoria</div>
                                        {% endif %}
                                      </div>
                                    </td>
                                    <td class="text-center">
                                      <button
                                        class="btn btn-icon btn-outline-success"
                                        onclick="conciliarAgendamento({{ transacao.id }}, {{ sugestao.id }})"
                                        title="Conciliar este agendamento">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                          width="24" height="24"
                                          viewBox="0 0 24 24" fill="none"
                                          stroke="currentColor" stroke-width="2"
                                          stroke-linecap="round"
                                          stroke-linejoin="round"
                                          class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag">
                                          <path stroke="none" d="M0 0h24v24H0z"
                                            fill="none" />
                                          <path
                                            d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                                          <path
                                            d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" />
                                        </svg>
                                      </button>
                                    </td>
                                  </tr>
                                  {% endfor %}
                                </tbody>
                              </table>
                            </div>
                            <div class="mt-2 text-muted small">
                              <i
                                class="icon icon-tabler icon-tabler-info-circle me-1"></i>{{
                              sugestoes_transacao|length
                              }} sugestão(ões) encontrada(s) com valores
                              próximos
                            </div>
                            {% else %}
                            <div class="text-center py-2 text-muted small">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14"
                                height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="me-1">
                                <path
                                  d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
                              </svg>
                              Nenhuma sugestão automática disponível
                            </div>
                            {% endif %}
                          </div>

                        </div>

                        <div class="tab-pane fade"
                          id="nova-movimentacao-{{ transacao.id }}"
                          role="tabpanel"
                          style="display: none;">
                        </div>

                        <div class="tab-pane"
                          id="search-create-{{ transacao.id }}" role="tabpanel">
                          
                          <div class="row g-2 mb-3">
                            <div class="col-md-2">
                              <label class="form-label small">Valor
                                Mínimo</label>
                              <input type="text"
                                class="form-control campo-moeda-brl"
                                name="valor_min"
                                id="filtro-valor-min-{{ transacao.id }}">
                            </div>
                            <div class="col-md-2">
                              <label class="form-label small">Valor
                                Máximo</label>
                              <input type="text"
                                class="form-control campo-moeda-brl"
                                name="valor_max"
                                id="filtro-valor-max-{{ transacao.id }}">
                            </div>
                            <div class="col-md-2">
                              <label class="form-label small">Data
                                Início</label>
                              <input type="date" class="form-control"
                                name="data_inicio"
                                id="filtro-data-inicio-{{ transacao.id }}">
                            </div>
                            <div class="col-md-2">
                              <label class="form-label small">Data Fim</label>
                              <input type="date" class="form-control"
                                name="data_fim"
                                id="filtro-data-fim-{{ transacao.id }}">
                            </div>
                            <div class="col-md-4">
                              <label class="form-label small">Categoria</label>
                              <select name="categoria_id"
                                class="form-select categoria-select"
                                id="filtro-categoria-{{ transacao.id }}">
                                <option value>Todas as categorias</option>
                                {% for item in estrutura_plano %}
                                {% if item.tem_filhos %}
                                <option value="{{ item.id }}" disabled
                                  style="font-weight: bold; color: #2c3e50; background-color: #f8f9fa; font-style: italic;">
                                  {{ item.indentacao_visual|safe }}{{ item.nome
                                  }}
                                </option>
                                {% else %}
                                <option value="{{ item.id }}"
                                  style="color: #495057;">
                                  {{ item.indentacao_visual|safe }}{{ item.nome
                                  }}
                                </option>
                                {% endif %}
                                {% endfor %}
                              </select>
                            </div>
                            <div class="col-md-4">
                              <label
                                class="form-label small">Beneficiário</label>
                              <select name="beneficiario_id" class="form-select"
                                id="filtro-beneficiario-{{ transacao.id }}">
                                <option value>Todas os beneficiarios</option>
                                {% for pessoa in pessoas_financeiro %}
                                <option value="{{ pessoa.id }}"
                                  style="font-weight: bold; color: #2c3e50; background-color: #f8f9fa; font-style: italic;">
                                  {{ pessoa.identificacao }} ({{
                                  pessoa.documento_formatado }})
                                </option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>

                          <div class="row mb-3">
                            <div class="col-md-12">
                              <button type="button"
                                class="btn btn-sm modern-btn-primary w-100"
                                id="btn-buscar-{{ transacao.id }}"
                                data-transacao-id="{{ transacao.id }}"
                                data-is-credit="{{ 'true' if transacao.valor > 0 else 'false' }}">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                  width="16" height="16" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor"
                                  stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round" class="icon me-1">
                                  <path stroke="none" d="M0 0h24v24H0z"
                                    fill="none" />
                                  <path
                                    d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                                  <path d="M21 21l-6 -6" />
                                </svg>
                                Buscar Agendamentos
                              </button>
                            </div>
                          </div> 
                          <div class="row mb-3"
                            id="info-selecao-busca-{{ transacao.id }}">
                            <div class="col-12">
                              <div
                                class="alert border-0 d-flex justify-content-between align-items-center text-white"
                                style="background: linear-gradient(135deg, #335B45, #4F7F66);">
                                <div>
                                  <strong>Valor da transação:</strong> {{
                                  transacao.valor_formatado }}<br>
                                  <strong>Selecionados:</strong> <span
                                    id="valor-selecionado-busca-{{ transacao.id }}">R$
                                    0,00</span>
                                  (<span
                                    id="qtd-selecionados-busca-{{ transacao.id }}">0</span>
                                  item(s))
                                </div>
                                <div>
                                  <span class="badge bg-light text-dark"
                                    id="badge-status-busca-{{ transacao.id }}">Selecione
                                    os
                                    agendamentos</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="mt-3"
                            id="resultados-busca-{{ transacao.id }}">
                            {% set agendamentos_transacao =
                            agendamentos_por_transacao.get(transacao.id, []) %}
                            {% if agendamentos_transacao %}
                            <div class="table-responsive">
                              <table class="table table-hover">
                                <thead class="bg-light">
                                  <tr>
                                    <th class="text-center py-3">
                                      <input type="checkbox"
                                        class="form-check-input checkbox-busca"
                                        id="selectAllBusca-{{ transacao.id }}"
                                        data-transacao-id="{{ transacao.id }}"
                                        title="Selecionar todos">
                                    </th>
                                    <th class="text-center py-3">Origem</th>
                                    <th class="text-center py-3">Valor</th>
                                    <th class="text-center py-3">Vencimento</th>
                                    <th class="text-center py-3">Pessoa
                                      Beneficiário</th>
                                    <th class="text-center py-3">Descrição</th>
                                    <th class="text-center py-3">Categorias</th>
                                    <th class="text-center py-3">Ações</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for agendamento in agendamentos_transacao
                                  %}
                                  <tr class="busca-row"
                                    data-agendamento-id="{{ agendamento.id }}"
                                    data-valor-centavos="{{ agendamento.valor_centavos }}">
                                    <td class="text-center py-3">
                                      <input type="checkbox"
                                        class="form-check-input checkbox-busca"
                                        id="busca-{{ transacao.id }}-{{ agendamento.id }}"
                                        data-transacao-id="{{ transacao.id }}"
                                        data-agendamento-id="{{ agendamento.id }}"
                                        data-valor-centavos="{{ agendamento.valor_centavos }}">
                                    </td>
                                    <td class="text-center py-3">
                                      {% if agendamento.origem == 'Faturamento'
                                      %}
                                      <span class="badge bg-primary-lt">{{
                                        agendamento.faturamento_codigo or
                                        'Faturamento' }}</span>
                                      {% else %}
                                      <span
                                        class="badge bg-success-lt">Lançamento
                                        Avulso</span>
                                      {% endif %}
                                    </td>
                                    <td class="text-center py-3">
                                      <strong class="fw-medium">{{
                                        agendamento.valor_formatado }}</strong>
                                    </td>
                                    <td class="text-center py-3">
                                      <span class="text-muted">{{
                                        agendamento.data_vencimento }}</span>
                                    </td>
                                    <td class="text-center py-3">
                                      {% set pessoa_truncada =
                                      agendamento.pessoa_nome[:20] + '...' if
                                      agendamento.pessoa_nome|length > 20 else
                                      agendamento.pessoa_nome %}
                                      <div class="fw-medium"
                                        title="{{ agendamento.pessoa_nome }}">{{
                                        pessoa_truncada }}
                                      </div>
                                    </td>
                                    <td class="text-center py-3">
                                      {% set descricao_truncada =
                                      agendamento.descricao[:20] + '...' if
                                      agendamento.descricao|length > 20 else
                                      agendamento.descricao %}
                                      <span
                                        title="{{ agendamento.descricao }}">{{
                                        descricao_truncada }}</span>
                                    </td>
                                    <td class="text-center py-3">
                                      <div
                                        class="d-flex flex-column align-items-center">
                                        {% if agendamento.categorias %}
                                        {% for categoria in
                                        agendamento.categorias %}
                                        {% set categoria_truncada =
                                        categoria[:25] + '...' if
                                        categoria|length > 25 else
                                        categoria %}
                                        <div
                                          class="badge bg-dark-lt mb-1 d-block mx-auto"
                                          style="font-size: 0.65rem;"
                                          title="{{ categoria }}">
                                          {{ categoria_truncada }}
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <div
                                          class="badge bg-secondary-lt mx-auto"
                                          style="font-size: 0.65rem;">Sem
                                          categoria</div>
                                        {% endif %}
                                      </div>
                                    </td>
                                    <td class="text-center">
                                      <button
                                        class="btn btn-icon btn-outline-success"
                                        onclick="conciliarAgendamento({{ transacao.id }}, {{ agendamento.id }})"
                                        title="Conciliar este agendamento">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                          width="24" height="24"
                                          viewBox="0 0 24 24" fill="none"
                                          stroke="currentColor" stroke-width="2"
                                          stroke-linecap="round"
                                          stroke-linejoin="round"
                                          class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag">
                                          <path stroke="none" d="M0 0h24v24H0z"
                                            fill="none" />
                                          <path
                                            d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                                          <path
                                            d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" />
                                        </svg>
                                      </button>
                                    </td>
                                  </tr>
                                  {% endfor %}
                                </tbody>
                              </table>
                            </div>
                            <div class="mt-2 text-muted small">
                              <i
                                class="icon icon-tabler icon-tabler-info-circle me-1"></i>Mais
                              de {{
                              agendamentos_transacao|length }} agendamento(s)
                              disponível(eis)
                            </div>
                            {% else %}
                            <div class="text-center py-4 text-muted">
                              <svg xmlns="http://www.w3.org/2000/svg" width="48"
                                height="48" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor"
                                stroke-width="1" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="icon mb-3 text-muted">
                                <path stroke="none" d="M0 0h24v24H0z"
                                  fill="none" />
                                <path
                                  d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                                <path d="M21 21l-6 -6" />
                              </svg>
                              <p class="mb-0">Nenhum agendamento encontrado para
                                este tipo de transação</p>
                            </div>
                            {% endif %}
                          </div>

                          <div class="row mt-3"
                            id="acao-conciliar-busca-{{ transacao.id }}"
                            style="display: none;">
                            <div class="col-12">
                              <button type="button"
                                class="btn btn-success btn-conciliar-selecionados w-100"
                                id="btn-conciliar-multiplos-busca-{{ transacao.id }}"
                                disabled>
                                <svg xmlns="http://www.w3.org/2000/svg"
                                  width="16" height="16" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor"
                                  stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round" class="icon me-1">
                                  <path stroke="none" d="M0 0h24v24H0z"
                                    fill="none" />
                                  <path d="M5 12l5 5l10 -10" />
                                </svg>
                                Conciliar Agendamentos Selecionados
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% else %}
                      
                      <div class="text-center py-4">
                        
                        <div
                          class="d-flex flex-wrap justify-content-center gap-2">
                          {% if transacao.data_conciliacao %}
                          <span class="badge bg-blue-lt">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14"
                              height="14" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round"
                              class="icon me-1">
                              <path stroke="none" d="M0 0h24v24H0z"
                                fill="none" />
                              <path
                                d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" />
                              <path d="M16 3v4" />
                              <path d="M8 3v4" />
                              <path d="M4 11h16" />
                            </svg>
                            {{ transacao.data_conciliacao.strftime('%d/%m/%Y')
                            }}
                          </span>
                          {% endif %}

                          {% if transacao.tipo_conciliacao %}
                          {% set tipo_texto = {
                          'AGENDAMENTO': 'Agendamento',
                          'AGENDAMENTO_MASSA': 'Múltiplos Agendamentos',
                          'NOVA_MOVIMENTACAO': 'Nova Movimentação',
                          'nova_movimentacao': 'Nova Movimentação'
                          } %}
                          <span class="badge bg-purple-lt">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14"
                              height="14" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round"
                              class="icon me-1">
                              <path stroke="none" d="M0 0h24v24H0z"
                                fill="none" />
                              <path d="M9 11l3 3l8 -8" />
                              <path
                                d="M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9" />
                            </svg>
                            {{ tipo_texto.get(transacao.tipo_conciliacao,
                            transacao.tipo_conciliacao) }}
                          </span>
                          {% endif %}

                          {% if transacao.dados_conciliacao_json and
                          transacao.dados_conciliacao_json.get('agendamentos_ids')
                          %}
                          {% set qtd_agendamentos =
                          transacao.dados_conciliacao_json.get('agendamentos_ids')|length
                          %}
                          {% if qtd_agendamentos > 0 %}
                          <span class="badge bg-cyan-lt">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14"
                              height="14" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round"
                              class="icon me-1">
                              <path stroke="none" d="M0 0h24v24H0z"
                                fill="none" />
                              <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
                              <path d="M12 7v5l3 3" />
                            </svg>
                            {{ qtd_agendamentos }} {% if qtd_agendamentos == 1
                            %}item{% else %}itens{% endif %}
                          </span>
                          {% endif %}
                          {% endif %}
                        </div>

                        {% if transacao.observacoes_conciliacao %}
                        <div class="card border-0 bg-light">
                          <div class="card-body">
                            <div class="text-start small">
                              {% set obs = transacao.observacoes_conciliacao %}
                              {{ obs }}
                            </div>
                          </div>
                        </div>
                        {% endif %}

                        {% if transacao.dados_conciliacao_json %}
                        <div class="mt-4 pt-3 border-top">

                          <button type="button"
                            class="btn btn-outline-warning"
                            onclick="abrirModalReversao({{ transacao.id }}, '{{ transacao.fitid }}', '{{ transacao.valor_formatado }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                              height="24" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round"
                              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-back-up"><path
                                stroke="none" d="M0 0h24v24H0z"
                                fill="none" /><path d="M9 14l-4 -4l4 -4" /><path
                                d="M5 10h11a4 4 0 1 1 0 8h-1" /></svg>
                            Reverter Conciliação
                          </button>
                        </div>
                        {% endif %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-center text-muted py-5">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                  viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="1.5"
                  stroke-linecap="round" stroke-linejoin="round"
                  class="icon mb-3 text-muted">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                  <path
                    d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                  <path d="M9 9l1 0" />
                  <path d="M9 13l6 0" />
                  <path d="M9 17l6 0" />
                </svg>
                <h6>Nenhuma transação encontrada</h6>
                <p class="text-muted mb-0">
                  {% if filtro_conciliado == 'nao' %}
                  Todas as transações já foram conciliadas.
                  {% else %}
                  Não há transações para o filtro selecionado.
                  {% endif %}
                </p>
              </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card-footer px-2 pb-0 pt-3 bg-transparent border-0">
            <div class="row">
              <div
                class="col-sm-6 col-md-6 d-flex justify-content-center justify-content-md-start">
                <div class="mb-3">
                  <p class="m-0 text-secondary">
                    Página
                    <span>{{ pagina }}</span>
                    de
                    <span>{{ total_paginas }}</span>
                    (total de
                    <span>{{ total_transacoes }}</span>
                    transações)
                  </p>
                </div>
              </div>
              <div
                class="col-sm-6 col-md-6 d-flex justify-content-center justify-content-md-end">
                <div class="mb-3">
                  <ul class="pagination m-0 ms-auto">
                    
                    {% if pagina > 1 %}
                    <li class="page-item">
                      <a class="page-link"
                        href="?pagina={{ pagina - 1 }}{% if filtro_conciliado %}&conciliado={{ filtro_conciliado }}{% endif %}{% if filtro_fitid %}&fitid={{ filtro_fitid }}{% endif %}">Anterior</a>
                    </li>
                    {% endif %}

                    {% set range_start = pagina - 2 if pagina - 2 > 0 else 1 %}
                    {% set range_end = pagina + 2 if pagina + 2 <= total_paginas
                    else total_paginas %} {% for p in
                    range(range_start, range_end + 1) %} {% if p==pagina %} <li
                      class="page-item active"><span
                        class="page-link">{{ p }}</span></li>
                    {% else %}
                    <li class="page-item"><a class="page-link"
                        href="?pagina={{ p }}{% if filtro_conciliado %}&conciliado={{ filtro_conciliado }}{% endif %}{% if filtro_fitid %}&fitid={{ filtro_fitid }}{% endif %}">{{
                        p }}</a></li>
                    {% endif %}
                    {% endfor %}

                    {% if pagina < total_paginas %} <li class="page-item">
                      <a class="page-link"
                        href="?pagina={{ pagina + 1 }}{% if filtro_conciliado %}&conciliado={{ filtro_conciliado }}{% endif %}{% if filtro_fitid %}&fitid={{ filtro_fitid }}{% endif %}">Próxima</a>
                    </li>
                    {% endif %}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

{% include 'estrutura/footer.html' %}

<div class="modal modal-blur fade" id="modalFiltros" tabindex="-1" role="dialog"
  aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
            viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-filter me-2">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
          </svg>
          Filtrar Transações
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="Close"></button>
      </div>

      <form method="get" id="filtroForm">
        <div class="modal-body">
          <div class="row">
             <div class="col-md-6 mb-3">
                <label class="form-label">Data Início</label>
                <input type="date" name="dataInicio" class="form-control"
                  value="{{ filtro_data_inicio }}">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Data Fim</label>
                <input type="date" name="dataFim" class="form-control" value="{{ filtro_data_fim }}">
              </div>
            <div class="col-12 col-md-6 mb-3">
              <label class="form-label" for="selectConciliado"><strong>Status de
                  Conciliação:</strong></label>
              <select id="selectConciliado" name="conciliado"
                class="form-select">
                <option value="nao" {% if filtro_conciliado=='nao' or not
                  filtro_conciliado %}selected{% endif %}>
                  Não conciliados
                </option>
                <option value="sim" {% if filtro_conciliado=='sim' %}selected{%
                  endif %}>Conciliados</option>
              </select>
            </div>

            <div class="col-12 col-md-6 mb-3">
              <label class="form-label"
                for="inputFitid"><strong>FITID:</strong></label>
              <input type="text" id="inputFitid" name="fitid"
                class="form-control"
                placeholder="Digite o FITID para buscar..."
                value="{{ filtro_fitid or '' }}">
            </div>
            <div class="col-12 col-md-3 mb-3">
              <label class="form-label"
                for="inputValor"><strong>Valor</strong></label>
              <input type="text" id="inputValor" name="valor"
                class="form-control campo-moeda-brl"
                placeholder="Digite o valor para buscar..."
                value="{{ filtro_valor or '' }}">
            </div>
            <div class="col-12 col-md-9 mb-3">
              <label class="form-label"
                for="inputDescricao"><strong>Descrição:</strong></label>
              <input type="text" id="inputDescricao" name="descricao"
                class="form-control"
                placeholder="Digite a descrição para buscar..."
                value="{{ filtro_descricao or '' }}">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <a href="{{ url_for('listagem_ofx') }}"
            class="btn btn-outline-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
              viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Limpar Filtros
          </a>
          <button type="submit" class="btn modern-btn-primary"
            data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
              viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
              <path d="M21 21l-6 -6" />
            </svg>
            Filtrar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% for transacao in transacoes %}
<div class="modal modal-blur fade" id="modalConciliacao{{ transacao.id }}"
  tabindex="-1" role="dialog"
  aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title d-flex align-items-center">
          Conciliar Transação
        </h5>
        <button type="button" class="btn-close"
          data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body pt-2">
        <div class="alert alert-info border-0 mb-4"
          style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
          <div class="d-flex align-items-center">
            <div class="avatar avatar-sm bg-info-lt me-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="icon">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4" />
                <path d="M12 8h.01" />
              </svg>
            </div>
            <div class="flex-fill">
              <div class="fw-medium text-dark">
                {% if transacao.valor < 0 %} Selecione o tipo de pagamento para
                conciliar esta saída {% else %} Confirme
                o recebimento para conciliar esta entrada {% endif %} </div>
            </div>
          </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-auto">
                <div
                  class="avatar avatar-lg {{ 'bg-light-lt' if transacao.valor > 0 else 'bg-danger-lt' }}">
                  {% if transacao.valor > 0 %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="icon text-success icon-tabler icons-tabler-outline icon-tabler-currency-dollar">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path
                      d="M16.7 8a3 3 0 0 0 -2.7 -2h-4a3 3 0 0 0 0 6h4a3 3 0 0 1 0 6h-4a3 3 0 0 1 -2.7 -2" />
                    <path d="M12 3v3m0 12v3" />
                  </svg>
                  {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="icon text-danger">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M7 17h10v-10l-5 5l-5 -5z" />
                  </svg>
                  {% endif %}
                </div>
              </div>
              <div class="col">
                <div class="row">
                  <div class="col-md-8">
                    <div class="mb-2">
                      <span class="badge bg-primary-lt me-2">{{ transacao.fitid
                        or 'N/A' }}</span>
                      <small class="text-muted">{{
                        transacao.data_transacao.strftime('%d/%m/%Y') if
                        transacao.data_transacao else 'Data N/A' }}</small>
                    </div>
                    <h4
                      class="mb-1 {{ 'text-success' if transacao.valor > 0 else 'text-danger' }}">
                      {{ transacao.valor_formatado or 'R$ 0,00' }}
                    </h4>
                    <div class="text-muted small">{{ transacao.tipo_movimento or
                      'Tipo N/A' }}</div>
                  </div>
                  <div class="col-md-4 text-md-end">
                    <div
                      class="badge bg-{{ 'success' if transacao.valor > 0 else 'danger' }}-lt fs-6 px-3 py-2">
                      {{ 'ENTRADA' if transacao.valor > 0 else 'SAÍDA' }}
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="text-muted small mb-1">Descrição:</div>
                  <div class="fw-medium">{{ transacao.descricao_limpa or
                    transacao.memo or 'Sem descrição disponível'
                    }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% if transacao.valor < 0 %} <div class="mb-3">
          <h6 class="text-muted mb-3">Escolha o tipo de pagamento:</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <a
                href="{{ url_for('conciliar_transacao', transacao_id=transacao.id, tipo='pagamento_fornecedor') }}"
                class="card card-link border-0 shadow-sm h-100 text-decoration-none">
                <div class="card-body d-flex align-items-center p-4">
                  <div class="avatar avatar-md bg-blue-lt me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20"
                      height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon text-blue">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                      <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                    </svg>
                  </div>
                  <div class="flex-fill">
                    <div class="fw-semibold text-dark">Fornecedor</div>
                    <div class="text-muted small">Pagamentos a
                      fornecedores</div>
                  </div>
                  <div class="text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 6l6 6l-6 6" />
                    </svg>
                  </div>
                </div>
              </a>
            </div>

            <div class="col-md-6">
              <a
                href="{{ url_for('conciliar_transacao', transacao_id=transacao.id, tipo='pagamento_frete') }}"
                class="card card-link border-0 shadow-sm h-100 text-decoration-none">
                <div class="card-body d-flex align-items-center p-4">
                  <div class="avatar avatar-md bg-green-lt me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20"
                      height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon text-green">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path
                        d="M5 17h-2v-11a1 1 0 0 1 1 -1h9v12m-4 0h6m4 0h2v-6h-8m0 -5h5l3 5" />
                    </svg>
                  </div>
                  <div class="flex-fill">
                    <div class="fw-semibold text-dark">Transportadora</div>
                    <div class="text-muted small">Pagamentos de fretes</div>
                  </div>
                  <div class="text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 6l6 6l-6 6" />
                    </svg>
                  </div>
                </div>
              </a>
            </div>

            <div class="col-md-6">
              <a
                href="{{ url_for('conciliar_transacao', transacao_id=transacao.id, tipo='pagamento_extrator') }}"
                class="card card-link border-0 shadow-sm h-100 text-decoration-none">
                <div class="card-body d-flex align-items-center p-4">
                  <div class="avatar avatar-md bg-orange-lt me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20"
                      height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon text-orange">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path
                        d="M12 5.5m-6 0a6 2.5 0 1 0 12 0a6 2.5 0 1 0 -12 0" />
                      <path
                        d="M18 5.5v4.626a1.415 1.415 0 0 1 1.683 2.18l-.097 .108l-1.586 1.586v4c0 1.61 -2.54 2.925 -5.725 3l-.275 0c-3.314 0 -6 -1.343 -6 -3v-2l-1.586 -1.586a1.414 1.414 0 0 1 1.586 -2.287v-6.627" />
                      <path d="M10 12.5v1.5" />
                      <path d="M14 16v1" />
                    </svg>
                  </div>
                  <div class="flex-fill">
                    <div class="fw-semibold text-dark">Extrator</div>
                    <div class="text-muted small">Pagamentos de extração</div>
                  </div>
                  <div class="text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 6l6 6l-6 6" />
                    </svg>
                  </div>
                </div>
              </a>
            </div>

            <div class="col-md-6">
              <a
                href="{{ url_for('conciliar_transacao', transacao_id=transacao.id, tipo='outros_pagamentos') }}"
                class="card card-link border-0 shadow-sm h-100 text-decoration-none">
                <div class="card-body d-flex align-items-center p-4">
                  <div class="avatar avatar-md bg-purple-lt me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20"
                      height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon text-purple">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0" />
                      <path d="M4 6v6a8 3 0 0 0 16 0v-6" />
                      <path d="M4 12v6a8 3 0 0 0 16 0v-6" />
                    </svg>
                  </div>
                  <div class="flex-fill">
                    <div class="fw-semibold text-dark">Outros</div>
                    <div class="text-muted small">Outras categorias</div>
                  </div>
                  <div class="text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 6l6 6l-6 6" />
                    </svg>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        {% else %}
        <div class="mb-3">
          <h6 class="text-muted mb-3">Confirmar recebimento:</h6>
          <div class="row justify-content-center">
            <div class="col-md-6">
              <a
                href="{{ url_for('conciliar_transacao', transacao_id=transacao.id, tipo='a_receber') }}"
                class="card card-link border-0 shadow-sm h-100 text-decoration-none">
                <div class="card-body d-flex align-items-center p-4">
                  <div class="avatar avatar-md bg-blue-lt me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20"
                      height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon text-blue">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                      <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                    </svg>
                  </div>
                  <div class="flex-fill">
                    <div class="fw-semibold text-dark">Valores a receber</div>
                    <div class="text-muted small">Confirmar e conciliar este
                      recebimento.</div>
                  </div>
                  <div class="text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 6l6 6l-6 6" />
                    </svg>
                  </div>
                </div>
              </a>
            </div>

            <div class="col-md-6">
              <a
                href="{{ url_for('conciliar_transacao', transacao_id=transacao.id, tipo='outros_recebimentos') }}"
                class="card card-link border-0 shadow-sm h-100 text-decoration-none">
                <div class="card-body d-flex align-items-center p-4">
                  <div class="avatar avatar-md bg-purple-lt me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20"
                      height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon text-purple">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0" />
                      <path d="M4 6v6a8 3 0 0 0 16 0v-6" />
                      <path d="M4 12v6a8 3 0 0 0 16 0v-6" />
                    </svg>
                  </div>
                  <div class="flex-fill">
                    <div class="fw-semibold text-dark">Outros Recebimentos</div>
                    <div class="text-muted small">Outros tipos de entrada</div>
                  </div>
                  <div class="text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 6l6 6l-6 6" />
                    </svg>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary"
          data-bs-dismiss="modal">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
            viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" class="icon me-1">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M18 6l-12 12" />
            <path d="M6 6l12 12" />
          </svg>
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<div class="modal modal-blur fade" id="modalReversaoConciliacao" tabindex="-1"
  role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title d-flex align-items-center">
          Reverter Conciliação
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-primary">
          <div class="d-flex">
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon"
                width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M12 9v2m0 4v.01" />
                <path
                  d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75" />
              </svg>
            </div>
            <div>
              <strong>Atenção!</strong> Esta ação irá:
              <ul class="mb-0 mt-2">
                <li>Marcar a transação OFX como não conciliada</li>
                <li>Restaurar os agendamentos para status "Pendente"</li>
                <li>Restaurar os faturamentos para status "Pendente"</li>
                <li>Remover as movimentações financeiras criadas na
                  conciliação</li>
                <li>Atualização de saldo</li>
              </ul>
            </div>
          </div>
        </div>

        <div id="detalhes-reversao-modal" class="mb-3">
          
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary"
          data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="btn-confirmar-reversao-modal"
          class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
            viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" class="icon me-1">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M9 14l-4 -4l4 -4" />
            <path d="M5 10h11a4 4 0 1 1 0 8h-1" />
          </svg>
          Confirmar Reversão
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-confirmacao-conciliacao"
  tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal"
        aria-label="Close"></button>
      <div class="modal-status bg-warning"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round"
          class="icon mb-2 text-warning icon-lg">
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M12 8v4" />
          <path d="M12 16h.01" />
        </svg>
        <h3>Confirmar Conciliação</h3>
        <div class="text-secondary" id="texto-confirmacao-conciliacao">
          Deseja realmente conciliar esta transação com o agendamento
          selecionado?
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <button type="button" class="btn w-100" data-bs-dismiss="modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                  viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon me-1">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M18 6l-12 12" />
                  <path d="M6 6l12 12" />
                </svg>
                Cancelar
              </button>
            </div>
            <div class="col">
              <button type="button" class="btn btn-warning w-100"
                id="btn-confirmar-conciliacao">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                  viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon me-1">
                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                  <path d="M9 12l2 2l4 -4" />
                </svg>
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-sucesso-conciliacao" tabindex="-1"
  role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal"
        aria-label="Close"></button>
      <div class="modal-status bg-success"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round"
          class="icon mb-2 text-success icon-lg">
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M9 12l2 2l4 -4" />
        </svg>
        <h3>Conciliação Realizada!</h3>
        <div class="text-secondary" id="texto-sucesso-conciliacao">
          A conciliação foi processada com sucesso.
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <button type="button" class="btn w-100" data-bs-dismiss="modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-reload">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747" />
                  <path d="M20 4v5h-5" />
                </svg>
                Atualizar Lista
              </button>
            </div>
            <div class="col">
              <button type="button" class="btn btn-success w-100"
                data-bs-dismiss="modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-checks">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M7 12l5 5l10 -10" />
                  <path d="M2 12l5 5m5 -5l5 -5" />
                </svg>
                Continuar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-valor-incompativel" tabindex="-1"
  role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal"
        aria-label="Close"></button>
      <div class="modal-status bg-warning"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round"
          class="icon mb-2 text-warning icon-lg">
          <path d="M12 9v4" />
          <path
            d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
          <path d="M12 16h.01" />
        </svg>
        <h3>Valor Incompatível</h3>
        <div class="text-secondary" id="texto-valor-incompativel">
          O valor do agendamento é superior ao valor da transação.
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <button type="button" class="btn btn-warning w-100"
            data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
              viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Entendido
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-erro-conciliacao" tabindex="-1"
  role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal"
        aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round"
          class="icon mb-2 text-danger icon-lg">
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M12 8v4" />
          <path d="M12 16h.01" />
        </svg>
        <h3>Erro na Conciliação</h3>
        <div class="text-secondary" id="texto-erro-conciliacao">
          Ocorreu um erro ao processar a conciliação.
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <button type="button" class="btn btn-danger w-100"
            data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
              viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalNovaMovimentacao" tabindex="-1"
  aria-labelledby="modalNovaMovimentacaoLabel"
  aria-hidden="true">
  <div
    class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalNovaMovimentacaoLabel">
          Nova Movimentação
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div x-data="modalNovaMovimentacaoData()" x-init="init()"
          id="formNovaMovimentacao">
          <form @submit.prevent="prepararEnvio()">
            
            <div class="row mb-4">
              <div class="col-md-4">
                <label class="form-label required">Descrição da
                  Movimentação</label>
                <input type="text" x-model="formulario.descricao"
                  class="form-control"
                  :class="{'is-invalid': erros.descricao}"
                  @input="limparErro('descricao')"
                  placeholder="Ex.: Pagamento fornecedor, Taxa bancária..."
                  required>
                <div class="invalid-feedback" x-show="erros.descricao"
                  x-text="erros.descricao"></div>
              </div>
              <div class="col-md-3">
                <label class="form-label required">Valor</label>
                <input type="text" class="form-control text-end campo-moeda-brl"
                  :class="{'is-invalid': erros.valor}"
                  x-bind:value="formatarParaExibicao(formulario.valor)"
                  @input="aplicarMascaraValor($event); limparErro('valor')"
                  placeholder="R$ 0,00" required>
                <div class="invalid-feedback" x-show="erros.valor"
                  x-text="erros.valor"></div>
                <small class="text-muted"
                  x-show="formulario.valor > 0 && !erros.valor">
                  Valor da transação: <span
                    x-text="formatarMoeda(formulario.valor)"></span>
                </small>
              </div>
              <div class="col-md-3">
                <label class="form-label required">Data Vencimento</label>
                <input type="date" x-model="formulario.data_vencimento"
                  class="form-control"
                  :class="{'is-invalid': erros.data_vencimento}"
                  @change="limparErro('data_vencimento')" required>
                <div class="invalid-feedback" x-show="erros.data_vencimento"
                  x-text="erros.data_vencimento"></div>
              </div>
              <div class="col-md-2">
                <div class="text-end">
                  <label class="form-label text-muted small">Valor da
                    Transação</label>
                  <h3 class="fw-bold mb-0 text-success"
                    x-text="formatarMoeda(totalPagar)"></h3>
                  <small class="text-muted">Total a liquidar</small>
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-4">
                <label class="form-label required">Beneficiário</label>
                <select x-model="formulario.pessoa_financeiro_id"
                  class="form-select"
                  :class="{'is-invalid': erros.pessoa_financeiro_id}"
                  @change="limparErro('pessoa_financeiro_id')"
                  required>
                  <option value>Selecione o beneficiário...</option>
                  {% if pessoas_financeiro %}
                  {% for pessoa in pessoas_financeiro %}
                  <option value="{{ pessoa.id }}">
                    {{ pessoa.identificacao }} ({{ pessoa.documento_formatado
                    }})
                  </option>
                  {% endfor %}
                  {% else %}
                  {% endif %}
                </select>
                <div class="invalid-feedback"
                  x-show="erros.pessoa_financeiro_id"
                  x-text="erros.pessoa_financeiro_id">
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Data Competência</label>
                <input type="text" x-model="formulario.data_competencia"
                  class="form-control mesAno"
                  :class="{'is-invalid': erros.data_competencia}"
                  @input="limparErro('data_competencia')" placeholder="MM/YYYY">
                <div class="invalid-feedback" x-show="erros.data_competencia"
                  x-text="erros.data_competencia"></div>
              </div>
              <div class="col-md-4">
                <label class="form-label required">Conta Bancária</label>
                <select x-model="formulario.conta_bancaria_id"
                  class="form-select"
                  :class="{'is-invalid': erros.conta_bancaria_id}"
                  @change="limparErro('conta_bancaria_id')" required>
                  <option value>Selecione a conta bancária...</option>
                  {% if contas_bancarias %}
                  {% for conta in contas_bancarias %}
                  <option value="{{ conta.id }}">
                    {{ conta.identificacao }}
                  </option>
                  {% endfor %}
                  {% else %}
                  {% endif %}
                </select>
                <div class="invalid-feedback" x-show="erros.conta_bancaria_id"
                  x-text="erros.conta_bancaria_id"></div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label mb-3 required">Categoria</label>

              <div class="border rounded p-3"
                :class="{'border-danger': erros.categorias_json}">
                
                <template x-for="(categoria, index) in lista" :key="index">
                  <div class="row mb-3 align-items-center">
                    <div class="col-lg-4 col-md-4 col-sm-6 col-12">
                      <select class="form-select categoria-select"
                        x-model="categoria.nome"
                        @change="validarTotalCompleto(); limparErro('categorias_json')">
                        <option value>Selecione uma categoria...</option>
                        {% if estrutura_plano %}
                        {% for item in estrutura_plano %}
                        {% if item.tem_filhos %}
                        <option value="{{ item.codigo }}" disabled
                          style="font-weight: bold; color: #2c3e50; background-color: #f8f9fa; font-style: italic;">
                          {{ item.indentacao_visual|safe }}{{ item.nome }}
                        </option>
                        {% else %}
                        <option value="{{ item.codigo }}"
                          style="color: #495057;">
                          {{ item.indentacao_visual|safe }}{{ item.nome }}
                        </option>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                      </select>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-6 col-12">
                      <input type="text" class="form-control"
                        x-model="categoria.detalhamento"
                        placeholder="Detalhamento (opcional)">
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-10 col-9">
                      <input type="text"
                        class="form-control text-end campo-moeda-brl"
                        x-bind:value="formatarParaExibicao(categoria.valor)"
                        @input="aplicarMascara($event, index)"
                        placeholder="R$ 0,00">
                    </div>
                    <div class="col-lg-1 col-md-1 col-sm-2 col-3 text-center">
                      <button type="button" class="btn btn-link text-danger p-1"
                        @click="removerCategoria(index)"
                        x-show="lista.length > 1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20"
                          height="20" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-trash">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 7l16 0" />
                          <path d="M10 11l0 6" />
                          <path d="M14 11l0 6" />
                          <path
                            d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </template>

                <div class="mt-3">
                  <button type="button"
                    class="btn btn-link text-primary p-0 d-flex align-items-center"
                    @click="adicionarCategoria()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18"
                      height="18" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-tabler icons-tabler-outline icon-tabler-plus me-1">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M12 5l0 14" />
                      <path d="M5 12l14 0" />
                    </svg>
                    Adicionar categoria
                  </button>
                </div>
              </div>
              <div class="invalid-feedback d-block"
                x-show="erros.categorias_json"
                x-text="erros.categorias_json"></div>
            </div>

            <div class="row mb-4">
              <div class="col-12">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox"
                    id="valoresDetalhadosModal"
                    x-model="mostrarValoresDetalhados"
                    @change="validarTotalCompleto()">
                  <label class="form-check-label text-muted"
                    for="valoresDetalhadosModal">
                    Valores detalhados
                  </label>
                </div>

                <div x-show="mostrarValoresDetalhados" x-transition
                  class="card mb-3"
                  style="display: none; background-color: #F6F8FB !important;"
                  :class="{'border-danger': erros.centros_custo_json}">
                  <div class="card-body">
                    
                    <ul class="nav nav-tabs" role="tablist"
                      style="border: unset !important;">
                      <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="tab-centro-custo-modal"
                          style="background-color: white !important; border: unset;"
                          data-bs-toggle="tab"
                          href="#centro-custo-modal" role="tab">Centro de
                          custo</a>
                      </li>
                    </ul>

                    <div class="tab-content"
                      style="background-color: white !important; padding: 30px;">
                      <div class="tab-pane fade show active"
                        id="centro-custo-modal" role="tabpanel">
                        <div class="mb-3">
                          <div class="row align-items-center mb-2">
                            <div class="col-12 mb-3">
                              <strong>Tipo de distribuição:</strong>
                            </div>
                            <div class="col-4">
                              <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio"
                                  name="tipoDistribuicaoModal"
                                  id="percentualModal" value="percentual"
                                  x-model="tipoDistribuicao"
                                  @change="validarTotalCompleto()">
                                <label class="form-check-label"
                                  for="percentualModal">Percentual</label>
                              </div>
                              <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio"
                                  name="tipoDistribuicaoModal"
                                  id="valorModal" value="valor"
                                  x-model="tipoDistribuicao"
                                  @change="validarTotalCompleto()">
                                <label class="form-check-label"
                                  for="valorModal">Valor</label>
                              </div>
                            </div>
                          </div>
                        </div>

                        <template x-for="(centro, index) in centrosCusto"
                          :key="index">
                          <div class="row mb-3 align-items-center">
                            <div class="col-md-6">
                              <select class="form-select"
                                x-model="centro.centro"
                                @change="limparErro('centros_custo_json')">
                                <option value>Selecione um centro de
                                  custo...</option>
                                {% if centros_custo %}
                                {% for centro in centros_custo %}
                                <option value="{{ centro.id }}">{{ centro.nome
                                  }}</option>
                                {% endfor %}
                                {% endif %}
                              </select>
                            </div>
                            <div class="col-md-2">
                              <input type="text"
                                class="form-control text-center campo-float"
                                x-model="centro.percentual"
                                @input="validarTotalCompleto(); limparErro('centros_custo_json')"
                                placeholder="0,00"
                                :disabled="tipoDistribuicao === 'valor'">
                            </div>
                            <div class="col-md-3">
                              <input type="text"
                                class="form-control text-end campo-moeda-brl"
                                x-bind:value="formatarParaExibicao(centro.valor)"
                                @input="aplicarMascaraCentroCusto($event, index); limparErro('centros_custo_json')"
                                placeholder="R$ 0,00"
                                :disabled="tipoDistribuicao === 'percentual'">
                            </div>
                            <div class="col-md-1 text-center">
                              <button type="button"
                                class="btn btn-link text-danger p-1"
                                @click="removerCentroCusto(index); limparErro('centros_custo_json')"
                                x-show="centrosCusto.length > 1">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                  width="16" height="16" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor"
                                  stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round">
                                  <path stroke="none" d="M0 0h24v24H0z"
                                    fill="none" />
                                  <path d="M4 7l16 0" />
                                  <path d="M10 11l0 6" />
                                  <path d="M14 11l0 6" />
                                  <path
                                    d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                                  <path
                                    d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        </template>

                        <div class="mt-3">
                          <button type="button"
                            class="btn btn-link text-primary p-0 d-flex align-items-center"
                            @click="adicionarCentroCusto(); limparErro('centros_custo_json')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16"
                              height="16" viewBox="0 0 24 24"
                              fill="none" stroke="currentColor" stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round" class="me-1">
                              <path stroke="none" d="M0 0h24v24H0z"
                                fill="none" />
                              <path d="M12 5l0 14" />
                              <path d="M5 12l14 0" />
                            </svg>
                            Adicionar centro de custo
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox"
                    id="parcelamentoModal" x-model="mostrarParcelamento"
                    @change="initParcelamento()">
                  <label class="form-check-label text-muted"
                    for="parcelamentoModal">
                    Parcelamento
                  </label>
                </div>

                <div x-show="mostrarParcelamento" x-transition
                  style="background-color: #F6F8FB !important;"
                  class="card mb-3 mt-3" style="display: none;"
                  :class="{'border-danger': erros.parcelas_json}">
                  <div class="card-body">
                    <div class="row mb-3 align-items-end">
                      <div class="col-md-3">
                        <label class="form-label required">Parcelas</label>
                        <select x-model.number="qtdParcelas" class="form-select"
                          @change="qtdParcelas > 0 ? gerarParcelas() : parcelas = []; limparErro('parcelas_json')"
                          :class="{'is-invalid': erros.parcelas_json}">
                          <option value="0">Selecione...</option>
                          <option value="1">1</option>
                          <option value="2">2</option>
                          <option value="3">3</option>
                          <option value="4">4</option>
                          <option value="5">5</option>
                          <option value="6">6</option>
                          <option value="7">7</option>
                          <option value="8">8</option>
                          <option value="9">9</option>
                          <option value="10">10</option>
                          <option value="11">11</option>
                          <option value="12">12</option>
                        </select>
                        <div x-show="erros.parcelas_json"
                          class="invalid-feedback"
                          x-text="erros.parcelas_json"></div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Dias entre parcelas</label>
                        <select x-model.number="diasEntre" class="form-select"
                          @change="gerarParcelas(); limparErro('parcelas_json')">
                          <option value="30">30 dias</option>
                          <option value="60">60 dias</option>
                          <option value="180">180 dias</option>
                        </select>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <template x-if="parcelas.length > 0">
                        <table class="table table-bordered align-middle mb-0">
                          <thead class="bg-white">
                            <tr>
                              <th style="width: 60px;">#</th>
                              <th style="width: 120px;">Valor</th>
                              <th style="width: 160px;">Vencimento</th>
                              <th>Descrição <span
                                  class="text-muted">(opcional)</span></th>
                              <th>Referência <span
                                  class="text-muted">(opcional)</span></th>
                            </tr>
                          </thead>
                          <tbody>
                            <template x-for="(parcela, idx) in parcelas"
                              :key="idx">
                              <tr>
                                <td x-text="(idx+1) + '/' + qtdParcelas"></td>
                                <td>
                                  <input type="text"
                                    class="form-control text-start campo-moeda-brl"
                                    :value="formatarMoeda(parcela.valor)"
                                    readonly disabled>
                                </td>
                                <td>
                                  <input type="date" class="form-control"
                                    x-model="parcela.vencimento"
                                    @input="limparErro('parcelas_json')">
                                </td>
                                <td>
                                  <input type="text" class="form-control"
                                    x-model="parcela.descricao"
                                    placeholder="Descrição"
                                    @input="limparErro('parcelas_json')">
                                </td>
                                <td>
                                  <input type="text" class="form-control"
                                    x-model="parcela.referencia"
                                    placeholder="Referência"
                                    @input="limparErro('parcelas_json')">
                                </td>
                              </tr>
                            </template>
                          </tbody>
                          <tfoot>
                            <tr>
                              <td colspan="4"
                                class="text-end fw-bold">Total:</td>
                              <td class="fw-bold text-primary"
                                x-text="formatarMoeda(totalParcelas)"></td>
                            </tr>
                          </tfoot>
                        </table>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-success"
          id="btnSalvarNovaMovimentacao" x-on:click="salvarMovimentacao()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
            viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-device-floppy me-1">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
            <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
            <path d="M14 4l0 4l-6 0l0 -4" />
          </svg>
          Salvar Nova Movimentação
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  
  window.contaBancariaId = (() => {
    const urlPath = window.location.pathname;
    const contaIdMatch = urlPath.match(/\/conciliacao-ofx\/(\d+)/);
    return contaIdMatch ? contaIdMatch[1] : null;
  })();
  
  window.estruturaPlanoContas = {
    {% if estrutura_plano %}
  {% for cat in estrutura_plano %}
  {% for sub in cat.children %}
  '{{ sub.codigo }}': {
    id: { { sub.id } },
    codigo: '{{ sub.codigo }}',
      nome: '{{ sub.nome }}'
  },
  {% for subsub in sub.children %}
  '{{ subsub.codigo }}': {
    id: { { subsub.id } },
    codigo: '{{ subsub.codigo }}',
      nome: '{{ subsub.nome }}'
  },
  {% endfor %}
  {% endfor %}
  {% endfor %}
  {% endif %}
  };

  if (Object.keys(window.estruturaPlanoContas).length === 0) {
    window.estruturaPlanoContas = {
      '1.1': { id: 1, codigo: '1.1', nome: 'ATIVO CIRCULANTE' },
      '1.1.1': { id: 2, codigo: '1.1.1', nome: 'Disponibilidades' },
      '1.1.2': { id: 3, codigo: '1.1.2', nome: 'Créditos' },
      '2.1': { id: 4, codigo: '2.1', nome: 'PASSIVO CIRCULANTE' },
      '2.1.1': { id: 5, codigo: '2.1.1', nome: 'Fornecedores' },
      '2.1.2': { id: 6, codigo: '2.1.2', nome: 'Obrigações Fiscais' },
      '3.1': { id: 7, codigo: '3.1', nome: 'RECEITA BRUTA' },
      '3.1.1': { id: 8, codigo: '3.1.1', nome: 'Vendas de Produtos' },
      '3.1.2': { id: 9, codigo: '3.1.2', nome: 'Prestação de Serviços' },
      '4.1': { id: 10, codigo: '4.1', nome: 'CUSTOS' },
      '4.1.1': { id: 11, codigo: '4.1.1', nome: 'Custos de Produtos' },
      '4.2': { id: 12, codigo: '4.2', nome: 'DESPESAS OPERACIONAIS' },
      '4.2.1': { id: 13, codigo: '4.2.1', nome: 'Despesas Administrativas' },
      '4.2.2': { id: 14, codigo: '4.2.2', nome: 'Despesas Comerciais' }
    };
  }

</script>

<script>
  
  document.addEventListener('DOMContentLoaded', function () {
    const selectsToInitialize = document.querySelectorAll('select.form-select');
    
    if (selectsToInitialize.length > 0) {
      const selectObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !entry.target.dataset.tomSelectInitialized) {
            try {
              new TomSelect(entry.target, { create: false, allowEmptyOption: false });
              entry.target.dataset.tomSelectInitialized = 'true';
              selectObserver.unobserve(entry.target);
            } catch (e) {
              console.warn('Erro ao inicializar TomSelect:', e);
            }
          }
        });
      }, { threshold: 0.1 });

      selectsToInitialize.forEach(select => selectObserver.observe(select));
    }
  });
  
  const FormatadorMonetario = {
    
    paraReal(valorCentavos) {
      if (isNaN(valorCentavos) || valorCentavos === null || valorCentavos === undefined) {
        return "R$ 0,00";
      }
      
      const valorFormatado = (valorCentavos / 100).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      return `R$ ${valorFormatado}`;
    },

    paraCentavos(valorBRL) {
      if (!valorBRL) return 0;
      
      const valorLimpo = valorBRL.replace(/R\$\s?/g, '').replace(/\./g, '').replace(',', '.');
      return Math.round((parseFloat(valorLimpo) || 0) * 100);
    },

    paraNumero(valorBRL) {
      if (!valorBRL) return 0;
      
      const valorLimpo = valorBRL.replace(/R\$\s?/g, '').replace(/\./g, '').replace(',', '.');
      return parseFloat(valorLimpo) || 0;
    }
  };

  const formatarValorParaBRL = FormatadorMonetario.paraReal;
  const converterBRLParaCentavos = FormatadorMonetario.paraCentavos;
  const converterBRLParaNumero = FormatadorMonetario.paraNumero;

  const PerformanceUtils = {
    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    },

    throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }
  };

  const dadosCarregados = new Set();

  function mostrarToast(tipo, mensagem) {
    const toastContainer = document.querySelector('.toast-container') || criarContainerToast();

    const toastId = 'toast-' + Date.now();
    let tipoClass, icone;

    switch (tipo) {
      case 'success':
        tipoClass = 'bg-success';
        icone = '<i class="fas fa-check-circle me-2"></i>';
        break;
      case 'info':
        tipoClass = 'bg-info';
        icone = '<i class="fas fa-info-circle me-2"></i>';
        break;
      case 'error':
      default:
        tipoClass = 'bg-danger';
        icone = '<i class="fas fa-exclamation-circle me-2"></i>';
        break;
    }

    const toastHtml = `
      <div id="${toastId}" class="toast align-items-center text-white ${tipoClass} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">
            ${icone}${mensagem}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();

    toastElement.addEventListener('hidden.bs.toast', () => {
      toastElement.remove();
    });
  }

  function criarContainerToast() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '11055';
    document.body.appendChild(container);
    return container;
  }

  function removerAgendamentosConciliados(agendamentosIds, transacaoId) {
    const idsArray = Array.isArray(agendamentosIds) ? agendamentosIds : [agendamentosIds];
    
    idsArray.forEach(agendamentoId => {
      
      const seletoresBusca = [
        `tr[data-agendamento-id="${agendamentoId}"]`,
        `#tabela-busca tr[data-agendamento-id="${agendamentoId}"]`,
        `#resultados-busca-${transacaoId} tr[data-agendamento-id="${agendamentoId}"]`
      ];
      
      for (const seletor of seletoresBusca) {
        const linha = document.querySelector(seletor);
        if (linha) {
          linha.style.transition = 'opacity 0.3s ease';
          linha.style.opacity = '0';
          setTimeout(() => {
            linha.remove();
            verificarTabelaVazia('tabela-busca', 'Nenhum agendamento encontrado.');
          }, 300);
          break;
        }
      }

      const seletoresSugestoes = [
        `#tabela-sugestoes-${transacaoId} tr[data-agendamento-id="${agendamentoId}"]`,
        `tr.suggestion-row[data-agendamento-id="${agendamentoId}"]`
      ];
      
      for (const seletor of seletoresSugestoes) {
        const linha = document.querySelector(seletor);
        if (linha) {
          linha.style.transition = 'opacity 0.3s ease';
          linha.style.opacity = '0';
          setTimeout(() => {
            linha.remove();
            verificarTabelaVazia(`tabela-sugestoes-${transacaoId}`, 'Não há sugestões disponíveis.');
          }, 300);
          break;
        }
      }
    });
  }

  function verificarTabelaVazia(tabelaId, mensagem) {
    const tabela = document.getElementById(tabelaId);
    if (!tabela) return;
    
    const tbody = tabela.querySelector('tbody');
    if (!tbody) return;
    
    const linhasValidas = tbody.querySelectorAll('tr:not(.empty-row)').length;
    if (linhasValidas === 0) {
      
      tbody.querySelectorAll('.empty-row').forEach(row => row.remove());
      
      const linhaVazia = document.createElement('tr');
      linhaVazia.classList.add('empty-row');
      linhaVazia.innerHTML = `<td colspan="100%" class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>${mensagem}</td>`;
      tbody.appendChild(linhaVazia);
    }
  }

  function atualizarTransacaoConciliada(transacaoId) {
    
    const isNaoConciliadasView = window.location.search.includes('conciliado=nao') ||
      !window.location.search.includes('conciliado=');

    if (isNaoConciliadasView) {
      
      const accordionItem = document.querySelector(`button[data-transaction-id="${transacaoId}"]`)?.closest('.accordion-item');
      if (accordionItem) {
        accordionItem.remove();
      }
    }
  }

  const EventManager = {
    init() {
      
      document.addEventListener('click', this.handleClick.bind(this));
    },

    handleClick(event) {
      const target = event.target;
      const closest = (selector) => target.matches(selector) ? target : target.closest(selector);

      if (closest('[id^="btn-limpar-filtros-"]')) {
        const botao = closest('[id^="btn-limpar-filtros-"]');
        const transacaoId = botao.getAttribute('data-transacao-id');
        limparFiltros(transacaoId);
      }

      else if (closest('.accordion-button')) {
        const button = closest('.accordion-button');
        const collapseTarget = button.getAttribute('data-bs-target');
        if (collapseTarget) {
          processarAberturaAccordion(collapseTarget.replace('#', ''));
        }
      }

      else if (closest('[id^="btn-buscar-"]')) {
        const botao = closest('[id^="btn-buscar-"]');
        this.handleBuscarClick(botao);
      }

      else if (closest('.btn-conciliar-selecionados')) {
        const botao = closest('.btn-conciliar-selecionados');
        const transacaoId = botao.id.replace('btn-conciliar-multiplos-busca-', '');
        conciliarBuscaSelecionados(transacaoId);
      }
    },

    handleBuscarClick(botao) {
      
    }
  };

  function processarAberturaAccordion(collapseId) {
    if (!collapseId?.startsWith('collapse')) return;

    const transacaoId = collapseId.replace('collapse', '');
    
    configurarEventListenersAgendamentos(transacaoId);

    const resultadosDiv = document.getElementById(`resultados-busca-${transacaoId}`);
    if (resultadosDiv) {
      resultadosDiv.style.display = 'block';
    }
    
    const infoSelecaoDiv = document.getElementById(`info-selecao-busca-${transacaoId}`);
    if (infoSelecaoDiv) {
      infoSelecaoDiv.style.display = 'block';
    }

    dadosCarregados.set(transacaoId, true);
  }
  
  function limparFiltros(transacaoId) {
    
    const valorMin = document.getElementById(`filtro-valor-min-${transacaoId}`);
    const valorMax = document.getElementById(`filtro-valor-max-${transacaoId}`);
    const dataInicio = document.getElementById(`filtro-data-inicio-${transacaoId}`);
    const dataFim = document.getElementById(`filtro-data-fim-${transacaoId}`);

    if (valorMin) valorMin.value = '';
    if (valorMax) valorMax.value = '';
    if (dataInicio) dataInicio.value = '';
    if (dataFim) dataFim.value = '';

    const loadingDiv = document.getElementById(`loading-busca-${transacaoId}`);
    const buscaContentDiv = document.querySelector(`.busca-content-${transacaoId}`);
    const noResultsDiv = document.getElementById(`no-results-busca-${transacaoId}`);
    const infoSelecaoDiv = document.getElementById(`info-selecao-busca-${transacaoId}`);
    const acaoConciliarDiv = document.getElementById(`acao-conciliar-busca-${transacaoId}`);

    if (loadingDiv) loadingDiv.style.display = 'none';
    if (buscaContentDiv) {
      buscaContentDiv.innerHTML = '';
      buscaContentDiv.style.display = 'none';
    }
    if (noResultsDiv) noResultsDiv.style.display = 'none';
    if (infoSelecaoDiv) infoSelecaoDiv.style.display = 'none';
    if (acaoConciliarDiv) acaoConciliarDiv.style.display = 'none';

    const botaoLimpar = document.getElementById(`btn-limpar-filtros-${transacaoId}`);
    if (botaoLimpar) {
      const textoOriginal = botaoLimpar.innerHTML;
      botaoLimpar.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Limpando...';
      botaoLimpar.disabled = true;

      setTimeout(() => {
        botaoLimpar.innerHTML = textoOriginal;
        botaoLimpar.disabled = false;
      }, 200);
    }
  }

  EventManager.handleBuscarClick = function(botao) {
    const transacaoId = botao.getAttribute('data-transacao-id');
    const ehCredito = botao.getAttribute('data-is-credit');

    const urlPath = window.location.pathname;
    const contaIdMatch = urlPath.match(/\/conciliacao-ofx\/(\d+)/);
    const contaBancariaId = contaIdMatch ? contaIdMatch[1] : null;

    const filtros = {
      is_credit: ehCredito,
      conta_bancaria_id: contaBancariaId,
      valor_min: document.getElementById(`filtro-valor-min-${transacaoId}`)?.value || '',
      valor_max: document.getElementById(`filtro-valor-max-${transacaoId}`)?.value || '',
      data_inicio: document.getElementById(`filtro-data-inicio-${transacaoId}`)?.value || '',
      data_fim: document.getElementById(`filtro-data-fim-${transacaoId}`)?.value || '',
      categoria: document.getElementById(`filtro-categoria-${transacaoId}`)?.value || '',
      beneficiario_id: document.getElementById(`filtro-beneficiario-${transacaoId}`)?.value || ''
    };

    const cacheKey = `${transacaoId}-${JSON.stringify(filtros)}`;
    if (dadosCarregados.has(cacheKey)) {
      return; 
    }

    botao.disabled = true;
    botao.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Buscando...';

    fetch('/api/buscar-agendamentos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        dadosCarregados.add(cacheKey);
        renderizarResultadosBusca(transacaoId, data.agendamentos);
        
        ['resultados-busca', 'info-selecao-busca'].forEach(id => {
          const element = document.getElementById(`${id}-${transacaoId}`);
          if (element) element.style.display = 'block';
        });
        
        configurarEventListenersAgendamentos(transacaoId);
      } else {
        mostrarToast('error', 'Erro ao buscar agendamentos: ' + (data.message || 'Erro desconhecido'));
      }
    })
    .catch(error => {
      console.error('Erro na busca:', error);
      mostrarToast('error', 'Erro ao buscar agendamentos. Tente novamente.');
    })
    .finally(() => {
      botao.disabled = false;
      botao.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round" class="icon me-1">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
          <path d="M21 21l-6 -6" />
        </svg>
        Buscar Agendamentos
      `;
    });
  };

  function renderizarResultadosBusca(transacaoId, agendamentos) {
    const resultadosDiv = document.getElementById(`resultados-busca-${transacaoId}`);
    
    if (!resultadosDiv) return;

    if (!agendamentos || agendamentos.length === 0) {
      resultadosDiv.innerHTML = `
        <div class="text-center text-muted py-5">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
            class="icon mb-3 text-muted">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
            <path d="M21 21l-6 -6" />
          </svg>
          <h6>Nenhum agendamento encontrado</h6>
          <p class="text-muted mb-0">Tente ajustar os filtros de busca.</p>
        </div>
      `;
      return;
    }

    let html = `
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="bg-light">
            <tr>
              <th class="text-center py-3">
                <input type="checkbox" class="form-check-input" id="selectAllBusca-${transacaoId}"
                  title="Selecionar todos">
              </th>
              <th class="text-center py-3">Origem</th>
              <th class="text-center py-3">Valor</th>
              <th class="text-center py-3">Vencimento</th>
              <th class="text-center py-3">Pessoa Beneficiário</th>
              <th class="text-center py-3">Descrição</th>
              <th class="text-center py-3">Categorias</th>
              <th class="text-center py-3">Ações</th>
            </tr>
          </thead>
          <tbody>
    `;

    agendamentos.forEach(agendamento => {
      const categoriasHtml = agendamento.categorias && agendamento.categorias.length > 0
        ? agendamento.categorias.map(categoria => {
            const categoriaTruncada = categoria.length > 25 ? categoria.substring(0, 25) + '...' : categoria;
            return `<div class="badge bg-dark-lt mb-1 d-block mx-auto" style="font-size: 0.65rem;" title="${categoria}">${categoriaTruncada}</div>`;
          }).join('')
        : '<div class="badge bg-secondary-lt mx-auto" style="font-size: 0.65rem;">Sem categoria</div>';

      const pessoaTruncada = agendamento.pessoa_nome && agendamento.pessoa_nome.length > 20 
        ? agendamento.pessoa_nome.substring(0, 20) + '...' 
        : agendamento.pessoa_nome || '';

      const descricaoTruncada = agendamento.descricao && agendamento.descricao.length > 20 
        ? agendamento.descricao.substring(0, 20) + '...' 
        : agendamento.descricao || '';

      html += `
        <tr class="busca-row" data-agendamento-id="${agendamento.id}" data-valor-centavos="${agendamento.valor_centavos}">
          <td class="text-center py-3">
            <input type="checkbox" class="form-check-input checkbox-busca"
              id="agendamento-${transacaoId}-${agendamento.id}"
              data-transacao-id="${transacaoId}" data-agendamento-id="${agendamento.id}"
              data-valor-centavos="${agendamento.valor_centavos}">
          </td>
          <td class="text-center py-3">
            ${agendamento.origem === 'Faturamento' 
              ? `<span class="badge bg-primary-lt">${agendamento.faturamento_codigo || 'Faturamento'}</span>`
              : `<span class="badge bg-secondary-lt">Lançamento Avulso</span>`
            }
          </td>
          <td class="text-center py-3">
            <strong class="fw-medium">${agendamento.valor_formatado}</strong>
          </td>
          <td class="text-center py-3">
            <span class="text-muted">${agendamento.data_vencimento}</span>
          </td>
          <td class="text-center py-3">
            <div class="fw-medium" title="${agendamento.pessoa_nome || ''}">${pessoaTruncada}</div>
          </td>
          <td class="text-center py-3">
            <span title="${agendamento.descricao || ''}">${descricaoTruncada}</span>
          </td>
          <td class="text-center py-3">
            <div class="d-flex flex-column align-items-center">
              ${categoriasHtml}
            </div>
          </td>
          <td class="text-center">
            <button class="btn btn-icon btn-outline-success"
              onclick="conciliarAgendamento(${transacaoId}, ${agendamento.id})"
              title="Conciliar este agendamento">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                <path d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" />
              </svg>
            </button>
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
      <div class="mt-2 text-muted small">
        <i class="icon icon-tabler icon-tabler-info-circle me-1"></i>${agendamentos.length} agendamento(s) encontrado(s)
      </div>
    `;

    resultadosDiv.innerHTML = html;
  }

  function configurarEventListenersAgendamentos(transacaoId) {
    const resultadosDiv = document.getElementById(`resultados-busca-${transacaoId}`);

    if (!resultadosDiv) return;
    
    if (resultadosDiv.getAttribute('data-listeners-configurados') === 'true') {
      return;
    }
    
    resultadosDiv.setAttribute('data-listeners-configurados', 'true');

    if (!resultadosDiv.hasChildNodes() || resultadosDiv.children.length === 0) {
      resultadosDiv.innerHTML = `
        <div class="text-center py-4 text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
            class="icon mb-3 text-muted">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
            <path d="M21 21l-6 -6" />
          </svg>
          <h6>Nenhum agendamento disponível</h6>
          <p class="text-muted mb-0">Use os filtros acima e clique em "Buscar Agendamentos" para encontrar agendamentos específicos.</p>
        </div>
      `;
      return;
    }

    const checkboxes = resultadosDiv.querySelectorAll('.checkbox-busca');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => atualizarSelecaoBusca(transacaoId));
    });

    const selectAllCheckbox = document.getElementById(`selectAllBusca-${transacaoId}`);
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function () {
        const isChecked = this.checked;

        if (isChecked) {
          
          selecionarInteligenteBusca(transacaoId, checkboxes);
        } else {
          
          checkboxes.forEach(checkbox => {
            if (!checkbox.id.includes('selectAllBusca')) {
              checkbox.checked = false;
            }
          });
        }
        atualizarSelecaoBusca(transacaoId);
      });
    }

    const rows = resultadosDiv.querySelectorAll('.busca-row');
    rows.forEach(row => {
      row.addEventListener('click', function (e) {
        
        if (e.target.type === 'checkbox') return;

        const checkbox = this.querySelector('.checkbox-busca');
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          atualizarSelecaoBusca(transacaoId);
        }
      });

      row.style.cursor = 'pointer';
      row.addEventListener('mouseenter', function () {
        this.classList.add('table-active');
      });
      row.addEventListener('mouseleave', function () {
        this.classList.remove('table-active');
      });
    });

    const btnConciliarMassa = document.getElementById(`btn-conciliar-multiplos-busca-${transacaoId}`);
    if (btnConciliarMassa) {
      btnConciliarMassa.addEventListener('click', function () {
        conciliarMultiplosBusca(transacaoId);
      });
    }

    atualizarSelecaoBusca(transacaoId);
  }

  function atualizarSelecaoBusca(transacaoId) {
    
    const checkboxes = Array.from(document.querySelectorAll(
      `input.checkbox-busca[data-transacao-id="${transacaoId}"][data-agendamento-id]:checked`
    )).filter(cb => !cb.id.includes('selectAllBusca') && cb.getAttribute('data-agendamento-id'));
    
    const elementos = ['valor-selecionado', 'qtd-selecionados', 'badge-status', 'btn-conciliar-multiplos', 'acao-conciliar']
      .reduce((acc, tipo) => {
        acc[tipo] = document.getElementById(`${tipo}-busca-${transacaoId}`);
        return acc;
      }, {});

    const button = document.querySelector(`button[data-bs-target="#collapse${transacaoId}"]`);
    const valorTransacao = FormatadorMonetario.paraCentavos(button?.getAttribute('data-value') || 'R$ 0,00');

    const totalCentavos = checkboxes.reduce((total, cb) => {
      const valor = parseInt(cb.getAttribute('data-valor-centavos'));
      return total + (isNaN(valor) ? 0 : valor);
    }, 0);

    if (elementos['valor-selecionado']) elementos['valor-selecionado'].textContent = FormatadorMonetario.paraReal(totalCentavos);
    if (elementos['qtd-selecionados']) elementos['qtd-selecionados'].textContent = checkboxes.length;

    const valorExcedido = Math.abs(totalCentavos) > Math.abs(valorTransacao);
    const temSelecao = checkboxes.length > 0;

    const estados = {
      vazio: { classe: 'badge bg-light text-dark', texto: 'Selecione os agendamentos', habilitado: false, visivel: false },
      excedido: { classe: 'badge bg-danger-lt text-dark', texto: 'Valor excedido!', habilitado: false, visivel: false },
      valido: { classe: 'badge bg-success-lt text-dark', texto: `${checkboxes.length} selecionado(s)`, habilitado: true, visivel: true }
    };

    const estadoAtual = !temSelecao ? 'vazio' : valorExcedido ? 'excedido' : 'valido';
    const config = estados[estadoAtual];

    if (elementos['badge-status']) {
      elementos['badge-status'].className = config.classe;
      elementos['badge-status'].textContent = config.texto;
    }
    if (elementos['btn-conciliar-multiplos']) elementos['btn-conciliar-multiplos'].disabled = !config.habilitado;
    if (elementos['acao-conciliar']) elementos['acao-conciliar'].style.display = config.visivel ? 'block' : 'none';
  }

  function selecionarInteligenteBusca(transacaoId, checkboxes) {
    const button = document.querySelector(`button[data-bs-target="#collapse${transacaoId}"]`);
    const valorTransacaoStr = button ? button.getAttribute('data-value') : 'R$ 0,00';
    const valorTransacaoCentavos = Math.abs(converterBRLParaCentavos(valorTransacaoStr));

    let totalSelecionado = 0;

    const checkboxesIndividuais = Array.from(checkboxes).filter(checkbox => 
      !checkbox.id.includes('selectAllBusca')
    );

    const checkboxesArray = checkboxesIndividuais.sort((a, b) => {
      const valorA = parseInt(a.getAttribute('data-valor-centavos')) || 0;
      const valorB = parseInt(b.getAttribute('data-valor-centavos')) || 0;
      return valorA - valorB;
    });

    checkboxesArray.forEach(checkbox => {
      const valorStr = checkbox.getAttribute('data-valor-centavos');
      const valorItem = parseInt(valorStr);
      
      if (!isNaN(valorItem)) {
        const valorAbsoluto = Math.abs(valorItem);
        
        if (totalSelecionado + valorAbsoluto <= valorTransacaoCentavos) {
          checkbox.checked = true;
          totalSelecionado += valorAbsoluto;
        } else {
          checkbox.checked = false;
        }
      } else {
        checkbox.checked = false;
      }
    });
  }

  let dadosConciliacao = {
    transacaoId: null,
    agendamentoId: null,
    botaoOriginal: null,
    textoOriginal: null
  };

  function conciliarAgendamento(transacaoId, agendamentoId) {
    
    const button = document.querySelector(`button[data-bs-target="#collapse${transacaoId}"]`);
    const valorTransacaoStr = button ? button.getAttribute('data-value') : 'R$ 0,00';
    const valorTransacaoCentavos = Math.abs(converterBRLParaCentavos(valorTransacaoStr));

    const botaoClicado = event.target.closest('button');
    const linhaTr = botaoClicado.closest('tr');
    const valorAgendamentoCentavos = Math.abs(parseInt(linhaTr.getAttribute('data-valor-centavos')));

    if (valorAgendamentoCentavos > valorTransacaoCentavos) {
      
      const valorTransacaoFormatado = formatarValorParaBRL(valorTransacaoCentavos);
      const valorAgendamentoFormatado = formatarValorParaBRL(valorAgendamentoCentavos);

      const textoValorIncompativel = document.getElementById('texto-valor-incompativel');
      textoValorIncompativel.innerHTML = `
        O valor do agendamento <strong>${valorAgendamentoFormatado}</strong> é superior 
        ao valor da transação <strong>${valorTransacaoFormatado}</strong>.<br><br>
        Não é possível conciliar valores superiores ao valor da transação.
      `;

      const modalValorIncompativel = new bootstrap.Modal(document.getElementById('modal-valor-incompativel'));
      modalValorIncompativel.show();
      return;
    }

    dadosConciliacao.transacaoId = transacaoId;
    dadosConciliacao.agendamentoId = agendamentoId;
    dadosConciliacao.botaoOriginal = botaoClicado;
    dadosConciliacao.textoOriginal = dadosConciliacao.botaoOriginal.innerHTML;

    const textoConfirmacao = document.getElementById('texto-confirmacao-conciliacao');
    textoConfirmacao.textContent = 'Deseja realmente conciliar esta transação com o agendamento selecionado?';

    const modalConfirmacao = new bootstrap.Modal(document.getElementById('modal-confirmacao-conciliacao'));
    modalConfirmacao.show();
  }

  function processarConciliacao() {
    const { transacaoId, agendamentoId, botaoOriginal, textoOriginal } = dadosConciliacao;

    const modalConfirmacao = bootstrap.Modal.getInstance(document.getElementById('modal-confirmacao-conciliacao'));
    modalConfirmacao.hide();

    botaoOriginal.disabled = true;
    botaoOriginal.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processando...';

    fetch('/api/processar-conciliacao', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        transacao_id: transacaoId,
        agendamento_id: agendamentoId,
        observacoes: ''
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          
          mostrarToast('success', data.message || 'Conciliação realizada com sucesso!');

          removerAgendamentosConciliados([agendamentoId], transacaoId);
          
          setTimeout(() => {
            const elementosRestantes = document.querySelectorAll(`tr[data-agendamento-id="${agendamentoId}"]`);
            elementosRestantes.forEach(el => el.remove());
          }, 400);
          
          atualizarTransacaoConciliada(transacaoId);

          const modalConciliacao = document.querySelector('.modal.show');
          if (modalConciliacao) {
            const modal = bootstrap.Modal.getInstance(modalConciliacao);
            if (modal) modal.hide();
          }
        } else {
          
          mostrarToast('error', data.message || 'Erro ao processar conciliação!');
        }
      })
      .catch(error => {
        console.error('Erro ao processar conciliação:', error);
        mostrarToast('error', 'Erro de comunicação com o servidor. Tente novamente.');
      });
  }

  let dadosConciliacaoMassa = {};

  function conciliarBuscaSelecionados(transacaoId) {
    
    const todosCheckboxes = document.querySelectorAll(`input.checkbox-busca[data-transacao-id="${transacaoId}"][data-agendamento-id]:checked`);
    
    const checkboxes = Array.from(todosCheckboxes).filter(checkbox => 
      !checkbox.id.includes('selectAllBusca') && 
      checkbox.getAttribute('data-agendamento-id') && 
      checkbox.getAttribute('data-valor-centavos')
    );

    if (checkboxes.length === 0) {
      alert('Selecione pelo menos um agendamento para conciliar.');
      return;
    }

    const button = document.querySelector(`button[data-bs-target="#collapse${transacaoId}"]`);
    const valorTransacaoStr = button ? button.getAttribute('data-value') : 'R$ 0,00';
    const valorTransacaoCentavos = converterBRLParaCentavos(valorTransacaoStr);

    let totalCentavos = 0;
    const agendamentosIds = [];

    checkboxes.forEach((checkbox, index) => {
      const valorStr = checkbox.getAttribute('data-valor-centavos');
      const agendamentoStr = checkbox.getAttribute('data-agendamento-id');
      const valorCentavos = parseInt(valorStr);
      const agendamentoId = parseInt(agendamentoStr);
      
      if (!isNaN(valorCentavos) && !isNaN(agendamentoId)) {
        totalCentavos += valorCentavos;
        agendamentosIds.push(agendamentoId);
      }
    });
    
    if (Math.abs(totalCentavos) > Math.abs(valorTransacaoCentavos)) {
      const valorTransacaoFormatado = formatarValorParaBRL(Math.abs(valorTransacaoCentavos));
      const valorSelecionadoFormatado = formatarValorParaBRL(Math.abs(totalCentavos));
      const diferencaFormatada = formatarValorParaBRL(Math.abs(totalCentavos) - Math.abs(valorTransacaoCentavos));

      const textoValorIncompativel = document.getElementById('texto-valor-incompativel');
      textoValorIncompativel.innerHTML = `
        O valor total dos agendamentos selecionados <strong>${valorSelecionadoFormatado}</strong> 
        é superior ao valor da transação <strong>${valorTransacaoFormatado}</strong>.<br><br>
        Diferença: <strong>${diferencaFormatada}</strong><br><br>
        Não é possível conciliar valores superiores ao valor da transação.
      `;

      const modalValorIncompativel = new bootstrap.Modal(document.getElementById('modal-valor-incompativel'));
      modalValorIncompativel.show();
      return;
    }

    dadosConciliacaoMassa.transacaoId = transacaoId;
    dadosConciliacaoMassa.agendamentosIds = agendamentosIds;
    dadosConciliacaoMassa.tipo = 'busca';
    dadosConciliacaoMassa.totalSelecionados = checkboxes.length;

    const textoConfirmacao = document.getElementById('texto-confirmacao-conciliacao');
    textoConfirmacao.innerHTML = `
      Deseja realmente conciliar esta transação com <strong>${checkboxes.length} agendamento(s)</strong> selecionado(s)?<br><br>
      <small class="text-muted">
        Valor da transação: <strong>${formatarValorParaBRL(Math.abs(valorTransacaoCentavos))}</strong><br>
        Valor total selecionado: <strong>${formatarValorParaBRL(Math.abs(totalCentavos))}</strong>
      </small>
    `;

    const modalConfirmacao = new bootstrap.Modal(document.getElementById('modal-confirmacao-conciliacao'));
    modalConfirmacao.show();
  }

  function conciliarMultiplosBusca(transacaoId) {
    conciliarBuscaSelecionados(transacaoId);
  }

  function processarConciliacaoMassa() {
    const { transacaoId, agendamentosIds, tipo, totalSelecionados } = dadosConciliacaoMassa;

    const modalConfirmacao = bootstrap.Modal.getInstance(document.getElementById('modal-confirmacao-conciliacao'));
    modalConfirmacao.hide();

    const botaoOriginal = document.getElementById(`btn-conciliar-multiplos-busca-${transacaoId}`);
    if (botaoOriginal) {
      botaoOriginal.disabled = true;
      botaoOriginal.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processando conciliação em massa...';
    }

    fetch('/api/processar-conciliacao-massa', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        transacao_id: transacaoId,
        agendamentos_ids: agendamentosIds,
        observacoes: `Conciliação em massa de ${totalSelecionados} agendamentos`
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacaoMassa'));
          if (modal) {
            modal.hide();
          }
          
          mostrarToast('success', data.message || 'Conciliação em massa realizada com sucesso!');

          removerAgendamentosConciliados(agendamentosIds, transacaoId);
          
          const acaoConciliarDiv = document.getElementById(`acao-conciliar-busca-${transacaoId}`);
          const infoSelecaoDiv = document.getElementById(`info-selecao-busca-${transacaoId}`);
          if (acaoConciliarDiv) acaoConciliarDiv.style.display = 'none';
          if (infoSelecaoDiv) infoSelecaoDiv.style.display = 'none';
          
          const todosCheckboxes = document.querySelectorAll(`input.checkbox-busca[data-transacao-id="${transacaoId}"]`);
          todosCheckboxes.forEach(checkbox => checkbox.checked = false);
          
          setTimeout(() => {
            agendamentosIds.forEach(agendamentoId => {
              const elementosRestantes = document.querySelectorAll(`tr[data-agendamento-id="${agendamentoId}"]`);
              elementosRestantes.forEach(el => {
                el.style.transition = 'opacity 0.3s ease';
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
              });
            });
            
            setTimeout(() => {
              const tabelaResultados = document.getElementById(`resultados-busca-${transacaoId}`);
              if (tabelaResultados) {
                const linhasRestantes = tabelaResultados.querySelectorAll('tbody tr:not(.empty-row)');
                if (linhasRestantes.length === 0) {
                  
                  verificarTabelaVazia(`resultados-busca-${transacaoId}`, 'Todos os agendamentos foram conciliados');
                }
              }
            }, 400);
          }, 100);
          
          setTimeout(() => {
            atualizarTransacaoConciliada(transacaoId);
            
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          }, 1000);
        } else {
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacaoMassa'));
          if (modal) {
            modal.hide();
          }
          
          mostrarToast('error', data.message || 'Erro na conciliação em massa');

          if (botaoOriginal) {
            botaoOriginal.disabled = false;
            botaoOriginal.innerHTML = tipo === 'sugestoes'
              ? 'Conciliar Sugestões Selecionadas'
              : 'Conciliar Agendamentos Selecionados';
          }
        }
      })
      .catch(error => {
        console.error('Erro ao processar conciliação em massa:', error);
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacaoMassa'));
        if (modal) {
          modal.hide();
        }
        
        mostrarToast('error', 'Erro de comunicação com o servidor. Tente novamente.');

        if (botaoOriginal) {
          botaoOriginal.disabled = false;
          botaoOriginal.innerHTML = tipo === 'sugestoes'
            ? 'Conciliar Sugestões Selecionadas'
            : 'Conciliar Agendamentos Selecionados';
        }
      });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const btnConfirmar = document.getElementById('btn-confirmar-conciliacao');
    if (btnConfirmar) {
      btnConfirmar.addEventListener('click', function () {
        
        if (dadosConciliacaoMassa.agendamentosIds && dadosConciliacaoMassa.agendamentosIds.length > 0) {
          processarConciliacaoMassa();
        } else {
          processarConciliacao();
        }

        dadosConciliacaoMassa = {};
      });
    }

    document.addEventListener('click', function (event) {
      
      if (event.target.classList.contains('btn-conciliar-selecionados') &&
        event.target.id.includes('btn-conciliar-multiplos-busca')) {
        const transacaoId = event.target.id.replace('btn-conciliar-multiplos-busca-', '');
        conciliarBuscaSelecionados(transacaoId);
      }
    });

  });

  window.novaMovimentacaoData = function (transacaoId, transacaoValor) {
    
    const mapaCategorias = window.estruturaPlanoContas || {};

    return {
      
      totalPagar: transacaoValor,
      transacaoId: transacaoId,
      mapaCategorias: mapaCategorias,

      formulario: {
        descricao: '',
        valor: 0, 
        data_vencimento: '',
        pessoa_financeiro_id: '',
        data_competencia: '',
        conta_bancaria_id: ''
      },

      mostrarValoresDetalhados: false,
      mostrarParcelamento: false,
      tipoDistribuicao: 'percentual',

      lista: [
        {
          nome: '',
          detalhamento: '',
          valor: 0 
        }
      ],

      centrosCusto: [
        {
          centro: '',
          percentual: '',
          valor: 0
        }
      ],

      qtdParcelas: 0,
      diasEntre: 30,
      parcelas: [],
      totalParcelas: 0,

      init() {
        
        const hoje = new Date();
        this.formulario.data_vencimento = hoje.toISOString().slice(0, 10);

        this.lista[0].valor = this.totalPagar;
        this.validarTotalCompleto();
      },

      prepararEnvio() {
        
        if (!this.podeEnviar()) {
          alert('Por favor, preencha todos os campos obrigatórios.');
          return;
        }

        const categoriasComDados = this.lista.map(categoria => {
          const dadosCategoria = this.mapaCategorias[categoria.nome] || {};
          const categoriaCompleta = dadosCategoria.nome ?
            `${categoria.nome} - ${dadosCategoria.nome}` :
            categoria.nome;

          return {
            categoria: categoriaCompleta,
            categoria_id: dadosCategoria.id || null,
            detalhamento: categoria.detalhamento,
            valor: categoria.valor
          };
        });

        const dadosEnvio = {
          transacao_id: this.transacaoId,
          descricao: this.formulario.descricao,
          valor: this.formulario.valor,
          data_vencimento: this.formulario.data_vencimento,
          pessoa_financeiro_id: this.formulario.pessoa_financeiro_id,
          data_competencia: this.formulario.data_competencia,
          conta_bancaria_id: this.formulario.conta_bancaria_id,
          categorias: categoriasComDados,
          centros_custo: this.mostrarValoresDetalhados ? this.centrosCusto : [],
          parcelas: this.mostrarParcelamento ? this.parcelas : [],
          valores_detalhados_ativo: this.mostrarValoresDetalhados,
          parcelamento_ativo: this.mostrarParcelamento
        };

        alert('Funcionalidade em desenvolvimento!\nDados preparados no console.');
      },

      limparFormulario() {
        
        this.formulario = {
          descricao: '',
          valor: 0,
          data_vencimento: new Date().toISOString().slice(0, 10),
          pessoa_financeiro_id: '',
          data_competencia: '',
          conta_bancaria_id: ''
        };

        this.lista = [{
          nome: '',
          detalhamento: '',
          valor: 0
        }];

        this.centrosCusto = [{
          centro: '',
          percentual: '',
          valor: 0
        }];

        this.parcelas = [];
        this.qtdParcelas = 0;
        this.totalParcelas = 0;

        this.mostrarValoresDetalhados = false;
        this.mostrarParcelamento = false;
      },

      podeEnviar() {
        
        if (!this.formulario.descricao ||
          !this.formulario.valor ||
          this.formulario.valor <= 0 ||
          !this.formulario.data_vencimento ||
          !this.formulario.pessoa_financeiro_id ||
          !this.formulario.conta_bancaria_id) {
          return false;
        }

        if (!this.lista || this.lista.length === 0) return false;

        let temCategoriaValida = false;
        for (let categoria of this.lista) {
          if (categoria.nome && categoria.valor > 0) {
            temCategoriaValida = true;
            break;
          }
        }

        if (!temCategoriaValida) return false;

        const totalCategorias = this.lista.reduce((acc, cat) => acc + (cat.valor || 0), 0);
        if (totalCategorias !== this.formulario.valor) return false;

        return true;
      },

      formatarMoeda: FormatadorMonetario.paraReal,
      formatarParaExibicao: FormatadorMonetario.paraReal,

      aplicarMascaraValor(event) {
        const valorCentavos = this._extrairValorCentavos(event);
        this.formulario.valor = valorCentavos;
        
        if (this.lista.length > 0) {
          this.lista[0].valor = valorCentavos;
        }
        
        this._atualizarCampoFormatado(event, valorCentavos);
        this.validarTotalCompleto();
      },

      aplicarMascara(event, index) {
        const valorCentavos = this._extrairValorCentavos(event);
        this.lista[index].valor = valorCentavos;
        this._atualizarCampoFormatado(event, valorCentavos);
        this.validarTotalCompleto();
      },

      aplicarMascaraCentroCusto(event, index) {
        const valorCentavos = this._extrairValorCentavos(event);
        this.centrosCusto[index].valor = valorCentavos;
        this._atualizarCampoFormatado(event, valorCentavos);
        this.validarTotalCompleto();
      },

      _extrairValorCentavos(event) {
        const valor = event.target.value.replace(/\D/g, '');
        return parseInt(valor) || 0;
      },

      _atualizarCampoFormatado(event, valorCentavos) {
        event.target.value = FormatadorMonetario.paraReal(valorCentavos);
      },

      adicionarCategoria() {
        this.lista.push({
          nome: '',
          detalhamento: '',
          valor: 0
        });
      },

      removerCategoria(index) {
        if (this.lista.length > 1) {
          this.lista.splice(index, 1);
          this.validarTotalCompleto();
        }
      },

      validarTotalCompleto() {
        
        this.validarCategoriasDuplicadas();

        let totalCategorias = 0;
        this.lista.forEach(categoria => {
          if (categoria.valor && categoria.valor > 0) {
            totalCategorias += categoria.valor;
          }
        });

        if (this.mostrarValoresDetalhados) {
          this.validarCentrosCusto();
        }
      },

      validarCategoriasDuplicadas() {
        const categoriasUsadas = [];
        let temDuplicada = false;

        this.lista.forEach(categoria => {
          if (categoria.nome && categoria.nome.trim() !== '') {
            if (categoriasUsadas.includes(categoria.nome)) {
              temDuplicada = true;
            } else {
              categoriasUsadas.push(categoria.nome);
            }
          }
        });

        return temDuplicada;
      },

      adicionarCentroCusto() {
        this.centrosCusto.push({
          centro: '',
          percentual: '',
          valor: 0
        });
      },

      removerCentroCusto(index) {
        if (this.centrosCusto.length > 1) {
          this.centrosCusto.splice(index, 1);
          this.validarTotalCompleto();
        }
      },

      validarCentrosCusto() {
        if (!this.mostrarValoresDetalhados) return true;

        if (this.tipoDistribuicao === 'valor') {
          let totalCentros = 0;
          this.centrosCusto.forEach(centro => {
            if (centro.valor && centro.valor > 0) {
              totalCentros += centro.valor;
            }
          });
          return (totalCentros === this.formulario.valor || totalCentros === 0);
        } else if (this.tipoDistribuicao === 'percentual') {
          let totalPercentual = 0;
          this.centrosCusto.forEach(centro => {
            if (centro.percentual) {
              const percentual = parseFloat(centro.percentual.replace(',', '.')) || 0;
              totalPercentual += percentual;
            }
          });
          return (Math.abs(totalPercentual - 100) <= 0.01 || totalPercentual === 0);
        }
        return true;
      },

      initParcelamento() {
        if (this.mostrarParcelamento && this.qtdParcelas > 0) {
          this.gerarParcelas();
        } else {
          this.parcelas = [];
          this.totalParcelas = 0;
        }
      },

      gerarParcelas() {
        if (!this.qtdParcelas || this.qtdParcelas < 1) {
          this.parcelas = [];
          this.totalParcelas = 0;
          return;
        }

        this.parcelas = [];
        const valorTotal = this.formulario.valor || this.totalPagar;
        const valorParcela = Math.floor(valorTotal / this.qtdParcelas);
        let resto = valorTotal - (valorParcela * this.qtdParcelas);

        let hoje = new Date();
        let ano = hoje.getFullYear();
        let mes = hoje.getMonth();
        if (hoje.getDate() > 10) {
          mes += 1;
          if (mes > 11) { mes = 0; ano += 1; }
        }
        let dataBase = new Date(ano, mes, 10);

        for (let i = 0; i < this.qtdParcelas; i++) {
          let valor = valorParcela;
          if (resto > 0) {
            valor += 1;
            resto--;
          }

          let vencimento = new Date(dataBase);
          if (i > 0) {
            vencimento.setDate(vencimento.getDate() + (i * this.diasEntre));
          }

          const vencStr = vencimento.toISOString().slice(0, 10);
          this.parcelas.push({
            valor: valor,
            vencimento: vencStr,
            descricao: this.formulario.descricao || '',
            referencia: ''
          });
        }

        this.calcularTotalParcelas();
      },

      calcularTotalParcelas() {
        this.totalParcelas = this.parcelas.reduce((acc, p) => acc + p.valor, 0);
      }
    }
  }

  window.initModalNovaMovimentacao = function (transacaoId, transacaoValor) {
    if (!transacaoValor || isNaN(transacaoValor)) transacaoValor = 0;

    const botaoNovaMovimentacao = document.querySelector(`#nova-movimentacao-tab-${transacaoId}`);
    if (botaoNovaMovimentacao) {
      
      const todosBootoesTransacao = document.querySelectorAll(`[id*="tab-${transacaoId}"]`);
      todosBootoesTransacao.forEach(btn => btn.classList.remove('active'));

      botaoNovaMovimentacao.classList.add('active');
    }

    const formElement = document.querySelector('#formNovaMovimentacao');
    if (formElement?._x_dataStack?.[0]) {
      const data = formElement._x_dataStack[0];
      
      data.formulario.valor = transacaoValor;
      data.totalPagar = transacaoValor; 
      data.transacaoId = transacaoId;  
      data.transacaoValor = transacaoValor;  

      setTimeout(() => {
        const campoValor = document.querySelector('#modalNovaMovimentacao input.campo-moeda-brl');
        const valorFormatado = formatarValorParaBRL(transacaoValor);
        if (campoValor) campoValor.value = valorFormatado;
      }, 100);
    }
  }

  window.modalNovaMovimentacaoData = function () {
    return {
      formulario: {
        descricao: '',
        valor: 0,
        data_vencimento: '',
        pessoa_financeiro_id: '',
        data_competencia: '',
        conta_bancaria_id: '',
        referencia: ''
      },
      erros: {},
      lista: [{
        nome: '',
        detalhamento: '',
        valor: 0
      }],
      mostrarValoresDetalhados: false,
      tipoDistribuicao: 'percentual',
      centrosCusto: [{
        centro: '',
        percentual: 100,
        valor: 0
      }],
      mostrarParcelamento: false,
      qtdParcelas: 0,
      diasEntre: 30,
      parcelas: [],
      totalPagar: 0,
      totalParcelas: 0,
      transacaoId: null,
      transacaoValor: 0,

      init() {
        
        this.$el.addEventListener('salvar-movimentacao', () => {
          this.salvarMovimentacao();
        });

        this.$el.addEventListener('limpar-formulario', () => {
          this.limparFormulario();
        });
      },

      adicionarCategoria() {
        this.lista.push({
          nome: '',
          detalhamento: '',
          valor: 0
        });
      },

      removerCategoria(index) {
        if (this.lista.length > 1) {
          this.lista.splice(index, 1);
          this.validarTotalCompleto();
        }
      },

      adicionarCentroCusto() {
        this.centrosCusto.push({
          centro: '',
          percentual: 0,
          valor: 0
        });
      },

      removerCentroCusto(index) {
        if (this.centrosCusto.length > 1) {
          this.centrosCusto.splice(index, 1);
        }
      },

      aplicarMascaraValor(event) {
        let valor = event.target.value.replace(/\D/g, '');
        const valorCentavos = parseInt(valor) || 0;
        this.formulario.valor = valorCentavos;
        this.totalPagar = valorCentavos;
        const valorFormatado = this.formatarParaExibicao(valorCentavos);
        event.target.value = valorFormatado;
        this.validarTotalCompleto();
      },

      aplicarMascara(event, index) {
        let valor = event.target.value.replace(/\D/g, '');
        const valorCentavos = parseInt(valor) || 0;
        this.lista[index].valor = valorCentavos;
        const valorFormatado = this.formatarParaExibicao(valorCentavos);
        event.target.value = valorFormatado;
        this.validarTotalCompleto();
      },

      aplicarMascaraCentroCusto(event, index) {
        let valor = event.target.value.replace(/\D/g, '');
        const valorCentavos = parseInt(valor) || 0;
        this.centrosCusto[index].valor = valorCentavos;
        const valorFormatado = this.formatarParaExibicao(valorCentavos);
        event.target.value = valorFormatado;
      },

      converterParaFloat: FormatadorMonetario.paraCentavos,
      formatarParaExibicao: FormatadorMonetario.paraReal,
      formatarMoeda: FormatadorMonetario.paraReal,

      validarTotalCompleto() {
        
      },

      initParcelamento() {
        if (!this.mostrarParcelamento) {
          this.parcelas = [];
          this.qtdParcelas = 0;
        }
      },

      gerarParcelas() {
        this.parcelas = [];
        if (this.qtdParcelas > 0 && this.formulario.valor > 0) {
          const valorParcela = this.formulario.valor / this.qtdParcelas;
          const dataBase = new Date(this.formulario.data_vencimento);

          for (let i = 0; i < this.qtdParcelas; i++) {
            const dataVencimento = new Date(dataBase);
            dataVencimento.setDate(dataBase.getDate() + (i * this.diasEntre));

            this.parcelas.push({
              valor: valorParcela,
              vencimento: dataVencimento.toISOString().split('T')[0],
              descricao: '',
              referencia: ''
            });
          }
        }
        this.calcularTotalParcelas();
      },

      calcularTotalParcelas() {
        this.totalParcelas = this.parcelas.reduce((total, parcela) => total + parcela.valor, 0);
      },

      podeEnviar() {
        
        const basico = this.formulario.descricao &&
          this.formulario.valor > 0 &&
          this.formulario.data_vencimento &&
          this.formulario.pessoa_financeiro_id &&
          this.formulario.conta_bancaria_id &&
          this.lista.some(cat => cat.nome);

        if (this.mostrarParcelamento) {
          return basico &&
            this.qtdParcelas > 1 &&
            this.parcelas.length > 0 &&
            this.parcelas.every(p => p.vencimento && p.valor > 0);
        }

        return basico;
      },

      limparFormulario() {
        this.formulario = {
          descricao: '',
          valor: 0,
          data_vencimento: '',
          pessoa_financeiro_id: '',
          data_competencia: '',
          conta_bancaria_id: '',
          referencia: ''
        };
        this.erros = {};
        this.lista = [{
          nome: '',
          detalhamento: '',
          valor: 0
        }];
        this.mostrarValoresDetalhados = false;
        this.mostrarParcelamento = false;
        this.parcelas = [];
        this.qtdParcelas = 0;
        this.configurarDataVencimento();
      },

      async prepararEnvio() {
        if (!this.podeEnviar()) {
          alert('Por favor, preencha todos os campos obrigatórios');
          return;
        }

        await this.salvarMovimentacao();
      },

      limparErro(campo) {
        if (this.erros[campo]) {
          delete this.erros[campo];
        }
      },

      async salvarMovimentacao() {
        try {
          
          const dados = {
            transacao_id: this.transacaoId,
            valor: this.formatarParaExibicao(this.formulario.valor),
            descricao: this.formulario.descricao,
            data_vencimento: this.formulario.data_vencimento,
            data_competencia: this.formulario.data_competencia,
            conta_bancaria_id: this.formulario.conta_bancaria_id,
            pessoa_financeiro_id: this.formulario.pessoa_financeiro_id,
            referencia: this.formulario.referencia || '',
            categorias_json: JSON.stringify(
              this.lista
                .filter(cat => cat.nome && cat.valor > 0)
                .map(cat => ({
                  categoria: cat.nome,
                  valor: cat.valor,
                  detalhamento: cat.detalhamento || '',
                  referencia: cat.referencia || ''
                }))
            ),
            centros_custo_json: this.mostrarValoresDetalhados ? JSON.stringify(
              this.centrosCusto
                .filter(cc => cc.centro)
                .map(cc => ({
                  centro: cc.centro,
                  valor: cc.valor,
                  percentual: cc.percentual || ''
                }))
            ) : '[]',
            valores_detalhados_ativo: this.mostrarValoresDetalhados,
            parcelamento_ativo: this.mostrarParcelamento,
            numero_parcelas: this.qtdParcelas,
            dias_entre_parcelas: this.diasEntre,
            parcelas_json: this.mostrarParcelamento ? JSON.stringify(
              this.parcelas.map(parcela => ({
                vencimento: parcela.vencimento,
                valor: parcela.valor,
                descricao: parcela.descricao || '',
                referencia: parcela.referencia || ''
              }))
            ) : '[]'
          };

          const response = await fetch('/api/salvar-nova-movimentacao', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
          });

          const resultado = await response.json();

          if (resultado.success) {
            
            mostrarToast('success', 'Nova movimentação criada e conciliada com sucesso!');

            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNovaMovimentacao'));
            if (modal) {
              modal.hide();
            }

            setTimeout(() => {
              window.location.reload();
            }, 1000); 

            this.resetarFormulario();

          } else {
            
            this.erros = {};

            if (resultado.campos_obrigatorios) {
              
              Object.assign(this.erros, resultado.campos_obrigatorios);
            }

            if (resultado.campos_erros) {
              
              Object.assign(this.erros, resultado.campos_erros);
            }

            if (!resultado.campos_obrigatorios && !resultado.campos_erros && resultado.errors) {
              Object.assign(this.erros, resultado.errors);
            }

          }

        } catch (error) {
          console.error('Erro ao salvar movimentação:', error);
          mostrarToast('error', 'Erro de comunicação com o servidor. Tente novamente.');
        }
      },

      resetarFormulario() {
        
        this.formulario = {
          valor: '',
          descricao: '',
          data_vencimento: '',
          data_competencia: '',
          conta_bancaria_id: '',
          pessoa_financeiro_id: '',
          referencia: ''
        };

        this.lista = [{ nome: '', valor: 0, detalhamento: '' }];
        this.centrosCusto = [{ centro: '', percentual: '', valor: '' }];
        this.parcelas = [];

        this.mostrarValoresDetalhados = false;
        this.mostrarParcelamento = false;
        this.qtdParcelas = 0;
        this.diasEntre = 30;

        this.erros = {};
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    
    EventManager.init();

    const modalNovaMovimentacao = document.getElementById('modalNovaMovimentacao');
    if (modalNovaMovimentacao) {
      modalNovaMovimentacao.addEventListener('hidden.bs.modal', function () {
        document.querySelectorAll('[id*="nova-movimentacao-tab-"]').forEach(btn => {
          btn.classList.remove('active');
        });
      });
    }

    const btnSalvar = document.getElementById('btnSalvarNovaMovimentacao');
    if (btnSalvar) {
      btnSalvar.addEventListener('click', function () {
        const formElement = document.querySelector('#formNovaMovimentacao');
        const alpineData = formElement?._x_dataStack?.[0];
        
        if (alpineData?.salvarMovimentacao) {
          alpineData.salvarMovimentacao();
        } else {
          console.error('Dados Alpine não encontrados ou função salvarMovimentacao não disponível');
        }
      });
    }

    {% for transacao_id, agendamentos in agendamentos_por_transacao.items() %}
    {% if agendamentos %}
    configurarEventListenersAgendamentos('{{ transacao_id }}');
    {% endif %}
    {% endfor %}
    
    setInterval(() => {
      dadosCarregados.clear();
    }, 300000); 
  });

</script>

<script>

let transacaoParaReverter = null;

function abrirModalReversao(transacaoId, fitid, valorFormatado) {
    transacaoParaReverter = {
        id: transacaoId,
        fitid: fitid,
        valor_formatado: valorFormatado
    };
    
    document.getElementById('detalhes-reversao-modal').innerHTML = `
        <div class="card">
            <div class="card-body p-3 text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>Carregando detalhes da conciliação...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('modalReversaoConciliacao'));
    modal.show();
    
    fetch(`/api/detalhes-conciliacao/${transacaoId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const valorTotalAgendamentos = data.valor_total_agendamentos || 'R$ 0,00';
            const quantidadeAgendamentos = data.quantidade_agendamentos || 0;
            
            document.getElementById('detalhes-reversao-modal').innerHTML = `
                <div class="card">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3">Detalhes da Conciliação</h6>
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <small class="text-muted">FITID:</small>
                                <div class="fw-semibold">${fitid}</div>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">Valor da Transação:</small>
                                <div class="fw-semibold">${valorFormatado}</div>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">Agendamentos Conciliados:</small>
                                <div class="fw-semibold">${quantidadeAgendamentos} item(s)</div>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">Valor Total dos Agendamentos:</small>
                                <div class="fw-semibold">${valorTotalAgendamentos}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            
            document.getElementById('detalhes-reversao-modal').innerHTML = `
                <div class="card">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-2">Detalhes da Transação</h6>
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <small class="text-muted">FITID:</small>
                                <div class="fw-semibold">${fitid}</div>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">Valor:</small>
                                <div class="fw-semibold">${valorFormatado}</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Não foi possível carregar detalhes dos agendamentos
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Erro ao buscar detalhes da conciliação:', error);
        
        document.getElementById('detalhes-reversao-modal').innerHTML = `
            <div class="card">
                <div class="card-body p-3">
                    <h6 class="card-title mb-2">Detalhes da Transação</h6>
                    <div class="row g-2">
                        <div class="col-sm-6">
                            <small class="text-muted">FITID:</small>
                            <div class="fw-semibold">${fitid}</div>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted">Valor:</small>
                            <div class="fw-semibold">${valorFormatado}</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-danger">
                            <i class="fas fa-times-circle me-1"></i>
                            Erro ao carregar detalhes dos agendamentos
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
}

function confirmarReversao() {
    if (!transacaoParaReverter) {
        const modal = new bootstrap.Modal(document.getElementById('modal-transacao-nao-selecionada'));
        modal.show();
        return;
    }
    
    const btnConfirmar = document.getElementById('btn-confirmar-reversao-modal');
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
    
    const modalReversao = bootstrap.Modal.getInstance(document.getElementById('modalReversaoConciliacao'));
    if (modalReversao) {
        modalReversao.hide();
    }
    
    fetch('/api/reverter-conciliacao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            transacao_id: transacaoParaReverter.id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            
            document.getElementById('mensagem-sucesso-reversao').textContent = data.message || 'Conciliação revertida com sucesso!';
            const modalSucesso = new bootstrap.Modal(document.getElementById('modal-sucesso-reversao'));
            modalSucesso.show();
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            
            document.getElementById('mensagem-erro-reversao').textContent = data.message || 'Erro ao reverter conciliação.';
            const modalErro = new bootstrap.Modal(document.getElementById('modal-erro-reversao'));
            modalErro.show();
            
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Erro na reversão:', error);
        
        document.getElementById('mensagem-erro-conexao').textContent = 'Erro de conexão com o servidor. Tente novamente.';
        const modalErroConexao = new bootstrap.Modal(document.getElementById('modal-erro-conexao'));
        modalErroConexao.show();
        
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const btnConfirmar = document.getElementById('btn-confirmar-reversao-modal');
    if (btnConfirmar) {
        btnConfirmar.addEventListener('click', confirmarReversao);
    }
});
</script>

<div class="modal modal-blur fade" id="modal-transacao-nao-selecionada" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon mb-2 text-danger icon-lg">
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M12 8v4" />
          <path d="M12 16h.01" />
        </svg>
        <h3>Erro na Reversão</h3>
        <div class="text-secondary">
          Nenhuma transação selecionada para reversão.
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-sucesso-reversao" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-success"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon mb-2 text-success icon-lg">
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M9 12l2 2l4 -4" />
        </svg>
        <h3>Reversão Concluída</h3>
        <div class="text-secondary" id="mensagem-sucesso-reversao">
          Conciliação revertida com sucesso!
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <button type="button" class="btn btn-success w-100" onclick="window.location.reload()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
            </svg>
            Recarregar Página
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-erro-reversao" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon mb-2 text-danger icon-lg">
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M12 8v4" />
          <path d="M12 16h.01" />
        </svg>
        <h3>Erro na Reversão</h3>
        <div class="text-secondary" id="mensagem-erro-reversao">
          Erro ao reverter conciliação.
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-erro-conexao" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon mb-2 text-danger icon-lg">
          <path d="M12 18.178l4.62 -1.256c.251 -.068 .46 -.249 .571 -.495l1.809 -4.427a1.13 1.13 0 0 0 0 -1l-1.809 -4.427a1.13 1.13 0 0 0 -.571 -.495l-4.62 -1.256a1.13 1.13 0 0 0 -.84 0l-4.62 1.256c-.251 .068 -.46 .249 -.571 .495l-1.809 4.427a1.13 1.13 0 0 0 0 1l1.809 4.427c.112 .246 .32 .427 .571 .495l4.62 1.256c.28 .076 .56 .076 .84 0z" />
          <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
        </svg>
        <h3>Erro de Conexão</h3>
        <div class="text-secondary" id="mensagem-erro-conexao">
          Erro de conexão com o servidor.
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
            </svg>
            Tentar Novamente
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock conteudo %}