{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}
<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">
            FATURAMENTOS
          </div>
          <div class="d-flex justify-content-start align-items-center flex-wrap gap-2">
            <h2 class="page-title">
              Listagem
            </h2>
            <a href="{{ url_for('listagem_fornecedores_a_pagar') }}" class="btn btn-outline-danger">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-user">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
              </svg>
              Faturar > Fornecedor
            </a>
            <a href="{{ url_for('listagem_fretes_a_pagar') }}" class="btn btn-outline-danger">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-truck">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                <path d="M5 17h-2v-11a1 1 0 0 1 1 -1h9v12m-4 0h6m4 0h2v-6h-8m0 -5h5l3 5" />
              </svg>
              Faturar > Transportadora
            </a>
          </div>
        </div>
        <div class="col-12 col-md-auto ms-auto d-print-none">
          <div class="d-flex gap-2">
            <!-- Botões de filtro rápido -->
            <a href="{{ url_for('listagem_faturamentos_cargas_a_pagar', situacaoFaturamento='') }}"
              class="btn btn-outline-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-list">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M9 6l11 0" />
                <path d="M9 12l11 0" />
                <path d="M9 18l11 0" />
                <path d="M5 6l0 .01" />
                <path d="M5 12l0 .01" />
                <path d="M5 18l0 .01" />
              </svg>
              Todos
            </a>
            <a href="{{ url_for('listagem_faturamentos_cargas_a_pagar', situacaoFaturamento=8) }}"
              class="btn btn-outline-dark">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-circle-check">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                <path d="m9 12 2 2 4 -4" />
              </svg>
              Conciliados
            </a>
            <a href="{{ url_for('listagem_faturamentos_cargas_a_pagar', situacaoFaturamento=6) }}"
              class="btn btn-outline-success">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-circle-check">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                <path d="m9 12 2 2 4 -4" />
              </svg>
              Categorizados
            </a>
            <a href="{{ url_for('listagem_faturamentos_cargas_a_pagar', situacaoFaturamento=7) }}"
              class="btn btn-outline-warning">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-clock">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
                <path d="M12 7v5l3 3" />
              </svg>
              Não Categorizado
            </a>
            <a href="#" class="btn" data-bs-toggle="modal" data-bs-target="#modal-report">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-filter">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
              </svg>
              Filtrar </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">

      {% include 'estrutura/mensagens_flash.html' %}

      <!-- Indicador dos filtros aplicados -->
      <div class="col-12 mb-3">
        <div class="alert alert-info d-flex align-items-center bg-white" role="alert">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler me-2">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
          </svg>
          <div>
            <strong>Visualização atual:</strong>
            {% if dados_corretos.get('beneficiario') %}
            {% for b in beneficiarios %}
            {% if b.id == dados_corretos.get('beneficiario')|int %}
            Beneficiário: {{ b.identificacao }}
            {% endif %}
            {% endfor %}
            {% endif %}

            {% if dados_corretos.get('situacaoFaturamento') %}
            {% for s in situacoes_faturamento %}
            {% if s.id == dados_corretos.get('situacaoFaturamento')|int %}
            {% if dados_corretos.get('beneficiario') %} | {% endif %}{{ s.situacao }}
            {% endif %}
            {% endfor %}
            {% elif 'situacaoFaturamento' in dados_corretos and dados_corretos.get('situacaoFaturamento') == '' %}
            {% if dados_corretos.get('beneficiario') %} | {% endif %}Todos os Faturamentos
            {% elif not dados_corretos %}
            Não Categorizados (padrão)
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12">
        {% if faturamentos%}
        <div class="card">
          <div class="table-responsive">
            <table id="tabela-faturamentos" class="table table-vcenter card-table">
              <thead>
                <tr>
                  <th style="text-align: center;">Beneficiário</th>
                  <th style="text-align: center;">Cód. Faturamento</th>
                  <th style="text-align: center;">Data/Hora</th>
                  <th style="text-align: center;">Valor Bruto</th>
                  <th style="text-align: center;">Crédito Aplicado</th>
                  <th style="text-align: center;">Valor Total</th>
                  <!-- <th style="text-align: center;">Utilizou Crédito</th>-->
                  <th style="text-align: center;">Situação</th>
                  <th style="text-align: center;">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for faturamento in faturamentos %}
                <tr>
                  <td class="text-secondary text-center">
                    <span id="beneficiario-{{ faturamento.id }}" class="text-muted">
                      <span class="beneficiario-nome">-</span>
                    </span>
                  </td>
                  <td class="text-secondary text-center">
                    {% if faturamento.codigo_faturamento %}
                    {{ faturamento.codigo_faturamento }}
                    {% else %}
                    {{ faturamento.id }}
                    {% endif %}
                  </td>
                  <td class="text-secondary text-center">
                    {% if faturamento.data_cadastro %}
                    {{ faturamento.data_cadastro.strftime('%d/%m/%Y %H:%M') }}
                    {% else %}
                    N/A
                    {% endif %}
                  </td>
                  <td class="text-secondary text-center">
                    {% if faturamento.valor_bruto_total %}
                    {{ faturamento.valor_bruto_total | formatar_float_para_brl }}
                    {% else %}
                    -
                    {% endif %}
                  </td>
                  <td class="text-secondary text-center">
                    {% if faturamento.valor_credito_aplicado %}
                    <span>
                      {{ faturamento.valor_credito_aplicado | formatar_float_para_brl }}
                    </span>
                    {% else %}
                    -
                    {% endif %}
                  </td>
                  <td class="text-secondary text-center">
                    <span>
                      {% if faturamento.valor_total %}
                      {{ faturamento.valor_total | formatar_float_para_brl }}
                      {% else %}
                      -
                      {% endif %}
                    </span>
                  </td>
                  <td class="text-secondary text-center">
                    {% if faturamento.situacao %}
                    {% if faturamento.situacao.id == 6 or faturamento.situacao.id == 8 %}
                    <span class="badge badge-outline text-success">{{ faturamento.situacao.situacao }}</span>
                    {% else %}
                    <span class="badge badge-outline text-warning">{{ faturamento.situacao.situacao }}</span>
                    {% endif %}
                    {% else %}
                    <span class="badge badge-outline text-warning">Pendente</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="btn-list flex-nowrap justify-content-center">
                      <button type="button" class="btn btn-icon btn-outline-primary" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Visualizar detalhes" data-faturamento-id="{{ faturamento.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                          <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                        </svg>
                      </button>

                      {% if faturamento.situacao_pagamento_id == 6 %}
                      <!-- Botão para ver categorização (já categorizado) -->
                      <button type="button" class="btn btn-icon btn-outline-dark" data-bs-toggle="modal"
                        data-bs-target="#modal-categorizacao" onclick="carregarCategorizacao({{ faturamento.id }})"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="Visualizar Categorização">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-check-circle">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                          <path d="m9 12 2 2 4 -4" />
                        </svg>
                      </button>

                      {% else %}
                      {% if faturamento.situacao_pagamento_id == 7 %}
                      <!-- Botão para categorizar (não categorizado) -->
                      <a href="{{ url_for('categorizar_fatura', id=faturamento.id) }}"
                        class="btn btn-icon btn-outline-orange" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Categorizar Fatura">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-category">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 4h6v6h-6z" />
                          <path d="M14 4h6v6h-6z" />
                          <path d="M4 14h6v6h-6z" />
                          <path d="M17 17m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                        </svg>
                      </a>
                      {%endif%}
                      {% endif %}
                      <button type="button" class="btn btn-icon btn-outline-success" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Copiar dados bancários"
                        onclick="copiarDadosBancariosFaturamento({{ faturamento.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-credit-card">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M3 5m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z" />
                          <path d="M3 10l18 0" />
                          <path d="M7 15l.01 0" />
                          <path d="M11 15l2 0" />
                        </svg>
                      </button>
                      <button type="button" class="btn btn-icon btn-outline-danger" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Exportar para PDF"
                        onclick="abrirModalExportarPDF({{ faturamento.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-pdf">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M10 8v8h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-2z" />
                          <path d="M3 12h2a2 2 0 1 0 0 -4h-2v8" />
                          <path d="M17 12h3" />
                          <path d="M21 8h-4v8" />
                        </svg>
                      </button>

                      <button type="button" class="btn btn-icon btn-outline-purple" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Exportar como Imagem"
                        onclick="abrirModalExportarImagem({{ faturamento.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-photo-scan">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M15 8h.01" />
                          <path d="M6 13l2.644 -2.644a1.21 1.21 0 0 1 1.712 0l3.644 3.644" />
                          <path d="M13 13l1.644 -1.644a1.21 1.21 0 0 1 1.712 0l1.644 1.644" />
                          <path d="M4 8v-2a2 2 0 0 1 2 -2h2" />
                          <path d="M4 16v2a2 2 0 0 0 2 2h2" />
                          <path d="M16 4h2a2 2 0 0 1 2 2v2" />
                          <path d="M16 20h2a2 2 0 0 0 2 -2v-2" />
                        </svg>
                      </button>
                      {% if dados_corretos.get('situacaoFaturamento')|string != '8' %}
                      <a href="#"
                        class="btn btn-icon btn-outline-danger excluir  {%if faturamento.situacao_pagamento_id == 6 %} disabled {%endif%}"
                        data-bs-toggle="modal" data-bs-target="#modal-desativar-{{faturamento.id}}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-trash">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 7l16 0" />
                          <path d="M10 11l0 6" />
                          <path d="M14 11l0 6" />
                          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                        </svg>
                      </a>
                      <div class="modal modal-blur fade" id="modal-desativar-{{faturamento.id}}" tabindex="-1"
                        role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                          <div class="modal-content">
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            <div class="modal-status bg-danger"></div>
                            <div class="modal-body text-center py-4">
                              <!-- Download SVG icon from http://tabler.io/icons/icon/alert-triangle -->
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="icon mb-2 text-danger icon-lg">
                                <path d="M12 9v4" />
                                <path
                                  d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
                                <path d="M12 16h.01" />
                              </svg>
                              <div class="text-secondary">
                                Você realmente deseja excluir este faturamento?
                              </div>
                            </div>
                            <div class="modal-footer">
                              <div class="w-100">
                                <div class="row">
                                  <div class="col">
                                    <a href="#" class="btn btn-3 w-100" data-bs-dismiss="modal">
                                      Fechar
                                    </a>
                                  </div>
                                  <div class="col">
                                    <a href="{{url_for('excluir_faturamento_a_pagar', faturamento_id=faturamento.id)}}"
                                      class="btn btn-danger btn-4 w-100">
                                      Excluir
                                    </a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                      {% if dados_corretos.get('situacaoFaturamento')|string == '8' %}
                      <button type="button" class="btn btn-icon btn-outline-danger" data-bs-toggle="modal"
                        data-bs-target="#modal-reverter-conciliacao-{{ faturamento.id }}" title="Reverter Conciliação">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-back-up">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M9 14l-4 -4l4 -4" />
                          <path d="M5 10h11a4 4 0 1 1 0 8h-1" />
                        </svg>
                      </button>
                      <!-- Modal de Confirmação para Reverter Conciliação -->
                      <div class="modal modal-blur fade" id="modal-reverter-conciliacao-{{ faturamento.id }}" tabindex="-1"
                        role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                          <div class="modal-content">
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            <div class="modal-status bg-warning"></div>
                            <div class="modal-body text-center py-4">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="icon mb-2 text-warning icon-lg">
                                <path d="M12 9v4" />
                                <path
                                  d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
                                <path d="M12 16h.01" />
                              </svg>
                              <h3 class="mb-2">Reverter Conciliação</h3>
                              <div class="text-secondary">
                                <p class="mb-2">Você realmente deseja reverter a conciliação do faturamento <strong>{{ faturamento.codigo_faturamento }}</strong>?</p>
                                <small class="text-muted">
                                  Esta ação irá:
                                  <ul class="text-start mt-2" style="font-size: 12px;">
                                    <li>Desvincular da transação OFX</li>
                                    <li>Retornar para status "Pendente"</li>
                                    <li>Remover movimentações financeiras</li>
                                    <li>Reembolsar créditos/adiantamentos (se houver)</li>
                                  </ul>
                                </small>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <div class="w-100">
                                <div class="row">
                                  <div class="col">
                                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">
                                      Cancelar
                                    </button>
                                  </div>
                                  <div class="col">
                                    <button type="button" class="btn btn-warning w-100"
                                      onclick="confirmarReverterConciliacao({{ faturamento.id }})">
                                      Confirmar
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% else %}
        <div class="area-info-card"
          style="padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2); background-color: white;">
          <div class="icon-extrato" style="font-size: 70px; color: #fc7801; margin-bottom: 15px">❌</div>
          <h2 style="font-size: 22px; margin-bottom: 10px; color: #555;">Nenhum faturamento disponível</h2>
          <p style="color: #777;">No momento não há faturamentos para serem exibidos.</p>
        </div>
        {%endif%}
      </div>
    </div>
  </div>

  <!-- Filtro -->
  <div class="modal modal-blur fade" id="modal-report" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document" style="display: grid;">
      <form action="" method="GET">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Filtrar Faturamentos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Beneficiário</label>
                <select class="form-select" name="beneficiario" id="beneficiario">
                  <option value="">Todos os Beneficiários</option>
                  {% for b in beneficiarios %}
                  <option value="{{ b.id }}" {% if dados_corretos.get('beneficiario')==b.id|string %}selected{% endif
                    %}>
                    {{ b.identificacao }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Situação Faturamento</label>
                <select class="form-select" name="situacaoFaturamento" id="situacaoFaturamento">
                  <option value="">Todas as Situações</option>
                  {% for s in situacoes_faturamento %}
                  <option value="{{ s.id }}" {% if dados_corretos.get('situacaoFaturamento')==s.id|string %}selected{%
                    endif %}>
                    {{ s.situacao }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <a href="{{ url_for('listagem_faturamentos_cargas_a_pagar') }}" class="btn btn-link link-secondary btn-3">
              Limpar Filtros
            </a>
            <button type="submit" class="btn btn-primary btn-5 ms-auto">
              <!-- Download SVG icon from http://tabler.io/icons/icon/plus -->
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-2">
                <path d="M12 5l0 14" />
                <path d="M5 12l14 0" />
              </svg>
              Filtrar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal modal-blur fade" id="modal-dados-bancarios" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-0"
          style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
          <h4 class="modal-title text-white fw-bold">
            Dados Bancários
          </h4>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body p-0">
          <div id="loading-dados-bancarios" class="text-center py-5" style="display: none;">
            <div class="spinner-border" style="color: #28a745;" role="status">
              <span class="visually-hidden">Carregando...</span>
            </div>
            <div class="mt-3 text-muted">Carregando dados bancários...</div>
          </div>

          <div id="conteudo-dados-bancarios" class="p-4">
            <!-- Conteúdo será preenchido dinamicamente -->
          </div>
        </div>

        <div class="modal-footer border-0" style="background: #f8f9fa; padding: 1rem 2rem;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Fechar
          </button>
          <button type="button" class="btn btn-secondary" id="btn-copiar-todos">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />
              <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" />
            </svg>
            Copiar Todos
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal modal-blur fade" id="modal-faturamento" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-0"
          style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
          <h4 class="modal-title text-white fw-bold">
            <span id="modal-faturamento-id"></span>
          </h4>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body p-0">
          <div id="loading-faturamento" class="text-center py-5">
            <div class="spinner-border" style="color: #1B5E20;" role="status">
              <span class="visually-hidden">Carregando...</span>
            </div>
            <div class="mt-3 text-muted">Carregando detalhes do faturamento...</div>
          </div>

          <div id="conteudo-faturamento" style="display: none;">

            <div class="p-4">
              <!-- Fornecedores -->
              <div class="mb-5" id="secao-fornecedores">
                <div class="d-flex align-items-center justify-content-between mb-4">
                  <div class="d-flex align-items-center">
                    <div>
                      <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Fornecedores</h5>
                      <div class="text-muted">
                        <span id="total-fornecedores">0</span> registro(s) •
                        <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-fornecedores">R$
                          0,00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="lista-fornecedores"></div>
              </div>

              <!-- Transportadoras -->
              <div id="secao-transportadoras">
                <div class="d-flex align-items-center justify-content-between mb-4">
                  <div class="d-flex align-items-center">
                    <div>
                      <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Transportadoras</h5>
                      <div class="text-muted">
                        <span id="total-transportadoras">0</span> registro(s) •
                        <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-transportadoras">R$
                          0,00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="lista-transportadoras"></div>
              </div>
              <!-- Extratores -->
              <div id="secao-extratores">
                <div class="d-flex align-items-center justify-content-between mb-4">
                  <div class="d-flex align-items-center">
                    <div>
                      <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Extratores</h5>
                      <div class="text-muted">
                        <span id="total-extratores">0</span> registro(s) •
                        <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-extratores">R$
                          0,00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="lista-extratores"></div>
              </div>
              <!-- Comissionados -->
              <div id="secao-comissionados">
                <div class="d-flex align-items-center justify-content-between mb-4">
                  <div class="d-flex align-items-center">
                    <div>
                      <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Comissionados</h5>
                      <div class="text-muted">
                        <span id="total-comissionados">0</span> registro(s) •
                        <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-comissionados">R$
                          0,00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="lista-comissionados"></div>
              </div>
              <!-- Receitas Avulsas -->
              <div id="secao-receitas-avulsas">
                <div class="d-flex align-items-center justify-content-between mb-4">
                  <div class="d-flex align-items-center">
                    <div>
                      <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Receitas Avulsas</h5>
                      <div class="text-muted">
                        <span id="total-receitas-avulsas">0</span> registro(s) •
                        <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-receitas-avulsas">R$
                          0,00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="lista-receitas-avulsas"></div>
              </div>
              <!-- Despesas Avulsas -->
              <div id="secao-despesas-avulsas">
                <div class="d-flex align-items-center justify-content-between mb-4">
                  <div class="d-flex align-items-center">
                    <div>
                      <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Despesas Avulsas</h5>
                      <div class="text-muted">
                        <span id="total-despesas-avulsas">0</span> registro(s) •
                        <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-despesas-avulsas">R$
                          0,00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="lista-despesas-avulsas"></div>
              </div>
              <!-- Créditos Utilizados -->
              <div id="secao-creditos-utilizados">
                <div class="d-flex align-items-center justify-content-between mb-4">
                  <div class="d-flex align-items-center">
                    <div>
                      <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Créditos Utilizados</h5>
                      <div class="text-muted">
                        <span id="total-creditos-utilizados">0</span> registro(s) •
                        <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-creditos-utilizados">R$
                          0,00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="lista-creditos-utilizados"></div>
              </div>
              <!-- Resumo Financeiro Destacado -->
              <div class="p-4"
                style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-top: 1px solid #dee2e6;">
                <div class="row g-4">
                  <div class="col-md-3 text-center">
                    <div class="mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                      </svg>
                    </div>
                    <div class="text-muted small fw-medium text-uppercase">Valor Bruto</div>
                    <div class="mb-0" id="info-valor-bruto">-</div>
                  </div>
                  <div class="col-md-3 text-center">
                    <div class="mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 6v6l4 2" />
                      </svg>
                    </div>
                    <div class="text-muted small fw-medium text-uppercase">Crédito Aplicado</div>
                    <div class="mb-0" id="info-valor-credito">-</div>
                  </div>
                  <div class="col-md-3 text-center">
                    <div class="mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="#1B5E20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon-tabler icons-tabler-outline icon-tabler-basket-dollar">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M17 10l-2 -6" />
                        <path d="M7 10l2 -6" />
                        <path
                          d="M13 20h-5.756a3 3 0 0 1 -2.965 -2.544l-1.255 -7.152a2 2 0 0 1 1.977 -2.304h13.999a2 2 0 0 1 1.977 2.304" />
                        <path d="M10 14a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                        <path d="M21 15h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" />
                        <path d="M19 21v1m0 -8v1" />
                      </svg>
                    </div>
                    <div class="text-muted small fw-medium text-uppercase">Valor Final</div>
                    <div class="mb-0" id="info-valor-total">-</div>
                  </div>
                  <div class="col-md-3 text-center">
                    <div class="mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                      </svg>
                    </div>
                    <div class="text-muted small fw-medium text-uppercase">Data</div>
                    <div id="info-data">-</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0" style="background: #f8f9fa; padding: 1rem 2rem;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Exportar PDF -->
  <div class="modal modal-blur fade" id="modal-exportar-pdf" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-0"
          style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
          <h4 class="modal-title text-white fw-bold">
            Exportar Faturamento para PDF
          </h4>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body p-4">
          <div class="mb-4">
            <h6 class="mb-3 fw-bold text-muted">Selecione as informações que deseja OCULTAR no PDF:</h6>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="ocultar-fornecedores">
              <label class="form-check-label d-flex align-items-center" for="ocultar-fornecedores">
                <span class="fw-medium">Ocultar Informações dos Fornecedores</span>
              </label>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="ocultar-transportadoras">
              <label class="form-check-label d-flex align-items-center" for="ocultar-transportadoras">
                <span class="fw-medium">Ocultar Informações das Transportadoras</span>
              </label>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="ocultar-cliente">
              <label class="form-check-label d-flex align-items-center" for="ocultar-cliente">
                <span class="fw-medium">Ocultar Informações do Cliente</span>
              </label>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0" style="background: #f8f9fa; padding: 1rem 2rem;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-secondary" id="btn-gerar-pdf">
            Gerar PDF
          </button>
        </div>
      </div>
    </div>
  </div>


</div>

{% include 'estrutura/footer.html' %}
</div>

<script>
  // Variável global para o modal PDF
  let faturamentoParaPDF = null;
  let faturamentoParaImagem = null;

  // Inicialização quando DOM carregar
  document.addEventListener('DOMContentLoaded', function () {
    // Inicializar TomSelect
    document.querySelectorAll('select.form-select').forEach(function (select) {
      new TomSelect(select, {
        create: false,
        allowEmptyOption: false,
        sortField: { field: "text", direction: "asc" }
      });
    });

    // Event listeners para visualizar faturamentos
    document.querySelectorAll('[data-faturamento-id]').forEach(button => {
      button.addEventListener('click', function () {
        const faturamentoId = this.getAttribute('data-faturamento-id');
        visualizarFaturamento(faturamentoId);
      });
    });

    // Carregar beneficiários para cada faturamento
    carregarBeneficiariosFaturamentos();
  });

  // ===== FUNÇÃO PARA CARREGAR BENEFICIÁRIOS =====
  function carregarBeneficiariosFaturamentos() {
    // Buscar todos os elementos de beneficiários na tabela
    document.querySelectorAll('[id^="beneficiario-"]').forEach(elemento => {
      const faturamentoId = elemento.id.replace('beneficiario-', '');
      carregarBeneficiarioFaturamento(faturamentoId);
    });
  }

  function carregarBeneficiarioFaturamento(faturamentoId) {
    // Fazer requisição direta sempre
    fetch(`/financeiro/faturamentos/detalhes/${faturamentoId}`)
      .then(response => response.text())
      .then(text => {
        try {
          const data = JSON.parse(text);
          if (data.erro) {
            const elemento = document.getElementById(`beneficiario-${faturamentoId}`);
            if (elemento) {
              const nomeElemento = elemento.querySelector('.beneficiario-nome');
              if (nomeElemento) {
                nomeElemento.textContent = 'N/A';
              }
            }
            return;
          }
          processarBeneficiarios(faturamentoId, data);
        } catch (e) {
          // Se não for JSON válido, definir como "N/A" silenciosamente
          const elemento = document.getElementById(`beneficiario-${faturamentoId}`);
          if (elemento) {
            const nomeElemento = elemento.querySelector('.beneficiario-nome');
            if (nomeElemento) {
              nomeElemento.textContent = 'N/A';
            }
          }
        }
      })
      .catch(() => {
        // Em caso de erro, definir como "N/A" silenciosamente
        const elemento = document.getElementById(`beneficiario-${faturamentoId}`);
        if (elemento) {
          const nomeElemento = elemento.querySelector('.beneficiario-nome');
          if (nomeElemento) {
            nomeElemento.textContent = 'N/A';
          }
        }
      });
  }

  function processarBeneficiarios(faturamentoId, data) {
    const elemento = document.getElementById(`beneficiario-${faturamentoId}`);
    const nomeElemento = elemento.querySelector('.beneficiario-nome');

    // Coletar todos os nomes únicos organizados por categoria
    const beneficiarios = {
      fornecedores: new Set(),
      transportadoras: new Set(),
      extratores: new Set(),
      comissionados: new Set()
    };

    // Adicionar fornecedores
    if (data.fornecedores && data.fornecedores.length > 0) {
      data.fornecedores.forEach(f => {
        if (f.fornecedor_identificacao) {
          beneficiarios.fornecedores.add(f.fornecedor_identificacao);
        }
      });
    }

    // Adicionar transportadoras  
    if (data.transportadoras && data.transportadoras.length > 0) {
      data.transportadoras.forEach(t => {
        if (t.transportadora_identificacao) {
          beneficiarios.transportadoras.add(t.transportadora_identificacao);
        }
      });
    }

    // Adicionar extratores
    if (data.extratores && data.extratores.length > 0) {
      data.extratores.forEach(e => {
        if (e.nome) {
          beneficiarios.extratores.add(e.nome);
        }
      });
    }

    // Adicionar comissionados
    if (data.comissionados && data.comissionados.length > 0) {
      data.comissionados.forEach(c => {
        if (c.nome) {
          beneficiarios.comissionados.add(c.nome);
        }
      });
    }

    // Converter Sets para Arrays e coletar todos os nomes únicos
    const todosNomes = new Set();
    let primeiroNome = null;

    // Coletar todos os nomes únicos e pegar o primeiro
    Object.values(beneficiarios).forEach(categoria => {
      Array.from(categoria).forEach(nome => {
        if (!primeiroNome) primeiroNome = nome;
        todosNomes.add(nome);
      });
    });

    const nomesArray = Array.from(todosNomes);

    if (nomesArray.length === 0) {
      nomeElemento.textContent = 'N/A';
    } else if (nomesArray.length === 1) {
      // Apenas um nome, não precisa de tooltip
      nomeElemento.textContent = primeiroNome;
    } else {
      // Múltiplos nomes, mostrar o primeiro e criar tooltip
      nomeElemento.textContent = primeiroNome;

      // Criar tooltip organizado por categoria usando HTML
      let tooltipHtml = '<div style="text-align: left;">';

      if (beneficiarios.fornecedores.size > 0) {
        tooltipHtml += '<strong>Fornecedores:</strong><br>';
        Array.from(beneficiarios.fornecedores).forEach(nome => {
          tooltipHtml += `• ${nome}<br>`;
        });
        tooltipHtml += '<br>';
      }

      if (beneficiarios.transportadoras.size > 0) {
        tooltipHtml += '<strong>Transportadoras:</strong><br>';
        Array.from(beneficiarios.transportadoras).forEach(nome => {
          tooltipHtml += `• ${nome}<br>`;
        });
        tooltipHtml += '<br>';
      }

      if (beneficiarios.extratores.size > 0) {
        tooltipHtml += '<strong>Extratores:</strong><br>';
        Array.from(beneficiarios.extratores).forEach(nome => {
          tooltipHtml += `• ${nome}<br>`;
        });
        tooltipHtml += '<br>';
      }

      if (beneficiarios.comissionados.size > 0) {
        tooltipHtml += '<strong>Comissionados:</strong><br>';
        Array.from(beneficiarios.comissionados).forEach(nome => {
          tooltipHtml += `• ${nome}<br>`;
        });
      }

      tooltipHtml += '</div>';

      // Adicionar ícone indicativo de mais informações
      nomeElemento.innerHTML = `${primeiroNome} <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-primary"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>`;

      // Inicializar tooltip do Bootstrap com HTML habilitado
      new bootstrap.Tooltip(elemento, {
        html: true,
        title: tooltipHtml,
        placement: 'top'
      });
    }
  }

  // ===== FUNÇÕES PRINCIPAIS =====

  function visualizarFaturamento(id) {
    const modal = new bootstrap.Modal(document.getElementById('modal-faturamento'));
    modal.show();

    document.getElementById('loading-faturamento').style.display = 'block';
    document.getElementById('conteudo-faturamento').style.display = 'none';

    fetch(`/financeiro/faturamentos/detalhes/${id}`)
      .then(response => response.json())
      .then(data => {
        if (data.erro) {
          alert('Erro: ' + data.erro);
          modal.hide();
          return;
        }

        processarDadosModal(data);
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao carregar os detalhes do faturamento');
        modal.hide();
      });
  }

  function processarDadosModal(data) {
    // Preencher informações
    document.getElementById('info-data').textContent = data.faturamento.data_cadastro;
    document.getElementById('info-valor-bruto').textContent = data.faturamento.valor_bruto_total;
    document.getElementById('info-valor-credito').textContent = data.faturamento.valor_credito_aplicado;
    document.getElementById('info-valor-total').textContent = data.faturamento.valor_total;
    document.getElementById('modal-faturamento-id').textContent = data.faturamento.codigo_faturamento;

    // Processar dados
    processarFornecedores(data.fornecedores || []);
    processarTransportadoras(data.transportadoras || []);
    processarExtratores(data.extratores || []);
    processarComissionados(data.comissionados || []);
    processarReceitasAvulsas(data.receitas_avulsas || []);
    processarDespesasAvulsas(data.despesas_avulsas || []);
    processarCreditosUtilizados(data.creditos_utilizados || []);

    // Verificar se não há dados para mostrar mensagem informativa
    verificarDadosVazios(data.fornecedores || [], data.transportadoras || [], data.extratores || [], data.comissionados || [], data.receitas_avulsas || [], data.despesas_avulsas || [], data.creditos_utilizados || []);

    // Contadores
    document.getElementById('total-fornecedores').textContent = data.faturamento.total_fornecedores;
    document.getElementById('total-transportadoras').textContent = data.faturamento.total_transportadoras;
    document.getElementById('total-extratores').textContent = data.faturamento.total_extratores;
    document.getElementById('total-comissionados').textContent = data.faturamento.total_comissionados;
    document.getElementById('total-receitas-avulsas').textContent = data.faturamento.total_receitas_avulsas || 0;
    document.getElementById('total-despesas-avulsas').textContent = data.faturamento.total_despesas_avulsas || 0;
    document.getElementById('total-creditos-utilizados').textContent = (data.creditos_utilizados || []).length;

    document.getElementById('loading-faturamento').style.display = 'none';
    document.getElementById('conteudo-faturamento').style.display = 'block';
  }

  function processarFornecedores(fornecedores) {
    const container = document.getElementById('lista-fornecedores');
    const secaoFornecedores = document.getElementById('secao-fornecedores');

    container.innerHTML = '';

    if (!fornecedores.length) {
      // Esconder a seção inteira quando não há fornecedores
      secaoFornecedores.style.display = 'none';
      document.getElementById('total-valor-fornecedores').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a seção quando há fornecedores
    secaoFornecedores.style.display = 'block';

    // Agrupar e processar
    const grupos = {};
    let totalGeral = 0;

    fornecedores.forEach(item => {
      const nome = item.fornecedor_identificacao;
      if (!grupos[nome]) {
        grupos[nome] = { registros: [], total: 0 };
      }
      grupos[nome].registros.push(item);
      const valor = parseFloat(item.valor_faturado.replace(/[R$\s.]/g, '').replace(',', '.'));
      grupos[nome].total += valor;
      totalGeral += valor;
    });

    document.getElementById('total-valor-fornecedores').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar grupos
    Object.entries(grupos).forEach(([nome, grupo]) => {
      const card = document.createElement('div');
      card.className = 'card mb-4 shadow-sm';
      card.style.borderRadius = '12px';
      card.style.border = '1px solid #e3e6f0';

      card.innerHTML = `
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div>
                <h6 class="mb-0 fw-bold">${nome}</h6>
                <small class="text-muted">${grupo.registros.length} registro(s)</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th class="fw-semibold text-center">Data Entrega</th>
                  <th class="fw-semibold text-center">Produto | Bitola</th>
                  <th class="fw-semibold text-center">NF</th>
                  <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                  <th class="fw-semibold text-center text-end">Preço Custo</th>
                  <th class="fw-semibold text-center text-end">Valor Bruto</th>
                  <th class="fw-semibold text-center text-end">Valor Final</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.registros.map(r => `
                  <tr>
                    <td class="text-center">${r.data_entrega}</td>
                    <td class="text-center">${r.produto} | ${r.bitola}</td>
                    <td class="text-center">${r.nota_fiscal}</td>
                    <td class="text-center">${r.peso_ticket}</td>
                    <td class="text-center">${r.preco_custo}</td>
                    <td class="text-center">${r.valor_bruto}</td>
                    <td class="text-center">
                      <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor_faturado}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function processarTransportadoras(transportadoras) {
    const container = document.getElementById('lista-transportadoras');
    const secaoTransportadoras = document.getElementById('secao-transportadoras');

    container.innerHTML = '';

    if (!transportadoras.length) {
      // Esconder a seção inteira quando não há transportadoras
      secaoTransportadoras.style.display = 'none';
      document.getElementById('total-valor-transportadoras').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a seção quando há transportadoras
    secaoTransportadoras.style.display = 'block';

    // Agrupar e processar
    const grupos = {};
    let totalGeral = 0;

    transportadoras.forEach(item => {
      const nome = item.transportadora_identificacao;
      if (!grupos[nome]) {
        grupos[nome] = { registros: [], total: 0 };
      }
      grupos[nome].registros.push(item);
      const valor = parseFloat(item.valor_faturado.replace(/[R$\s.]/g, '').replace(',', '.'));
      grupos[nome].total += valor;
      totalGeral += valor;
    });

    document.getElementById('total-valor-transportadoras').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar grupos
    Object.entries(grupos).forEach(([nome, grupo]) => {
      console.log('nome', nome);
      const card = document.createElement('div');
      card.className = 'card mb-4 shadow-sm';
      card.style.borderRadius = '12px';
      card.style.border = '1px solid #e3e6f0';

      card.innerHTML = `
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div>
                <h6 class="mb-0 fw-bold">${nome}</h6>
                <small class="text-muted">${grupo.registros.length} registro(s)</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th class="fw-semibold text-center">Data Entrega</th>
                  <th class="fw-semibold text-center">Produto | Bitola</th>
                  <th class="fw-semibold text-center">NF</th>
                  <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                  <th class="fw-semibold text-center text-end">Preço Custo</th>
                  <th class="fw-semibold text-center text-end">Valor Bruto</th>
                  <th class="fw-semibold text-center text-end">Valor Final</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.registros.map(r => `
                  <tr>
                    <td class="text-center">${r.data_entrega}</td>
                    <td class="text-center">${r.produto} | ${r.bitola}</td>
                    <td class="text-center">${r.nota_fiscal}</td>
                    <td class="text-center">${r.peso_ticket}</td>
                    <td class="text-center">${r.preco_custo}</td>
                    <td class="text-center">${r.valor_bruto}</td>
                    <td class="text-center">
                      <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor_faturado}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function processarExtratores(extratores) {
    const container = document.getElementById('lista-extratores');
    const secaoExtratores = document.getElementById('secao-extratores');

    container.innerHTML = '';

    if (!extratores.length) {
      // Esconder a seção inteira quando não há extratores
      secaoExtratores.style.display = 'none';
      document.getElementById('total-valor-extratores').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a seção quando há extratores
    secaoExtratores.style.display = 'block';

    // Agrupar e processar
    const grupos = {};
    let totalGeral = 0;

    extratores.forEach(item => {
      const nome = item.nome;
      if (!grupos[nome]) {
        grupos[nome] = { registros: [], total: 0 };
      }
      grupos[nome].registros.push(item);
      const valor = parseFloat(item.valor_faturado.replace(/[R$\s.]/g, '').replace(',', '.'));
      grupos[nome].total += valor;
      totalGeral += valor;
    });

    document.getElementById('total-valor-extratores').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar grupos
    Object.entries(grupos).forEach(([nome, grupo]) => {
      console.log('nome', nome);
      const card = document.createElement('div');
      card.className = 'card mb-4 shadow-sm';
      card.style.borderRadius = '12px';
      card.style.border = '1px solid #e3e6f0';

      card.innerHTML = `
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div>
                <h6 class="mb-0 fw-bold">${nome}</h6>
                <small class="text-muted">${grupo.registros.length} registro(s)</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th class="fw-semibold text-center">Data Entrega</th>
                  <th class="fw-semibold text-center">Produto | Bitola</th>
                  <th class="fw-semibold text-center">NF</th>
                  <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                  <th class="fw-semibold text-center text-end">Preço Custo</th>
                  <th class="fw-semibold text-center text-end">Valor Bruto</th>
                  <th class="fw-semibold text-center text-end">Valor Final</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.registros.map(r => `
                  <tr>
                    <td class="text-center">${r.data_entrega}</td>
                    <td class="text-center">${r.produto} | ${r.bitola}</td>
                    <td class="text-center">${r.nota_fiscal}</td>
                    <td class="text-center">${r.peso_ticket}</td>
                    <td class="text-center">${r.preco_custo}</td>
                    <td class="text-center">${r.valor_bruto}</td>
                    <td class="text-center">
                      <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor_faturado}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function processarComissionados(comissionados) {
    const container = document.getElementById('lista-comissionados');
    const secaoComissionados = document.getElementById('secao-comissionados');

    container.innerHTML = '';

    if (!comissionados.length) {
      // Esconder a seção inteira quando não há comissionados
      secaoComissionados.style.display = 'none';
      document.getElementById('total-valor-comissionados').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a seção quando há comissionados
    secaoComissionados.style.display = 'block';

    // Agrupar e processar
    const grupos = {};
    let totalGeral = 0;

    comissionados.forEach(item => {
      const nome = item.nome;
      if (!grupos[nome]) {
        grupos[nome] = { registros: [], total: 0 };
      }
      grupos[nome].registros.push(item);
      const valor = parseFloat(item.valor_faturado.replace(/[R$\s.]/g, '').replace(',', '.'));
      grupos[nome].total += valor;
      totalGeral += valor;
    });

    document.getElementById('total-valor-comissionados').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar grupos
    Object.entries(grupos).forEach(([nome, grupo]) => {
      console.log('nome', nome);
      const card = document.createElement('div');
      card.className = 'card mb-4 shadow-sm';
      card.style.borderRadius = '12px';
      card.style.border = '1px solid #e3e6f0';

      card.innerHTML = `
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div>
                <h6 class="mb-0 fw-bold">${nome}</h6>
                <small class="text-muted">${grupo.registros.length} registro(s)</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th class="fw-semibold text-center">Data Entrega</th>
                  <th class="fw-semibold text-center">Produto | Bitola</th>
                  <th class="fw-semibold text-center">NF</th>
                  <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                  <th class="fw-semibold text-center text-end">Preço Custo</th>
                  <th class="fw-semibold text-center text-end">Valor Bruto</th>
                  <th class="fw-semibold text-center text-end">Valor Final</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.registros.map(r => `
                  <tr>
                    <td class="text-center">${r.data_entrega}</td>
                    <td class="text-center">${r.produto} | ${r.bitola}</td>
                    <td class="text-center">${r.nota_fiscal}</td>
                    <td class="text-center">${r.peso_ticket}</td>
                    <td class="text-center">${r.preco_custo}</td>
                    <td class="text-center">${r.valor_bruto}</td>
                    <td class="text-center">
                      <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor_faturado}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function processarReceitasAvulsas(receitasAvulsas) {
    const container = document.getElementById('lista-receitas-avulsas');
    const secaoReceitasAvulsas = document.getElementById('secao-receitas-avulsas');

    container.innerHTML = '';

    if (!receitasAvulsas.length) {
      // Esconder a seção inteira quando não há receitas avulsas
      secaoReceitasAvulsas.style.display = 'none';
      document.getElementById('total-valor-receitas-avulsas').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a seção quando há receitas avulsas
    secaoReceitasAvulsas.style.display = 'block';

    let totalGeral = 0;

    receitasAvulsas.forEach(item => {
      const valor = parseFloat(item.valor.replace(/[R$\s.]/g, '').replace(',', '.'));
      totalGeral += valor;
    });

    document.getElementById('total-valor-receitas-avulsas').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar card único para receitas avulsas
    const card = document.createElement('div');
    card.className = 'card mb-4 shadow-sm';
    card.style.borderRadius = '12px';
    card.style.border = '1px solid #e3e6f0';

    card.innerHTML = `
      <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div>
              <h6 class="mb-0 fw-bold">Receitas Avulsas</h6>
              <small class="text-muted">${receitasAvulsas.length} receita(s)</small>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead style="background: #f8f9fa;">
              <tr>
                <th class="fw-semibold text-center">Descrição</th>
                <th class="fw-semibold text-center">Conta Bancária</th>
                <th class="fw-semibold text-center">Data Cadastro</th>
                <th class="fw-semibold text-center text-end">Valor</th>
              </tr>
            </thead>
            <tbody>
              ${receitasAvulsas.map(r => `
                <tr>
                  <td class="text-center">${r.descricao}</td>
                  <td class="text-center">${r.conta_bancaria}</td>
                  <td class="text-center">${r.data_cadastro}</td>
                  <td class="text-center">
                    <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor}</span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    container.appendChild(card);
  }

  function processarDespesasAvulsas(despesasAvulsas) {
    const container = document.getElementById('lista-despesas-avulsas');
    const secaoDespesasAvulsas = document.getElementById('secao-despesas-avulsas');

    container.innerHTML = '';

    if (!despesasAvulsas.length) {
      // Esconder a seção inteira quando não há despesas avulsas
      secaoDespesasAvulsas.style.display = 'none';
      document.getElementById('total-valor-despesas-avulsas').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a seção quando há despesas avulsas
    secaoDespesasAvulsas.style.display = 'block';

    let totalGeral = 0;

    despesasAvulsas.forEach(item => {
      const valor = parseFloat(item.valor.replace(/[R$\s.]/g, '').replace(',', '.'));
      totalGeral += valor;
    });

    document.getElementById('total-valor-despesas-avulsas').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar card único para despesas avulsas
    const card = document.createElement('div');
    card.className = 'card mb-4 shadow-sm';
    card.style.borderRadius = '12px';
    card.style.border = '1px solid #e3e6f0';

    card.innerHTML = `
      <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div>
              <h6 class="mb-0 fw-bold">Despesas Avulsas</h6>
              <small class="text-muted">${despesasAvulsas.length} despesa(s)</small>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead style="background: #f8f9fa;">
              <tr>
                <th class="fw-semibold text-center">Descrição</th>
                <th class="fw-semibold text-center">Conta Bancária</th>
                <th class="fw-semibold text-center">Data Cadastro</th>
                <th class="fw-semibold text-center text-end">Valor</th>
              </tr>
            </thead>
            <tbody>
              ${despesasAvulsas.map(d => `
                <tr>
                  <td class="text-center">${d.descricao}</td>
                  <td class="text-center">${d.conta_bancaria}</td>
                  <td class="text-center">${d.data_cadastro}</td>
                  <td class="text-center">
                    <span class="badge badge-outline text-danger">${d.valor}</span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    container.appendChild(card);
  }

  function processarCreditosUtilizados(creditosUtilizados) {
    const container = document.getElementById('lista-creditos-utilizados');
    const secaoCreditosUtilizados = document.getElementById('secao-creditos-utilizados');

    container.innerHTML = '';

    if (!creditosUtilizados.length) {
      // Esconder a seção inteira quando não há créditos utilizados
      secaoCreditosUtilizados.style.display = 'none';
      document.getElementById('total-valor-creditos-utilizados').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a seção quando há créditos utilizados
    secaoCreditosUtilizados.style.display = 'block';

    let totalGeral = 0;

    creditosUtilizados.forEach(item => {
      const valor = parseFloat(item.valor_utilizado.replace(/[R$\s.]/g, '').replace(',', '.'));
      totalGeral += valor;
    });

    document.getElementById('total-valor-creditos-utilizados').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar card único para créditos utilizados
    const card = document.createElement('div');
    card.className = 'card mb-4 shadow-sm';
    card.style.borderRadius = '12px';
    card.style.border = '1px solid #e3e6f0';

    card.innerHTML = `
      <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div>
              <h6 class="mb-0 fw-bold">Créditos Utilizados</h6>
              <small class="text-muted">${creditosUtilizados.length} crédito(s)</small>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead style="background: #f8f9fa;">
              <tr>
                <th class="fw-semibold text-center">Categoria</th>
                <th class="fw-semibold text-center">Descrição do Crédito</th>
                <th class="fw-semibold text-center">Valor Utilizado</th>
              </tr>
            </thead>
            <tbody>
              ${creditosUtilizados.map(c => `
                <tr>
                  <td class="text-center">
                    <b style="color: #1B5E20">${c.categoria}</b>
                  </td>
                  <td class="text-center">${c.descricao}</td>
                  <td class="text-center">
                    <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${c.valor_utilizado}</span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    container.appendChild(card);
  }

  // ===== FUNÇÕES DE DADOS BANCÁRIOS =====

  function copiarDadosBancariosFaturamento(faturamentoId) {
    const modalElement = document.getElementById('modal-dados-bancarios');
    let modal;

    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        modal = new bootstrap.Modal(modalElement);
      } else {
        // Fallback manual
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');
      }
    } catch (error) {
      console.log('Erro ao abrir modal:', error);
      modalElement.style.display = 'block';
      modalElement.classList.add('show');
      document.body.classList.add('modal-open');
    }

    // Mostrar loading
    document.getElementById('loading-dados-bancarios').style.display = 'block';
    document.getElementById('conteudo-dados-bancarios').innerHTML = '';

    if (modal && modal.show) {
      modal.show();
    }

    fetch(`/financeiro/faturamentos/dados-bancarios/${faturamentoId}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('loading-dados-bancarios').style.display = 'none';

        if (data.erro) {
          mostrarErroDadosBancarios(data.erro);
          return;
        }

        mostrarDadosBancarios(data);

        // Configurar botão copiar todos
        document.getElementById('btn-copiar-todos').onclick = function () {
          copiarTodosDados(data);
        };
      })
      .catch(error => {
        document.getElementById('loading-dados-bancarios').style.display = 'none';
        console.error('Erro:', error);
        mostrarErroDadosBancarios('Erro ao buscar dados bancários');
      });
  }

  function copiarDadosBancarios(tipo, nome, id) {
    const modal = new bootstrap.Modal(document.getElementById('modal-dados-bancarios'));

    // Mostrar loading
    document.getElementById('loading-dados-bancarios').style.display = 'block';
    document.getElementById('conteudo-dados-bancarios').innerHTML = '';

    modal.show();

    fetch(`/financeiro/${tipo}s/dados-bancarios/${id}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('loading-dados-bancarios').style.display = 'none';

        if (data.erro) {
          mostrarErroDadosBancarios(data.erro);
          return;
        }

        // Simular estrutura de dados única
        const dadosFormatados = {};
        if (tipo === 'fornecedor') {
          dadosFormatados.fornecedores = [data];
          dadosFormatados.transportadoras = [];
          dadosFormatados.extratores = [];
        } else if (tipo === 'transportadora') {
          dadosFormatados.fornecedores = [];
          dadosFormatados.transportadoras = [];
          dadosFormatados.extratores = [];
        } else {
          dadosFormatados.fornecedores = [];
          dadosFormatados.transportadoras = [];
          dadosFormatados.extratores = [data];
        }

        mostrarDadosBancarios(dadosFormatados);

        // Configurar botão copiar
        document.getElementById('btn-copiar-todos').onclick = function () {
          copiarDadosIndividual(tipo.toUpperCase(), data);
        };
      })
      .catch(error => {
        document.getElementById('loading-dados-bancarios').style.display = 'none';
        console.error('Erro:', error);
        mostrarErroDadosBancarios('Erro ao buscar dados bancários');
      });
  }

  function mostrarDadosBancarios(data) {
    const container = document.getElementById('conteudo-dados-bancarios');
    let html = '';

    // Mostrar fornecedores
    if (data.fornecedores && data.fornecedores.length > 0) {
      html += `
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0 fw-bold" style="color: #1c5f20;">Fornecedores</h5>
          </div>
      `;

      data.fornecedores.forEach(fornecedor => {
        html += criarCardDadosBancarios('FORNECEDOR', fornecedor);
      });

      html += '</div>';
    }

    // Mostrar transportadoras
    if (data.transportadoras && data.transportadoras.length > 0) {
      html += `
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0 fw-bold" style="color: #1c5f20;">Transportadoras</h5>
          </div>
      `;

      data.transportadoras.forEach(transportadora => {
        html += criarCardDadosBancarios('TRANSPORTADORA', transportadora);
      });

      html += '</div>';
    }

    // Mostrar extratores
    if (data.extratores && data.extratores.length > 0) {
      html += `
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0 fw-bold" style="color: #1c5f20;">Extratores</h5>
          </div>
      `;

      data.extratores.forEach(extrator => {
        html += criarCardDadosBancarios('EXTRATOR', extrator);
      });

      html += '</div>';
    }

    // Mostrar comissionados
    if (data.comissionados && data.comissionados.length > 0) {
      html += `
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0 fw-bold" style="color: #1c5f20;">Comissionados</h5>
          </div>
      `;

      data.comissionados.forEach(comissionado => {
        html += criarCardDadosBancarios('COMISSIONADO', comissionado);
      });

      html += '</div>';
    }

    // Mostrar receitas avulsas
    if (data.receitas_avulsas && data.receitas_avulsas.length > 0) {
      html += `
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0 fw-bold" style="color: #1c5f20;">Receitas Avulsas</h5>
          </div>
      `;

      data.receitas_avulsas.forEach(receita => {
        html += criarCardDadosBancarios('RECEITA AVULSA', receita);
      });

      html += '</div>';
    }

    // Mostrar despesas avulsas
    if (data.despesas_avulsas && data.despesas_avulsas.length > 0) {
      html += `
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0 fw-bold" style="color: #1c5f20;">Despesas Avulsas</h5>
          </div>
      `;

      data.despesas_avulsas.forEach(despesa => {
        html += criarCardDadosBancarios('DESPESA AVULSA', despesa);
      });

      html += '</div>';
    }

    if (!html) {
      html = `
        <div class="text-center py-5 text-muted">
          <div class="mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
              <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
              <line x1="9" y1="9" x2="10" y2="9"/>
              <line x1="9" y1="13" x2="15" y2="13"/>
              <line x1="9" y1="17" x2="15" y2="17"/>
            </svg>
          </div>
          <div class="fw-medium">Nenhum dado bancário encontrado</div>
        </div>
      `;
    }

    container.innerHTML = html;
  }

  function criarCardDadosBancarios(tipo, dados) {
    const banco = dados.instituicao_financeira || 'Não informado';
    const agencia = dados.agencia_bancaria || 'Não informado';
    const conta = dados.conta_bancaria || 'Não informado';
    const pix = dados.chave_pix || 'Não informado';

    return `
      <div class="card mb-3 shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center justify-content-between" style="gap: 1rem;">
              <div>
                <h6 class="mb-0 fw-bold">${dados.identificacao}</h6>
                <small class="text-muted">${tipo}</small>
              </div>
              <button class="btn btn-sm btn-outline-success" onclick="copiarDadosIndividual('${tipo}', ${JSON.stringify(dados).replace(/"/g, '&quot;')})">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z"/>
                  <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div>
                  <div class="text-muted small">Banco</div>
                  <div class="fw-medium">${banco}</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div>
                  <div class="text-muted small">Agência</div>
                  <div class="fw-medium">${agencia}</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div>
                  <div class="text-muted small">Conta</div>
                  <div class="fw-medium">${conta}</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div>
                  <div class="text-muted small">PIX</div>
                  <div class="fw-medium">${pix}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function mostrarErroDadosBancarios(erro) {
    const container = document.getElementById('conteudo-dados-bancarios');
    container.innerHTML = `
      <div class="text-center py-5">
        <div class="mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
        </div>
        <div class="fw-medium text-danger">${erro}</div>
      </div>
    `;

    // Esconder botão copiar todos
    document.getElementById('btn-copiar-todos').style.display = 'none';
  }

  function copiarTodosDados(data) {
    let dadosBancarios = '';

    // Processar fornecedores
    if (data.fornecedores && data.fornecedores.length > 0) {
      dadosBancarios += '=== FORNECEDORES ===\n\n';
      data.fornecedores.forEach(fornecedor => {
        dadosBancarios += formatarDadosBancarios('FORNECEDOR', fornecedor);
        dadosBancarios += '\n' + '='.repeat(50) + '\n\n';
      });
    }

    // Processar transportadoras
    if (data.transportadoras && data.transportadoras.length > 0) {
      dadosBancarios += '=== TRANSPORTADORAS ===\n\n';
      data.transportadoras.forEach(transportadora => {
        dadosBancarios += formatarDadosBancarios('TRANSPORTADORA', transportadora);
        dadosBancarios += '\n' + '='.repeat(50) + '\n\n';
      });
    }

    // Processar extratores
    if (data.extratores && data.extratores.length > 0) {
      dadosBancarios += '=== EXTRATORES ===\n\n';
      data.extratores.forEach(extrator => {
        dadosBancarios += formatarDadosBancarios('EXTRATOR', extrator);
        dadosBancarios += '\n' + '='.repeat(50) + '\n\n';
      });
    }

    // Processar comissionados
    if (data.comissionados && data.comissionados.length > 0) {
      dadosBancarios += '=== COMISSIONADOS ===\n\n';
      data.comissionados.forEach(comissionado => {
        dadosBancarios += formatarDadosBancarios('COMISSIONADO', comissionado);
        dadosBancarios += '\n' + '='.repeat(50) + '\n\n';
      });
    }

    if (dadosBancarios) {
      navigator.clipboard.writeText(dadosBancarios).then(() => {
        mostrarNotificacao('Todos os dados bancários copiados para a área de transferência!', 'success');
      });
    } else {
      mostrarNotificacao('Nenhum dado bancário para copiar.', 'warning');
    }
  }

  function copiarDadosIndividual(tipo, dados) {
    const dadosFormatados = formatarDadosBancarios(tipo, dados);

    navigator.clipboard.writeText(dadosFormatados).then(() => {
      mostrarNotificacao(`Dados bancários de "${dados.identificacao}" copiados!`, 'success');
    });
  }

  function formatarDadosBancarios(tipo, dados) {
    const banco = dados.instituicao_financeira || 'Não informado';
    const agencia = dados.agencia_bancaria || 'Não informado';
    const conta = dados.conta_bancaria || 'Não informado';
    const pix = dados.chave_pix || 'Não informado';

    return `${tipo}: ${dados.identificacao}
Banco: ${banco}
Agência: ${agencia}
Conta: ${conta}
PIX: ${pix}`;
  }

  // ===== FUNÇÃO DE REVERTER CONCILIAÇÃO =====

  function confirmarReverterConciliacao(faturamentoId) {
    // Fechar o modal de confirmação
    const modal = document.getElementById(`modal-reverter-conciliacao-${faturamentoId}`);
    const bsModal = bootstrap.Modal.getInstance(modal);
    if (bsModal) {
      bsModal.hide();
    }

    // Mostrar loading
    mostrarNotificacao('Revertendo conciliação...', 'info');

    // Fazer requisição para reverter
    fetch(`/${faturamentoId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.sucesso) {
          mostrarNotificacao(data.mensagem || 'Conciliação revertida com sucesso!', 'success');
          // Recarregar a página após 1 segundo
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          mostrarNotificacao(data.mensagem || 'Erro ao reverter conciliação', 'error');
        }
      })
      .catch(error => {
        console.error('Erro ao reverter conciliação:', error);
        mostrarNotificacao('Erro ao reverter conciliação. Tente novamente.', 'error');
      });
  }

  // ===== FUNÇÕES DE EXPORTAR PDF =====

  function abrirModalExportarPDF(faturamentoId) {
    faturamentoParaPDF = faturamentoId;
    faturamentoParaImagem = null;

    const modalElement = document.getElementById('modal-exportar-pdf');
    if (!modalElement) {
      console.error('Modal de exportar PDF não encontrado');
      return;
    }

    // Restaurar título original do modal
    const modalTitle = modalElement.querySelector('.modal-title');
    modalTitle.innerHTML = `
    Exportar Faturamento para PDF
  `;

    // Restaurar texto do botão e limpar event listeners
    const btnGerar = document.getElementById('btn-gerar-pdf');
    btnGerar.innerHTML = `
    Gerar PDF
  `;

    // Limpar todos os event listeners e definir apenas um
    btnGerar.replaceWith(btnGerar.cloneNode(true));
    const newBtnGerar = document.getElementById('btn-gerar-pdf');
    newBtnGerar.onclick = function () {
      gerarPDFFaturamento();
    };

    // Carregar beneficiários do faturamento
    carregarBeneficiariosParaModal(faturamentoId);

    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      } else {
        // Fallback manual
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');

        // Criar backdrop
        if (!document.querySelector('.modal-backdrop')) {
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          document.body.appendChild(backdrop);
        }
      }
    } catch (error) {
      console.log('Erro ao abrir modal PDF:', error);
      // Fallback final
      modalElement.style.display = 'block';
      modalElement.classList.add('show');
      document.body.classList.add('modal-open');
    }
  }

  function gerarPDFFaturamento() {
    if (!faturamentoParaPDF) {
      mostrarNotificacao('Erro: Nenhum faturamento selecionado.', 'error');
      return;
    }

    // Coletar opções do modal
    const opcoes = {
      ocultar_fornecedores: document.getElementById('ocultar-fornecedores')?.checked || false,
      ocultar_transportadoras: document.getElementById('ocultar-transportadoras')?.checked || false,
      ocultar_cliente: document.getElementById('ocultar-cliente')?.checked || false,
      ocultar_receitas_avulsas: document.getElementById('ocultar-receitas-avulsas')?.checked || false,
      ocultar_despesas_avulsas: document.getElementById('ocultar-despesas-avulsas')?.checked || false
    };

    // Criar formulário para enviar via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/financeiro/cargas-a-pagar/exportar-pdf/${faturamentoParaPDF}`;
    form.target = '_blank'; // Abrir em nova aba

    // Adicionar dados das opções
    Object.keys(opcoes).forEach(key => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = opcoes[key];
      form.appendChild(input);
    });

    // Adicionar CSRF token se necessário
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'csrf_token';
      input.value = csrfToken.getAttribute('content');
      form.appendChild(input);
    }

    // Enviar formulário
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    // Fechar modal
    fecharModalSeguro('modal-exportar-pdf');

    mostrarNotificacao('PDF sendo gerado...', 'info');
  }

  // ===== FUNÇÕES AUXILIARES =====

  function fecharModalSeguro(modalId) {
    const modalElement = document.getElementById(modalId);
    if (!modalElement) return;

    try {
      // Tentar Bootstrap Modal
      if (window.bootstrap && window.bootstrap.Modal) {
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
          modalInstance.hide();
        } else {
          const modal = new bootstrap.Modal(modalElement);
          modal.hide();
        }
        return;
      }

      // Fallback manual
      modalElement.style.display = 'none';
      modalElement.classList.remove('show');
      document.body.classList.remove('modal-open');

      // Remover backdrop se existir
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }

    } catch (error) {
      console.log('Erro ao fechar modal:', error);
      // Fallback final
      modalElement.style.display = 'none';
      modalElement.classList.remove('show');
      document.body.classList.remove('modal-open');

      // Remover backdrop
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
    }
  }

  function mostrarNotificacao(mensagem, tipo = 'info') {
    // Toast simples do Tabler (se não tiver, usar fallback)
    if (typeof window.Tabler !== 'undefined' && window.Tabler.toast) {
      window.Tabler.toast({
        message: mensagem,
        type: tipo
      });
    } else {
      // Fallback: criar toast manual
      const toast = document.createElement('div');
      toast.className = `bg-white alert alert-${tipo === 'success' ? 'success' : tipo === 'warning' ? 'warning' : tipo === 'error' ? 'danger' : 'info'} alert-dismissible`;
      toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
      toast.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
      `;

      document.body.appendChild(toast);

      // Auto remover após 4 segundos
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 4000);
    }
  }

  // ======== FUNÇÃO DE EXPORTAR IMG ======

  function abrirModalExportarImagem(faturamentoId) {
    faturamentoParaImagem = faturamentoId;
    faturamentoParaPDF = null; // Limpar variável de PDF

    const modalElement = document.getElementById('modal-exportar-pdf'); // Reutilizar o mesmo modal
    if (!modalElement) {
      console.error('Modal de exportar não encontrado');
      return;
    }

    // Alterar título do modal para imagem
    const modalTitle = modalElement.querySelector('.modal-title');
    modalTitle.innerHTML = `
    Exportar Faturamento para Imagem
  `;

    // Alterar texto do botão e limpar event listeners
    const btnGerar = document.getElementById('btn-gerar-pdf');
    btnGerar.innerHTML = `
    Gerar Imagem
  `;

    // Limpar todos os event listeners e definir apenas um
    btnGerar.replaceWith(btnGerar.cloneNode(true));
    const newBtnGerar = document.getElementById('btn-gerar-pdf');
    newBtnGerar.onclick = function () {
      gerarImagemFaturamento();
    };

    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      } else {
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');

        if (!document.querySelector('.modal-backdrop')) {
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          document.body.appendChild(backdrop);
        }
      }
    } catch (error) {
      console.log('Erro ao abrir modal imagem:', error);
      modalElement.style.display = 'block';
      modalElement.classList.add('show');
      document.body.classList.add('modal-open');
    }
  }

  // Gerar imagem do faturamento

  function gerarImagemFaturamento() {
    if (!faturamentoParaImagem) {
      mostrarNotificacao('Erro: Nenhum faturamento selecionado.', 'error');
      return;
    }

    // Coletar opções do modal (mesmo do PDF)
    const opcoes = {
      ocultar_fornecedores: document.getElementById('ocultar-fornecedores')?.checked || false,
      ocultar_transportadoras: document.getElementById('ocultar-transportadoras')?.checked || false,
      ocultar_cliente: document.getElementById('ocultar-cliente')?.checked || false,
      ocultar_receitas_avulsas: document.getElementById('ocultar-receitas-avulsas')?.checked || false,
      ocultar_despesas_avulsas: document.getElementById('ocultar-despesas-avulsas')?.checked || false
    };

    // Criar formulário para enviar via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/financeiro/cargas-a-pagar/exportar-imagem/${faturamentoParaImagem}`; // Nova rota
    form.target = '_blank';

    // Adicionar dados das opções
    Object.keys(opcoes).forEach(key => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = opcoes[key];
      form.appendChild(input);
    });

    // Adicionar CSRF token se necessário
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'csrf_token';
      input.value = csrfToken.getAttribute('content');
      form.appendChild(input);
    }

    // Enviar formulário
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    // Fechar modal
    fecharModalSeguro('modal-exportar-pdf');

    mostrarNotificacao('Imagem sendo gerada...', 'info');
  }

  // ===== FUNÇÃO PARA VERIFICAR DADOS VAZIOS =====

  function verificarDadosVazios(fornecedores, transportadoras, extratores, comissionados, receitasAvulsas, despesasAvulsas, creditosUtilizados) {
    const temFornecedores = fornecedores && fornecedores.length > 0;
    const temTransportadoras = transportadoras && transportadoras.length > 0;
    const temExtratores = extratores && extratores.length > 0;
    const temComissionados = comissionados && comissionados.length > 0;
    const temReceitasAvulsas = receitasAvulsas && receitasAvulsas.length > 0;
    const temDespesasAvulsas = despesasAvulsas && despesasAvulsas.length > 0;
    const temCreditosUtilizados = creditosUtilizados && creditosUtilizados.length > 0;

    // Se não há nenhum tipo de dados, criar mensagem informativa
    if (!temFornecedores && !temTransportadoras && !temExtratores && !temComissionados && !temReceitasAvulsas && !temDespesasAvulsas && !temCreditosUtilizados) {
      const conteudoFaturamento = document.querySelector('#conteudo-faturamento .p-4');
      if (conteudoFaturamento) {
        conteudoFaturamento.innerHTML = `
          <div class="text-center py-5 text-muted">
            <div class="mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                <line x1="9" y1="9" x2="10" y2="9"/>
                <line x1="9" y1="13" x2="15" y2="13"/>
                <line x1="9" y1="17" x2="15" y2="17"/>
              </svg>
            </div>
            <h5 class="fw-bold mb-2">Faturamento sem detalhes</h5>
            <p class="text-muted mb-0">Este faturamento não possui fornecedores, transportadoras, extratores, comissionados ou lançamentos avulsos associados.</p>
          </div>
        `;
      }
    }
  }

</script>

<!-- Modal de Categorização Simples -->
<div class="modal modal-blur fade" id="modal-categorizacao" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header border-0"
        style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
        <h4 class="modal-title text-white fw-bold">
          Categorização do Faturamento
        </h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-0">
        <div id="loading-categorizacao" class="text-center py-5">
          <div class="spinner-border" style="color: #1B5E20;" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <div class="mt-3 text-muted">Carregando dados da categorização...</div>
        </div>

        <div id="conteudo-categorizacao" style="display: none;">
          <!-- O conteúdo será carregado via JavaScript -->
        </div>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="20" height="20" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
          </svg>
          Fechar
        </button>
        <button type="button" class="btn btn-primary" onclick="editarCategorizacao()">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="20" height="20" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
            <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
            <path d="M16 5l3 3" />
          </svg>
          Editar Categorização
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let categoriaId = null;

  function carregarCategorizacao(faturamentoId) {
    // Mostrar loading
    document.getElementById('loading-categorizacao').style.display = 'block';
    document.getElementById('conteudo-categorizacao').style.display = 'none';

    // Fazer requisição
    fetch(`/faturamento/categorizacao/detalhes-json/${faturamentoId}`)
      .then(response => response.json())
      .then(data => {
        // Esconder loading
        document.getElementById('loading-categorizacao').style.display = 'none';

        if (data.error) {
          document.getElementById('conteudo-categorizacao').innerHTML = `
            <div class="alert alert-danger m-3">
              <h4>Erro</h4>
              <p>${data.error}</p>
            </div>
          `;
        } else {
          // Montar HTML com os dados
          categoriaId = data.categorizacao_id; // Guardar categoriaId para edição
          document.getElementById('conteudo-categorizacao').innerHTML = montarHtmlCategorizacao(data);
        }

        document.getElementById('conteudo-categorizacao').style.display = 'block';
      })
      .catch(error => {
        document.getElementById('loading-categorizacao').style.display = 'none';
        document.getElementById('conteudo-categorizacao').innerHTML = `
        <div class="alert alert-danger m-3">
          <h4>Erro ao Carregar</h4>
          <p>Não foi possível carregar os dados da categorização.</p>
        </div>
      `;
        document.getElementById('conteudo-categorizacao').style.display = 'block';
      });
  }

  function montarHtmlCategorizacao(data) {
    // Usar valores vindos do backend
    const valorBrutoTotal = (data.faturamento.valor_bruto_total || data.faturamento.valor_total) / 100;
    const valorCreditoTotal = (data.faturamento.valor_credito_total || 0) / 100;
    const valorFinalTotal = data.faturamento.valor_total / 100;

    let html = `
    <div class="p-4">
      <!-- Resumo Superior com 4 cards -->
      <div class="row g-3 mb-4">
        <div class="col-3">
          <div class="text-center p-3" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
            <div class="avatar bg-secondary-lt mx-auto mb-2">
             <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" /><path d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" /></svg>
            </div>
            <div class="text-muted small text-uppercase mb-1">VALOR BRUTO</div>
            <div class="fw-bold text-dark">R$ ${valorBrutoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
          </div>
        </div>
        <div class="col-3">
          <div class="text-center p-3" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
            <div class="avatar bg-secondary-lt mx-auto mb-2">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-credit-card"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 5m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z" /><path d="M3 10l18 0" /><path d="M7 15l.01 0" /><path d="M11 15l2 0" /></svg>
            </div>
            <div class="text-muted small text-uppercase mb-1">CRÉDITO APLICADO</div>
            <div class="fw-bold">R$ ${valorCreditoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
          </div>
        </div>
        <div class="col-3">
          <div class="text-center p-3" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
            <div class="avatar bg-secondary-lt mx-auto mb-2">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon-tabler icons-tabler-outline icon-tabler-basket-dollar">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M17 10l-2 -6" />
                <path d="M7 10l2 -6" />
                <path
                  d="M13 20h-5.756a3 3 0 0 1 -2.965 -2.544l-1.255 -7.152a2 2 0 0 1 1.977 -2.304h13.999a2 2 0 0 1 1.977 2.304" />
                <path d="M10 14a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                <path d="M21 15h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" />
                <path d="M19 21v1m0 -8v1" />
              </svg>
            </div>
            <div class="text-muted small text-uppercase mb-1">VALOR FINAL</div>
            <div class="fw-bold">R$ ${valorFinalTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
          </div>
        </div>
        <div class="col-3">
          <div class="text-center p-3" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
            <div class="avatar bg-secondary-lt mx-auto mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
              </svg>
            </div>
            <div class="text-muted small text-uppercase mb-1">DATA</div>
            <div class="fw-bold">${data.pagamento.data_vencimento || 'N/A'}</div>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <!-- Informações do Pagamento -->
      <div class="mb-4">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border: 1px solid #dee2e6; border-radius: 8px;">
              <div class="text-muted small mb-1">Beneficiário</div>
              <div class="fw-bold">${data.pagamento.beneficiario}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border: 1px solid #dee2e6; border-radius: 8px;">
              <div class="text-muted small mb-1">Data Vencimento</div>
              <div class="fw-bold">${data.pagamento.data_vencimento}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border: 1px solid #dee2e6; border-radius: 8px;">
              <div class="text-muted small mb-1">Situação Pagamento</div>
              <div><span class="badge badge-outline text-default">${data.pagamento.situacao_nome}</span></div>
            </div>
          </div>
        </div>
      </div>`;

    // Seção de Fornecedores
    if (data.faturamento.fornecedores && data.faturamento.fornecedores.length > 0) {
      const totalFornecedores = data.faturamento.fornecedores.reduce((total, f) => total + (f.valor || 0), 0) / 100;

      html += `
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <div>
            <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Fornecedores</h5>
            <div class="text-muted small">${data.faturamento.fornecedores.length} registro(s) • <span style="color: #1B5E20;">R$ ${totalFornecedores.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">NOME</th>
                <th class="small text-uppercase text-center">VALOR BRUTO</th>
                <th class="small text-uppercase text-center">CRÉDITO UTILIZADO</th>
                <th class="small text-uppercase text-center">VALOR FINAL</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.fornecedores.forEach(fornecedor => {
        const valorBruto = (fornecedor.valor_bruto_total || fornecedor.valor_bruto || 0) / 100;
        const valorCredito = (fornecedor.valor_credito_aplicado || fornecedor.valor_credito || 0) / 100;
        const valorFinal = (fornecedor.valor || fornecedor.valor_faturado || 0) / 100;
        const nomeFornecedor = fornecedor.identificacao || fornecedor.fornecedor_identificacao || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeFornecedor}</td>
                <td class="text-center">R$ ${valorBruto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center"><span>R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
                <td class="text-center"><span>R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Seção de Transportadoras
    if (data.faturamento.transportadoras && data.faturamento.transportadoras.length > 0) {
      const totalTransportadoras = data.faturamento.transportadoras.reduce((total, t) => total + (t.valor || 0), 0) / 100;

      html += `
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <div>
            <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Transportadoras</h5>
            <div class="text-muted small">${data.faturamento.transportadoras.length} registro(s) • <span style="color: #1B5E20;">R$ ${totalTransportadoras.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">NOME</th>
                <th class="small text-uppercase text-center">VALOR BRUTO</th>
                <th class="small text-uppercase text-center">CRÉDITO UTILIZADO</th>
                <th class="small text-uppercase text-center">VALOR FINAL</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.transportadoras.forEach(transportadora => {
        const valorBruto = (transportadora.valor_bruto_total || transportadora.valor_bruto || 0) / 100;
        const valorCredito = (transportadora.valor_credito_aplicado || transportadora.valor_credito || 0) / 100;
        const valorFinal = (transportadora.valor || transportadora.valor_faturado || 0) / 100;
        const nomeTransportadora = transportadora.identificacao || transportadora.nome || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeTransportadora}</td>
                <td class="text-center">R$ ${valorBruto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center"><span>R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
                <td class="text-center"><span>R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Seção de Extratores
    if (data.faturamento.extratores && data.faturamento.extratores.length > 0) {
      const totalExtratores = data.faturamento.extratores.reduce((total, t) => total + (t.valor || 0), 0) / 100;

      html += `
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <div>
            <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Extratores</h5>
            <div class="text-muted small">${data.faturamento.extratores.length} registro(s) • <span style="color: #1B5E20;">R$ ${totalExtratores.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">NOME</th>
                <th class="small text-uppercase text-center">VALOR BRUTO</th>
                <th class="small text-uppercase text-center">CRÉDITO UTILIZADO</th>
                <th class="small text-uppercase text-center">VALOR FINAL</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.extratores.forEach(extrator => {
        const valorBruto = (extrator.valor_bruto_total || extrator.valor_bruto || 0) / 100;
        const valorCredito = (extrator.valor_credito_aplicado || extrator.valor_credito || 0) / 100;
        const valorFinal = (extrator.valor || extrator.valor_faturado || 0) / 100;
        const nomeExtrator = extrator.identificacao || extrator.nome || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeExtrator}</td>
                <td class="text-center">R$ ${valorBruto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center"><span>R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
                <td class="text-center"><span>R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Seção de Comissionados
    if (data.faturamento.comissionados && data.faturamento.comissionados.length > 0) {
      const totalComissionados = data.faturamento.comissionados.reduce((total, t) => total + (t.valor || 0), 0) / 100;

      html += `
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <div>
            <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Comissionados</h5>
            <div class="text-muted small">${data.faturamento.comissionados.length} registro(s) • <span style="color: #1B5E20;">R$ ${totalComissionados.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">NOME</th>
                <th class="small text-uppercase text-center">VALOR BRUTO</th>
                <th class="small text-uppercase text-center">CRÉDITO UTILIZADO</th>
                <th class="small text-uppercase text-center">VALOR FINAL</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.comissionados.forEach(comissionado => {
        const valorBruto = (comissionado.valor_bruto_total || comissionado.valor_bruto || 0) / 100;
        const valorCredito = (comissionado.valor_credito_aplicado || comissionado.valor_credito || 0) / 100;
        const valorFinal = (comissionado.valor || comissionado.valor_faturado || 0) / 100;
        const nomeComissionado = comissionado.identificacao || comissionado.nome || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeComissionado}</td>
                <td class="text-center">R$ ${valorBruto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center"><span>R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
                <td class="text-center"><span>R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Seção de Receitas Avulsas
    if (data.receitas_avulsas && data.receitas_avulsas.length > 0) {
      const totalReceitas = data.receitas_avulsas.reduce((total, r) => {
        const valor = parseFloat(r.valor.replace(/[R$\s.]/g, '').replace(',', '.'));
        return total + valor;
      }, 0);

      html += `
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <div>
            <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Receitas Avulsas</h5>
            <div class="text-muted small">${data.receitas_avulsas.length} receita(s) • <span style="color: #1B5E20;">R$ ${totalReceitas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">DESCRIÇÃO</th>
                <th class="small text-uppercase text-center">CONTA BANCÁRIA</th>
                <th class="small text-uppercase text-center">DATA CADASTRO</th>
                <th class="small text-uppercase text-center">VALOR</th>
              </tr>
            </thead>
            <tbody>`;

      data.receitas_avulsas.forEach(receita => {
        html += `
              <tr>
                <td class="text-center">${receita.descricao}</td>
                <td class="text-center">${receita.conta_bancaria}</td>
                <td class="text-center">${receita.data_cadastro}</td>
                <td class="text-center"><span>R$ ${receita.valor}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Seção de Despesas Avulsas
    if (data.despesas_avulsas && data.despesas_avulsas.length > 0) {
      const totalDespesas = data.despesas_avulsas.reduce((total, d) => {
        const valor = parseFloat(d.valor.replace(/[R$\s.]/g, '').replace(',', '.'));
        return total + valor;
      }, 0);

      html += `
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <div>
            <h5 class="mb-1 fw-bold" style="color: #dc3545;">Despesas Avulsas</h5>
            <div class="text-muted small">${data.despesas_avulsas.length} despesa(s) • <span style="color: #dc3545;">R$ ${totalDespesas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">DESCRIÇÃO</th>
                <th class="small text-uppercase text-center">CONTA BANCÁRIA</th>
                <th class="small text-uppercase text-center">DATA CADASTRO</th>
                <th class="small text-uppercase text-center">VALOR</th>
              </tr>
            </thead>
            <tbody>`;

      data.despesas_avulsas.forEach(despesa => {
        html += `
              <tr>
                <td class="text-center">${despesa.descricao}</td>
                <td class="text-center">${despesa.conta_bancaria}</td>
                <td class="text-center">${despesa.data_cadastro}</td>
                <td class="text-center"><span class="text-danger">R$ ${despesa.valor}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }    // Seção de Categorização por Conta
    if (data.categorias && data.categorias.length > 0) {
      html += `
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <div>
            <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Categorização por Conta</h5>
            <div class="text-muted small">${data.categorias.length} categoria(s)</div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">CATEGORIA</th>
                <th class="small text-uppercase text-center">VALOR</th>
                <th class="small text-uppercase text-center">DESCRIÇÃO</th>
              </tr>
            </thead>
            <tbody>`;

      let totalCategorias = 0;
      data.categorias.forEach(categoria => {
        const valorCategoria = categoria.valor / 100;
        totalCategorias += categoria.valor;
        const nomeCategoria = categoria.nome || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeCategoria}</td>
                <td class="text-center">R$ ${valorCategoria.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${categoria.detalhamento || '-'}</td>
              </tr>`;
      });

      html += `
            </tbody>
            <tfoot>
              <tr class="table-active fw-bold">
                <td class="text-center">TOTAL</td>
                <td class="text-center">R$ ${(totalCategorias / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-end"></td>
                <td class="text-end"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>`;
    }
    // Seção de Centros de Custo (se houver)
    if (data.centros_custo && data.centros_custo.length > 0) {
      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Centros de Custo</h6>
        <div class="text-muted small mb-3">${data.centros_custo.length} centro(s) de custo</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">CENTRO DE CUSTO</th>
                <th class="small text-uppercase text-center">VALOR</th>
                <th class="small text-uppercase text-center">PERCENTUAL</th>
              </tr>
            </thead>
            <tbody>`;

      data.centros_custo.forEach(centro => {
        const valorCentro = centro.valor / 100;
        const nomeCentro = centro.nome || centro.descricao || 'N/A';
        const centroCustoDisplay = `${nomeCentro}`;
        html += `
              <tr>
                <td class="text-center">${centroCustoDisplay}</td>
                <td class="text-center">R$ ${valorCentro.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${centro.percentual ? centro.percentual.toFixed(1) : '0.0'}%</td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Seção de Parcelas
    if (data.parcelas && data.parcelas.length > 0) {
      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Parcelas</h6>
        <div class="text-muted small mb-3">${data.parcelas.length} parcela(s)</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">PARCELA</th>
                <th class="small text-uppercase text-center">VENCIMENTO</th>
                <th class="small text-uppercase text-center text-end">VALOR</th>
                <th class="small text-uppercase text-center">SITUAÇÃO</th>
              </tr>
            </thead>
            <tbody>`;

      data.parcelas.forEach(parcela => {
        const valorParcela = parcela.valor_parcela / 100;
        const situacaoNome = parcela.situacao_nome || parcela.situacao || 'Pendente';
        html += `
              <tr>
                <td class="text-center">${parcela.numero_parcela}/${data.parcelas.length}</td>
                <td class="text-center">${parcela.data_vencimento}</td>
                <td class="text-center">R$ ${valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${situacaoNome}</td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    html += '</div>';
    return html;
  }
</script>

<!-- Modal para confirmar exclusão de faturamento -->
<div class="modal modal-blur fade" id="modal-excluir-faturamento" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Você tem certeza?</div>
        <div>Esta ação irá excluir permanentemente este faturamento e todos os registros relacionados.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">Cancelar</button>
        <form id="form-excluir-faturamento" method="POST" action="" style="display: inline;">
          <button type="submit" class="btn btn-danger">Sim, excluir</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function prepararExclusao(faturamentoId) {
    const form = document.getElementById('form-excluir-faturamento');
    form.action = `/financeiro/cargas-a-pagar/excluir/${faturamentoId}`;
  }
  function editarCategorizacao() {
    if (!categoriaId) {
      alert('Nenhuma categoria selecionada!');
      return;
    }

    // Fechar o modal atual
    const modal = document.getElementById('modal-categorizacao');
    if (modal) {
      const modalInstance = bootstrap.Modal.getInstance(modal);
      if (modalInstance) {
        modalInstance.hide();
      }
    }

    window.location.href = `/faturamento/editar-categorizacao/${categoriaId}/despesa`;
  }
</script>

{% endblock conteudo %}