{% extends 'estrutura/base.html' %}

{% block conteudo %}
{% include 'estrutura/header.html' %}

<link href="{{ url_for('static', filename='css/pages/despesa-avulsa-listagem.css') }}" rel="stylesheet">
<div class="page-wrapper">
  
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          
          <div class="page-pretitle">
            FINANCEIRO
          </div>
          <h2 class="page-title">
            Despesas Categorizadas
          </h2>
        </div>
        
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <a href="{{url_for('cadastrar_despesa_avulsa')}}" class="btn btn-primary d-none d-sm-inline-block">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M12 5l0 14" />
                <path d="M5 12l14 0" />
              </svg>
              Nova Despesa
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      <div class="card">
        {%if agendamentos%}

        <div class="card-header">
          <div class="row w-100 align-items-end">
            <div class="col-md-12">
              <div class="row g-2 align-items-end">
                
                <div class="col-md-6">
                  <label class="form-label">Pesquisar</label>
                  <div class="input-icon">
                    <span class="input-icon-addon">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-search" id="search-icon">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                      </svg>
                    </span>
                    <span class="input-icon-addon d-none" id="search-loading">
                      <div class="spinner-border spinner-border-sm text-primary" role="status"
                        style="width: 16px; height: 16px;">
                        <span class="visually-hidden">Pesquisando...</span>
                      </div>
                    </span>
                    <input type="text" value="" class="form-control" placeholder="Digite pelo menos 2 caracteres..."
                      id="search-despesas-avulsas">
                  </div>
                </div>

                <div class="col-md-2">
                  <label class="form-label">Data Início</label>
                  <input type="date" id="data-inicio" class="form-control form-control"
                    title="Data início do vencimento">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Data Fim</label>
                  <input type="date" id="data-fim" class="form-control form-control" title="Data fim do vencimento">
                </div>

                <div class="col-md-2 text-end">
                  <button type="button" class="btn btn-outline-primary" id="limpar-filtros"
                    title="Limpar todos os filtros">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-tabler icons-tabler-outline icon-tabler-filter-off">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path
                        d="M8 4h12v2.172a2 2 0 0 1 -.586 1.414l-3.914 3.914m-.5 3.5v4l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227" />
                      <path d="M3 3l18 18" />
                    </svg>
                    Limpar Filtros
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="selection-panel">
          <div class="selection-controls">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="selectAll" class="form-check-input">
              <label for="selectAll" class="checkbox-label">Selecionar todos</label>
            </div>
          </div>
          <div class="selection-summary">
            <div class="summary-item">
              <span class="summary-value" id="totalSelecionado">R$ 0,00</span>
              <span class="summary-label">Total</span>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
              <span class="summary-value" id="quantidadeSelecionada">0</span>
              <span class="summary-label">Selecionados</span>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table id="tabela-despesas-avulsas" class="table table-vcenter">
            <thead>
              <tr>
                <th class="text-center checkbox-column">
                  <input type="checkbox" id="selectAllHeader" class="form-check-input">
                </th>
                <th class="text-center">Descrição</th>
                <th class="text-center">Beneficiário</th>
                <th class="text-center">Data Vencimento</th>
                <th class="text-center">Valor</th>
                <th class="text-center">Situação</th>
                <th class="text-center">Ações</th>
              </tr>
            </thead>
            <tbody id="corpo-tabela-despesas">
              {% for agendamento in agendamentos %}
              <tr>
                <td class="text-center">
                  
                  {% set valor_centavos = agendamento.valor_total_100 %}
                  {% set valor_item = valor_centavos / 100 %}
                  <input type="checkbox" class="form-check-input item-checkbox"
                    data-valor="{{ '%.2f'|format(valor_item|float) }}" data-id="{{ agendamento.id }}"
                    data-debug="Valor_centavos: {{ valor_centavos }} | Valor_item: {{ valor_item }} | Agendamento_ID: {{ agendamento.id }}">
                </td>
                <td class="text-center">
                  <div class="d-flex py-1 align-items-center">
                    <div class="flex-fill">
                      {% if agendamento.faturamento_id %}
                      <div class="font-weight-medium">{{ agendamento.faturamento.codigo_faturamento }}</div>
                      {% elif agendamento.lancamento_avulso_id %}
                      <div class="font-weight-medium">{{ agendamento.lancamento_avulso.descricao | truncate(40, '...')
                        }}</div>
                      {% else %}
                      <div class="font-weight-medium">{{ agendamento.descricao | truncate(40, '...') or 'N/A' }}</div>
                      {% endif %}
                      {% if agendamento.descricao %}
                      <div class="text-muted small">{{ agendamento.descricao | truncate(40, '...') }}</div>
                      {% endif %}
                    </div>
                  </div>
                </td>
                <td class="text-center">
                  <div class="font-weight-medium">
                    {% if agendamento.faturamento_id and agendamento.faturamento and agendamento.faturamento.cliente %}
                    {{ agendamento.faturamento.cliente.nome or agendamento.faturamento.cliente.razao_social }}
                    {% else %}
                    {{ agendamento.pessoa_financeiro.identificacao }}
                    {% endif %}
                  </div>
                </td>
                <td class="text-center">
                  {{ agendamento.data_vencimento.strftime('%d/%m/%Y') }}
                </td>
                <td class="text-center">
                  {% if agendamento.faturamento_id and agendamento.faturamento %}
                  <span class="text-success font-weight-bold">{{ agendamento.faturamento.valor_total |
                    formatar_float_para_brl }}</span>
                  {% elif agendamento.lancamento_avulso_id and agendamento.lancamento_avulso %}
                  <span class="text-success font-weight-bold">{{ agendamento.lancamento_avulso.valor_movimentacao_100 |
                    formatar_float_para_brl }}</span>
                  {% else %}
                  <span class="text-success font-weight-bold">{{ agendamento.valor_total_100 | formatar_float_para_brl
                    }}</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% set situacao_class = {
                  6: 'bg-lime-lt'
                  } %}
                  <span class="badge {{ situacao_class.get(agendamento.situacao_pagamento_id, 'bg-lime-lt') }}">
                    {{ agendamento.situacao.situacao if agendamento.situacao else 'N/A' }}
                  </span>
                </td>
                <td class="d-flex justify-content-center">
                  <div class="btn-list flex-nowrap">
                    
                    {% if agendamento.faturamento_id and agendamento.faturamento %}
                    <button class="btn btn-icon btn-outline-primary" data-bs-toggle="modal"
                      data-bs-target="#modal-faturamento-{{ agendamento.faturamento_id }}" data-bs-placement="top"
                      title="Visualizar Faturamento">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                        <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                      </svg>
                    </button>
                    {% elif agendamento.lancamento_avulso_id and agendamento.lancamento_avulso %}
                    <button class="btn btn-icon btn-outline-primary" data-bs-toggle="modal"
                      data-bs-target="#modal-lancamento-{{ agendamento.lancamento_avulso_id }}" data-bs-placement="top"
                      title="Visualizar Lançamento Avulso">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                        <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                      </svg>
                    </button>
                    {% endif %}

                    <a href="{{ url_for('editar_categorizacao', agendamento_id=agendamento.id) }}"
                      class="btn btn-icon btn-outline-warning {%if agendamento.situacao_pagamento_id in [8,9] %}disabled{%endif%}"
                      data-bs-toggle="tooltip" data-bs-placement="top" title="Editar Categorização">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-pencil">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
                        <path d="M13.5 6.5l4 4" />
                      </svg>
                    </a>

                    <button type="button"
                      class="btn btn-icon btn-outline-success {%if agendamento.situacao_pagamento_id in [8,9] %}disabled{%endif%}"
                      data-bs-toggle="modal" data-bs-target="#modal-liquidacao-{{ agendamento.id }}"
                      title="Liquidar Receita">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path
                          d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                        <path d="M4 17v-1a8 8 0 1 1 16 0v1a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4" />
                      </svg>
                    </button>

                    <button type="button" class="btn btn-icon btn-outline-danger" data-bs-toggle="modal"
                      data-bs-target="#modal-excluir-{{ agendamento.id }}" title="Excluir">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-trash">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M4 7l16 0" />
                        <path d="M10 11l0 6" />
                        <path d="M14 11l0 6" />
                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                      </svg>
                    </button>

                  </div>
                </td>
              </tr>

              {% endfor %}
            </tbody>
          </table>
          <div class="card-footer" id="paginacao-despesas">
            <div class="row g-2 justify-content-center justify-content-sm-between">
              <div class="col-auto d-flex align-items-center">
                {% if paginacao %}
                {% set inicio = ((paginacao.pagina - 1) * paginacao.por_pagina) + 1 %}
                {% set fim = inicio + agendamentos|length - 1 %}
                <p class="m-0 text-secondary">
                  Mostrando <strong>{{ inicio }} até {{ fim }}</strong> de <strong>{{ paginacao.total }}</strong>
                  registros
                </p>
                {% else %}
                <p class="m-0 text-secondary">Mostrando <strong>1 até 8</strong> de <strong>16 registros</strong></p>
                {% endif %}
              </div>
              <div class="col-auto">
                {% if paginacao and paginacao.total_paginas > 1 %}
                <ul class="pagination">
                  
                  <li class="page-item {% if paginacao.pagina <= 1 %}disabled{% endif %}">
                    {% if paginacao.pagina > 1 %}
                    <a class="page-link"
                      href="?pagina={{ paginacao.pagina - 1 }}&por_pagina={{ paginacao.por_pagina }}{% if paginacao.termo_pesquisa %}&pesquisa={{ paginacao.termo_pesquisa }}{% endif %}"
                      tabindex="-1">
                      {% else %}
                      <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                        {% endif %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-1">
                          <path d="M15 6l-6 6l6 6" />
                        </svg>
                      </a>
                  </li>

                  {% set inicio_pag = [1, paginacao.pagina - 2]|max %}
                  {% set fim_pag = [paginacao.total_paginas, paginacao.pagina + 2]|min %}

                  {% if inicio_pag > 1 %}
                  <li class="page-item">
                    <a class="page-link"
                      href="?pagina=1&por_pagina={{ paginacao.por_pagina }}{% if paginacao.termo_pesquisa %}&pesquisa={{ paginacao.termo_pesquisa }}{% endif %}">1</a>
                  </li>
                  {% if inicio_pag > 2 %}
                  <li class="page-item disabled"><span class="page-link">...</span></li>
                  {% endif %}
                  {% endif %}

                  {% for p in range(inicio_pag, fim_pag + 1) %}
                  <li class="page-item {% if p == paginacao.pagina %}active{% endif %}">
                    <a class="page-link"
                      href="?pagina={{ p }}&por_pagina={{ paginacao.por_pagina }}{% if paginacao.termo_pesquisa %}&pesquisa={{ paginacao.termo_pesquisa }}{% endif %}">{{
                      p }}</a>
                  </li>
                  {% endfor %}

                  {% if fim_pag < paginacao.total_paginas %} {% if fim_pag < paginacao.total_paginas - 1 %} <li
                    class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    <li class="page-item">
                      <a class="page-link"
                        href="?pagina={{ paginacao.total_paginas }}&por_pagina={{ paginacao.por_pagina }}{% if paginacao.termo_pesquisa %}&pesquisa={{ paginacao.termo_pesquisa }}{% endif %}">{{
                        paginacao.total_paginas }}</a>
                    </li>
                    {% endif %}

                    <li class="page-item {% if paginacao.pagina >= paginacao.total_paginas %}disabled{% endif %}">
                      {% if paginacao.pagina < paginacao.total_paginas %} <a class="page-link"
                        href="?pagina={{ paginacao.pagina + 1 }}&por_pagina={{ paginacao.por_pagina }}{% if paginacao.termo_pesquisa %}&pesquisa={{ paginacao.termo_pesquisa }}{% endif %}">
                        {% else %}
                        <a class="page-link" href="#">
                          {% endif %}
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-1">
                            <path d="M9 6l6 6l-6 6" />
                          </svg>
                        </a>
                    </li>
                </ul>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {%else%}
        <div class="area-info-extrato text-center p-4 shadow-sm" style="border-radius: 10px; background-color: white;">
          <div style="font-size: 70px; color: #fc7801; margin-bottom: 15px;">❌</div>
          <h2 style="font-size: 22px; margin-bottom: 10px; color: #555;">
            Não encontramos nenhuma.
          </h2>
          <p style="color: #777;">
            No momento não há registros de receitas. Quando houver
            novos dados,
            eles aparecerão automaticamente aqui.
          </p>
        </div>
        {%endif%}
      </div>
    </div>
  </div>

  <div id="container-modais-faturamento">
  
  {% for agendamento in agendamentos %}
  {% if agendamento.faturamento_id and agendamento.faturamento %}
  <div class="modal modal-blur fade" id="modal-faturamento-{{ agendamento.faturamento_id }}" tabindex="-1" role="dialog"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-0"
          style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
          <h4 class="modal-title text-white fw-bold">
            {{ agendamento.faturamento.codigo_faturamento }}
          </h4>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          
          <div class="p-4"
            style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-bottom: 1px solid #dee2e6;">
            <div class="row g-4">
              <div class="col-md-4 text-center">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                  </svg>
                </div>
                <div class="text-muted small fw-medium text-uppercase">Valor Bruto</div>
                <div class="mb-0 fw-bold" style="color: #1B5E20;">{{ agendamento.faturamento.valor_bruto_total |
                  formatar_float_para_brl if agendamento.faturamento.valor_bruto_total else 'R$ 0,00' }}</div>
              </div>
              <div class="col-md-4 text-center">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="#1B5E20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon-tabler icons-tabler-outline icon-tabler-basket-dollar">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M17 10l-2 -6" />
                    <path d="M7 10l2 -6" />
                    <path
                      d="M13 20h-5.756a3 3 0 0 1 -2.965 -2.544l-1.255 -7.152a2 2 0 0 1 1.977 -2.304h13.999a2 2 0 0 1 1.977 2.304" />
                    <path d="M10 14a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                    <path d="M21 15h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" />
                    <path d="M19 21v1m0 -8v1" />
                  </svg>
                </div>
                <div class="text-muted small fw-medium text-uppercase">Valor Final</div>
                <div class="mb-0 fw-bold" style="color: #1B5E20;">{{ agendamento.faturamento.valor_total |
                  formatar_float_para_brl if agendamento.faturamento.valor_total else 'R$ 0,00' }}</div>
              </div>
              <div class="col-md-4 text-center">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                  </svg>
                </div>
                <div class="text-muted small fw-medium text-uppercase">Data</div>
                <div class="fw-bold">{{ agendamento.faturamento.data_cadastro.strftime('%d/%m/%Y') if
                  agendamento.faturamento.data_cadastro else 'N/A' }}</div>
              </div>
            </div>
          </div>

          <div class="p-4">

            {% set detalhes = agendamento.faturamento.obter_detalhes() %}

            {% set fornecedores = detalhes.fornecedores %}
            {% if fornecedores %}
            
            {% set fornecedores_agrupados = {} %}
            {% for fornecedor in fornecedores %}
            {% set identificacao = fornecedor.fornecedor_identificacao %}
            {% if identificacao not in fornecedores_agrupados %}
            {% set _ = fornecedores_agrupados.update({identificacao: []}) %}
            {% endif %}
            {% set _ = fornecedores_agrupados[identificacao].append(fornecedor) %}
            {% endfor %}

            {% for identificacao, cargas_fornecedor in fornecedores_agrupados.items() %}
            <div class="card mb-4 shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
              <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-2">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M8 9l5 5v7h-5v-4m0 4h-5v-7l5 -5m1 1v-6a1 1 0 0 1 1 -1h10a1 1 0 0 1 1 1v17h-8" />
                      <path d="M13 7l0 .01" />
                      <path d="M17 7l0 .01" />
                      <path d="M17 11l0 .01" />
                      <path d="M13 11l0 .01" />
                    </svg>
                    <div>
                      <h6 class="mb-0 fw-bold">Fornecedor: {{ identificacao }}</h6>
                      <small class="text-muted">{{ cargas_fornecedor|length }} registro(s)</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table mb-0">
                    <thead style="background: #f8f9fa;">
                      <tr>
                        <th class="fw-semibold text-center">Data Entrega</th>
                        <th class="fw-semibold text-center">Produto | Bitola</th>
                        <th class="fw-semibold text-center">NF</th>
                        <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                        <th class="fw-semibold text-center text-end">Preço Custo</th>
                        <th class="fw-semibold text-center text-end">Valor Bruto</th>
                        <th class="fw-semibold text-center text-end">Valor Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for fornecedor in cargas_fornecedor %}
                      <tr>
                        <td class="text-center">{{ fornecedor.data_entrega }}</td>
                        <td class="text-center">
                          {{ fornecedor.produto }} | {{ fornecedor.bitola }}
                        </td>
                        <td class="text-center">{{ fornecedor.nota_fiscal }}</td>
                        <td class="text-center">{{ fornecedor.peso_ticket }}</td>
                        <td class="text-center text-end">{{ fornecedor.preco_custo | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ fornecedor.valor_bruto | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ fornecedor.valor_faturado | formatar_float_para_brl }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
            {% endif %}

            {% set transportadoras = detalhes.transportadoras %}
            {% if transportadoras %}
            
            {% set transportadoras_agrupadas = {} %}
            {% for transportadora in transportadoras %}
            {% set identificacao = transportadora.nome %}
            {% if identificacao not in transportadoras_agrupadas %}
            {% set _ = transportadoras_agrupadas.update({identificacao: []}) %}
            {% endif %}
            {% set _ = transportadoras_agrupadas[identificacao].append(transportadora) %}
            {% endfor %}

            {% for identificacao, cargas_transportadora in transportadoras_agrupadas.items() %}
            <div class="card mb-4 shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
              <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-2">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                      <path d="M5 17h-2v-4m-1 -8h11v12m0 -8h4l2 2v4h-2" />
                    </svg>
                    <div>
                      <h6 class="mb-0 fw-bold">Transportadora: {{ identificacao }}</h6>
                      <small class="text-muted">{{ cargas_transportadora|length }} registro(s)</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table mb-0">
                    <thead style="background: #f8f9fa;">
                      <tr>
                        <th class="fw-semibold text-center">Data Entrega</th>
                        <th class="fw-semibold text-center">Produto | Bitola</th>
                        <th class="fw-semibold text-center">NF</th>
                        <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                        <th class="fw-semibold text-center text-end">Preço Frete</th>
                        <th class="fw-semibold text-center text-end">Valor Bruto</th>
                        <th class="fw-semibold text-center text-end">Valor Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for transportadora in cargas_transportadora %}
                      <tr>
                        <td class="text-center">{{ transportadora.data_entrega }}</td>
                        <td class="text-center">
                          {{ transportadora.produto }} | {{ transportadora.bitola }}
                        </td>
                        <td class="text-center">{{ transportadora.nota_fiscal }}</td>
                        <td class="text-center">{{ transportadora.peso_ticket }}</td>
                        <td class="text-center text-end">{{ transportadora.preco_custo | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ transportadora.valor_bruto | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ transportadora.valor_faturado | formatar_float_para_brl }}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
            {% endif %}

            {% set extratores = detalhes.extratores %}
            {% if extratores %}
            
            {% set extratores_agrupados = {} %}
            {% for extrator in extratores %}
            {% set identificacao = extrator.extrator_identificacao %}
            {% if identificacao not in extratores_agrupados %}
            {% set _ = extratores_agrupados.update({identificacao: []}) %}
            {% endif %}
            {% set _ = extratores_agrupados[identificacao].append(extrator) %}
            {% endfor %}

            {% for identificacao, cargas_extrator in extratores_agrupados.items() %}
            <div class="card mb-4 shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
              <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-2">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M7 4v16l13 -8z" />
                    </svg>
                    <div>
                      <h6 class="mb-0 fw-bold">Extrator: {{ identificacao }}</h6>
                      <small class="text-muted">{{ cargas_extrator|length }} registro(s)</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table mb-0">
                    <thead style="background: #f8f9fa;">
                      <tr>
                        <th class="fw-semibold text-center">Data Entrega</th>
                        <th class="fw-semibold text-center">Produto | Bitola</th>
                        <th class="fw-semibold text-center">NF</th>
                        <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                        <th class="fw-semibold text-center text-end">Preço Extração</th>
                        <th class="fw-semibold text-center text-end">Valor Bruto</th>
                        <th class="fw-semibold text-center text-end">Valor Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for extrator in cargas_extrator %}
                      <tr>
                        <td class="text-center">{{ extrator.data_entrega }}</td>
                        <td class="text-center">
                          {{ extrator.produto }} | {{ extrator.bitola }}
                        </td>
                        <td class="text-center">{{ extrator.nota_fiscal }}</td>
                        <td class="text-center">{{ extrator.peso_ticket }}</td>
                        <td class="text-center text-end">{{ extrator.preco_custo | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ extrator.valor_bruto | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ extrator.valor_faturado | formatar_float_para_brl }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
            {% endif %}

            {% set comissionados = detalhes.comissionados %}
            {% if comissionados %}
            
            {% set comissionados_agrupados = {} %}
            {% for comissionado in comissionados %}
            {% set identificacao = comissionado.comissionado_identificacao %}
            {% if identificacao not in comissionados_agrupados %}
            {% set _ = comissionados_agrupados.update({identificacao: []}) %}
            {% endif %}
            {% set _ = comissionados_agrupados[identificacao].append(comissionado) %}
            {% endfor %}

            {% for identificacao, cargas_comissionado in comissionados_agrupados.items() %}
            <div class="card mb-4 shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
              <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-2">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                      <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                    </svg>
                    <div>
                      <h6 class="mb-0 fw-bold">Comissionado: {{ identificacao }}</h6>
                      <small class="text-muted">{{ cargas_comissionado|length }} registro(s)</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table mb-0">
                    <thead style="background: #f8f9fa;">
                      <tr>
                        <th class="fw-semibold text-center">Data Entrega</th>
                        <th class="fw-semibold text-center">Produto | Bitola</th>
                        <th class="fw-semibold text-center">NF</th>
                        <th class="fw-semibold text-center">Peso Ticket (Ton.)</th>
                        <th class="fw-semibold text-center text-end">Preço Comissão</th>
                        <th class="fw-semibold text-center text-end">Valor Bruto</th>
                        <th class="fw-semibold text-center text-end">Valor Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for comissionado in cargas_comissionado %}
                      <tr>
                        <td class="text-center">{{ comissionado.data_entrega }}</td>
                        <td class="text-center">
                          {{ comissionado.produto }} | {{ comissionado.bitola }}
                        </td>
                        <td class="text-center">{{ comissionado.nota_fiscal }}</td>
                        <td class="text-center">{{ comissionado.peso_ticket }}</td>
                        <td class="text-center text-end">{{ comissionado.preco_custo | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ comissionado.valor_bruto | formatar_float_para_brl }}</td>
                        <td class="text-center text-end">{{ comissionado.valor_faturado | formatar_float_para_brl }}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
            {% endif %}

            {% set credito_fornecedor = detalhes.credito_fornecedor %}
            {% set credito_transportadora = detalhes.credito_transportadora %}
            {% set credito_extrator = detalhes.credito_extrator %}
            {% set todos_creditos = credito_fornecedor + credito_transportadora + credito_extrator %}

            {% if todos_creditos %}
            <div class="card mb-4 shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
              <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="me-2">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path
                        d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" />
                      <path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" />
                    </svg>
                    Créditos ({{ todos_creditos|length }})
                  </h6>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table mb-0">
                    <thead style="background: #f8f9fa;">
                      <tr>
                        <th class="fw-semibold text-center">Tipo</th>
                        <th class="fw-semibold text-center">Identificação</th>
                        <th class="fw-semibold text-center">Valor Utilizado</th>
                      </tr>
                    </thead>
                    <tbody>
                      {%if credito_fornecedor%}
                      {% for credito in credito_fornecedor %}
                      <tr>
                        <td class="text-center">
                          <span class="badge bg-success-lt">Fornecedor</span>
                        </td>
                        <td class="text-center">{{ credito.get('descricao', '') or credito.get('credito_descricao') }}
                        </td>
                        <td class="text-center">
                          <span class="badge bg-red-lt">{% if credito.get('valor_original') %}{{
                            credito.get('valor_original', 0) | formatar_float_para_brl }}{%else%}
                            {{ credito.get('valor_credito_100', 0) | formatar_float_para_brl }}
                            {%endif%}
                          </span>
                        </td>
                      </tr>

                      {% endfor %}
                      {%endif%}
                      {%if credito_transportadora%}
                      {% for credito in credito_transportadora %}
                      <tr>
                        <td class="text-center">
                          <span class="badge bg-blue-lt">Transportadora</span>
                        </td>
                        <td class="text-center">{{ credito.get('credito_descricao', credito.get('descricao', '')) }}
                        </td>
                        <td class="text-center">
                          <span class="badge bg-red-lt">
                            {% if credito.get('valor_original') %}{{ credito.get('valor_original', 0) |
                            formatar_float_para_brl }}{%else%}
                            {{ credito.get('valor_credito_100', 0) | formatar_float_para_brl }}
                            {%endif%}
                          </span>
                        </td>
                      </tr>
                      {% endfor %}
                      {%endif%}
                      {%if credito_extrator%}
                      {% for credito in credito_extrator %}
                      <tr>
                        <td class="text-center">
                          <span class="badge bg-orange-lt">Extrator</span>
                        </td>
                        <td class="text-center">{{ credito.get('credito_descricao', '') }}</td>
                        <td class="text-center">
                          <span class="badge bg-red-lt">R$ {{ "%.2f"|format(credito.get('valor_credito_100', 0) / 100)
                            }}</span>
                        </td>
                      </tr>
                      {% endfor %}
                      {%endif%}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endif %}

            {% if not fornecedores and not transportadoras and not extratores and not comissionados and not
            todos_creditos %}
            <div class="text-center py-4 text-muted">
              <div class="mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                  <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                  <path d="M10 12l4 4m0 -4l-4 4" />
                </svg>
              </div>
              <h6 class="fw-bold mb-2">Nenhum detalhe encontrado</h6>
              <p class="text-muted mb-0">Este faturamento não possui detalhes associados.</p>
            </div>
            {% endif %}

            {% set anexos_agendamento = agendamento.anexos %}
            
            <div class="row g-4 mb-4">
              <div class="col-md-12">
                <div class="card shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
                  <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
                    <div class="d-flex align-items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" />
                      </svg>
                      <span class="fw-bold">
                        {% if anexos_agendamento and anexos_agendamento|length > 0 %}
                          Anexos
                        {% else %}
                          Anexos
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="card-body p-0">
                    {% if anexos_agendamento and anexos_agendamento|length > 0 %}
                    <div class="list-group list-group-flush">
                      {% for anexo in anexos_agendamento %}
                      {% if anexo.ativo and not anexo.deletado %}
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icons-tabler-outline icon-tabler-file-text me-2 text-primary">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                            <path d="M9 9l1 0" />
                            <path d="M9 13l6 0" />
                            <path d="M9 17l6 0" />
                          </svg>
                          <div>
                            <div class="fw-bold">{{ anexo.upload_arquivo.nome_arquivo_original }}</div>
                            <small class="text-muted">
                              Enviado em {{ anexo.data_cadastro.strftime('%d/%m/%Y às %H:%M') }}
                              {% if anexo.upload_arquivo.tamanho_bytes %}
                                • {{ (anexo.upload_arquivo.tamanho_bytes / 1024)|round(2) }} KB
                              {% endif %}
                            </small>
                          </div>
                        </div>
                        <div>
                          <a href="{{ url_for('diretorio_uploads_anexo_comprovante_receita_despesa', filename=anexo.upload_arquivo.caminho.split('/')[-1]) }}" 
                             target="_blank" 
                             class="btn btn-icon btn-sm btn-outline-primary me-2"
                             title="Visualizar arquivo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                              <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                            </svg>
                          </a>
                          <a href="{{ url_for('diretorio_uploads_anexo_comprovante_receita_despesa', filename=anexo.upload_arquivo.caminho.split('/')[-1]) }}" 
                             download
                             class="btn btn-icon btn-sm btn-outline-secondary"
                             title="Baixar arquivo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="icon icon-tabler icons-tabler-outline icon-tabler-download">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                              <path d="M7 11l5 5l5 -5" />
                              <path d="M12 4l0 12" />
                            </svg>
                          </a>
                        </div>
                      </div>
                      {% endif %}
                      {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-3 text-center text-muted">
                      <small>Nenhum anexo foi adicionado a este faturamento.</small>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
        <div class="modal-footer border-0" style="background: #f8f9fa; padding: 1rem 2rem;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  </div>

  <div id="container-modais-excluir">
  
  {% for agendamento in agendamentos %}
  <div class="modal modal-blur fade" id="modal-excluir-{{ agendamento.id }}" tabindex="-1" role="dialog"
    aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-status bg-danger"></div>
        <div class="modal-body text-center py-4">
          
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon mb-2 text-danger icon-lg">
            <path d="M12 9v4" />
            <path
              d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
            <path d="M12 16h.01" />
          </svg>
          <h3>Atenção!</h3>
          <div class="text-secondary">Você realmente tem certeza que deseja excluir? Essa ação não pode ser desfeita.
          </div>
          <small class="text-danger">Caso conciliado, a conciliação será revertida!</small>
        </div>
        <div class="modal-footer">
          <div class="w-100">
            <div class="row">
              <div class="col">
                <a href="#" class="btn btn-3 w-100" data-bs-dismiss="modal">
                  Cancelar
                </a>
              </div>
              <div class="col">
                <a href="{{ url_for('excluir_despesa_avulsa', id=agendamento.id) }}" class="btn btn-danger btn-4 w-100">
                  Excluir
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  </div>

  <div id="container-modais-lancamento">
  
  {% for agendamento in agendamentos %}
  {% if agendamento.lancamento_avulso_id and agendamento.lancamento_avulso %}
  <div class="modal modal-blur fade" id="modal-lancamento-{{ agendamento.lancamento_avulso_id }}" tabindex="-1"
    role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-0"
          style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
          <h4 class="modal-title text-white fw-bold">
            Lançamento Avulso - {{ agendamento.lancamento_avulso.descricao if agendamento.lancamento_avulso.descricao
            else 'N/A' }}
          </h4>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          
          <div class="p-4"
            style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-bottom: 1px solid #dee2e6;">
            <div class="row g-4">
              <div class="col-md-4 text-center">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                  </svg>
                </div>
                <div class="text-muted small fw-medium text-uppercase">Data de Lançamento</div>
                <div class="mb-0 fw-bold">{{ agendamento.lancamento_avulso.data_cadastro.strftime('%d/%m/%Y') if
                  agendamento.lancamento_avulso.data_cadastro else 'N/A' }}</div>
              </div>
              <div class="col-md-4 text-center">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                  </svg>
                </div>
                <div class="text-muted small fw-medium text-uppercase">Valor</div>
                <div class="mb-0 fw-bold" style="color: #1B5E20;">{{
                  agendamento.lancamento_avulso.valor_movimentacao_100 | formatar_float_para_brl if
                  agendamento.lancamento_avulso.valor_movimentacao_100 else 'R$ 0,00' }}</div>
              </div>
              <div class="col-md-4 text-center">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="#1B5E20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M7 10l5 -6l5 6" />
                    <path d="M21 10l-2 8a2 2.5 0 0 1 -2 2h-10a2 2.5 0 0 1 -2 -2l-2 -8z" />
                    <path d="M12 15v4" />
                  </svg>
                </div>
                <div class="text-muted small fw-medium text-uppercase">Situação</div>
                <div class="mb-0 fw-bold">{{ agendamento.lancamento_avulso.situacao.situacao if
                  agendamento.lancamento_avulso.situacao else 'N/A' }}</div>
              </div>
            </div>
          </div>

          <div class="p-4">            
            <div class="row g-4 mb-4">
              <div class="col-md-12">
                <div class="card shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#1B5E20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
                        <path d="M13.5 6.5l4 4" />
                      </svg>
                      <span class="text-muted small fw-medium text-uppercase">Descrição</span>
                    </div>
                    <div class="fw-bold mb-0">{{ agendamento.lancamento_avulso.descricao if
                      agendamento.lancamento_avulso.descricao else 'N/A' }}</div>
                  </div>
                </div>
              </div>
            </div>
            
            {% set anexos_agendamento = agendamento.anexos %}
            
            <div class="row g-4 mb-4">
              <div class="col-md-12">
                <div class="card shadow-sm" style="border-radius: 12px; border: 1px solid #e3e6f0;">
                  <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
                    <div class="d-flex align-items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" />
                      </svg>
                      <span class="fw-bold">
                        {% if anexos_agendamento and anexos_agendamento|length > 0 %}
                          Anexos
                        {% else %}
                          Anexos
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="card-body p-0">
                    {% if anexos_agendamento and anexos_agendamento|length > 0 %}
                    <div class="list-group list-group-flush">
                      {% for anexo in anexos_agendamento %}
                      {% if anexo.ativo and not anexo.deletado %}
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icons-tabler-outline icon-tabler-file-text me-2 text-primary">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                            <path d="M9 9l1 0" />
                            <path d="M9 13l6 0" />
                            <path d="M9 17l6 0" />
                          </svg>
                          <div>
                            <div class="fw-bold">{{ anexo.upload_arquivo.nome_arquivo_original }}</div>
                            <small class="text-muted">
                              Enviado em {{ anexo.data_cadastro.strftime('%d/%m/%Y às %H:%M') }}
                              {% if anexo.upload_arquivo.tamanho_bytes %}
                                • {{ (anexo.upload_arquivo.tamanho_bytes / 1024)|round(2) }} KB
                              {% endif %}
                            </small>
                          </div>
                        </div>
                        <div>
                          <a href="{{ url_for('diretorio_uploads_anexo_comprovante_receita_despesa', filename=anexo.upload_arquivo.caminho.split('/')[-1]) }}" 
                             target="_blank" 
                             class="btn btn-icon btn-sm btn-outline-primary me-2"
                             title="Visualizar arquivo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                              <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                            </svg>
                          </a>
                          <a href="{{ url_for('diretorio_uploads_anexo_comprovante_receita_despesa', filename=anexo.upload_arquivo.caminho.split('/')[-1]) }}" 
                             download 
                             class="btn btn-icon btn-sm btn-outline-success"
                             title="Baixar arquivo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="icon icon-tabler icons-tabler-outline icon-tabler-download">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                              <path d="M7 11l5 5l5 -5" />
                              <path d="M12 4l0 12" />
                            </svg>
                          </a>
                        </div>
                      </div>
                      {% endif %}
                      {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-3 text-center text-muted">
                      <small>Nenhum anexo foi adicionado a este lançamento.</small>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0" style="background: #f8f9fa; padding: 1rem 2rem;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M18 6l-12 12" />
              <path d="M6 6l12 12" />
            </svg>
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  </div>

  <div id="container-modais-liquidacao">
  
  {% for agendamento in agendamentos %}
  <div class="modal modal-blur fade" id="modal-liquidacao-{{ agendamento.id }}" tabindex="-1" role="dialog"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header border-0"
          style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
          <h4 class="modal-title text-white fw-bold">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M7 9m0 2a2 2 0 0 1 2 -2h6a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-6a2 2 0 0 1 -2 -2z" />
              <path d="M14 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
              <path d="M17 9v-2a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v2" />
            </svg>
            Liquidar Receita
          </h4>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form method="POST" action="{{ url_for('liquidar_despesa') }}">
          <input type="hidden" name="agendamento_id" value="{{ agendamento.id }}">

          <div class="modal-body p-0">
            
            <div class="p-4"
              style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-bottom: 1px solid #dee2e6;">
              <div class="row g-4">
                <div class="col-md-4 text-center">
                  <div class="mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                      stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                      <line x1="16" y1="2" x2="16" y2="6" />
                      <line x1="8" y1="2" x2="8" y2="6" />
                      <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                  </div>
                  <div class="text-muted small fw-medium text-uppercase">Vencimento</div>
                  <div class="mb-0 fw-bold">{{ agendamento.data_vencimento.strftime('%d/%m/%Y') }}</div>
                </div>
                <div class="col-md-4 text-center">
                  <div class="mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                      stroke="#1B5E20" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                    </svg>
                  </div>
                  <div class="text-muted small fw-medium text-uppercase">Valor Total</div>
                  <div class="mb-0 fw-bold" style="color: #1B5E20;">
                    {% if agendamento.faturamento_id and agendamento.faturamento %}
                    {{ agendamento.faturamento.valor_total | formatar_float_para_brl }}
                    {% elif agendamento.lancamento_avulso_id and agendamento.lancamento_avulso %}
                    {{ agendamento.lancamento_avulso.valor_movimentacao_100 | formatar_float_para_brl }}
                    {% else %}
                    {{ agendamento.valor_total_100 | formatar_float_para_brl }}
                    {% endif %}
                  </div>
                </div>
                <div class="col-md-4 text-center">
                  <div class="mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                      stroke="#1B5E20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                      <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                    </svg>
                  </div>
                  <div class="text-muted small fw-medium text-uppercase">Beneficiário</div>
                  <div class="mb-0 fw-bold">
                    {% if agendamento.faturamento_id and agendamento.faturamento and agendamento.faturamento.cliente %}
                    {{ agendamento.faturamento.cliente.nome or agendamento.faturamento.cliente.razao_social }}
                    {% else %}
                    {{ agendamento.pessoa_financeiro.identificacao | truncate(20, '...') }}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div class="p-4">
              <div class="row g-4">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Selecionar Conta Bancária</label>
                  <select class="form-select modal-select" name="conta_bancaria_id" id="selectConta-{{ agendamento.id }}">
                    <option value="">Todas as contas</option>
                    {% for conta in contas_bancarias %}
                    <option value="{{ conta.id }}" {% if conta_selecionada_id==conta.id %}selected{% endif %}>
                      {{ conta.identificacao }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer border-0" style="background: #f8f9fa; padding: 1rem 2rem;">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M18 6l-12 12" />
                <path d="M6 6l12 12" />
              </svg>
              Cancelar
            </button>
            <button type="submit" class="btn btn-success">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M7 9m0 2a2 2 0 0 1 2 -2h6a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-6a2 2 0 0 1 -2 -2z" />
                <path d="M14 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                <path d="M17 9v-2a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v2" />
              </svg>
              Confirmar Liquidação
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
  </div>

  {% include 'estrutura/footer.html' %}

  <script src="{{ url_for('static', filename='js/pages/despesa-avulsa-listagem.js') }}"></script>

  <script>
  </script>
</div>

{% endblock conteudo %}