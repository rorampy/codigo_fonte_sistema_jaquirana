<!-- Crie este arquivo: templates/financeiro/faturamentos/relatorio_pdf.html -->

<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Relatório de Faturamento - {{ faturamento.codigo_faturamento }}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      margin: 20px;
      color: #333;
      line-height: 1.4;
    }

    .header {
      border-bottom: 2px solid #1c5f20;
      padding-bottom: 15px;
      margin-bottom: 25px;
    }

    .header table {
      width: 100%;
      border: none;
    }

    .header img {
      width: 120px;
    }

    .system-info {
      text-align: right;
      font-size: 11px;
      color: #666;
    }

    .relatorio-title {
      text-align: center;
      font-size: 18px;
      color: #1c5f20;
      font-weight: bold;
      margin: 20px 0;
      text-transform: uppercase;
    }

    .section-title {
      color: #1c5f20;
      font-weight: bold;
      font-size: 14px;
      margin: 20px 0 10px 0;
      padding: 8px 10px;
      background-color: #f0f8f0;
      border-left: 4px solid #1c5f20;
    }

    .simple-info {
      margin: 8px 0;
      font-size: 12px;
      padding: 5px 0;
    }

    .simple-info strong {
      color: #1c5f20;
      display: inline-block;
      min-width: 150px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0 20px 0;
      border: 1px solid #ddd;
    }

    th {
      background-color: #1c5f20;
      color: white;
      padding: 10px 8px;
      text-align: center;
      font-weight: bold;
      font-size: 11px;
    }

    td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 11px;
      text-align: center;
    }

    td:first-child {
      text-align: left;
      font-weight: bold;
      background-color: #f8f9fa;
    }

    tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .valor-destaque {
      color: #1c5f20;
      font-weight: bold;
    }

    .credito-sim {
      color: #28a745;
      font-weight: bold;
      background-color: #d4edda;
      padding: 2px 8px;
      border-radius: 3px;
      border: 1px solid #c3e6cb;
    }

    .credito-nao {
      color: #6c757d;
      font-weight: bold;
      background-color: #f8f9fa;
      padding: 2px 8px;
      border-radius: 3px;
      border: 1px solid #dee2e6;
    }

    .status-sim {
      background-color: #d4edda;
      color: #155724;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
    }

    .status-nao {
      background-color: #f8d7da;
      color: #721c24;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
    }

    .resumo-financeiro {
      margin: 20px 0;
      padding: 15px;
      background-color: #f0f8f0;
      border: 1px solid #c3e6c3;
      border-radius: 5px;
    }

    .resumo-financeiro .simple-info {
      margin: 10px 0;
      font-size: 13px;
    }

    .valor-total-destaque {
      font-size: 14px;
      color: #1c5f20;
      font-weight: bold;
      margin: 15px 0;
      padding: 8px 0;
      border-top: 1px solid #c3e6c3;
    }

    .info-faturamento {
      background-color: #f8f9fa;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }

    .info-faturamento .simple-info {
      margin: 5px 0;
    }

    .highlight-box {
      background-color: #e8f5e8;
      border: 1px solid #c3e6c3;
      padding: 12px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .total-principal {
      background-color: #1c5f20 !important;
      color: white !important;
    }

    .total-principal td {
      background-color: #1c5f20 !important;
      color: white !important;
      font-size: 13px !important;
      padding: 12px 8px !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .total-valor {
      font-size: 15px !important;
      font-weight: bold !important;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      font-size: 10px;
      color: #777;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }

    .oculto {
      background-color: #f5f5f5;
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 20px;
      border: 1px dashed #ccc;
    }

    .detalhes-registro {
      font-size: 10px;
    }

    .grupo-titulo {
      background-color: #1c5f20;
      color: white;
      font-weight: bold;
      text-transform: uppercase;
    }

    .grupo-titulo td {
      background-color: #1c5f20 !important;
      color: white !important;
      padding: 8px !important;
    }

    .subtotal {
      background-color: #e8f5e8;
      font-weight: bold;
      color: #1c5f20;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <table>
      <tr>
        <td style="width: 200px;">
          <img src="{{ logo_path }}" alt="Logo MBR Extração" />
        </td>
        <td class="system-info">
          <div><strong>Sistema de Gestão MBR</strong></div>
          <div><strong>Relatório gerado em:</strong> {{ data_geracao }}</div>
        </td>
      </tr>
    </table>
  </div>

  <div class="relatorio-title">Relatório de Faturamento | {{ faturamento.codigo_faturamento }}</div>

  <!-- Dados do Faturamento -->
  <div class="section-title">DADOS DO FATURAMENTO</div>
  {% if not opcoes.ocultar_cliente %}
  <div class="simple-info">
    <strong>Código:</strong> {{ faturamento.codigo_faturamento }}
  </div>
  <div class="simple-info">
    <strong>Data/Hora:</strong> {{ faturamento.data_cadastro }}
  </div>
  <div class="simple-info">
    <strong>Situação:</strong> {{ faturamento.situacao }}
  </div>
  {% endif %}

  <!-- Cargas a Receber -->
  {% if cargas_a_receber %}
  <div class="section-title">CARGAS A RECEBER ({{ total_cargas_a_receber }} registros)</div>

  <!-- Resumo por carga -->
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Qtd. Registros</th>
        <th>Valor Total</th>
      </tr>
    </thead>
    <tbody>
      {% for nome_cliente, grupo in cargas_a_receber.items() %}
      <tr>
        <td>{{ nome_cliente }}</td>
        <td>{{ grupo.registros | length }}</td>
        <td class="valor-destaque">{{ grupo.total | formatar_float_para_brl }}</td>
      </tr>
      {% endfor %}
      <tr class="total-principal">
        <td><strong>TOTAL CARGAS A RECEBER</strong></td>
        <td><strong>{{ total_cargas_a_receber }}</strong></td>
        <td class="total-valor"><strong>{{ faturamento.valor_cargas_a_receber | formatar_float_para_brl }}</strong>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Detalhes dos clientes -->
  {% for nome_cliente, grupo in cargas_a_receber.items() %}
  <div class="section-title">DETALHES - {{ nome_cliente }}</div>
  <table>
    <thead>
      <tr>
        <th>Data Entrega</th>
        <th>Fornecedor</th>
        <th>Transportadora</th>
        <th>Produto/Bitola</th>
        <th>NF</th>
        <th>Peso (Ton)</th>
        <th>Preço Custo</th>
        <th>Valor Bruto</th>
        <th>Valor Final</th>
      </tr>
    </thead>
    <tbody>
      {% for registro in grupo.registros %}
      <tr class="detalhes-registro">
        <td>{{ registro.data_entrega or '-' }}</td>
        <td>{{ registro.fornecedor_identificacao | truncate(30, '...') or '-' }}</td>
        <td>{{ registro.transportadora_identificacao | truncate(30, '...') or '-' }}</td>
        <td>{{ registro.produto or '-' }} | {{ registro.bitola or '-' }}</td>
        <td>{{ registro.nota_fiscal or '-' }}</td>
        <td>{{ registro.peso_ticket or '-' }}</td>
        <td>{{ registro.preco_custo | formatar_float_para_brl or '-' }}</td>
        <td>{{ registro.valor_bruto | formatar_float_para_brl or '-' }}</td>
        <td class="valor-destaque">{{ registro.valor_faturado | formatar_float_para_brl or '-' }}</td>
      </tr>
      {% endfor %}
      <tr class="subtotal">
        <td colspan="8"><strong>Subtotal {{ nome_cliente }}</strong></td>
        <td class="valor-destaque"><strong>{{ grupo.total | formatar_float_para_brl }}</strong></td>
      </tr>
    </tbody>
  </table>
  {% endfor %}
  {% endif %}

  <!-- NFs Complementares -->
  {% if nfs_complementares %}
  <div class="section-title">NFS COMPLEMENTARES ({{ total_nfs_complementares }} registros)</div>

  <!-- Resumo por cliente -->
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Qtd. NFs</th>
        <th>Valor Total</th>
      </tr>
    </thead>
    <tbody>
      {% for nome_cliente, grupo in nfs_complementares.items() %}
      <tr>
        <td>{{ nome_cliente }}</td>
        <td>{{ grupo.nfs | length }}</td>
        <td class="valor-destaque">{{ (grupo.total) | formatar_float_para_brl }}</td>
      </tr>
      {% endfor %}
      <tr class="total-principal">
        <td><strong>TOTAL NFS COMPLEMENTARES</strong></td>
        <td><strong>{{ total_nfs_complementares }}</strong></td>
        <td class="total-valor"><strong>{{ (nfs_complementares.values() | sum(attribute='total')) | formatar_float_para_brl }}</strong></td>
      </tr>
    </tbody>
  </table>

  <!-- Detalhes das NFs por cliente -->
  {% for nome_cliente, grupo in nfs_complementares.items() %}
  <div class="section-title">DETALHES NF COMPLEMENTAR - {{ nome_cliente }}</div>
  
  {% for nf in grupo.nfs %}
  <div style="margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
    <div style="font-weight: bold; color: #1c5f20; margin-bottom: 10px;">
      NF Complementar: {{ nf.numero_nf or '-' }} | 
      Data: {{ nf.destinatario_data_emissao or '-' }} | 
      Valor: {{ (nf.valor_total_nota_100) | formatar_float_para_brl }}
    </div>
    
    {% if nf.registros_operacionais %}
    <table style="margin-top: 10px;">
      <thead>
        <tr>
          <th>Data Entrega</th>
          <th>Fornecedor</th>
          <th>Transportadora</th>
          <th>Placa/Motorista</th>
          <th>Produto/Bitola</th>
          <th>Peso Ticket</th>
          <th>Número NF</th>
        </tr>
      </thead>
      <tbody>
        {% for reg in nf.registros_operacionais %}
        <tr class="detalhes-registro">
          <td>{{ reg.data_entrega_ticket or '-' }}</td>
          <td>{{ reg.fornecedor or '-' }}</td>
          <td>{{ reg.transportadora or '-' }}</td>
          <td>{{ reg.placa_veiculo or '-' }} | {{ reg.motorista or '-' }}</td>
          <td>{{ reg.produto or '-' }} | {{ reg.bitola or '-' }}</td>
          <td>{{ reg.peso_liquido_ticket or 0 }} Ton.</td>
          <td>{{ reg.numero_nota_fiscal or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align: center; color: #666; font-style: italic; padding: 10px;">
      Nenhum registro operacional encontrado para esta NF complementar.
    </div>
    {% endif %}
  </div>
  {% endfor %}
  {% endfor %}
  {% endif %}

  <!-- NFs de Serviço -->
  {% if nfs_servico %}
  <div class="section-title">NFS DE SERVIÇO ({{ total_nfs_servico }} registros)</div>

  <!-- Resumo por cliente -->
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Qtd. NFs</th>
        <th>Valor Total</th>
      </tr>
    </thead>
    <tbody>
      {% for nome_cliente, grupo in nfs_servico.items() %}
      <tr>
        <td>{{ nome_cliente }}</td>
        <td>{{ grupo.nfs | length }}</td>
        <td class="valor-destaque">{{ (grupo.total) | formatar_float_para_brl }}</td>
      </tr>
      {% endfor %}
      <tr class="total-principal">
        <td><strong>TOTAL NFS DE SERVIÇO</strong></td>
        <td><strong>{{ total_nfs_servico }}</strong></td>
        <td class="total-valor"><strong>{{ (nfs_servico.values() | sum(attribute='total')) | formatar_float_para_brl }}</strong></td>
      </tr>
    </tbody>
  </table>

  <!-- Detalhes das NFs por cliente -->
  {% for nome_cliente, grupo in nfs_servico.items() %}
  <div class="section-title">DETALHES NF SERVIÇO - {{ nome_cliente }}</div>
  <table>
    <thead>
      <tr>
        <th>Data Emissão</th>
        <th>Discriminação</th>
        <th>Valor Total</th>
      </tr>
    </thead>
    <tbody>
      {% for nf in grupo.nfs %}
      <tr class="detalhes-registro">
        <td>{{ nf.data_emissao or '-' }}</td>
        <td>{{ nf.discriminacao or '-' }}</td>
        <td class="valor-destaque">{{ (nf.valor_total) | formatar_float_para_brl }}</td>
      </tr>
      {% endfor %}
      <tr class="subtotal">
        <td colspan="2"><strong>Subtotal {{ nome_cliente }}</strong></td>
        <td class="valor-destaque"><strong>{{ grupo.total | formatar_float_para_brl }}</strong></td>
      </tr>
    </tbody>
  </table>
  {% endfor %}
  {% endif %}

  <!-- Total Geral -->
  {% if not opcoes.ocultar_cliente %}
  <div class="section-title">CONSOLIDADO FINAL</div>
  <table>
    <thead>
      <tr>
        <th>Descrição</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody>
      {% if cargas_a_receber%}
      <tr>
        <td>Total a Receber</td>
        <td class="valor-destaque">{{ faturamento.valor_total | formatar_float_para_brl }}</td>
      </tr>
      {% endif %}
      {% if nfs_complementares %}
      <tr>
        <td>Total NFs Complementares</td>
        <td class="valor-destaque">{{ (nfs_complementares.values() | sum(attribute='total')) | formatar_float_para_brl }}</td>
      </tr>
      {% endif %}
      {% if nfs_servico %}
      <tr>
        <td>Total NFs de Serviço</td>
        <td class="valor-destaque">{{ (nfs_servico.values() | sum(attribute='total')) | formatar_float_para_brl }}</td>
      </tr>
      {% endif %}
      <tr class="total-principal">
        <td><strong>VALOR TOTAL GERAL</strong></td>
        <td class="total-valor"><strong>{{ faturamento.valor_total | formatar_float_para_brl }}</strong></td>
      </tr>
    </tbody>
  </table>
  {% endif %}

  <div class="footer">
    <p><strong>MBR Extração &copy; 2025</strong> - Todos os direitos reservados</p>
    <p><strong>Sistema de Gestão MBR - Módulo Financeiro</strong></p>
    <p>Relatório de Faturamento gerado automaticamente pelo Sistema de Gestão MBR</p>
  </div>
</body>

</html>