{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}
<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">
            CONTROLE DE CR√âDITOS
          </div>
          <h2 class="page-title">
            Faturamentos de Cr√©ditos
          </h2>
        </div>
        <div class="col-12 col-md-auto ms-auto d-print-none">
          <div class="d-flex gap-2">
            <!-- Bot√µes de filtro r√°pido -->
            <a href="{{ url_for('listagem_faturamentos_controle_credito', situacaoFaturamento='') }}"
              class="btn btn-outline-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-list">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M9 6l11 0" />
                <path d="M9 12l11 0" />
                <path d="M9 18l11 0" />
                <path d="M5 6l0 .01" />
                <path d="M5 12l0 .01" />
                <path d="M5 18l0 .01" />
              </svg>
              Todos
            </a>
            <a href="{{ url_for('listagem_faturamentos_controle_credito', situacaoFaturamento=6) }}"
              class="btn btn-outline-success">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-circle-check">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                <path d="m9 12 2 2 4 -4" />
              </svg>
              Categorizados
            </a>
            <a href="{{ url_for('listagem_faturamentos_controle_credito', situacaoFaturamento=7) }}"
              class="btn btn-outline-warning">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-clock">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
                <path d="M12 7v5l3 3" />
              </svg>
              N√£o Categorizado
            </a>
            <a href="#" class="btn" data-bs-toggle="modal" data-bs-target="#modal-report">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-filter">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
              </svg>
              Filtrar </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">

      {% include 'estrutura/mensagens_flash.html' %}

      <!-- Indicador dos filtros aplicados -->
      <div class="col-12 mb-3">
        <div class="alert alert-info d-flex align-items-center bg-white" role="alert">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler me-2">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
          </svg>
          <div>
            <strong>Visualiza√ß√£o atual:</strong>
            {% if dados_corretos.get('beneficiario') %}
            {% for b in beneficiarios %}
            {% if b.id == dados_corretos.get('beneficiario')|int %}
            Benefici√°rio: {{ b.identificacao }}
            {% endif %}
            {% endfor %}
            {% endif %}

            {% if dados_corretos.get('situacaoFaturamento') %}
            {% for s in situacoes_faturamento %}
            {% if s.id == dados_corretos.get('situacaoFaturamento')|int %}
            {% if dados_corretos.get('beneficiario') %} | {% endif %}{{ s.situacao }}
            {% endif %}
            {% endfor %}
            {% elif 'situacaoFaturamento' in dados_corretos and dados_corretos.get('situacaoFaturamento') == '' %}
            {% if dados_corretos.get('beneficiario') %} | {% endif %}Todos os Faturamentos
            {% elif not dados_corretos %}
            N√£o Categorizados (padr√£o)
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12">
        {% if faturamentos%}
        <div class="card">
          <div class="table-responsive">
            <table id="tabela-faturamentos" class="table table-vcenter card-table">
              <thead>
                <tr>
                  <th style="text-align: center;">C√≥d. Faturamento</th>
                  <th style="text-align: center;">Data/Hora</th>
                  <th style="text-align: center;">Valor Total</th>
                  <!-- <th style="text-align: center;">Utilizou Cr√©dito</th>-->
                  <th style="text-align: center;">Situa√ß√£o</th>
                  <th style="text-align: center;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {% for faturamento in faturamentos %}
                <tr>
                  <td class="text-secondary text-center">
                    <span class="text-muted">{{ faturamento.codigo_faturamento }}</span>
                  </td>
                  <td class="text-secondary text-center">
                    {% if faturamento.data_cadastro %}
                    {{ faturamento.data_cadastro.strftime('%d/%m/%Y %H:%M') }}
                    {% else %}
                    N/A
                    {% endif %}
                  </td>
                  <td class="text-secondary text-center">
                    <span>
                      {% if faturamento.valor_total %}
                      {{ faturamento.valor_total | formatar_float_para_brl }}
                      {% else %}
                      -
                      {% endif %}
                    </span>
                  </td>
                  <td class="text-secondary text-center">
                    {% if faturamento.situacao %}
                    {% if faturamento.situacao.id == 6 %}
                    <span class="badge badge-outline text-success">{{ faturamento.situacao.situacao }}</span>
                    {% else %}
                    <span class="badge badge-outline text-warning">{{ faturamento.situacao.situacao }}</span>
                    {% endif %}
                    {% else %}
                    <span class="badge badge-outline text-warning">Pendente</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="btn-list flex-nowrap justify-content-center">
                      <button type="button" class="btn btn-icon btn-outline-primary" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Visualizar detalhes" data-faturamento-id="{{ faturamento.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                          <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                        </svg>
                      </button>

                      {% if faturamento.situacao_pagamento_id == 6 or faturamento.situacao_pagamento_id == 8 %}
                      <!-- Bot√£o para ver categoriza√ß√£o (j√° categorizado) -->
                      <button type="button" class="btn btn-icon btn-outline-dark" data-bs-toggle="modal"
                        data-bs-target="#modal-categorizacao" onclick="carregarCategorizacao({{ faturamento.id }})"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="Visualizar Categoriza√ß√£o">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-check-circle">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                          <path d="m9 12 2 2 4 -4" />
                        </svg>
                      </button>
                      {% else %}
                      <!-- Bot√£o para categorizar (n√£o categorizado) -->
                      <a href="{{ url_for('categorizar_fatura', id=faturamento.id) }}"
                        class="btn btn-icon btn-outline-orange" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Categorizar Fatura">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-category">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 4h6v6h-6z" />
                          <path d="M14 4h6v6h-6z" />
                          <path d="M4 14h6v6h-6z" />
                          <path d="M17 17m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                        </svg>
                      </a>
                      {% endif %}
                      <a href="{{ url_for('exportar_controle_creditos_pdf', faturamento_id=faturamento.id) }}"
                        target="_blank" class="btn btn-icon btn-outline-danger" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Exportar Relat√≥rio PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-pdf">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M10 8v8h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-2z" />
                          <path d="M3 12h2a2 2 0 1 0 0 -4h-2v8" />
                          <path d="M17 12h3" />
                          <path d="M21 8h-4v8" />
                        </svg>
                      </a>
                      <a href="{{ url_for('exportar_controle_creditos_imagem', faturamento_id=faturamento.id) }}"
                        target="_blank" class="btn btn-icon btn-outline-warning" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Exportar Relat√≥rio como Imagem">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-photo-scan">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M15 8h.01" />
                          <path d="M6 13l2.644 -2.644a1.21 1.21 0 0 1 1.712 0l3.644 3.644" />
                          <path d="M13 13l1.644 -1.644a1.21 1.21 0 0 1 1.712 0l1.644 1.644" />
                          <path d="M4 8v-2a2 2 0 0 1 2 -2h2" />
                          <path d="M4 16v2a2 2 0 0 0 2 2h2" />
                          <path d="M16 4h2a2 2 0 0 1 2 2v2" />
                          <path d="M16 20h2a2 2 0 0 0 2 -2v-2" />
                        </svg>
                      </a>
                      <a href="#"
                        class="btn btn-icon btn-outline-danger excluir  {%if faturamento.situacao_pagamento_id == 6%} disabled {%endif%}"
                        data-bs-toggle="modal" data-bs-target="#modal-desativar-{{faturamento.id}}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-tabler icons-tabler-outline icon-tabler-trash">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 7l16 0" />
                          <path d="M10 11l0 6" />
                          <path d="M14 11l0 6" />
                          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                        </svg>
                      </a>
                      <div class="modal modal-blur fade" id="modal-desativar-{{faturamento.id}}" tabindex="-1"
                        role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                          <div class="modal-content">
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            <div class="modal-status bg-danger"></div>
                            <div class="modal-body text-center py-4">
                              <!-- Download SVG icon from http://tabler.io/icons/icon/alert-triangle -->
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="icon mb-2 text-danger icon-lg">
                                <path d="M12 9v4" />
                                <path
                                  d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
                                <path d="M12 16h.01" />
                              </svg>
                              <div class="text-secondary">
                                Voc√™ realmente deseja excluir este faturamento?
                              </div>
                            </div>
                            <div class="modal-footer">
                              <div class="w-100">
                                <div class="row">
                                  <div class="col">
                                    <a href="#" class="btn btn-3 w-100" data-bs-dismiss="modal">
                                      Fechar
                                    </a>
                                  </div>
                                  <div class="col">
                                    <a href="{{url_for('excluir_faturamento_creditos', faturamento_id=faturamento.id)}}"
                                      class="btn btn-danger btn-4 w-100">
                                      Excluir
                                    </a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                  </td>
          </div>
          </td>
          </tr>
          {% endfor %}
          </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <div class="area-info-card"
        style="padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2); background-color: white;">
        <div class="icon-extrato" style="font-size: 70px; color: #fc7801; margin-bottom: 15px">üí≥</div>
        <h2 style="font-size: 22px; margin-bottom: 10px; color: #555;">Nenhum cr√©dito de fornecedor dispon√≠vel</h2>
        <p style="color: #777;">No momento n√£o h√° faturamentos de cr√©ditos de fornecedores para serem exibidos.</p>
      </div>
      {%endif%}
    </div>
  </div>
</div>

<!-- Filtro -->
<div class="modal modal-blur fade" id="modal-report" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered" role="document" style="display: grid;">
    <form action="" method="GET">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Filtrar Faturamentos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Benefici√°rio</label>
              <select class="form-select" name="beneficiario" id="beneficiario">
                <option value="">Todos os Benefici√°rios</option>
                {% for b in beneficiarios %}
                <option value="{{ b.id }}" {% if dados_corretos.get('beneficiario')==b.id|string %}selected{% endif %}>
                  {{ b.identificacao }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Situa√ß√£o Faturamento</label>
              <select class="form-select" name="situacaoFaturamento" id="situacaoFaturamento">
                <option value="">Todas as Situa√ß√µes</option>
                {% for s in situacoes_faturamento %}
                <option value="{{ s.id }}" {% if dados_corretos.get('situacaoFaturamento')==s.id|string %}selected{%
                  endif %}>
                  {{ s.situacao }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <a href="{{ url_for('listagem_faturamentos_controle_credito') }}" class="btn btn-link link-secondary btn-3">
            Limpar Filtros
          </a>
          <button type="submit" class="btn btn-primary btn-5 ms-auto">
            <!-- Download SVG icon from http://tabler.io/icons/icon/plus -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-2">
              <path d="M12 5l0 14" />
              <path d="M5 12l14 0" />
            </svg>
            Filtrar
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-faturamento" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header border-0"
        style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
        <h4 class="modal-title text-white fw-bold">
          <span id="modal-faturamento-id"></span>
        </h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-0">
        <div id="loading-faturamento" class="text-center py-5">
          <div class="spinner-border" style="color: #1B5E20;" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <div class="mt-3 text-muted">Carregando detalhes do faturamento...</div>
        </div>

        <div id="conteudo-faturamento" style="display: none;">
          <div class="p-4">
            <!-- Fornecedores -->
            <div class="mb-5" id="secao-fornecedores">
              <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center">
                  <div>
                    <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Cr√©ditos de Fornecedor</h5>
                    <div class="text-muted">
                      <span id="total-fornecedores">0</span> cr√©dito aplicado ‚Ä¢
                      <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-fornecedores">R$
                        0,00</span>
                    </div>
                  </div>
                </div>
              </div>
              <div id="lista-fornecedores"></div>
            </div>

            <!-- Transportadoras  -->
            <div class="mb-5" id="secao-transportadoras">
              <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center">
                  <div>
                    <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Cr√©ditos de Transportadora</h5>
                    <div class="text-muted">
                      <span id="total-transportadoras">0</span> cr√©dito aplicado ‚Ä¢
                      <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-transportadoras">R$
                        0,00</span>
                    </div>
                  </div>
                </div>
              </div>
              <div id="lista-transportadoras"></div>
            </div>


            <!-- Extratores  -->
            <div class="mb-5" id="secao-extratores">
              <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center">
                  <div>
                    <h5 class="mb-1 fw-bold" style="color: #1B5E20;">Cr√©ditos de Extrator</h5>
                    <div class="text-muted">
                      <span id="total-extratores">0</span> cr√©dito aplicado ‚Ä¢
                      <span style="color: #1B5E20; border-color: #1B5E20;" id="total-valor-extratores">R$
                        0,00</span>
                    </div>
                  </div>
                </div>
              </div>
              <div id="lista-extratores"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0" style="background: #f8f9fa; padding: 1rem 2rem;">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M18 6l-12 12" />
            <path d="M6 6l12 12" />
          </svg>
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>
</div>

{% include 'estrutura/footer.html' %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('select.form-select').forEach(function (select) {
      new TomSelect(select, {
        create: false,
        allowEmptyOption: false,
        sortField: { field: "text", direction: "asc" }
      });
    });
  });
  // Vari√°vel global para o modal PDF
  let faturamentoParaPDF = null;
  let faturamentoParaImagem = null;

  // Inicializa√ß√£o quando DOM carregar
  document.addEventListener('DOMContentLoaded', function () {
    // Event listeners para visualizar faturamentos
    document.querySelectorAll('[data-faturamento-id]').forEach(button => {
      button.addEventListener('click', function () {
        const faturamentoId = this.getAttribute('data-faturamento-id');
        visualizarFaturamento(faturamentoId);
      });
    });

  });

  // ===== FUN√á√ïES PRINCIPAIS =====

  function visualizarFaturamento(id) {
    const modal = new bootstrap.Modal(document.getElementById('modal-faturamento'));
    modal.show();

    document.getElementById('loading-faturamento').style.display = 'block';
    document.getElementById('conteudo-faturamento').style.display = 'none';

    fetch(`/financeiro/operacional/controle-creditos/detalhes/${id}`)
      .then(response => response.json())
      .then(data => {
        if (data.erro) {
          alert('Erro: ' + data.erro);
          modal.hide();
          return;
        }

        const modalTitle = document.getElementById('modal-faturamento-id');
        if (modalTitle) {
          modalTitle.textContent = data.faturamento.codigo_faturamento;
        }

        // Processar dados de cr√©ditos com arrays seguros
        const creditosFornecedores = data.creditos_fornecedores || [];
        const creditosTransportadoras = data.creditos_transportadoras || [];
        const creditosExtratores = data.creditos_extratores || [];

        processarCreditosFornecedores(creditosFornecedores);
        processarCreditosTransportadoras(creditosTransportadoras);
        processarCreditosExtratores(creditosExtratores);

        // Verificar se n√£o h√° dados para mostrar mensagem informativa
        verificarDadosVazios(creditosFornecedores, creditosTransportadoras, creditosExtratores);

        // Contadores
        document.getElementById('total-fornecedores').textContent = data.faturamento.total_creditos_fornecedores;

        document.getElementById('total-transportadoras').textContent = data.faturamento.total_creditos_transportadoras;

        document.getElementById('total-extratores').textContent = data.faturamento.total_creditos_extratores;

        // Esconder loading e mostrar conte√∫do
        document.getElementById('loading-faturamento').style.display = 'none';
        document.getElementById('conteudo-faturamento').style.display = 'block';
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao carregar os detalhes do faturamento');
        modal.hide();
      });
  }

  function processarCreditosFornecedores(creditos) {
    const container = document.getElementById('lista-fornecedores');
    const secaoFornecedores = document.getElementById('secao-fornecedores');

    container.innerHTML = '';

    if (!creditos.length) {
      // Esconder a se√ß√£o inteira quando n√£o h√° cr√©ditos
      secaoFornecedores.style.display = 'none';
      document.getElementById('total-valor-fornecedores').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a se√ß√£o quando h√° cr√©ditos
    secaoFornecedores.style.display = 'block';

    // Agrupar e processar cr√©ditos de fornecedores
    const grupos = {};
    let totalGeral = 0;

    creditos.forEach(item => {
      const nome = item.fornecedor_identificacao;
      if (!grupos[nome]) {
        grupos[nome] = { registros: [], total: 0 };
      }
      grupos[nome].registros.push(item);
      // Parse do valor do cr√©dito
      const valor = parseFloat(item.valor_credito_100.replace(/[R$\s.]/g, '').replace(',', '.'));
      grupos[nome].total += valor;
      totalGeral += valor;
    });

    document.getElementById('total-valor-fornecedores').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar grupos - layout para cr√©ditos de fornecedores
    Object.entries(grupos).forEach(([nome, grupo]) => {
      const card = document.createElement('div');
      card.className = 'card mb-4 shadow-sm';
      card.style.borderRadius = '12px';
      card.style.border = '1px solid #e3e6f0';

      card.innerHTML = `
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div>
                <h6 class="mb-0 fw-bold">${nome}</h6>
                <small class="text-muted">${grupo.registros.length} cr√©dito lan√ßado</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th class="fw-semibold text-center">Data</th>
                  <th class="fw-semibold text-center">Descri√ß√£o</th>
                  <th class="fw-semibold text-center">Conta Banc√°ria</th>
                  <th class="fw-semibold text-center text-end">Valor do Cr√©dito</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.registros.map(r => `
                  <tr>
                    <td class="text-center">${r.data_movimentacao}</td>
                    <td class="text-center">${r.credito_descricao}</td>
                    <td class="text-center">${r.conta_bancaria_id}</td>
                    <td class="text-center">
                      <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor_credito_100}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function processarCreditosTransportadoras(creditos) {
    console.log('Processando cr√©ditos de transportadoras:', creditos);
    const container = document.getElementById('lista-transportadoras');
    const secaoTransportadoras = document.getElementById('secao-transportadoras');

    container.innerHTML = '';

    if (!creditos.length) {
      // Esconder a se√ß√£o inteira quando n√£o h√° cr√©ditos
      secaoTransportadoras.style.display = 'none';
      document.getElementById('total-valor-transportadoras').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a se√ß√£o quando h√° cr√©ditos
    secaoTransportadoras.style.display = 'block';

    // Agrupar e processar cr√©ditos de transportadoras
    const grupos = {};
    let totalGeral = 0;

    creditos.forEach(item => {
      const nome = item.transportadora_identificacao;
      if (!grupos[nome]) {
        grupos[nome] = { registros: [], total: 0 };
      }
      grupos[nome].registros.push(item);
      // Parse do valor do cr√©dito
      const valor = parseFloat(item.valor_credito_100.replace(/[R$\s.]/g, '').replace(',', '.'));
      grupos[nome].total += valor;
      totalGeral += valor;
    });

    document.getElementById('total-valor-transportadoras').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar grupos - layout para cr√©ditos de transportadoras
    Object.entries(grupos).forEach(([nome, grupo]) => {
      const card = document.createElement('div');
      card.className = 'card mb-4 shadow-sm';
      card.style.borderRadius = '12px';
      card.style.border = '1px solid #e3e6f0';

      card.innerHTML = `
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div>
                <h6 class="mb-0 fw-bold">${nome}</h6>
                <small class="text-muted">${grupo.registros.length} cr√©dito lan√ßado</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th class="fw-semibold text-center">Data</th>
                  <th class="fw-semibold text-center">Descri√ß√£o</th>
                  <th class="fw-semibold text-center">Conta Banc√°ria</th>
                  <th class="fw-semibold text-center text-end">Valor do Cr√©dito</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.registros.map(r => `
                  <tr>
                    <td class="text-center">${r.data_movimentacao}</td>
                    <td class="text-center">${r.credito_descricao}</td>
                    <td class="text-center">${r.conta_bancaria_id}</td>
                    <td class="text-center">
                      <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor_credito_100}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function processarCreditosExtratores(creditos) {
    console.log('Processando cr√©ditos de extratores:', creditos);
    const container = document.getElementById('lista-extratores');
    const secaoExtratores = document.getElementById('secao-extratores');

    container.innerHTML = '';

    if (!creditos.length) {
      // Esconder a se√ß√£o inteira quando n√£o h√° cr√©ditos
      secaoExtratores.style.display = 'none';
      document.getElementById('total-valor-extratores').textContent = 'R$ 0,00';
      return;
    }

    // Mostrar a se√ß√£o quando h√° cr√©ditos
    secaoExtratores.style.display = 'block';

    // Agrupar e processar cr√©ditos de extratores
    const grupos = {};
    let totalGeral = 0;

    creditos.forEach(item => {
      const nome = item.extrator_identificacao;
      if (!grupos[nome]) {
        grupos[nome] = { registros: [], total: 0 };
      }
      grupos[nome].registros.push(item);
      // Parse do valor do cr√©dito
      const valor = parseFloat(item.valor_credito_100.replace(/[R$\s.]/g, '').replace(',', '.'));
      grupos[nome].total += valor;
      totalGeral += valor;
    });

    document.getElementById('total-valor-extratores').textContent =
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalGeral);

    // Criar grupos - layout para cr√©ditos de extratores
    Object.entries(grupos).forEach(([nome, grupo]) => {
      const card = document.createElement('div');
      card.className = 'card mb-4 shadow-sm';
      card.style.borderRadius = '12px';
      card.style.border = '1px solid #e3e6f0';

      card.innerHTML = `
        <div class="card-header py-3" style="background: #f8f9fa; border-bottom: 1px solid #e3e6f0;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div>
                <h6 class="mb-0 fw-bold">${nome}</h6>
                <small class="text-muted">${grupo.registros.length} cr√©dito lan√ßado</small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th class="fw-semibold text-center">Data</th>
                  <th class="fw-semibold text-center">Descri√ß√£o</th>
                  <th class="fw-semibold text-center">Conta Banc√°ria</th>
                  <th class="fw-semibold text-center text-end">Valor do Cr√©dito</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.registros.map(r => `
                  <tr>
                    <td class="text-center">${r.data_movimentacao}</td>
                    <td class="text-center">${r.credito_descricao}</td>
                    <td class="text-center">${r.conta_bancaria_id}</td>
                    <td class="text-center">
                      <span class="badge badge-outline" style="color: #1B5E20; border-color: #1B5E20;">${r.valor_credito_100}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  // ===== FUN√á√ïES DE EXPORTAR PDF =====

  function abrirModalExportarPDF(faturamentoId) {
    faturamentoParaPDF = faturamentoId;
    faturamentoParaImagem = null;

    const modalElement = document.getElementById('modal-exportar-pdf');
    if (!modalElement) {
      console.error('Modal de exportar PDF n√£o encontrado');
      return;
    }

    // Restaurar t√≠tulo original do modal
    const modalTitle = modalElement.querySelector('.modal-title');
    modalTitle.innerHTML = `
    Exportar Faturamento para PDF
  `;

    // Restaurar texto do bot√£o e limpar event listeners
    const btnGerar = document.getElementById('btn-gerar-pdf');
    btnGerar.innerHTML = `
    Gerar PDF
  `;

    // Limpar todos os event listeners e definir apenas um
    btnGerar.replaceWith(btnGerar.cloneNode(true));
    const newBtnGerar = document.getElementById('btn-gerar-pdf');
    newBtnGerar.onclick = function () {
      gerarPDFFaturamento();
    };

    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      } else {
        // Fallback manual
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');

        // Criar backdrop
        if (!document.querySelector('.modal-backdrop')) {
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          document.body.appendChild(backdrop);
        }
      }
    } catch (error) {
      console.log('Erro ao abrir modal PDF:', error);
      // Fallback final
      modalElement.style.display = 'block';
      modalElement.classList.add('show');
      document.body.classList.add('modal-open');
    }
  }

  function gerarPDFFaturamento() {
    if (!faturamentoParaPDF) {
      mostrarNotificacao('Erro: Nenhum faturamento selecionado.', 'error');
      return;
    }

    // Coletar op√ß√µes do modal
    const opcoes = {
      ocultar_fornecedores: document.getElementById('ocultar-fornecedores')?.checked || false,
      ocultar_transportadoras: document.getElementById('ocultar-transportadoras')?.checked || false,
      ocultar_cliente: document.getElementById('ocultar-cliente')?.checked || false,
      ocultar_receitas_avulsas: document.getElementById('ocultar-receitas-avulsas')?.checked || false,
      ocultar_despesas_avulsas: document.getElementById('ocultar-despesas-avulsas')?.checked || false
    };

    // Criar formul√°rio para enviar via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/financeiro/faturamentos/exportar-pdf/${faturamentoParaPDF}`;
    form.target = '_blank'; // Abrir em nova aba

    // Adicionar dados das op√ß√µes
    Object.keys(opcoes).forEach(key => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = opcoes[key];
      form.appendChild(input);
    });

    // Adicionar CSRF token se necess√°rio
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'csrf_token';
      input.value = csrfToken.getAttribute('content');
      form.appendChild(input);
    }

    // Enviar formul√°rio
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    // Fechar modal
    fecharModalSeguro('modal-exportar-pdf');

    mostrarNotificacao('PDF sendo gerado...', 'info');
  }

  // ===== FUN√á√ïES AUXILIARES =====

  function fecharModalSeguro(modalId) {
    const modalElement = document.getElementById(modalId);
    if (!modalElement) return;

    try {
      // Tentar Bootstrap Modal
      if (window.bootstrap && window.bootstrap.Modal) {
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
          modalInstance.hide();
        } else {
          const modal = new bootstrap.Modal(modalElement);
          modal.hide();
        }
        return;
      }

      // Fallback manual
      modalElement.style.display = 'none';
      modalElement.classList.remove('show');
      document.body.classList.remove('modal-open');

      // Remover backdrop se existir
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }

    } catch (error) {
      console.log('Erro ao fechar modal:', error);
      // Fallback final
      modalElement.style.display = 'none';
      modalElement.classList.remove('show');
      document.body.classList.remove('modal-open');

      // Remover backdrop
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
    }
  }

  function mostrarNotificacao(mensagem, tipo = 'info') {
    // Toast simples do Tabler (se n√£o tiver, usar fallback)
    if (typeof window.Tabler !== 'undefined' && window.Tabler.toast) {
      window.Tabler.toast({
        message: mensagem,
        type: tipo
      });
    } else {
      // Fallback: criar toast manual
      const toast = document.createElement('div');
      toast.className = `bg-white alert alert-${tipo === 'success' ? 'success' : tipo === 'warning' ? 'warning' : tipo === 'error' ? 'danger' : 'info'} alert-dismissible`;
      toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
      toast.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
      `;

      document.body.appendChild(toast);

      // Auto remover ap√≥s 4 segundos
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 4000);
    }
  }

  // ======== FUN√á√ÉO DE EXPORTAR IMG ======

  function abrirModalExportarImagem(faturamentoId) {
    faturamentoParaImagem = faturamentoId;
    faturamentoParaPDF = null; // Limpar vari√°vel de PDF

    const modalElement = document.getElementById('modal-exportar-pdf'); // Reutilizar o mesmo modal
    if (!modalElement) {
      console.error('Modal de exportar n√£o encontrado');
      return;
    }

    // Alterar t√≠tulo do modal para imagem
    const modalTitle = modalElement.querySelector('.modal-title');
    modalTitle.innerHTML = `
    Exportar Faturamento para Imagem
  `;

    // Alterar texto do bot√£o e limpar event listeners
    const btnGerar = document.getElementById('btn-gerar-pdf');
    btnGerar.innerHTML = `
    Gerar Imagem
  `;

    // Limpar todos os event listeners e definir apenas um
    btnGerar.replaceWith(btnGerar.cloneNode(true));
    const newBtnGerar = document.getElementById('btn-gerar-pdf');
    newBtnGerar.onclick = function () {
      gerarImagemFaturamento();
    };

    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      } else {
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');

        if (!document.querySelector('.modal-backdrop')) {
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          document.body.appendChild(backdrop);
        }
      }
    } catch (error) {
      console.log('Erro ao abrir modal imagem:', error);
      modalElement.style.display = 'block';
      modalElement.classList.add('show');
      document.body.classList.add('modal-open');
    }
  }

  // Gerar imagem do faturamento

  function gerarImagemFaturamento() {
    if (!faturamentoParaImagem) {
      mostrarNotificacao('Erro: Nenhum faturamento selecionado.', 'error');
      return;
    }

    // Coletar op√ß√µes do modal (mesmo do PDF)
    const opcoes = {
      ocultar_fornecedores: document.getElementById('ocultar-fornecedores')?.checked || false,
      ocultar_transportadoras: document.getElementById('ocultar-transportadoras')?.checked || false,
      ocultar_cliente: document.getElementById('ocultar-cliente')?.checked || false,
      ocultar_receitas_avulsas: document.getElementById('ocultar-receitas-avulsas')?.checked || false,
      ocultar_despesas_avulsas: document.getElementById('ocultar-despesas-avulsas')?.checked || false
    };

    // Criar formul√°rio para enviar via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/financeiro/faturamentos/exportar-imagem/${faturamentoParaImagem}`; // Nova rota
    form.target = '_blank';

    // Adicionar dados das op√ß√µes
    Object.keys(opcoes).forEach(key => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = opcoes[key];
      form.appendChild(input);
    });

    // Adicionar CSRF token se necess√°rio
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'csrf_token';
      input.value = csrfToken.getAttribute('content');
      form.appendChild(input);
    }

    // Enviar formul√°rio
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    // Fechar modal
    fecharModalSeguro('modal-exportar-pdf');

    mostrarNotificacao('Imagem sendo gerada...', 'info');
  }

  // ===== FUN√á√ÉO PARA VERIFICAR DADOS VAZIOS =====

  // Fun√ß√£o melhorada para verificar dados vazios
  function verificarDadosVazios(creditosFornecedores, creditosTransportadoras, creditosExtratores) {
    const temCreditosFornecedores = creditosFornecedores && creditosFornecedores.length > 0;
    const temCreditosTransportadoras = creditosTransportadoras && creditosTransportadoras.length > 0;
    const temCreditosExtratores = creditosExtratores && creditosExtratores.length > 0;

    // Se n√£o h√° nenhum tipo de cr√©dito, criar mensagem informativa
    if (!temCreditosFornecedores && !temCreditosTransportadoras && !temCreditosExtratores) {
      const conteudoFaturamento = document.querySelector('#conteudo-faturamento .p-4');
      if (conteudoFaturamento) {
        conteudoFaturamento.innerHTML = `
        <div class="text-center py-5 text-muted">
          <div class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 5m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z"/>
              <path d="M3 10l18 0"/>
              <path d="M7 15l.01 0"/>
              <path d="M11 15l2 0"/>
            </svg>
          </div>
          <h5 class="fw-bold mb-2">Faturamento sem cr√©ditos</h5>
          <p class="text-muted mb-0">Este faturamento de cr√©ditos n√£o possui cr√©ditos de fornecedores ou transportadoras associados.</p>
        </div>
      `;
      }
    }
  }

</script>

<!-- Modal de Categoriza√ß√£o Simples -->
<div class="modal modal-blur fade" id="modal-categorizacao" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header border-0"
        style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 1.5rem 2rem;">
        <h4 class="modal-title text-white fw-bold">
          Categoriza√ß√£o do Faturamento
        </h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-0">
        <div id="loading-categorizacao" class="text-center py-5">
          <div class="spinner-border" style="color: #1B5E20;" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <div class="mt-3 text-muted">Carregando dados da categoriza√ß√£o...</div>
        </div>

        <div id="conteudo-categorizacao" style="display: none;">
          <!-- O conte√∫do ser√° carregado via JavaScript -->
        </div>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="20" height="20" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
          </svg>
          Fechar
        </button>
        <button type="button" class="btn btn-primary" onclick="editarCategorizacao()">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="20" height="20" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
            <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
            <path d="M16 5l3 3" />
          </svg>
          Editar Categoriza√ß√£o
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let faturamentoSelecionadoId = null;
  let categoriaId = null;

  function carregarCategorizacao(faturamentoId) {
    faturamentoSelecionadoId = faturamentoId;

    // Mostrar loading
    document.getElementById('loading-categorizacao').style.display = 'block';
    document.getElementById('conteudo-categorizacao').style.display = 'none';

    // Fazer requisi√ß√£o para controle de cr√©ditos
    fetch(`/financeiro/operacional/categorizacao/controle-creditos/detalhes-json/${faturamentoId}`)
      .then(response => response.text())
      .then(text => {
        // Esconder loading
        document.getElementById('loading-categorizacao').style.display = 'none';

        try {
          const data = JSON.parse(text);
          if (data.error) {
            document.getElementById('conteudo-categorizacao').innerHTML = `
              <div class="alert alert-danger m-3">
                <h4>Erro</h4>
                <p>${data.error}</p>
              </div>
            `;
          } else {
            categoriaId = data.categorizacao_id
            // Montar HTML com os dados
            document.getElementById('conteudo-categorizacao').innerHTML = montarHtmlCategorizacao(data);
          }
        } catch (e) {
          document.getElementById('conteudo-categorizacao').innerHTML = `
            <div class="alert alert-danger m-3">
              <h4>Erro de Comunica√ß√£o</h4>
              <p>N√£o foi poss√≠vel carregar os dados da categoriza√ß√£o.</p>
            </div>
          `;
        }

        document.getElementById('conteudo-categorizacao').style.display = 'block';
      })
      .catch(error => {
        console.error('Erro:', error);
        document.getElementById('loading-categorizacao').style.display = 'none';
        document.getElementById('conteudo-categorizacao').innerHTML = `
        <div class="alert alert-danger m-3">
          <h4>Erro ao Carregar</h4>
          <p>N√£o foi poss√≠vel carregar os dados da categoriza√ß√£o.</p>
        </div>
      `;
        document.getElementById('conteudo-categorizacao').style.display = 'block';
      });
  }

  function montarHtmlCategorizacao(data) {
    console.log(data)
    // Usar valores vindos do backend - j√° convertidos para reais
    const valorBrutoTotal = data.faturamento.valor_bruto_total || data.faturamento.valor_total || 0;
    const valorCreditoTotal = data.faturamento.valor_credito_total || 0;
    const valorFinalTotal = data.faturamento.valor_total || 0;

    let html = `
    <div class="p-4">
      <!-- Informa√ß√µes do Pagamento -->
      <div class="mb-4">
        <h4 class="mb-3" style="color: #277329;">
          Informa√ß√µes da Categoriza√ß√£o
        </h4>
        <div class="row">
          <div class="col-md-4">
            <div class="text-muted small mb-1">Benefici√°rio</div>
            <div class="fw-bold">${data.pagamento.beneficiario}</div>
          </div>
          <div class="col-md-4">
            <div class="text-muted small mb-1">Data Vencimento</div>
            <div class="fw-bold">${data.pagamento.data_vencimento}</div>
          </div>
          <div class="col-md-4">
            <div class="text-muted small mb-1">Situa√ß√£o Pagamento</div>
            <div><span class="badge badge-outline text-yellow">${data.pagamento.situacao_nome}</span></div>
          </div>
        </div>
      </div>`;

    // Se√ß√£o de Cr√©ditos de Fornecedores
    if (data.faturamento.creditos_fornecedores && data.faturamento.creditos_fornecedores.length > 0) {
      const totalCreditosFornecedores = data.faturamento.creditos_fornecedores.reduce((total, f) => total + (f.valor_credito || 0), 0);

      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Cr√©ditos de Fornecedores</h6>
        <div class="text-muted small mb-3">${data.faturamento.creditos_fornecedores.length} cr√©dito(s) ‚Ä¢ R$ ${totalCreditosFornecedores.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">FORNECEDOR</th>
                <th class="small text-uppercase text-center">DATA MOVIMENTA√á√ÉO</th>
                <th class="small text-uppercase text-center">DESCRI√á√ÉO</th>
                <th class="small text-uppercase text-center">VALOR CR√âDITO</th>
                <th class="small text-uppercase text-center">CONTA BANC√ÅRIA</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.creditos_fornecedores.forEach(credito => {
        const valorCredito = credito.valor_credito || 0;
        const nomeFornecedor = credito.identificacao || 'N/A';
        const dataMovimentacao = credito.data_movimentacao || 'N/A';
        const descricao = credito.credito_descricao || 'N/A';
        const contaBancaria = credito.conta_bancaria_id || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeFornecedor}</td>
                <td class="text-center">${dataMovimentacao}</td>
                <td class="text-center">${descricao}</td>
                <td class="text-center">R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${contaBancaria}</td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Se√ß√£o de Cr√©ditos de Transportadoras
    if (data.faturamento.creditos_transportadoras && data.faturamento.creditos_transportadoras.length > 0) {
      const totalCreditosTransportadoras = data.faturamento.creditos_transportadoras.reduce((total, t) => total + (t.valor_credito || 0), 0);

      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Cr√©ditos de Transportadoras</h6>
        <div class="text-muted small mb-3">${data.faturamento.creditos_transportadoras.length} cr√©dito(s) ‚Ä¢ R$ ${totalCreditosTransportadoras.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">TRANSPORTADORA</th>
                <th class="small text-uppercase text-center">DATA MOVIMENTA√á√ÉO</th>
                <th class="small text-uppercase text-center">DESCRI√á√ÉO</th>
                <th class="small text-uppercase text-center">VALOR CR√âDITO</th>
                <th class="small text-uppercase text-center">CONTA BANC√ÅRIA</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.creditos_transportadoras.forEach(credito => {
        const valorCredito = credito.valor_credito || 0;
        const nomeTransportadora = credito.identificacao || 'N/A';
        const dataMovimentacao = credito.data_movimentacao || 'N/A';
        const descricao = credito.credito_descricao || 'N/A';
        const contaBancaria = credito.conta_bancaria_id || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeTransportadora}</td>
                <td class="text-center">${dataMovimentacao}</td>
                <td class="text-center">${descricao}</td>
                <td class="text-center">R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${contaBancaria}</td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Se√ß√£o de Cr√©ditos de Extratores
    if (data.faturamento.creditos_extratores && data.faturamento.creditos_extratores.length > 0) {
      const totalCreditosExtratores = data.faturamento.creditos_extratores.reduce((total, t) => total + (t.valor_credito || 0), 0);

      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Cr√©ditos de Extratores</h6>
        <div class="text-muted small mb-3">${data.faturamento.creditos_extratores.length} cr√©dito(s) ‚Ä¢ R$ ${totalCreditosExtratores.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">EXTRATOR</th>
                <th class="small text-uppercase text-center">DATA MOVIMENTA√á√ÉO</th>
                <th class="small text-uppercase text-center">DESCRI√á√ÉO</th>
                <th class="small text-uppercase text-center">VALOR CR√âDITO</th>
                <th class="small text-uppercase text-center">CONTA BANC√ÅRIA</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.creditos_extratores.forEach(credito => {
        const valorCredito = credito.valor_credito || 0;
        const nomeExtrator = credito.identificacao || 'N/A';
        const dataMovimentacao = credito.data_movimentacao || 'N/A';
        const descricao = credito.credito_descricao || 'N/A';
        const contaBancaria = credito.conta_bancaria_id || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeExtrator}</td>
                <td class="text-center">${dataMovimentacao}</td>
                <td class="text-center">${descricao}</td>
                <td class="text-center">R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${contaBancaria}</td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Se√ß√£o de Comissionados
    if (data.faturamento.comissionados && data.faturamento.comissionados.length > 0) {
      const totalComissionados = data.faturamento.comissionados.reduce((total, t) => total + (t.valor || 0), 0) / 100;

      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Comissionados</h6>
        <div class="text-muted small mb-3">${data.faturamento.comissionados.length} registro ‚Ä¢ R$ ${totalComissionados.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">NOME</th>
                <th class="small text-uppercase text-center">VALOR BRUTO</th>
                <th class="small text-uppercase text-center">CR√âDITO UTILIZADO</th>
                <th class="small text-uppercase text-center">VALOR FINAL</th>
              </tr>
            </thead>
            <tbody>`;

      data.faturamento.comissionados.forEach(comissionado => {
        const valorBruto = (comissionado.valor_bruto_total || comissionado.valor_bruto || 0) / 100;
        const valorCredito = (comissionado.valor_credito_aplicado || comissionado.valor_credito || 0) / 100;
        const valorFinal = (comissionado.valor || comissionado.valor_faturado || 0) / 100;
        const nomeComissionado = comissionado.identificacao || comissionado.nome || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeComissionado}</td>
                <td class="text-center">R$ ${valorBruto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center"><span>R$ ${valorCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
                <td class="text-center"><span>R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Se√ß√£o de Receitas Avulsas
    if (data.receitas_avulsas && data.receitas_avulsas.length > 0) {
      const totalReceitas = data.receitas_avulsas.reduce((total, r) => {
        const valor = parseFloat(r.valor.replace(/[R$\s.]/g, '').replace(',', '.'));
        return total + valor;
      }, 0);

      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Receitas Avulsas</h6>
        <div class="text-muted small mb-3">${data.receitas_avulsas.length} receita ‚Ä¢ R$ ${totalReceitas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">DESCRI√á√ÉO</th>
                <th class="small text-uppercase text-center">CONTA BANC√ÅRIA</th>
                <th class="small text-uppercase text-center">DATA CADASTRO</th>
                <th class="small text-uppercase text-center">VALOR</th>
              </tr>
            </thead>
            <tbody>`;

      data.receitas_avulsas.forEach(receita => {
        html += `
              <tr>
                <td class="text-center">${receita.descricao}</td>
                <td class="text-center">${receita.conta_bancaria}</td>
                <td class="text-center">${receita.data_cadastro}</td>
                <td class="text-center"><span>R$ ${receita.valor}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Se√ß√£o de Despesas Avulsas
    if (data.despesas_avulsas && data.despesas_avulsas.length > 0) {
      const totalDespesas = data.despesas_avulsas.reduce((total, d) => {
        const valor = parseFloat(d.valor.replace(/[R$\s.]/g, '').replace(',', '.'));
        return total + valor;
      }, 0);

      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Despesas Avulsas</h6>
        <div class="text-muted small mb-3">${data.despesas_avulsas.length} despesa ‚Ä¢ R$ ${totalDespesas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">DESCRI√á√ÉO</th>
                <th class="small text-uppercase text-center">CONTA BANC√ÅRIA</th>
                <th class="small text-uppercase text-center">DATA CADASTRO</th>
                <th class="small text-uppercase text-center">VALOR</th>
              </tr>
            </thead>
            <tbody>`;

      data.despesas_avulsas.forEach(despesa => {
        html += `
              <tr>
                <td class="text-center">${despesa.descricao}</td>
                <td class="text-center">${despesa.conta_bancaria}</td>
                <td class="text-center">${despesa.data_cadastro}</td>
                <td class="text-center"><span class="text-danger">R$ ${despesa.valor}</span></td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }    // Se√ß√£o de Categoriza√ß√£o por Conta
    if (data.categorias && data.categorias.length > 0) {
      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Categoriza√ß√£o por Conta</h6>
        <div class="text-muted small mb-3">${data.categorias.length} categoria</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">CATEGORIA</th>
                <th class="small text-uppercase text-center">VALOR</th>
                <th class="small text-uppercase text-center">DESCRI√á√ÉO</th>
              </tr>
            </thead>
            <tbody>`;

      let totalCategorias = 0;
      data.categorias.forEach(categoria => {
        const valorCategoria = categoria.valor / 100 || 0; // Valor j√° vem em reais do backend
        totalCategorias += valorCategoria;
        const nomeCategoria = categoria.nome || 'N/A';

        html += `
              <tr>
                <td class="text-center">${nomeCategoria}</td>
                <td class="text-center">R$ ${valorCategoria.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${categoria.detalhamento || '-'}</td>
              </tr>`;
      });

      html += `
            </tbody>
            <tfoot>
              <tr class="table-active fw-bold">
                <td class="text-center">TOTAL</td>
                <td class="text-center">R$ ${totalCategorias.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-end"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>`;
    }

    // Se√ß√£o de Centros de Custo (se houver)
    console.log('Debug centros_custo:', data.centros_custo);
    if (data.centros_custo && data.centros_custo.length > 0) {
      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Centros de Custo</h6>
        <div class="text-muted small mb-3">${data.centros_custo.length} centro(s) de custo</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">CENTRO DE CUSTO</th>
                <th class="small text-uppercase text-center">VALOR</th>
                <th class="small text-uppercase text-center">PERCENTUAL</th>
              </tr>
            </thead>
            <tbody>`;

      data.centros_custo.forEach(centro => {
        console.log('Debug centro individual:', centro);

        // Tratar valores que podem vir do backend de diferentes formas
        const valorCentro = centro.valor || 0;
        const nomeCentro = centro.nome || centro.descricao || centro.centro || 'Centro n√£o informado';
        const percentualCentro = centro.percentual || 0;

        html += `
              <tr>
                <td class="text-center">${nomeCentro}</td>
                <td class="text-center">R$ ${valorCentro.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${percentualCentro ? parseFloat(percentualCentro).toFixed(1) : '0.0'}%</td>
              </tr>`;
      });

      html += ` 
            </tbody>
          </table>
        </div>
      </div>`;
    }

    // Se√ß√£o de Parcelas
    if (data.parcelas && data.parcelas.length > 0) {
      html += `
      <div class="mb-4">
        <h6 class="text-muted mb-2">Parcelas</h6>
        <div class="text-muted small mb-3">${data.parcelas.length} parcela</div>
        
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr class="text-muted">
                <th class="small text-uppercase text-center">PARCELA</th>
                <th class="small text-uppercase text-center">VENCIMENTO</th>
                <th class="small text-uppercase text-center text-end">VALOR</th>
                <th class="small text-uppercase text-center">SITUA√á√ÉO</th>
              </tr>
            </thead>
            <tbody>`;

      data.parcelas.forEach(parcela => {
        const valorParcela = parcela.valor_parcela / 100;
        const situacaoNome = parcela.situacao_nome || parcela.situacao || 'Pendente';
        html += `
              <tr>
                <td class="text-center">${parcela.numero_parcela}/${data.parcelas.length}</td>
                <td class="text-center">${parcela.data_vencimento}</td>
                <td class="text-center">R$ ${valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td class="text-center">${situacaoNome}</td>
              </tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      </div>`;
    }

    html += '</div>';
    return html;
  }
</script>
<script>
  function editarCategorizacao() {
    if (!categoriaId) {
      alert('Nenhuma categoria selecionada!');
      return;
    }

    // Fechar o modal atual
    const modal = document.getElementById('modal-categorizacao');
    if (modal) {
      const modalInstance = bootstrap.Modal.getInstance(modal);
      if (modalInstance) {
        modalInstance.hide();
      }
    }

    window.location.href = `/faturamento/editar-categorizacao/${categoriaId}/receita`;
  }
</script>

{% endblock conteudo %}