{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle text-muted">Financeiro</div>
          <h2 class="page-title fw-bold display-6">Confirmação de Faturamento - Comissionado</h2>
        </div>
      </div>
    </div>
  </div>

  {% if conciliar_transacao_id %}
  {% set titulo_pagina = "comissionado" %}
  {% include 'financeiro/importar_ofx/dados_conciliacao_component.html' %}
  {% endif %}

  <div class="py-4">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      <div class="row row-cards mb-4">
        
        <div class="col-md-6 col-lg-6">
          <div class="card border shadow-lg rounded-3 stat-card-hover card-orange">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-orange text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-file-invoice">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                  <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                  <path d="M9 7l1 0" />
                  <path d="M9 13l6 0" />
                  <path d="M13 17l2 0" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold small">Total a Faturar</div>
                <div class="fs-3 fw-bold text-orange mt-1" id="total-pagar">{{registro.valor_total_a_pagar_100 |
                  formatar_float_para_brl}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-6">
          <div class="card border shadow-lg rounded-3 stat-card-hover card-green">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-green text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icon-tabler-user-dollar">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                  <path d="M6 21v-2a4 4 0 0 1 4 -4h3" />
                  <path d="M21 15h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" />
                  <path d="M19 21v1m0 -8v1" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold small">Comissionado</div>
                <div class="fs-3 fw-bold text-green mt-1">{{registro.comissionado.identificacao if registro.comissionado else 'N/A'}}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-light fw-bold">Informações Gerais</div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-2">
              <label class="form-label">Fornecedor</label>
              <input type="text" class="form-control"
                value="{{ registro_operacional.solicitacao.fornecedor.identificacao if registro_operacional.solicitacao and registro_operacional.solicitacao.fornecedor else '' }}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Valor da NF</label>
              <input type="text" class="form-control"
                value="{{ registro_operacional.valor_total_nota_100 | default(0) | formatar_float_para_brl }}" disabled
                readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Comissionado</label>
              <input type="text" class="form-control"
                value="{{ registro.comissionado.identificacao if registro.comissionado else '' }}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Preço Comissão</label>
              <input type="text" id="preco-custo" class="form-control campo-moeda-brl"
                value="{{ registro.preco_custo_bitola_100 | default(0) | formatar_float_para_brl }}">
            </div>
            <div class="col-md-2">
              <label class="form-label">Peso Ton.</label>
              <input type="text" id="peso-toneladas" class="form-control"
                value="{{ registro_operacional.peso_liquido_ticket or 0 }}" disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Valor a Faturar</label>
              <input type="text" id="valor-pagar-input" class="form-control"
                value="{{ registro.valor_total_a_pagar_100 | default(0) | formatar_float_para_brl }}" disabled readonly>
            </div>
          </div>
        </div>
      </div>

      <form action="{{ url_for('comissionado_a_pagar', id=registro.id) }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="valor_total_calculado" id="valor-total-hidden">
        <input type="hidden" name="preco_custo_atualizado" id="preco-custo-hidden">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body">
            <div class="text-end">
              <a class="btn btn-primary" href="javascript:history.back()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-left">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M5 12l14 0" />
                  <path d="M5 12l6 6" />
                  <path d="M5 12l6 -6" />
                </svg>Voltar
              </a>
              <button type="submit" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M12 5l0 14" />
                  <path d="M5 12l14 0" />
                </svg> Faturar
              </button>
            </div>
          </div>
        </div>
      </form>

    </div>
  </div>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/informar-pagamento.css') }}">

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const precoCustoInput = document.getElementById('preco-custo');
      const pesoInput = document.getElementById('peso-toneladas');
      const valorPagarInput = document.getElementById('valor-pagar-input');
      const valorTotalHidden = document.getElementById('valor-total-hidden');
      const precoCustoHidden = document.getElementById('preco-custo-hidden');
      const totalPagarEl = document.getElementById('total-pagar');

      function extrairValorNumerico(valorMascarado) {
        if (!valorMascarado) return 0;
        return parseFloat(valorMascarado.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
      }

      function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        });
      }

      function calcularValores() {
        const precoCusto = extrairValorNumerico(precoCustoInput.value);
        const peso = parseFloat(pesoInput.value) || 0;
        const valorTotal = precoCusto * peso;

        valorTotalHidden.value = valorTotal.toFixed(2);
        precoCustoHidden.value = precoCusto.toFixed(2);

        const valorFormatado = formatarMoeda(valorTotal);
        valorPagarInput.value = valorFormatado;
        totalPagarEl.textContent = valorFormatado;
      }

      precoCustoInput.addEventListener('input', calcularValores);
      precoCustoInput.addEventListener('blur', calcularValores);

      calcularValores();
    });
  </script>

  {% include 'estrutura/footer.html' %}
</div>
{% endblock conteudo %}
