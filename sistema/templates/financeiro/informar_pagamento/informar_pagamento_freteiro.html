{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle text-muted">Financeiro</div>
          <h2 class="page-title fw-bold display-6">Confirmação de Faturamento</h2>
        </div>
      </div>
    </div>
  </div>

  {% if conciliar_transacao_id %}
  {% set titulo_pagina = "frete" %}
  {% include 'financeiro/importar_ofx/dados_conciliacao_component.html' %}
  {% endif %}

  <div class="py-4">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      <div class="row row-cards mb-4">
        <!-- 1. Total Bruto - O que precisa pagar -->
        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3 stat-card-hover card-orange">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-orange text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-file-invoice">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                  <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                  <path d="M9 7l1 0" />
                  <path d="M9 13l6 0" />
                  <path d="M13 17l2 0" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold small">Total Bruto</div>
                <div class="fs-3 fw-bold text-orange mt-1" id="total-faturar">{{registro.valor_total_a_pagar_100 |
                  formatar_float_para_brl}}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2. Crédito Disponível - Quanto pode abater -->
        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3 stat-card-hover card-blue">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-blue text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-currency-dollar" width="24"
                  height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M16.7 8a3 3 0 0 0 -2.7 -2h-4a3 3 0 0 0 0 6h4a3 3 0 0 1 0 6h-4a3 3 0 0 1 -2.7 -2" />
                  <path d="M12 3v3m0 12v3" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold small">Crédito Disponível</div>
                <div class="fs-3 fw-bold text-blue mt-1" id="credito-disponivel">{{saldo_credito |
                  formatar_float_para_brl}}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. Valor Líquido - Resultado após crédito -->
        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3 stat-card-hover card-green">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-green text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-receipt">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16l-3 -2l-2 2l-2 -2l-2 2l-2 -2l-3 2" />
                  <path d="M14 8h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5m2 0v1.5m0 -9v1.5" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold small">Valor Líquido</div>
                {% set valor_liquido = registro.valor_total_a_pagar_100 - saldo_credito if saldo_credito > 0 else registro.valor_total_a_pagar_100 %}
                <div class="fs-3 fw-bold text-green mt-1" id="valor-liquido">{{ valor_liquido | formatar_float_para_brl if valor_liquido > 0 else 'R$ 0,00' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-light fw-bold">Informações Gerais</div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-2">
              <label class="form-label">Fornecedor</label>
              <input type="text" class="form-control"
                value="{{ registro_operacional.solicitacao.fornecedor.identificacao if registro_operacional.solicitacao and registro_operacional.solicitacao.fornecedor else '' }}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Transportadora</label>
              <input type="text" class="form-control"
                value="{{ registro.solicitacao.transportadora_exibicao.identificacao if registro.solicitacao and registro.solicitacao.transportadora_exibicao else '' }}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Produto/Bitola</label>
              <input type="text" class="form-control"
                value="{% if registro.solicitacao and registro.solicitacao.produto and registro.solicitacao.bitola %}{{ registro.solicitacao.produto.nome }} | {{ registro.solicitacao.bitola.bitola }}{% else %}{% endif %}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Preço Custo</label>
              <input type="text" id="preco-custo" class="form-control campo-moeda-brl"
                value="{{ registro.preco_custo_bitola_100 | default(0) | formatar_float_para_brl }}">
            </div>
            <div class="col-md-2">
              <label class="form-label">Peso Ton.</label>
              <input type="text" id="peso-toneladas" class="form-control"
                value="{{ registro_operacional.peso_liquido_ticket or 0 }}" disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Valor a faturar</label>
              <input type="text" id="valor-faturar-input" class="form-control"
                value="{{ registro.valor_total_a_pagar_100 | default(0) | formatar_float_para_brl }}" disabled readonly>
            </div>
          </div>
        </div>
      </div>

      <form action="{{ url_for('frete_a_pagar', id=registro.id) }}" method="POST">
        <input type="hidden" name="valor_total_calculado" id="valor-total-hidden">
        <input type="hidden" name="preco_custo_atualizado" id="preco-custo-hidden">
        <input type="hidden" name="creditos_selecionados" id="creditos-selecionados-hidden" value="">

        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body">

            <div class="row">
              <div class="col-sm-6 col-md-6">
                <div class="mb-3">
                  <div class="form-label">Deseja utilizar o crédito disponível?</div>
                  <div>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="usar_credito" value="sim" {% if
                        dados_corretos.get('usar_credito')=='sim' %}checked{% endif %}>
                      <span class="form-check-label">Sim</span>
                    </label>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="usar_credito" value="nao" {% if
                        dados_corretos.get('usar_credito')!='sim' %}checked{% endif
                        %}>
                      <span class="form-check-label">Não</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            {% if saldo_credito != 0 or creditos_individuais %}
            <!-- Seção de seleção de créditos individuais (aparece quando seleciona "Sim") -->
            {% if creditos_individuais %}
            <div id="secao-selecao-creditos" class="mb-4" style="display: none;">
              <div class="card shadow-sm border-0" style="border-left: 4px solid #1B5E20 !important;">
                <div class="card-header"
                  style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6;">
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                      style="width: 32px; height: 32px; background: #1B5E20;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2" />
                        <path d="M15 18H9" />
                        <path
                          d="M19 18h2a1 1 0 0 0 1-1v-3.28a1 1 0 0 0-.684-.948l-1.923-.641a1 1 0 0 1-.578-.502l-1.539-3.076A1 1 0 0 0 16.382 8H14" />
                        <circle cx="8" cy="18" r="2" />
                        <circle cx="18" cy="18" r="2" />
                      </svg>
                    </div>
                    <div>
                      <h6 class="card-title mb-0 fw-bold" style="color: #1B5E20;">
                        Selecionar Créditos -
                        {{ registro.solicitacao.transportadora_exibicao.identificacao if registro.solicitacao and
                        registro.solicitacao.transportadora_exibicao else 'Transportadora' }}
                      </h6>
                      <small class="text-muted">{{ creditos_individuais|length }} crédito(s) disponível(is)</small>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <tr>
                          <th width="50" class="text-center">
                            <input type="checkbox" class="form-check-input" id="select-all-creditos"
                              onchange="toggleAllCreditosIndividuais()">
                          </th>
                          <th class="fw-bold text-center text-muted">Data</th>
                          <th class="fw-bold text-center text-muted">Descrição</th>
                          <th class="fw-bold text-center text-muted">Valor</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for credito in creditos_individuais %}
                        <tr class="hover-row" style="border-bottom: 1px solid #f1f3f4;">
                          <td class="text-center">
                            <input type="checkbox" class="form-check-input credito-checkbox"
                              name="creditos_transportadora[]" value="{{ credito.id }}"
                              data-valor="{{ credito.valor_credito_100 }}"
                              data-transportadora-id="{{ registro.transportadora_id }}">
                          </td>
                          <td class="text-center text-muted">{{ credito.data_movimentacao }}</td>
                          <td class="text-center">{{ credito.descricao }}</td>
                          <td class="text-center">
                            {% if credito.valor_credito_100 < 0 %}
                              <span class="badge bg-danger-lt">{{ (credito.valor_credito_100 | abs) | formatar_float_para_brl}} (Débito)</span>
                            {% else %}
                              <span class="badge bg-green-lt">{{ credito.valor_credito_100 | formatar_float_para_brl}} (Crédito)</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                      <tfoot
                        style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-top: 2px solid #dee2e6;">
                        <tr>
                          <td colspan="3" class="text-end fw-bold" style="color: #1B5E20;">Total Selecionado:</td>
                          <td class="text-center fw-bold" style="color: #1B5E20;" id="total-creditos-selecionados">R$ 0,00</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            {% if saldo_credito != 0 and not creditos_individuais %}
            <!-- Seção quando há saldo mas não há créditos individuais - TABELA DE SELEÇÃO SIMULADA -->
            <div id="secao-credito-total" class="mb-4" style="display: none;">
              <div class="card shadow-sm border-0" style="border-left: 4px solid #1B5E20 !important;">
                <div class="card-header"
                  style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6;">
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                      style="width: 32px; height: 32px; background: #1B5E20;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2" />
                        <path d="M15 18H9" />
                        <path
                          d="M19 18h2a1 1 0 0 0 1-1v-3.28a1 1 0 0 0-.684-.948l-1.923-.641a1 1 0 0 1-.578-.502l-1.539-3.076A1 1 0 0 0 16.382 8H14" />
                        <circle cx="8" cy="18" r="2" />
                        <circle cx="18" cy="18" r="2" />
                      </svg>
                    </div>
                    <div>
                      <h6 class="card-title mb-0 fw-bold" style="color: #1B5E20;">
                        Selecionar Créditos -
                        {{ registro.solicitacao.transportadora_exibicao.identificacao if registro.solicitacao and
                        registro.solicitacao.transportadora_exibicao else 'Transportadora' }}
                      </h6>
                      <small class="text-muted">1 crédito disponível</small>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <tr>
                          <th width="50" class="text-center">
                            <input type="checkbox" class="form-check-input" id="select-all-creditos-total">
                          </th>
                          <th class="fw-bold text-center text-muted">Data</th>
                          <th class="fw-bold text-center text-muted">Descrição</th>
                          <th class="fw-bold text-center text-muted">Valor</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="hover-row" style="border-bottom: 1px solid #f1f3f4;">
                          <td class="text-center">
                            <input type="checkbox" class="form-check-input credito-checkbox"
                              name="creditos_transportadora[]" value="saldo_total"
                              data-valor="{{ (saldo_credito * 100)|round|int }}"
                              data-transportadora-id="{{ registro.transportadora_id }}">
                          </td>
                          <td class="text-center text-muted">23/09/2025</td>
                          <td class="text-center">Saldo Total Disponível</td>
                          <td class="text-center">
                            {% if saldo_credito < 0 %}
                              <b style="color: #dc3545;">{{ saldo_credito | formatar_float_para_brl}}</b>
                              <small class="badge bg-danger-lt">DÉBITO</small>
                            {% else %}
                              <b style="color: #1B5E20;">{{ saldo_credito | formatar_float_para_brl}}</b>
                              <small class="badge bg-success-lt">CRÉDITO</small>
                            {% endif %}
                          </td>
                        </tr>
                      </tbody>
                      <tfoot
                        style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-top: 2px solid #dee2e6;">
                        <tr>
                          <td colspan="3" class="text-end fw-bold" style="color: #1B5E20;">Total Selecionado:</td>
                          <td class="text-center fw-bold" style="color: #1B5E20;" id="total-creditos-selecionados">R$ 0,00</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Seção do resumo de créditos (aparece quando seleciona "Sim") -->
            <div id="resumo-creditos" class="mb-4" style="display: none;">

              <!-- Card do Resumo -->
              <div class="card border-0 shadow-sm card-smooth" style="border-radius: 12px; overflow: hidden;">
                <!-- Header clean -->
                <div class="card-header text-white py-3"
                  style="background: linear-gradient(135deg, #1B5E20 0%, #388E3C 100%); border: none;">
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                      style="width: 40px; height: 40px; background: rgba(255,255,255,0.2);">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2 " />
                        <rect x="9" y="3" width="6" height="4" rx="2" />
                        <path d="m9 14 2 2 4-4" />
                      </svg>
                    </div>
                    <div>
                      <h5 class="mb-0 fw-bold">Resumo do Faturamento</h5>
                    </div>
                  </div>
                </div>

                <div class="card-body p-4">
                  {% set valor_liquido_resumo = registro.valor_total_a_pagar_100 - saldo_credito if saldo_credito > 0 else registro.valor_total_a_pagar_100 %}
                  
                  <!-- Info da Transportadora -->
                  <div class="d-flex align-items-center justify-content-between p-3 mb-4 rounded-3" style="background: #f8f9fa;">
                    <div class="d-flex align-items-center">
                      <div class="avatar bg-primary-lt me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5" />
                        </svg>
                      </div>
                      <div>
                        <div class="text-muted small">Transportadora</div>
                        <div class="fw-bold fs-5" style="color: #1B5E20;">
                          {{ registro.solicitacao.transportadora_exibicao.identificacao if registro.solicitacao and registro.solicitacao.transportadora_exibicao else 'Não identificada' }}
                        </div>
                      </div>
                    </div>
                    <div id="resumo-status-transportadora" class="text-end">
                      {% set diferenca = saldo_credito - registro.valor_total_a_pagar_100 %}
                      {% if diferenca >= 0 %}
                      <span class="badge bg-success-lt text-success fs-6 px-3 py-2">COBERTO</span>
                      {% else %}
                      <span class="badge bg-warning-lt text-warning fs-6 px-3 py-2">FALTA {{ (diferenca * -1) | formatar_float_para_brl }}</span>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Cards do Resultado Final - Números Maiores -->
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="card h-100 stat-card-hover card-orange" style="border-radius: 10px;">
                        <div class="card-body p-4 text-center">
                          <div class="text-muted small text-uppercase mb-2">Total a Faturar</div>
                          <h3 class="fw-bold mb-0 text-orange" id="resumo-total-faturar">{{ registro.valor_total_a_pagar_100 | formatar_float_para_brl }}</h3>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card h-100 stat-card-hover card-blue" style="border-radius: 10px;">
                        <div class="card-body p-4 text-center">
                          <div class="text-muted small text-uppercase mb-2">Créditos Utilizados</div>
                          <h3 class="fw-bold mb-0 text-blue" id="resumo-creditos-totais">{{ saldo_credito | formatar_float_para_brl }}</h3>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card h-100 stat-card-hover card-green" id="resumo-saldo-final-card" style="border-radius: 10px;">
                        <div class="card-body p-4 text-center">
                          <div class="text-muted small text-uppercase mb-2" id="resumo-saldo-final-label">Valor Líquido</div>
                          <h3 class="fw-bold mb-0 text-green" id="resumo-saldo-final">{{ valor_liquido_resumo | formatar_float_para_brl if valor_liquido_resumo > 0 else 'R$ 0,00' }}</h3>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Fórmula visual -->
                  <div class="text-center mt-4 py-2 rounded-3" style="background: #f8f9fa;">
                    <span class="text-orange fw-bold fs-5" id="resumo-valor-transportadora">{{ registro.valor_total_a_pagar_100 | formatar_float_para_brl }}</span>
                    <span class="mx-3 text-muted">−</span>
                    <span class="text-blue fw-bold fs-5" id="resumo-credito-transportadora">{{ saldo_credito | formatar_float_para_brl }}</span>
                    <span class="mx-3 text-muted">=</span>
                    <span class="text-green fw-bold fs-5" id="resumo-valor-liquido-formula">{{ valor_liquido_resumo | formatar_float_para_brl if valor_liquido_resumo > 0 else 'R$ 0,00' }}</span>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <div class="text-end">
              <a class="btn btn-primary" href="javascript:history.back()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-left">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M5 12l14 0" />
                  <path d="M5 12l6 6" />
                  <path d="M5 12l6 -6" />
                </svg>Voltar
              </a>
              <button type="submit" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-plus">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M12 5l0 14" />
                  <path d="M5 12l14 0" />
                </svg>Salvar
              </button>
            </div>

          </div>
        </div>
      </form>

    </div>
  </div>

  <!-- CSS reutilizável para páginas de pagamento -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/informar-pagamento.css') }}">

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const precoCustoInput = document.getElementById('preco-custo');
      const pesoInput = document.getElementById('peso-toneladas');
      const valorFaturarInput = document.getElementById('valor-faturar-input');
      const valorTotalHidden = document.getElementById('valor-total-hidden');
      const precoCustoHidden = document.getElementById('preco-custo-hidden');
      const totalFaturarEl = document.getElementById('total-faturar');
      const saldoRestanteEl = document.getElementById('saldo-restante');
      const creditoDisponivel = parseFloat('{{ (saldo_credito|default(0) / 100)|round(2) }}');

      function extrairValorNumerico(valorMascarado) {
        if (!valorMascarado) return 0;
        return parseFloat(valorMascarado.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
      }

      function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        });
      }

      function calcularValores() {
        const precoCusto = extrairValorNumerico(precoCustoInput.value);
        const peso = parseFloat(pesoInput.value) || 0;
        const valorTotal = precoCusto * peso;

        valorTotalHidden.value = valorTotal.toFixed(2);
        precoCustoHidden.value = precoCusto.toFixed(2);

        const valorFormatado = formatarMoeda(valorTotal);
        valorFaturarInput.value = valorFormatado;
        totalFaturarEl.textContent = valorFormatado;

        const saldoRestante = creditoDisponivel - valorTotal;
        saldoRestanteEl.textContent = formatarMoeda(saldoRestante);

        atualizarResumoCredito(valorTotal);
      }

      function atualizarResumoCredito(valorTotal) {
        const resumoTotalFaturar = document.getElementById('resumo-total-faturar');
        const resumoSaldoFinal = document.getElementById('resumo-saldo-final');
        const resumoValorTransportadora = document.getElementById('resumo-valor-transportadora');
        const resumoStatusTransportadora = document.getElementById('resumo-status-transportadora');
        const radioSim = document.querySelector('input[name="usar_credito"][value="sim"]');

        if (resumoTotalFaturar) resumoTotalFaturar.textContent = formatarMoeda(valorTotal);
        if (resumoValorTransportadora) resumoValorTransportadora.textContent = formatarMoeda(valorTotal);

        if (radioSim && radioSim.checked) {
          // Se usar crédito, recalcular com base nos créditos selecionados ou saldo disponível
          calcularCreditosSelecionadosIndividuais();
        } else {
          // Não usar crédito: valor total negativo
          if (resumoSaldoFinal) resumoSaldoFinal.textContent = formatarMoeda(-valorTotal);

          if (resumoStatusTransportadora) {
            resumoStatusTransportadora.innerHTML = '<div class="small fw-bold text-info">SEM CRÉDITO</div>';
          }
        }
      }

      // Funções de seleção de créditos individuais
      function toggleAllCreditosIndividuais() {
        const selectAllCheckbox = document.getElementById('select-all-creditos');
        const creditoCheckboxes = document.querySelectorAll('.credito-checkbox');
        
        console.log('Toggle all - Estado:', selectAllCheckbox.checked); // Debug
        
        creditoCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
        
        calcularCreditosSelecionadosIndividuais();
      }

      function calcularCreditosSelecionadosIndividuais() {
        const creditoCheckboxes = document.querySelectorAll('.credito-checkbox:checked');
        const allCheckboxes = document.querySelectorAll('.credito-checkbox');
        let totalSelecionado = 0;
        
        // Se há checkboxes de créditos individuais e algum está selecionado
        if (allCheckboxes.length > 0) {
          creditoCheckboxes.forEach(checkbox => {
            const valor = parseFloat(checkbox.getAttribute('data-valor')) / 100;
            console.log('Valor do checkbox:', valor); // Debug
            totalSelecionado += valor;
          });
        } else {
          // Se não há checkboxes individuais, usar o saldo disponível total
          totalSelecionado = creditoDisponivel;
        }
        
        console.log('Total selecionado:', totalSelecionado); // Debug
        
        // Atualizar display do total selecionado
        const totalElement = document.getElementById('total-creditos-selecionados');
        if (totalElement) {
          totalElement.textContent = formatarMoeda(totalSelecionado);
        }
        
        // Preparar dados para envio
        const creditos_selecionados = {};
        if (creditoCheckboxes.length > 0) {
          creditos_selecionados.transportadora = {};
          const transportadoraId = creditoCheckboxes[0].getAttribute('data-transportadora-id');
          creditos_selecionados.transportadora[transportadoraId] = [];
          
          creditoCheckboxes.forEach(checkbox => {
            creditos_selecionados.transportadora[transportadoraId].push(parseInt(checkbox.value));
          });
        }
        
        const creditosHidden = document.getElementById('creditos-selecionados-hidden');
        if (creditosHidden) {
          creditosHidden.value = JSON.stringify(creditos_selecionados);
        }
        
        // Atualizar campos do resumo
        atualizarResumoComCreditosSelecionados(totalSelecionado);
      }

      function atualizarResumoComCreditosSelecionados(creditosSelecionados) {
        const resumoCreditoTransportadora = document.getElementById('resumo-credito-transportadora');
        const resumoCreditosTotais = document.getElementById('resumo-creditos-totais');
        const resumoSaldoFinal = document.getElementById('resumo-saldo-final');
        const resumoSaldoFinalLabel = document.getElementById('resumo-saldo-final-label');
        const resumoStatusTransportadora = document.getElementById('resumo-status-transportadora');
        const resumoTotalPagar = document.getElementById('resumo-total-faturar');
        const resumoValorTransportadora = document.getElementById('resumo-valor-transportadora');
        const resumoValorLiquidoFormula = document.getElementById('resumo-valor-liquido-formula');
        const cardCreditosUtilizados = document.querySelector('.card-blue');
        const cardValorLiquido = document.querySelector('.card-green');
        
        const valorTotal = parseFloat(valorTotalHidden.value) || 0;
        const isDebito = creditosSelecionados < 0;
        const valorDebito = Math.abs(creditosSelecionados);
        
        console.log('Atualizando resumo - Créditos:', creditosSelecionados, 'Valor Total:', valorTotal, 'É Débito:', isDebito);
        
        // Atualizar valor total a pagar no resumo (card e fórmula)
        if (resumoTotalPagar) {
          resumoTotalPagar.textContent = formatarMoeda(valorTotal);
        }
        
        // Atualizar valor total na fórmula visual
        if (resumoValorTransportadora) {
          resumoValorTransportadora.textContent = formatarMoeda(valorTotal);
        }
        
        if (isDebito) {
          // === DÉBITO (crédito negativo) - AUMENTA o valor a pagar ===
          const valorFinal = valorTotal + valorDebito;
          
          // Card de créditos -> mudar para vermelho e mostrar "DÉBITO"
          if (cardCreditosUtilizados) {
            cardCreditosUtilizados.classList.remove('card-blue');
            cardCreditosUtilizados.classList.add('card-red');
          }
          if (resumoCreditosTotais) {
            resumoCreditosTotais.textContent = formatarMoeda(valorDebito);
            resumoCreditosTotais.className = 'fw-bold mb-0 text-red fs-2';
            // Atualizar label
            const labelCreditos = resumoCreditosTotais.previousElementSibling;
            if (labelCreditos) {
              labelCreditos.innerHTML = 'DÉBITO <small class="text-danger">(+)</small>';
            }
          }
          
          // Fórmula - mostrar como SOMA
          if (resumoCreditoTransportadora) {
            resumoCreditoTransportadora.textContent = formatarMoeda(valorDebito);
            resumoCreditoTransportadora.className = 'text-red fw-bold fs-5';
          }
          
          // Trocar o sinal de − para + na fórmula
          const sinaisFormula = document.querySelectorAll('#resumo-creditos .text-center.mt-4 .text-muted');
          if (sinaisFormula.length >= 1) {
            sinaisFormula[0].textContent = '+';
            sinaisFormula[0].className = 'mx-3 text-red fw-bold';
          }
          
          // Card valor líquido -> mudar para vermelho (valor aumentou!)
          if (cardValorLiquido) {
            cardValorLiquido.classList.remove('card-green');
            cardValorLiquido.classList.add('card-red');
          }
          if (resumoSaldoFinal) {
            resumoSaldoFinal.textContent = formatarMoeda(valorFinal);
            resumoSaldoFinal.className = 'fw-bold mb-0 text-red fs-2';
          }
          if (resumoValorLiquidoFormula) {
            resumoValorLiquidoFormula.textContent = formatarMoeda(valorFinal);
            resumoValorLiquidoFormula.className = 'text-red fw-bold fs-5';
          }
          
          // Status - mostrar alerta de débito
          if (resumoStatusTransportadora) {
            resumoStatusTransportadora.innerHTML = `
              <span class="badge bg-danger-lt text-danger fs-6 px-3 py-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v4" /><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" /><path d="M12 16h.01" /></svg>
                DÉBITO +${formatarMoeda(valorDebito)}
              </span>
            `;
          }
          
        } else {
          // === CRÉDITO (normal ou zero) - DIMINUI o valor a pagar ===
          const saldoFinal = Math.max(0, valorTotal - creditosSelecionados);
          
          // Restaurar cor azul no card de créditos
          if (cardCreditosUtilizados) {
            cardCreditosUtilizados.classList.remove('card-red');
            cardCreditosUtilizados.classList.add('card-blue');
          }
          if (resumoCreditosTotais) {
            resumoCreditosTotais.textContent = formatarMoeda(creditosSelecionados);
            resumoCreditosTotais.className = 'fw-bold mb-0 text-blue fs-2';
            // Restaurar label
            const labelCreditos = resumoCreditosTotais.previousElementSibling;
            if (labelCreditos) {
              labelCreditos.textContent = 'Créditos Utilizados';
            }
          }
          
          // Fórmula - mostrar como SUBTRAÇÃO
          if (resumoCreditoTransportadora) {
            resumoCreditoTransportadora.textContent = formatarMoeda(creditosSelecionados);
            resumoCreditoTransportadora.className = 'text-blue fw-bold fs-5';
          }
          
          // Restaurar sinal de − na fórmula
          const sinaisFormula = document.querySelectorAll('#resumo-creditos .text-center.mt-4 .text-muted, #resumo-creditos .text-center.mt-4 .text-red');
          if (sinaisFormula.length >= 1) {
            sinaisFormula[0].textContent = '−';
            sinaisFormula[0].className = 'mx-3 text-muted';
          }
          
          // Restaurar cor verde no card valor líquido
          if (cardValorLiquido) {
            cardValorLiquido.classList.remove('card-red');
            cardValorLiquido.classList.add('card-green');
          }
          if (resumoSaldoFinal) {
            resumoSaldoFinal.textContent = formatarMoeda(saldoFinal);
            resumoSaldoFinal.className = 'fw-bold mb-0 text-green fs-2';
          }
          if (resumoValorLiquidoFormula) {
            resumoValorLiquidoFormula.textContent = formatarMoeda(saldoFinal);
            resumoValorLiquidoFormula.className = 'text-green fw-bold fs-5';
          }
          
          // Atualizar status
          if (resumoStatusTransportadora) {
            if (creditosSelecionados >= valorTotal) {
              resumoStatusTransportadora.innerHTML = '<span class="badge bg-success-lt text-success fs-6 px-3 py-2">COBERTO</span>';
            } else {
              const falta = valorTotal - creditosSelecionados;
              resumoStatusTransportadora.innerHTML = `
                <span class="badge bg-warning-lt text-warning fs-6 px-3 py-2">FALTA ${formatarMoeda(falta)}</span>
              `;
            }
          }
        }
      }

      function alternarResumo() {
        const radioSim = document.querySelector('input[name="usar_credito"][value="sim"]');
        const radioNao = document.querySelector('input[name="usar_credito"][value="nao"]');
        const resumoCreditos = document.getElementById('resumo-creditos');
        const secaoSelecaoCreditos = document.getElementById('secao-selecao-creditos');
        const secaoCreditoTotal = document.getElementById('secao-credito-total');
        const creditosHidden = document.getElementById('creditos-selecionados-hidden');

        if (radioSim && radioSim.checked) {
          // Mostrar seção de seleção de créditos individuais (se existir)
          if (secaoSelecaoCreditos) {
            secaoSelecaoCreditos.style.display = 'block';
            secaoSelecaoCreditos.style.opacity = '0';
            secaoSelecaoCreditos.style.transform = 'translateY(20px)';

            setTimeout(() => {
              secaoSelecaoCreditos.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
              secaoSelecaoCreditos.style.opacity = '1';
              secaoSelecaoCreditos.style.transform = 'translateY(0)';
            }, 10);
          }

          // Mostrar seção de crédito total (se existir e não há créditos individuais)
          if (secaoCreditoTotal) {
            secaoCreditoTotal.style.display = 'block';
            secaoCreditoTotal.style.opacity = '0';
            secaoCreditoTotal.style.transform = 'translateY(20px)';

            setTimeout(() => {
              secaoCreditoTotal.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
              secaoCreditoTotal.style.opacity = '1';
              secaoCreditoTotal.style.transform = 'translateY(0)';
            }, 10);
          }

          // Mostrar resumo de créditos
          if (resumoCreditos) {
            setTimeout(() => {
              resumoCreditos.style.display = 'block';
              resumoCreditos.style.opacity = '0';
              resumoCreditos.style.transform = 'translateY(20px)';

              setTimeout(() => {
                resumoCreditos.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                resumoCreditos.style.opacity = '1';
                resumoCreditos.style.transform = 'translateY(0)';
              }, 10);
            }, 200);
          }
        } else {
          // Limpar créditos selecionados quando escolhe "Não"
          if (creditosHidden) {
            creditosHidden.value = '';
          }
          
          // Desmarcar todos os checkboxes de crédito
          document.querySelectorAll('.credito-checkbox').forEach(checkbox => {
            checkbox.checked = false;
          });
          
          // Ocultar todas as seções
          if (secaoSelecaoCreditos) {
            secaoSelecaoCreditos.style.transition = 'all 0.3s ease-out';
            secaoSelecaoCreditos.style.opacity = '0';
            secaoSelecaoCreditos.style.transform = 'translateY(-20px)';

            setTimeout(() => {
              secaoSelecaoCreditos.style.display = 'none';
            }, 300);
          }

          if (secaoCreditoTotal) {
            secaoCreditoTotal.style.transition = 'all 0.3s ease-out';
            secaoCreditoTotal.style.opacity = '0';
            secaoCreditoTotal.style.transform = 'translateY(-20px)';

            setTimeout(() => {
              secaoCreditoTotal.style.display = 'none';
            }, 300);
          }

          if (resumoCreditos) {
            resumoCreditos.style.transition = 'all 0.3s ease-out';
            resumoCreditos.style.opacity = '0';
            resumoCreditos.style.transform = 'translateY(-20px)';

            setTimeout(() => {
              resumoCreditos.style.display = 'none';
            }, 300);
          }
        }

        const valorAtual = parseFloat(valorTotalHidden.value) || 0;
        atualizarResumoCredito(valorAtual);
      }

      // Event listeners
      precoCustoInput.addEventListener('input', calcularValores);
      precoCustoInput.addEventListener('blur', calcularValores);

      document.querySelectorAll('input[name="usar_credito"]').forEach(radio => {
        radio.addEventListener('change', () => {
          alternarResumo();
          const valorAtual = parseFloat(valorTotalHidden.value) || 0;
          atualizarResumoCredito(valorAtual);
        });
      });

      // Event listeners para checkboxes de crédito
      document.querySelectorAll('.credito-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          calcularCreditosSelecionadosIndividuais();
          // Atualizar o estado do checkbox "selecionar todos"
          const selectAllCheckbox = document.getElementById('select-all-creditos');
          const allCheckboxes = document.querySelectorAll('.credito-checkbox');
          const checkedCheckboxes = document.querySelectorAll('.credito-checkbox:checked');
          
          if (selectAllCheckbox) {
            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
          }
        });
      });

      // Event listener para o checkbox "Selecionar Todos"
      const selectAllCheckbox = document.getElementById('select-all-creditos');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          toggleAllCreditosIndividuais();
        });
      }

      // Event listener para o checkbox "Selecionar Todos" da seção de crédito total
      const selectAllCreditoTotal = document.getElementById('select-all-creditos-total');
      if (selectAllCreditoTotal) {
        selectAllCreditoTotal.addEventListener('change', function() {
          const creditoTotalCheckbox = document.querySelector('input[value="saldo_total"]');
          if (creditoTotalCheckbox) {
            creditoTotalCheckbox.checked = this.checked;
            calcularCreditosSelecionadosIndividuais();
          }
        });
      }

      // Inicialização
      calcularValores();
      
      // Garantir comportamento padrão consistente com fornecedores
      const radioSim = document.querySelector('input[name="usar_credito"][value="sim"]');
      const radioNao = document.querySelector('input[name="usar_credito"][value="nao"]');
      
      console.log('Inicialização - Radio Sim checked:', radioSim?.checked);
      console.log('Inicialização - Radio Não checked:', radioNao?.checked);
      
      // Garantir comportamento padrão igual ao fornecedor: "Não" por padrão
      if (!radioSim.checked && !radioNao.checked) {
        radioNao.checked = true;
        console.log('Forçando seleção padrão: Não');
      }
      
      // Garantir que as seções de crédito estejam ocultas inicialmente se "Não" estiver selecionado
      if (radioNao && radioNao.checked) {
        const resumoCreditos = document.getElementById('resumo-creditos');
        const secaoSelecaoCreditos = document.getElementById('secao-selecao-creditos');
        const secaoCreditoTotal = document.getElementById('secao-credito-total');
        
        if (resumoCreditos) resumoCreditos.style.display = 'none';
        if (secaoSelecaoCreditos) secaoSelecaoCreditos.style.display = 'none';
        if (secaoCreditoTotal) secaoCreditoTotal.style.display = 'none';
      }
      
      alternarResumo();

      // Adicionar evento para garantir que o usuário tenha controle total
      document.querySelectorAll('input[name="usar_credito"]').forEach(radio => {
        radio.addEventListener('click', function() {
          console.log('Usuário clicou em:', this.value);
          setTimeout(() => alternarResumo(), 10);
        });
      });

      // Força atualização inicial do resumo e cálculo de créditos
      setTimeout(() => {
        const valorAtual = parseFloat(valorTotalHidden.value) || 0;
        atualizarResumoCredito(valorAtual);
        if (radioSim && radioSim.checked) {
          calcularCreditosSelecionadosIndividuais();
        }
      }, 100);
    });
  </script>

  <!-- Script para máscara de moeda -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Função para aplicar máscara de moeda brasileira
      function aplicarMascaraMoeda(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor === '') {
          input.value = 'R$ 0,00';
          return;
        }
        valor = (parseInt(valor) / 100).toFixed(2) + '';
        valor = valor.replace(".", ",");
        valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
        valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
        input.value = 'R$ ' + valor;
      }

      // Aplicar máscara nos inputs de preço de custo
      document.querySelectorAll('.campo-moeda-brl').forEach(input => {
        input.addEventListener('input', function () {
          aplicarMascaraMoeda(this);
        });

        input.addEventListener('focus', function () {
          if (this.value === 'R$ 0,00') {
            this.value = '';
          }
        });

        input.addEventListener('blur', function () {
          if (this.value === '' || this.value === 'R$ ') {
            this.value = 'R$ 0,00';
          }
        });

        // Permitir apenas números e vírgula
        input.addEventListener('keypress', function (e) {
          const char = String.fromCharCode(e.which);
          if (!/[0-9,.]/.test(char)) {
            e.preventDefault();
          }
        });
      });
    });
  </script>

  {% include 'estrutura/footer.html' %}
</div>
{% endblock conteudo %}