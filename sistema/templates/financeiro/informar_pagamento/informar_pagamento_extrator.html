{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle text-muted">Financeiro</div>
          <h2 class="page-title fw-bold display-6">Confirmação de Faturamento - Extrator</h2>
        </div>
      </div>
    </div>
  </div>

  {% if conciliar_transacao_id %}
  {% set titulo_pagina = "extrator" %}
  {% include 'financeiro/importar_ofx/dados_conciliacao_component.html' %}
  {% endif %}

  <div class="py-4">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      <div class="row row-cards mb-4">
        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-blue text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-currency-dollar" width="24"
                  height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M16.7 8a3 3 0 0 0 -2.7 -2h-4a3 3 0 0 0 0 6h4a3 3 0 0 1 0 6h-4a3 3 0 0 1 -2.7 -2" />
                  <path d="M12 3v3m0 12v3" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold">Crédito Disponível</div>
                <div class="fs-3 fw-bold text-blue mt-1" id="credito-disponivel">{{saldo_credito |
                  formatar_float_para_brl}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-orange text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-moneybag-move">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M9.5 3h5a1.5 1.5 0 0 1 1.5 1.5a3.5 3.5 0 0 1 -3.5 3.5h-1a3.5 3.5 0 0 1 -3.5 -3.5a1.5 1.5 0 0 1 1.5 -1.5" />
                  <path d="M12.5 21h-4.5a4 4 0 0 1 -4 -4v-1a8 8 0 0 1 14.946 -3.971" />
                  <path d="M16 19h6" />
                  <path d="M19 16l3 3l-3 3" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold">Total a Faturar</div>
                <div class="fs-3 fw-bold text-orange mt-1" id="total-faturar">{{registro.valor_total_a_pagar_100 |
                  formatar_float_para_brl}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3">
            <div class="card-body d-flex align-items-center">
              <span class="avatar text-white me-3" id="avatar-saldo-restante">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-wallet">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" />
                  <path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold">Saldo Restante</div>
                <div class="fs-3 fw-bold text-red mt-1" id="saldo-restante">{{saldo_credito | formatar_float_para_brl}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-light fw-bold">Informações Gerais</div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-2">
              <label class="form-label">Fornecedor</label>
              <input type="text" class="form-control"
                value="{{ registro_operacional.solicitacao.fornecedor.identificacao if registro_operacional.solicitacao and registro_operacional.solicitacao.fornecedor else '' }}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Extrator</label>
              <input type="text" class="form-control"
                value="{{ extrator.identificacao if extrator else '' }}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Produto/Bitola</label>
              <input type="text" class="form-control"
                value="{% if registro.solicitacao and registro.solicitacao.produto and registro.solicitacao.bitola %}{{ registro.solicitacao.produto.nome }} | {{ registro.solicitacao.bitola.bitola }}{% else %}{% endif %}"
                disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Preço Custo</label>
              <input type="text" id="preco-custo" class="form-control campo-moeda-brl"
                value="{{ registro.preco_custo_bitola_100 | default(0) | formatar_float_para_brl }}">
            </div>
            <div class="col-md-2">
              <label class="form-label">Peso Ton.</label>
              <input type="text" id="peso-toneladas" class="form-control"
                value="{{ registro_operacional.peso_liquido_ticket or 0 }}" disabled readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Valor a faturar</label>
              <input type="text" id="valor-faturar-input" class="form-control"
                value="{{ registro.valor_total_a_pagar_100 | default(0) | formatar_float_para_brl }}" disabled readonly>
            </div>
          </div>
        </div>
      </div>

      <form action="{{ url_for('extrator_a_pagar', id=registro.id) }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="valor_total_calculado" id="valor-total-hidden">
        <input type="hidden" name="preco_custo_atualizado" id="preco-custo-hidden">
        <input type="hidden" name="creditos_selecionados" id="creditos-selecionados-hidden" value="">

        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body">

            <div class="row">
              <div class="col-sm-6 col-md-6">
                <div class="mb-3">
                  <div class="form-label">Deseja utilizar o crédito disponível?</div>
                  <div>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="usar_credito" value="sim" {% if
                        dados_corretos['usar_credito']=='sim' %}checked{% endif %}>
                      <span class="form-check-label">Sim</span>
                    </label>
                    <label class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="usar_credito" value="nao" {% if
                        dados_corretos['usar_credito']=='nao' or not dados_corretos['usar_credito'] %}checked{% endif
                        %}>
                      <span class="form-check-label">Não</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            {% if saldo_credito != 0 or creditos_individuais %}
            <!-- Seção do resumo de créditos (aparece quando seleciona "Sim") -->
            <div id="resumo-creditos" class="mb-4" style="display: none;">

              <!-- Tabela de Créditos Individuais - Extrator -->
              {% if creditos_individuais %}
              <div class="creditos-section mb-3"
                id="creditos-extrator-{{ registro.solicitacao.fornecedor.extrator.id if registro.solicitacao and registro.solicitacao.fornecedor and registro.solicitacao.fornecedor.extrator else 'unknown' }}"
                style="display: none;">
                <div class="card shadow-sm border-0" style="border-left: 4px solid #1B5E20 !important;">
                  <div class="card-header"
                    style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6;">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                        style="width: 32px; height: 32px; background: #1B5E20;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                          stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M3 21h4l13 -13a1.5 1.5 0 0 0 -4 -4l-13 13v4" />
                          <path d="M14.5 5.5l4 4" />
                        </svg>
                      </div>
                      <div>
                        <h6 class="card-title mb-0 fw-bold" style="color: #1B5E20;">
                          Selecionar Créditos -
                          {{ extrator.identificacao if extrator else 'Extrator' }}
                        </h6>
                        <small class="text-muted">{{ creditos_individuais|length }} crédito(s)
                          disponível(is)</small>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-sm mb-0">
                        <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                          <tr>
                            <th width="50" class="text-center">
                              <input type="checkbox" class="form-check-input"
                                id="select-all-creditos-extrator-{{ extrator_id if extrator_id else 'unknown' }}"
                                onchange="toggleAllCreditos('extrator', {{ extrator_id if extrator_id else 0 }})">
                            </th>
                            <th class="fw-bold text-center text-muted">Data</th>
                            <th class="fw-bold text-center text-muted">Descrição</th>
                            <th class="fw-bold text-center text-muted">Valor</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for credito in creditos_individuais %}
                          <tr class="hover-row" style="border-bottom: 1px solid #f1f3f4;">
                            <td class="text-center">
                              <input type="checkbox" class="form-check-input credito-checkbox"
                                name="creditos_extrator_{{ extrator_id if extrator_id else 0 }}[]"
                                value="{{ credito.id }}" data-valor="{{ credito.valor_credito_100 }}"
                                data-tipo="extrator"
                                data-entidade-id="{{ registro.solicitacao.fornecedor.extrator.id if registro.solicitacao and registro.solicitacao.fornecedor and registro.solicitacao.fornecedor.extrator else 0 }}"
                                onchange="calcularCreditosSelecionados()">
                            </td>
                            <td class="text-center text-muted">{{ credito.data_movimentacao if credito.data_movimentacao
                              else '' }}</td>
                            <td class="text-center">{{ credito.descricao }}</td>
                            <td class="text-center">
                              <b style="color: #1B5E20;">{{ credito.valor_credito_100 | formatar_float_para_brl}}</b>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                        <tfoot
                          style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-top: 2px solid #dee2e6;">
                          <tr>
                            <td colspan="3" class="text-start fw-bold" style="color: #1B5E20;">Total Selecionado:</td>
                            <td class="text-end">
                              <span class="badge fs-6" style="background: #1B5E20; color: white;"
                                id="total-credito-extrator-{{ registro.solicitacao.fornecedor.extrator.id if registro.solicitacao and registro.solicitacao.fornecedor and registro.solicitacao.fornecedor.extrator else 0 }}">R$
                                0,00</span>
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              <!-- Header moderno -->
              <div class="card border-0 shadow-sm" style="border-radius: 5px; overflow: hidden;">
                <div class="card-header border-0 text-white position-relative"
                  style="background: linear-gradient(135deg, #1B5E20 0%, #2E7D2E 100%); padding: 24px;">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                        style="width: 48px; height: 48px; background: rgba(255,255,255,0.2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                        </svg>
                      </div>
                      <div>
                        <h4 class="mb-1 fw-bold">Resumo Final</h4>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card-body p-0">
                  <!-- Seção Principal: Cards lado a lado -->
                  <div class="row g-0">

                    <!-- Extrator -->
                    <div class="col-12">
                      <div class="p-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">

                        <!-- Título da seção -->
                        <div class="d-flex align-items-center mb-4">
                          <div class="rounded-circle me-3 d-flex align-items-center justify-content-center"
                            style="width: 40px; height: 40px; background: #1B5E20;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                              fill="none" stroke="white" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round">
                              <path d="M3 21h4l13 -13a1.5 1.5 0 0 0 -4 -4l-13 13v4" />
                              <path d="M14.5 5.5l4 4" />
                            </svg>
                          </div>
                          <div>
                            <h6 class="mb-0 fw-bold" style="color: #1B5E20;">EXTRATOR</h6>
                            <small class="text-muted">Pagamento individual</small>
                          </div>
                        </div>

                        <!-- Card do extrator -->
                        <div class="card border-0 shadow-sm mb-3" style="border-radius: 5px; background: white;">
                          <div class="card-body p-3">
                            <div class="row align-items-center">
                              <div class="col-12">
                                <h6 class="mb-1 fw-bold" style="color: #1B5E20; font-size: 0.95rem;">
                                  {{ registro.solicitacao.fornecedor.extrator.identificacao if
                                  registro.solicitacao and registro.solicitacao.fornecedor and
                                  registro.solicitacao.fornecedor.extrator
                                  else
                                  'Extrator não identificado' | truncate(25, True, '...') }}
                                </h6>
                                <div class="row text-center mt-2">
                                  <div class="col-4">
                                    <div class="small text-muted">Crédito</div>
                                    <div class="fw-bold small" style="color: #1B5E20;" id="resumo-credito-extrator">
                                      {{ saldo_credito | formatar_float_para_brl }}</div>
                                  </div>
                                  <div class="col-4">
                                    <div class="small text-muted">A Faturar</div>
                                    <div class="fw-bold small text-dark" id="resumo-valor-extrator">{{
                                      registro.valor_total_a_pagar_100 | formatar_float_para_brl }}</div>
                                  </div>
                                  <div class="col-4" id="resumo-status-extrator">
                                    {% set diferenca = saldo_credito - registro.valor_total_a_pagar_100 %}
                                    {% if diferenca >= 0 %}
                                    <div class="small fw-bold text-success">COBERTO</div>
                                    {% else %}
                                    <div class="small fw-bold text-warning">FALTA</div>
                                    <div class="small text-warning">{{ (diferenca * -1) | formatar_float_para_brl }}
                                    </div>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Resumo Final Moderno -->
                  <div class="border-top bg-light">
                    <div class="p-4">

                      <!-- Título do resumo -->
                      <div class="text-center mb-4">
                        <div class="rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center"
                          style="width: 48px; height: 48px; background: #f8f9fa; border: 2px solid #dee2e6;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#6c757d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon icon-tabler icons-tabler-outline icon-tabler-script">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path
                              d="M17 20h-11a3 3 0 0 1 0 -6h11a3 3 0 0 0 0 6h1a3 3 0 0 0 3 -3v-11a2 2 0 0 0 -2 -2h-10a2 2 0 0 0 -2 2v8" />
                          </svg>
                        </div>
                        <h5 class="mb-0 text-dark">RESULTADO FINAL</h5>
                      </div>

                      <!-- Cards do resumo matemático -->
                      <div class="row g-3 mb-4">
                        <div class="col-md-4">
                          <div class="card border shadow-sm"
                            style="border-radius: 12px;">
                            <div class="card-body p-3 text-center">
                              <div class="small text-muted text-uppercase mb-1">Total a Faturar</div>
                              <h4 class="fw-bold mb-0" id="resumo-total-faturar">{{ registro.valor_total_a_pagar_100 |
                                formatar_float_para_brl }}</h4>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="card border shadow-sm"
                            style="border-radius: 12px;">
                            <div class="card-body p-3 text-center">
                              <div class="small text-muted text-uppercase mb-1">Créditos Selecionados</div>
                              <h4 class="fw-bold mb-0" id="resumo-creditos-totais">R$ 0,00</h4>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="card border shadow-sm text-center" id="resumo-saldo-final-card"
                            style="border-radius: 12px;">
                            <div class="card-body p-3">
                              <div class="small text-muted text-uppercase mb-1" id="resumo-saldo-final-label">Saldo
                                Final a Faturar</div>
                              <h4 class="fw-bold mb-0 text-success" id="resumo-saldo-final">{{ registro.valor_total_a_pagar_100 |
                                formatar_float_para_brl }}</h4>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <div class="text-end">
              <a class="btn btn-primary" href="javascript:history.back()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-left">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M5 12l14 0" />
                  <path d="M5 12l6 6" />
                  <path d="M5 12l6 -6" />
                </svg>Voltar
              </a>
              <button type="submit" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-check">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M5 12l5 5l10 -10" />
                </svg>Salvar
              </button>
            </div>

          </div>
        </div>
      </form>

    </div>
  </div>

  <!-- Estilos customizados para as tabelas de créditos -->
  <style>
    .hover-row:hover {
      background-color: #f8f9fa !important;
      cursor: pointer;
    }

    .creditos-section {
      border-radius: 8px;
      overflow: hidden;
    }

    .creditos-section .table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .creditos-section .table td,
    .creditos-section .table th {
      border: none;
      padding: 12px 16px;
      vertical-align: middle;
    }

    .creditos-section .form-check-input {
      transform: scale(1.1);
    }

    .creditos-section .badge {
      font-size: 0.85rem;
      padding: 0.4em 0.8em;
    }

    .hover-row {
      transition: background-color 0.2s ease;
    }
  </style>

  <!-- Sistema de Gerenciamento de Créditos -->
  <script>
    // Variáveis globais para créditos selecionados
    let creditosSelecionados = {
      extrator: {}
    };

    const extratorId = {{ registro.solicitacao.fornecedor.extrator.id if registro.solicitacao and registro.solicitacao.fornecedor and registro.solicitacao.fornecedor.extrator else 0 }};

    // Utilitários de formatação (definidos globalmente)
    function extrairValorNumerico(valorMascarado) {
      if (!valorMascarado) return 0;
      return parseFloat(valorMascarado.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    }

    function formatarMoeda(valor) {
      return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // Função para alternar todos os créditos de uma entidade
    function toggleAllCreditos(tipo, entidadeId) {
      const checkboxPrincipal = document.getElementById(`select-all-creditos-${tipo}-${entidadeId}`);
      const checkboxes = document.querySelectorAll(`input[name="creditos_${tipo}_${entidadeId}[]"]`);

      checkboxes.forEach(checkbox => {
        checkbox.checked = checkboxPrincipal.checked;
      });

      calcularCreditosSelecionados();
    }

    // Função para calcular créditos selecionados
    function calcularCreditosSelecionados() {
      // Reset dos totais
      const creditosParaEnvio = { extrator: {} };
      creditosSelecionados = { extrator: {} };

      // Calcular por tipo de entidade
      document.querySelectorAll('.credito-checkbox:checked').forEach(checkbox => {
        const tipo = checkbox.dataset.tipo;
        const entidadeId = checkbox.dataset.entidadeId;
        const valor = parseInt(checkbox.dataset.valor) || 0;
        const creditoId = parseInt(checkbox.value);

        // Para exibição visual
        if (!creditosSelecionados[tipo][entidadeId]) {
          creditosSelecionados[tipo][entidadeId] = [];
        }
        creditosSelecionados[tipo][entidadeId].push({
          id: creditoId,
          valor: valor
        });

        // Para envio ao backend (apenas IDs)
        if (!creditosParaEnvio[tipo][entidadeId]) {
          creditosParaEnvio[tipo][entidadeId] = [];
        }
        creditosParaEnvio[tipo][entidadeId].push(creditoId);
      });

      // Atualizar totais visuais
      atualizarTotaisCreditos();

      // Atualizar campo hidden com estrutura simplificada para o backend
      document.getElementById('creditos-selecionados-hidden').value = JSON.stringify(creditosParaEnvio);

      // Verificar se há créditos excessivos
      verificarCreditosExcessivos();

      // Recalcular totais gerais se estiver usando crédito
      const radioUsarCredito = document.querySelector('input[name="usar_credito"][value="sim"]');
      if (radioUsarCredito && radioUsarCredito.checked) {
        calcularTotaisGerais();
      }
    }

    // Função para verificar créditos excessivos
    function verificarCreditosExcessivos() {
      // Calcular total de créditos selecionados
      let totalCreditosSelecionados = 0;

      Object.keys(creditosSelecionados.extrator).forEach(extratorId => {
        if (creditosSelecionados.extrator[extratorId]) {
          totalCreditosSelecionados += creditosSelecionados.extrator[extratorId].reduce((sum, credito) => sum + (credito.valor / 100), 0);
        }
      });

      // Calcular valor total da fatura
      const valorTotalFatura = parseFloat(document.getElementById('valor-total-hidden').value) || 0;

      // Verificar se há excesso
      const creditoExcessivo = Math.max(0, totalCreditosSelecionados - valorTotalFatura);

      // Remover alerta anterior se existir
      const alertaExistente = document.getElementById('alerta-credito-excessivo');
      if (alertaExistente) {
        alertaExistente.remove();
      }

      // Mostrar alerta se há crédito excessivo
      if (creditoExcessivo > 0) {
        const alertaDiv = document.createElement('div');
        alertaDiv.id = 'alerta-credito-excessivo';
        alertaDiv.className = 'bg-white alert alert-primary mt-3';
        alertaDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="m9 12 2 2 4-4"></path>
            </svg>
            <div>
              <strong>Crédito Suficiente!</strong><br>
              <small>Você selecionou <strong>${formatarMoeda(totalCreditosSelecionados)}</strong> em créditos, mas apenas <strong>${formatarMoeda(Math.min(totalCreditosSelecionados, valorTotalFatura))}</strong> serão utilizados para cobrir o valor da fatura.</small>
            </div>
          </div>
        `;

        // Inserir após as tabelas de crédito
        const resumoCreditos = document.getElementById('resumo-creditos');
        if (resumoCreditos) {
          resumoCreditos.appendChild(alertaDiv);
        }
      }
    }

    // Função para atualizar totais visuais dos créditos
    function atualizarTotaisCreditos() {
      // Atualizar totais por extrator
      Object.keys(creditosSelecionados.extrator).forEach(extratorId => {
        const total = creditosSelecionados.extrator[extratorId].reduce((sum, credito) => sum + credito.valor, 0);
        const elemento = document.getElementById(`total-credito-extrator-${extratorId}`);
        if (elemento) {
          elemento.textContent = formatarMoeda(total / 100);
        }
      });

      // Limpar totais para entidades sem créditos selecionados
      document.querySelectorAll('[id^="total-credito-extrator-"]').forEach(elemento => {
        const extratorId = elemento.id.replace('total-credito-extrator-', '');
        if (!creditosSelecionados.extrator[extratorId] || creditosSelecionados.extrator[extratorId].length === 0) {
          elemento.textContent = 'R$ 0,00';
        }
      });
    }

    // Função para calcular totais gerais
    function calcularTotaisGerais() {
      const valorTotal = parseFloat(document.getElementById('valor-total-hidden').value) || 0;
      const radioUsarCredito = document.querySelector('input[name="usar_credito"][value="sim"]');
      const usandoCredito = radioUsarCredito && radioUsarCredito.checked;

      let totalCreditosSelecionados = 0;
      if (usandoCredito) {
        Object.keys(creditosSelecionados.extrator).forEach(extratorId => {
          if (creditosSelecionados.extrator[extratorId]) {
            totalCreditosSelecionados += creditosSelecionados.extrator[extratorId].reduce((sum, credito) => sum + (credito.valor / 100), 0);
          }
        });
      }

      const creditoUtilizado = Math.min(totalCreditosSelecionados, valorTotal);
      const valorFinal = Math.max(0, valorTotal - creditoUtilizado);

      // Atualizar resumo
      const resumoCreditos = document.getElementById('resumo-creditos-totais');
      const resumoSaldoFinal = document.getElementById('resumo-saldo-final');
      const resumoTotalFaturar = document.getElementById('resumo-total-faturar');

      if (resumoCreditos) resumoCreditos.textContent = formatarMoeda(creditoUtilizado);
      if (resumoSaldoFinal) resumoSaldoFinal.textContent = formatarMoeda(valorFinal);
      if (resumoTotalFaturar) resumoTotalFaturar.textContent = formatarMoeda(valorTotal);
    }
  </script>

  <!-- Sistema Principal de Cálculos -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const precoCustoInput = document.getElementById('preco-custo');
      const pesoInput = document.getElementById('peso-toneladas');
      const valorFaturarInput = document.getElementById('valor-faturar-input');
      const valorTotalHidden = document.getElementById('valor-total-hidden');
      const precoCustoHidden = document.getElementById('preco-custo-hidden');
      const totalFaturarEl = document.getElementById('total-faturar');
      const saldoRestanteEl = document.getElementById('saldo-restante');
      const creditoDisponivel = parseFloat('{{ (saldo_credito|default(0) / 100)|round(2) }}');

      function calcularValores() {
        const precoCusto = extrairValorNumerico(precoCustoInput.value);
        const peso = parseFloat(pesoInput.value) || 0;
        const valorTotal = precoCusto * peso;

        valorTotalHidden.value = valorTotal.toFixed(2);
        precoCustoHidden.value = precoCusto.toFixed(2);

        const valorFormatado = formatarMoeda(valorTotal);
        valorFaturarInput.value = valorFormatado;
        totalFaturarEl.textContent = valorFormatado;

        const saldoRestante = creditoDisponivel - valorTotal;
        saldoRestanteEl.textContent = formatarMoeda(Math.abs(saldoRestante));

        // Atualizar cor do saldo e avatar baseado no valor
        const avatarElement = document.getElementById('avatar-saldo-restante');

        if (saldoRestante >= 0) {
          saldoRestanteEl.className = 'fs-3 fw-bold text-success mt-1';
          if (avatarElement) {
            avatarElement.className = 'avatar text-white me-3 bg-success';
          }
        } else {
          saldoRestanteEl.className = 'fs-3 fw-bold text-danger mt-1';
          if (avatarElement) {
            avatarElement.className = 'avatar text-white me-3 bg-danger';
          }
        }

        atualizarResumoCredito(valorTotal);
        calcularTotaisGerais();
      }

      function atualizarResumoCredito(valorTotal) {
        const resumoTotalFaturar = document.getElementById('resumo-total-faturar');
        const resumoSaldoFinal = document.getElementById('resumo-saldo-final');
        const resumoValorExtrator = document.getElementById('resumo-valor-extrator');
        const resumoStatusExtrator = document.getElementById('resumo-status-extrator');
        const radioSim = document.querySelector('input[name="usar_credito"][value="sim"]');

        if (resumoTotalFaturar) resumoTotalFaturar.textContent = formatarMoeda(valorTotal);
        if (resumoValorExtrator) resumoValorExtrator.textContent = formatarMoeda(valorTotal);

        if (radioSim && radioSim.checked) {
          // Usar crédito: calcular com créditos selecionados
          let totalCreditosSelecionados = 0;
          Object.keys(creditosSelecionados.extrator).forEach(extratorId => {
            if (creditosSelecionados.extrator[extratorId]) {
              totalCreditosSelecionados += creditosSelecionados.extrator[extratorId].reduce((sum, credito) => sum + (credito.valor / 100), 0);
            }
          });

          const creditoUtilizado = Math.min(totalCreditosSelecionados, valorTotal);
          const saldoFinal = Math.max(0, valorTotal - creditoUtilizado);

          if (resumoSaldoFinal) resumoSaldoFinal.textContent = formatarMoeda(saldoFinal);

          if (resumoStatusExtrator) {
            if (creditoUtilizado >= valorTotal) {
              resumoStatusExtrator.innerHTML = '<div class="small fw-bold text-success">COBERTO</div>';
            } else {
              const falta = valorTotal - creditoUtilizado;
              resumoStatusExtrator.innerHTML = `
                <div class="small fw-bold text-warning">FALTA</div>
                <div class="small text-warning">${formatarMoeda(falta)}</div>
              `;
            }
          }
        } else {
          // Não usar crédito: valor total
          if (resumoSaldoFinal) resumoSaldoFinal.textContent = formatarMoeda(valorTotal);

          if (resumoStatusExtrator) {
            resumoStatusExtrator.innerHTML = '<div class="small fw-bold text-info">SEM CRÉDITO</div>';
          }
        }
      }

      function alternarResumo() {
        const radioSim = document.querySelector('input[name="usar_credito"][value="sim"]');
        const radioNao = document.querySelector('input[name="usar_credito"][value="nao"]');
        const resumoCreditos = document.getElementById('resumo-creditos');
        const creditosSections = document.querySelectorAll('.creditos-section');

        if (!resumoCreditos) return;

        if (radioSim && radioSim.checked) {
          // Mostrar resumo
          resumoCreditos.style.display = 'block';
          resumoCreditos.style.opacity = '0';
          resumoCreditos.style.transform = 'translateY(20px)';

          setTimeout(() => {
            resumoCreditos.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
            resumoCreditos.style.opacity = '1';
            resumoCreditos.style.transform = 'translateY(0)';
          }, 10);

          // Mostrar tabelas de créditos com animação
          creditosSections.forEach(section => {
            section.style.display = 'block';
            section.style.opacity = '0';
            section.style.transform = 'translateY(10px)';

            setTimeout(() => {
              section.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
              section.style.opacity = '1';
              section.style.transform = 'translateY(0)';
            }, 100);
          });

        } else {
          // Esconder resumo
          resumoCreditos.style.transition = 'all 0.3s ease-out';
          resumoCreditos.style.opacity = '0';
          resumoCreditos.style.transform = 'translateY(-20px)';

          setTimeout(() => {
            resumoCreditos.style.display = 'none';
          }, 300);

          // Esconder tabelas de créditos
          creditosSections.forEach(section => {
            section.style.transition = 'all 0.3s ease-out';
            section.style.opacity = '0';
            section.style.transform = 'translateY(-10px)';

            setTimeout(() => {
              section.style.display = 'none';
            }, 300);
          });

          // Desmarcar todos os checkboxes de crédito
          document.querySelectorAll('.credito-checkbox').forEach(checkbox => {
            checkbox.checked = false;
          });

          // Recalcular totais sem créditos selecionados
          calcularCreditosSelecionados();
        }

        const valorAtual = parseFloat(valorTotalHidden.value) || 0;
        atualizarResumoCredito(valorAtual);

        // Recalcular para atualizar cores do saldo
        calcularValores();
      }

      // Event listeners
      precoCustoInput.addEventListener('input', calcularValores);
      precoCustoInput.addEventListener('blur', calcularValores);

      document.querySelectorAll('input[name="usar_credito"]').forEach(radio => {
        radio.addEventListener('change', () => {
          alternarResumo();
          const valorAtual = parseFloat(valorTotalHidden.value) || 0;
          atualizarResumoCredito(valorAtual);
        });
      });

      // Inicialização
      calcularValores();
      alternarResumo();
      calcularCreditosSelecionados(); // Inicializar sistema de créditos

      // Força atualização inicial do resumo
      setTimeout(() => {
        const valorAtual = parseFloat(valorTotalHidden.value) || 0;
        atualizarResumoCredito(valorAtual);
      }, 100);
    });
  </script>

  <!-- Script para máscara de moeda -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Função para aplicar máscara de moeda brasileira
      function aplicarMascaraMoeda(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor === '') {
          input.value = 'R$ 0,00';
          return;
        }
        valor = (parseInt(valor) / 100).toFixed(2) + '';
        valor = valor.replace(".", ",");
        valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
        valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
        input.value = 'R$ ' + valor;
      }

      // Aplicar máscara nos inputs de preço de custo
      document.querySelectorAll('.campo-moeda-brl').forEach(input => {
        input.addEventListener('input', function () {
          aplicarMascaraMoeda(this);
        });

        input.addEventListener('focus', function () {
          if (this.value === 'R$ 0,00') {
            this.value = '';
          }
        });

        input.addEventListener('blur', function () {
          if (this.value === '' || this.value === 'R$ ') {
            this.value = 'R$ 0,00';
          }
        });

        // Permitir apenas números e vírgula
        input.addEventListener('keypress', function (e) {
          const char = String.fromCharCode(e.which);
          if (!/[0-9,.]/.test(char)) {
            e.preventDefault();
          }
        });
      });
    });
  </script>

  {% include 'estrutura/footer.html' %}
</div>
{% endblock conteudo %}