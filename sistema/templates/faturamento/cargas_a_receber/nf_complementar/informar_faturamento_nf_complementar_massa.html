{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle text-muted">Faturamento</div>
          <h2 class="page-title fw-bold display-6">Confirmação de Faturamento em Massa</h2>
          <p class="text-muted">{{ registros|length }} registro(s) selecionado(s) para faturamento</p>
        </div>
      </div>
    </div>
  </div>

  <div class="py-4">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      <!-- Cards de resumo -->
      <div class="row row-cards mb-4">
        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-success text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-currency-dollar">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M16.7 8a3 3 0 0 0 -2.7 -2h-4a3 3 0 0 0 0 6h4a3 3 0 0 1 0 6h-4a3 3 0 0 1 -2.7 -2" />
                  <path d="M12 3v3m0 12v3" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold">Valor Total a Faturar</div>
                <div class="fs-3 fw-bold text-success mt-1" id="valor-total-receber">
                  {{ valor_total | default(0) | formatar_float_para_brl }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-blue text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-users">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                  <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                  <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold">Registros Selecionados</div>
                <div class="fs-3 fw-bold text-blue mt-1" id="qtd-registros">
                  {{ registros|length }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-4">
          <div class="card border shadow-lg rounded-3">
            <div class="card-body d-flex align-items-center">
              <span class="avatar bg-teal text-white me-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-file-text">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                  <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                  <path d="M9 9l1 0" />
                  <path d="M9 13l6 0" />
                  <path d="M9 17l6 0" />
                </svg>
              </span>
              <div>
                <div class="text-uppercase text-muted fw-semibold">NFs Complementares</div>
                <div class="fs-3 fw-bold text-teal mt-1 text-capitalize">
                  Faturamento em Massa
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Formulário de confirmação -->
      <form action="{{ url_for('informar_faturamento_nf_complementar_massa') }}" method="POST" enctype="multipart/form-data" id="form-recebimento">
        <input type="hidden" name="ids_registros" value="{{ ids_selecionados }}">

        <!-- Seção detalhada dos registros por cliente -->
        <div class="card shadow-sm border-0 rounded-3 mb-4">
          <div class="card-header bg-light fw-bold">
            NFs Complementares Selecionadas para Faturamento
            <span class="badge bg-primary-lt ms-2">{{ registros|length }} NF(s)</span>
          </div>
          <div class="card-body">
            {% for cliente_id, dados_cliente in clientes_dict.items() %}
            <div class="mb-4 p-3 border rounded">
              <div class="row align-items-center mb-3">
                <div class="col">
                  <h5 class="fw-bold text-primary mb-1">
                    {% if dados_cliente.cliente %}
                    {{ dados_cliente.cliente.identificacao }}
                    {% else %}
                    Cliente ID: {{ cliente_id }}
                    {% endif %}
                  </h5>
                  <span class="badge bg-blue-lt">{{ dados_cliente.registros|length }} NF(s) complementar(es)</span>
                  <span class="badge bg-green-lt ms-2" id="total-cliente-{{ cliente_id }}">Total: {{
                    dados_cliente.valor_total | formatar_float_para_brl }}</span>
                </div>
              </div>

              {% for registro in dados_cliente.registros %}
              <!-- Informações básicas da NF Complementar -->
              <div class="card mb-3 border-light">
                <div class="card-header bg-light">
                  <div class="row align-items-center">
                    <div class="col">
                      <h6 class="fw-bold mb-0">
                        NF Complementar: {{ registro.numero_nota_fiscal or '-' }}
                      </h6>
                      <small class="text-muted">
                        {{ registro.data_emissao | formatar_data_para_brl if registro.data_emissao else '-' }} | 
                        {{ registro.destinatario | truncate(30, True, '...') if registro.destinatario else '-' }} |
                        <span class="badge bg-warning-lt ms-2">{{ registro.valor_total_100 | formatar_float_para_brl if registro.valor_total_100 else 'R$ 0,00' }}</span>
                      </small>
                    </div>
                  </div>
                </div>
                
                <!-- Tabela com registros operacionais -->
                {% if registro.registros_operacionais %}
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0">
                      <thead class="bg-light">
                        <tr>
                          <th class="text-center">Data Entrega</th>
                          <th class="text-center">Fornecedor</th>
                          <th class="text-center">Transportadora</th>
                          <th class="text-center">Cliente</th>
                          <th class="text-center">Placa/Motorista</th>
                          <th class="text-center">Produto/Bitola</th>
                          <th class="text-center">Peso Ticket</th>
                          <th class="text-center">Número NF</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for reg_op in registro.registros_operacionais %}
                        <tr>
                          <td class="text-center fw-bold text-primary">
                            {{ reg_op.data_entrega_ticket | formatar_data_para_brl if reg_op.data_entrega_ticket else '-' }}
                          </td>
                          <td class="text-center">
                            {{ reg_op.solicitacao.fornecedor.identificacao | truncate(30, True, '...') if reg_op.solicitacao and reg_op.solicitacao.fornecedor else '-' }}
                          </td>
                          <td class="text-center">
                            {{ reg_op.solicitacao.transportadora_exibicao.identificacao | truncate(30, True, '...') if reg_op.solicitacao and reg_op.solicitacao.transportadora_exibicao else '-' }}
                          </td>
                          <td class="text-center">
                            {{ reg_op.solicitacao.cliente.identificacao | truncate(30, True, '...') if reg_op.solicitacao and reg_op.solicitacao.cliente else '-' }}
                          </td>
                          <td class="text-center">
                            {% if reg_op.solicitacao %}
                              {{ reg_op.solicitacao.veiculo.placa_veiculo or '-' }}
                            {% endif %} |
                            {% if reg_op.solicitacao.motorista %}
                              {{ reg_op.solicitacao.motorista.nome_completo | truncate(20, '...') }}
                            {% endif %}
                          </td>
                          <td class="text-center">
                            {% if reg_op.solicitacao and reg_op.solicitacao.produto %}
                              {{ reg_op.solicitacao.produto.nome }} |
                              {% if reg_op.solicitacao.bitola %}
                              {{ reg_op.solicitacao.bitola.bitola | truncate(20, '...') }}
                              {% endif %}
                            {% else %}
                              -
                            {% endif %}
                          </td>
                          <td class="text-center">
                            <span class="badge bg-cyan-lt">
                              {{ reg_op.peso_liquido_ticket or 0 }} Ton.
                            </span>
                          </td>
                          <td class="text-center">
                            {% if reg_op.numero_nota_fiscal %}
                              <span class="badge bg-warning-lt">{{ reg_op.numero_nota_fiscal }}</span>
                            {% else %}
                              -
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header bg-light fw-bold">Dados do Faturamento</div>
          <div class="card-body">
            <div class="text-end mt-4">
              <a class="btn btn-outline-secondary" href="javascript:history.back()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-left">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M5 12l14 0" />
                  <path d="M5 12l6 6" />
                  <path d="M5 12l6 -6" />
                </svg>
                Voltar
              </a>
              <button type="submit" class="btn btn-success">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-check">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M5 12l5 5l10 -10" />
                </svg>
                Confirmar Faturamento em Massa (<span id="qtd-registros-botao">{{ registros|length }} </span> registros)
              </button>
            </div>
          </div>
        </div>
      </form>

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Aplica a máscara de moeda se necessário
      if (typeof aplicarMascaraMoeda === 'function') {
        aplicarMascaraMoeda();
      }

      function formatarMoeda(valor) {
        return (valor / 100).toLocaleString('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        });
      }

      console.log('NFs Complementares carregadas para faturamento em massa');
    });
  </script>

  {% include 'estrutura/footer.html' %}
</div>
{% endblock conteudo %}