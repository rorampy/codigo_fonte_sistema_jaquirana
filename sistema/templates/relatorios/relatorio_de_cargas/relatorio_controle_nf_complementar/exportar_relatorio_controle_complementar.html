{% include 'relatorios/estrutura/style.html' %}

<div class="page-wrapper">
  <div class="page body">
    <div class="container">
      <div class="watermark">
        <img src="{{ logo_path }}" alt="MBR Extração Watermark" />
      </div>

      <div class="content">
        <div class="header no-break">
          <img src="{{ logo_path }}" alt="Logo MBR Extração" />
          <div class="system-info">
            <div><strong>Sistema de Gestão MBR</strong></div>
            <div><strong>Versão:</strong> {{ changelog.versao }}</div>
            <div><strong>Data:</strong> {{ changelog.data_lancamento }}</div>
          </div>
        </div>

        <div class="relatorio-title">Relatório de Controle NF Complementar</div>

        {% if dados_corretos %}
        <div class="dados-registro no-break">
          <div class="filtros-title">Filtros Aplicados</div>
          <div
            style="display: flex; flex-wrap: wrap; justify-content: space-between;">

            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Data Início:</strong></span>
                {% if dados_corretos.get('dataInicio') %}
                {{ dados_corretos.get('dataInicio') |
                converte_data_para_datetime_converte_data_brl }}
                {% else %}
                -
                {% endif %}
              </p>
            </div>

            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Data Fim:</strong></span>
                {% if dados_corretos.get('dataFim') %}
                {{ dados_corretos.get('dataFim') |
                converte_data_para_datetime_converte_data_brl }}
                {% else %}
                -
                {% endif %}
              </p>
            </div>

            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Cliente:</strong></span>
                {{ dados_corretos.get('clienteNfComplementar') or '-' }}
              </p>
            </div>

            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Número NF:</strong></span>
                {{ dados_corretos.get('numeroNfComplementar') or '-' }}
              </p>
            </div>

            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Status NF:</strong></span>
                {% if dados_corretos.get('statusNfComplementarEmitida') == '1'
                %}
                Emitida
                {% elif dados_corretos.get('statusNfComplementarEmitida') == '2'
                %}
                Não Emitida
                {% elif dados_corretos.get('statusNfComplementarEmitida') == '3'
                %}
                Cancelada
                {% else %}
                -
                {% endif %}
              </p>
            </div>

          </div>
        </div>
        {% endif %}

        {% if registros %}
        {% for cliente_group in registros | groupby('cliente') %}
        {% set registros_filtrados = cliente_group.list
        | selectattr('registro.peso_liquido_ticket')
        | selectattr('registro.peso_ton_nf')
        | list %}

        {% if registros_filtrados %}
        <div class="no-break" style="margin-top: 20px;">
          <div class="filtros-title">Cliente: {{ cliente_group.grouper or '-'
            }}</div>
        </div>

        {% for produto_group in registros_filtrados | groupby('produto') %}
        <div class="section-title no-break">
          Produto: {{ produto_group.grouper or '-' }}
          <span style="float: right; font-weight: normal; font-size: 12px;">
            Total de cargas: {{ produto_group.list | length }}
          </span>
        </div>

        <table>
          <thead>
            <tr>
              <th class="text-center text-primary">Data Emissão NF</th>
              <th class="text-center">Cliente</th>
              <th class="text-center">Número NF</th>
              <th class="text-center">Peso NF</th>
              <th class="text-center">Peso Ticket</th>
              <th class="text-center">Diferença</th>
              <th class="text-center">NF Complementar Emitida</th>
            </tr>
          </thead>
          <tbody>
            {% for item in produto_group.list %}
            {% set registro = item.registro %}
            {% set peso_nf = registro.peso_ton_nf %}
            {% set peso_ticket = registro.peso_liquido_ticket %}
            {% set dif = (peso_nf - peso_ticket) | round(2) %}

            <tr>
              <td class="text-center">
                {% if registro.destinatario_data_emissao %}
                {{ registro.destinatario_data_emissao | formatar_data_para_brl
                }}
                {% else %}
                -
                {% endif %}
              </td>
              <td class="text-center">
                {{ registro.solicitacao.cliente.identificacao or '-' }}
              </td>
              <td class="text-center">
                {% if registro.estorno_nf%}
                {{ registro.numero_nota_fiscal_estorno
                }} *
                {% elif registro.numero_nota_fiscal %}
                {{ registro.numero_nota_fiscal }}
                {%else%}
                -
                {% endif %}
              </td>
              <td class="text-center">{{ peso_nf }} Ton.</td>
              <td class="text-center">{{ peso_ticket }} Ton.</td>
              <td class="text-center">
                <span
                  class="badge {{ 'bg-danger-lt' if dif < 0 else 'bg-green-lt' }}">
                  {{ dif }} Ton.
                </span>
              </td>
              <td class="text-center">
                {% if dif < 0 %}
                <span class="badge 
                              {% if registro.status_emissao_nf_complementar_id == 1 %}
                                bg-green-lt
                              {% else %}
                                bg-danger-lt
                              {% endif %}">
                  {{ registro.status_emissao_nf_complementar.status }}
                </span>
                {% else %}
                -
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endfor %}
        {% endif %}
        {% endfor %}
        {% else %}
        <!-- Estado vazio -->
        <div style="text-align: center; padding: 50px 0;">
          <h3 style="color: #666;">Nenhum registro encontrado</h3>
          <p style="color: #999;">Não há registros de cargas disponíveis para os
            filtros selecionados.</p>
        </div>
        {% endif %}

        <div class="footer">
          <p><strong>MBR Extração &copy; 2025</strong> - Todos os direitos
            reservados</p>
          <p><strong>Sistema de Gestão MBR</strong></p>
        </div>
      </div>
    </div>
  </div>
</div>
