{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<style>
  .ps-5 {
    padding-left: 2.5rem !important;
  }

  .ps-6 {
    padding-left: 3.5rem !important;
  }

  .ps-7 {
    padding-left: 4.5rem !important;
  }

  .table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02) !important;
    transition: background-color 0.15s ease-in-out;
  }

  .border-3 {
    border-width: 3px !important;
  }

  .border-4 {
    border-width: 4px !important;
  }

  .fs-7 {
    font-size: 0.875rem;
  }

  .badge.rounded-pill {
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  .card {
    border-radius: 12px !important;
    overflow: hidden;
  }

  .table-borderless td {
    border: none !important;
  }

  .bg-success-subtle {
    background-color: rgba(25, 135, 84, 0.1) !important;
  }

  .bg-danger-subtle {
    background-color: rgba(220, 53, 69, 0.1) !important;
  }

  .bg-warning-subtle {
    background-color: rgba(255, 193, 7, 0.15) !important;
  }

  .text-success-emphasis {
    color: #0a3622 !important;
  }

  .text-danger-emphasis {
    color: #58151c !important;
  }

  .text-warning-emphasis {
    color: #664d03 !important;
  }

  .shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
  }

  /* Paleta Unificada Elegante - Tons Azul-Acinzentados com Varia√ß√µes Sutis */

  /* Receitas - Azul Ard√≥sia Elegante (tom harmonioso) */
  .bg-green-lt {
    background-color: #f1f5f9 !important;
    /* Azul ard√≥sia muito claro */
  }

  .text-green {
    color: #334155 !important;
    /* Azul ard√≥sia elegante */
  }

  .bg-green {
    background-color: #475569 !important;
  }

  .border-green {
    background-color: #f1f5f9;
    color: #334155;
    border: 1px solid #cbd5e1 !important;
  }

  /* üîπ Custos - Azul M√©dio Neutro (tom intermedi√°rio para diferencia√ß√£o) */
  .bg-red-lt {
    background-color: #f1f5f9 !important;
    /* Azul ard√≥sia muito claro */
  }

  .text-red {
    color: #334155 !important;
    /* Azul ard√≥sia m√©dio */
  }

  .bg-red {
    background-color: #475569 !important;
  }

  .border-red {
    background-color: #f1f5f9;
    color: #334155;
    border: 1px solid #cbd5e1 !important;
  }

  /* ÔøΩ Despesas - Azul Acinzentado (tom neutro sofisticado) */
  .bg-orange-lt {
    background-color: #f8fafc !important;
    /* Cinza azulado muito claro */
  }

  .text-orange {
    color: #475569 !important;
    /* Cinza azulado m√©dio */
  }

  .bg-orange {
    background-color: #64748b !important;
  }

  .border-orange {
    background-color: #f8fafc;
    color: #475569;
    border: 1px solid #e2e8f0 !important;
  }

  /* ÔøΩ Resultado Operacional - Azul Safira (destaque especial) */
  .bg-blue {
    background-color: #1e40af !important;
    /* Azul safira */
  }

  .border-blue {
    border-color: #93c5fd !important;
    /* Borda azul suave */
  }

  /* üåü Elementos Neutros - Azul P√©rola (muito sutil) */
  .bg-elegant-gray {
    background-color: #f8fafc !important;
    /* Azul p√©rola */
  }

  .text-elegant-gray {
    color: #64748b !important;
    /* Azul acinzentado suave */
  }

  /* ÔøΩ Financiamento - Azul Lunar (tom frio e elegante) */
  .bg-gray-lt {
    background-color: #f1f5f9 !important;
    /* Azul lunar claro */
  }

  .text-gray {
    color: #475569 !important;
    /* Azul lunar m√©dio */
  }

  .bg-gray {
    background-color: #64748b !important;
  }

  .border-gray {
    background-color: #f1f5f9;
    color: #475569;
    border: 1px solid #cbd5e1 !important;
  }

  /* üåä Investimento - Azul Ard√≥sia Harmonioso */
  .bg-orange-light {
    background-color: #f1f5f9 !important;
    /* Azul ard√≥sia muito claro */
  }

  .text-orange-light {
    color: #334155 !important;
    /* Azul ard√≥sia m√©dio */
  }

  .bg-orange-light-solid {
    background-color: #cbd5e1 !important;
    /* Azul ard√≥sia s√≥lido suave */
  }

  .border-orange-light {
    background-color: #f1f5f9;
    color: #334155;
    border: 1px solid #cbd5e1 !important;
  }
</style>

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">RELAT√ìRIO FINANCEIRO</div>
          <h2 class="page-title">DRE Anal√≠tico - Demonstrativo de Resultado do Exerc√≠cio</h2>
        </div>
        <div class="col-12 col-md-auto ms-auto d-print-none">
          <div class="d-flex gap-2">
            {% if dre_dados %}
            <form action="{{ url_for('dre_analitico') }}" method="POST" class="d-inline" target="_blank">
              <input type="hidden" name="data_inicio" value="{{ dados_form.data_inicio }}">
              <input type="hidden" name="data_fim" value="{{ dados_form.data_fim }}">
              <input type="hidden" name="exportar_pdf" value="1">
              <button type="submit" class="btn btn-outline-danger">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icon-tabler-file-type-pdf">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                  <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4" />
                  <path d="M5 18h1.5a1.5 1.5 0 0 0 0 -3h-1.5v6" />
                  <path d="M17 18h2" />
                  <path d="M20 15h-3v6" />
                  <path d="M11 15v6h1a2 2 0 0 0 2 -2v-2a2 2 0 0 0 -2 -2h-1z" />
                </svg>
                Exportar PDF
              </button>
            </form>
            {% endif %}

            <a href="{{ url_for('dre_analitico') }}" class="btn btn-dark active">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icon-tabler-chart-bar">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <rect x="3" y="12" width="6" height="8" rx="1" />
                <rect x="9" y="8" width="6" height="12" rx="1" />
                <rect x="15" y="4" width="6" height="16" rx="1" />
              </svg>
              DRE Anal√≠tico
            </a>

            <a href="{{ url_for('dre_sintetico') }}" class="btn btn-outline-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icon-tabler-chart-bar">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <rect x="3" y="12" width="6" height="8" rx="1" />
                <rect x="9" y="8" width="6" height="12" rx="1" />
                <rect x="15" y="4" width="6" height="16" rx="1" />
              </svg>
              DRE Sint√©tico
            </a>

            <a href="#" class="btn btn" data-bs-toggle="modal" data-bs-target="#modal-filtros">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icon-tabler-filter me-1">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
              </svg>
              Filtros
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      {% if dre_dados %}
      <div class="card">
        <div class="card-header bg-light border-0 py-4">
          <div class="row align-items-center">
            <div class="col">
              <h3 class="card-title mb-1 text-dark fw-bold fs-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                  stroke="#6c757d" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icon-tabler-report-money me-2">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" />
                  <rect x="9" y="3" width="6" height="4" rx="2" />
                  <path d="M14 11h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" />
                  <path d="M12 17v1m0 -8v1" />
                </svg>
                DRE Anal√≠tico
              </h3>
              <p class="text-muted mb-0 fs-6">Demonstrativo de Resultado do Exerc√≠cio</p>
              <div class="mt-3">
                <div class="col-auto">
                  <div class="badge bg-dark-lt">
                    Filtro por compet√™ncia: {{ dados_form.data_inicio | formatar_data_filtro_para_brl }} a {{
                    dados_form.data_fim |
                    formatar_data_filtro_para_brl }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-body p-0">

          <div class="mb-4">
            <div class="d-flex align-items-center mb-3 px-3">
              <div class="badge bg-green-lt text-green me-2 rounded-pill px-3 py-2 border border-green"
                style="font-weight: 500;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                  class="me-1 opacity-75">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
                RECEITAS
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-borderless mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-start fw-semibold text-dark border-0 py-3">Descri√ß√£o</th>
                    <th class="text-end fw-semibold text-dark border-0 py-3" style="width: 200px;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% set categorias_agrupadas = {} %}
                  {% for item in dre_dados.receitas.operacionais.detalhes %}
                  {% if item.valor != 0 %}
                  {% set partes_hierarquia = item.hierarquia_completa.split(' > ') %}
                  
                  {% set categoria_principal = partes_hierarquia[-2] if partes_hierarquia|length > 1 else
                  partes_hierarquia[0] %}
                  {% if categoria_principal not in categorias_agrupadas %}
                  {% set _ = categorias_agrupadas.update({categoria_principal: []}) %}
                  {% endif %}
                  {% set _ = categorias_agrupadas[categoria_principal].append(item) %}
                  {% endif %}
                  {% endfor %}

                  {% set grupos_ordenados = [] %}
                  {% for categoria_principal, itens in categorias_agrupadas.items() %}
                  {% set _ = grupos_ordenados.append((itens[0].codigo[:7], categoria_principal, itens)) %}
                  {% endfor %}
                  {% set _ = grupos_ordenados.sort() %}

                  {% if grupos_ordenados|length > 1 or (grupos_ordenados|length == 1 and grupos_ordenados[0][2]|length >
                  1) %}
                  <tr class="bg-green-lt">
                    <td class="fw-semibold ps-3 py-3 text-green border-0">Receitas Operacionais</td>
                    <td class="text-end fw-semibold py-3 text-green border-0">
                      {{ dre_dados.receitas.operacionais.total | formatar_float_para_brl }}
                    </td>
                  </tr>
                  {% endif %}

                  {% for codigo_ordenacao, categoria_principal, itens in grupos_ordenados %}
                  
                  {% if grupos_ordenados|length > 1 or itens|length > 1 %}
                  <tr class="bg-green-lt">
                    <td class="ps-3 fw-medium py-2 text-green border-0">
                      {{ categoria_principal }}
                    </td>
                    <td class="text-end fw-medium py-2 text-green border-0">
                      {{ (itens | sum(attribute='valor') ) | formatar_float_para_brl }}
                    </td>
                  </tr>
                  {% endif %}

                  {% for item in itens | sort(attribute='codigo') %}
                  <tr class="border-0">
                    <td
                      class="{% if grupos_ordenados|length > 1 or itens|length > 1 %}ps-5{% else %}ps-3 fw-medium text-green{% endif %} py-2 border-0">
                      <a href="#" class="categoria-link text-decoration-none text-dark d-flex align-items-center"
                        data-categoria-id="{{ item.categoria_id }}" data-categoria-nome="{{ item.nome }}">
                        <span>{{ item.nome }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="ms-auto opacity-50">
                          <path d="M9 18l6-6-6-6" />
                        </svg>
                      </a>
                    </td>
                    <td
                      class="text-end py-2 border-0 {% if not (grupos_ordenados|length > 1 or itens|length > 1) %}fw-medium text-green{% else %}text-dark{% endif %}">
                      {{ (item.valor ) | formatar_float_para_brl }}</td>
                  </tr>
                  {% endfor %}
                  {% endfor %}

                  {% set categorias_agrupadas_nao_op = {} %}
                  {% for item in dre_dados.receitas.nao_operacionais.detalhes %}
                  {% if item.valor != 0 and not item.codigo.startswith('1.02.01') %}
                  {% set partes_hierarquia = item.hierarquia_completa.split(' > ') %}
                  {% set categoria_principal = partes_hierarquia[-2] if partes_hierarquia|length > 1 else
                  partes_hierarquia[0] %}
                  {% if categoria_principal not in categorias_agrupadas_nao_op %}
                  {% set _ = categorias_agrupadas_nao_op.update({categoria_principal: []}) %}
                  {% endif %}
                  {% set _ = categorias_agrupadas_nao_op[categoria_principal].append(item) %}
                  {% endif %}
                  {% endfor %}

                  {% set grupos_ordenados_nao_op = [] %}
                  {% for categoria_principal, itens in categorias_agrupadas_nao_op.items() %}
                  {% set _ = grupos_ordenados_nao_op.append((itens[0].codigo[:7], categoria_principal, itens)) %}
                  {% endfor %}
                  {% set _ = grupos_ordenados_nao_op.sort() %}

                  {% if grupos_ordenados_nao_op|length > 0 %}
                  
                  {% set total_nao_op_sem_aplicacoes = [] %}
                  {% for item in dre_dados.receitas.nao_operacionais.detalhes %}
                  {% if not item.codigo.startswith('1.02.01') %}
                  {% set _ = total_nao_op_sem_aplicacoes.append(item) %}
                  {% endif %}
                  {% endfor %}
                  <tr class="bg-green-lt">
                    <td class="fw-semibold ps-3 py-3 text-green border-0">Receitas N√£o-Operacionais</td>
                    <td class="text-end fw-semibold py-3 text-green border-0">
                      {{ (total_nao_op_sem_aplicacoes | sum(attribute='valor')) | formatar_float_para_brl }}
                    </td>
                  </tr>

                  {% for codigo_ordenacao, categoria_principal, itens in grupos_ordenados_nao_op %}
                  
                  {% if grupos_ordenados_nao_op|length > 1 or itens|length > 1 %}
                  <tr class="bg-green-lt">
                    <td class="ps-3 fw-medium py-2 text-green border-0">
                      {{ categoria_principal }}
                    </td>
                    <td class="text-end fw-medium py-2 text-green border-0">
                      {{ (itens | sum(attribute='valor') ) | formatar_float_para_brl }}
                    </td>
                  </tr>
                  {% endif %}

                  {% for item in itens | sort(attribute='codigo') %}
                  <tr>
                    <td
                      class="{% if grupos_ordenados_nao_op|length > 1 or itens|length > 1 %}ps-5{% else %}ps-3 fw-medium text-green{% endif %} py-2 border-0">
                      <a href="#" class="categoria-link text-decoration-none text-dark d-flex align-items-center"
                        data-categoria-id="{{ item.categoria_id }}" data-categoria-nome="{{ item.nome }}">
                        <span>{{ item.nome }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="ms-auto opacity-50">
                          <path d="M9 18l6-6-6-6" />
                        </svg>
                      </a>
                    </td>
                    <td
                      class="text-end py-2 border-0 {% if not (grupos_ordenados_nao_op|length > 1 or itens|length > 1) %}fw-medium text-green{% else %}text-dark{% endif %}">
                      {{ (item.valor ) | formatar_float_para_brl }}</td>
                  </tr>
                  {% endfor %}
                  {% endfor %}
                  {% endif %}

                  {% set total_receitas_sem_aplicacoes = dre_dados.receitas.operacionais.total +
                  (total_nao_op_sem_aplicacoes | sum(attribute='valor')) %}
                  <tr class="border-top border-1" style="border-color: #cbd5e1 !important;">
                    <td class="fw-medium ps-3 py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">TOTAL DE RECEITAS</td>
                    <td class="text-end fw-medium py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">{{
                      total_receitas_sem_aplicacoes | formatar_float_para_brl }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="mb-4">
            <div class="d-flex align-items-center mb-3 px-3">
              <div class="badge bg-red-lt text-red me-2 rounded-pill px-3 py-2 border border-red"
                style="font-weight: 500;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                  class="me-1 opacity-75">
                  <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
                </svg>
                CUSTOS OPERACIONAIS
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-borderless mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-start fw-semibold text-dark border-0 py-3">Descri√ß√£o</th>
                    <th class="text-end fw-semibold text-dark border-0 py-3" style="width: 200px;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% set categorias_agrupadas_custos = {} %}
                  {% for item in dre_dados.custos.operacionais.detalhes %}
                  {% if item.valor != 0 and not item.codigo.startswith('2.01.11') and not
                  item.codigo.startswith('2.02.05') %}
                  {% set partes_hierarquia = item.hierarquia_completa.split(' > ') %}
                  {% set categoria_principal = partes_hierarquia[-2] if partes_hierarquia|length > 1 else
                  partes_hierarquia[0] %}
                  {% if categoria_principal not in categorias_agrupadas_custos %}
                  {% set _ = categorias_agrupadas_custos.update({categoria_principal: []}) %}
                  {% endif %}
                  {% set _ = categorias_agrupadas_custos[categoria_principal].append(item) %}
                  {% endif %}
                  {% endfor %}

                  {% set grupos_ordenados_custos = [] %}
                  {% for categoria_principal, itens in categorias_agrupadas_custos.items() %}
                  {% set _ = grupos_ordenados_custos.append((itens[0].codigo[:7], categoria_principal, itens)) %}
                  {% endfor %}
                  {% set _ = grupos_ordenados_custos.sort() %}

                  {% for codigo_ordenacao, categoria_principal, itens in grupos_ordenados_custos %}
                  
                  {% if grupos_ordenados_custos|length > 1 or itens|length > 1 %}
                  <tr class="bg-red-lt">
                    <td class="ps-3 fw-medium py-2 text-red border-0">
                      {{ categoria_principal }}
                    </td>
                    <td class="text-end fw-medium py-2 text-red border-0">
                      -{{ (itens | sum(attribute='valor') ) | formatar_float_para_brl }}
                    </td>
                  </tr>
                  {% endif %}

                  {% for item in itens | sort(attribute='codigo') %}
                  <tr class="border-0">
                    <td
                      class="{% if grupos_ordenados_custos|length > 1 or itens|length > 1 %}ps-5{% else %}ps-3 fw-medium text-red{% endif %} py-2 border-0">
                      <a href="#" class="categoria-link text-decoration-none text-dark d-flex align-items-center"
                        data-categoria-id="{{ item.categoria_id }}" data-categoria-nome="{{ item.nome }}">
                        <span>{{ item.nome }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="ms-auto opacity-50">
                          <path d="M9 18l6-6-6-6" />
                        </svg>
                      </a>
                    </td>
                    <td
                      class="text-end py-2 border-0 {% if not (grupos_ordenados_custos|length > 1 or itens|length > 1) %}fw-medium text-red{% else %}text-dark{% endif %}">
                      -{{ (item.valor ) | formatar_float_para_brl }}</td>
                  </tr>
                  {% endfor %}
                  {% endfor %}

                  {% set total_custos_sem_exclusoes = [] %}
                  {% for item in dre_dados.custos.operacionais.detalhes %}
                  {% if not item.codigo.startswith('2.01.11') and not item.codigo.startswith('2.02.05') %}
                  {% set _ = total_custos_sem_exclusoes.append(item) %}
                  {% endif %}
                  {% endfor %}
                  <tr class="border-top border-1" style="border-color: #cbd5e1 !important;">
                    <td class="fw-medium ps-3 py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">TOTAL DE CUSTOS</td>
                    <td class="text-end fw-medium py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">-{{
                      (total_custos_sem_exclusoes | sum(attribute='valor')) | formatar_float_para_brl }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          {% set margem_contribuicao_filtrada = total_receitas_sem_aplicacoes - (total_custos_sem_exclusoes |
          sum(attribute='valor')) %}
          {% set margem_percentual_filtrada = (margem_contribuicao_filtrada / total_receitas_sem_aplicacoes * 100) if
          total_receitas_sem_aplicacoes != 0 else 0 %}
          <div class="mb-4">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
              <div class="card-body text-center py-4 px-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div class="badge me-3 rounded-circle p-2" style="background: #64748b; color: white;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                      </svg>
                    </div>
                    <div class="text-start">
                      <h5 class="mb-0 fw-medium" style="color: #475569; letter-spacing: 0.3px;">MARGEM DE CONTRIBUI√á√ÉO
                        (A+B)</h5>
                      <small class="text-muted" style="font-size: 0.8rem;">{{
                        "%.0f"|format(margem_percentual_filtrada) }}%</small>
                    </div>
                  </div>
                  <h4 class="mb-0 fw-bold"
                    style="color: {% if margem_contribuicao_filtrada >= 0 %}#334155{% else %}#dc2626{% endif %}; font-size: 1.4rem;">
                    {{ margem_contribuicao_filtrada | formatar_float_para_brl }}
                  </h4>
                </div>
              </div>
            </div>
          </div>

          {% if dre_dados.despesas.total > 0 %}
          <div class="mb-4">
            <div class="d-flex align-items-center mb-3 px-3">
              <div class="badge bg-orange-lt text-orange me-2 rounded-pill px-3 py-2 border border-orange"
                style="font-weight: 500;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                  class="me-1 opacity-75">
                  <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                  <polyline points="14,2 14,8 20,8" />
                </svg>
                DESPESAS OPERACIONAIS
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-borderless mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-start fw-semibold text-dark border-0 py-3">Descri√ß√£o</th>
                    <th class="text-end fw-semibold text-dark border-0 py-3" style="width: 200px;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% set categorias_agrupadas_despesas = {} %}
                  {% for item in dre_dados.despesas.operacionais.detalhes %}
                  {% if item.valor != 0 %}
                  {% set partes_hierarquia = item.hierarquia_completa.split(' > ') %}
                  {% set categoria_principal = partes_hierarquia[-2] if partes_hierarquia|length > 1 else
                  partes_hierarquia[0] %}
                  {% if categoria_principal not in categorias_agrupadas_despesas %}
                  {% set _ = categorias_agrupadas_despesas.update({categoria_principal: []}) %}
                  {% endif %}
                  {% set _ = categorias_agrupadas_despesas[categoria_principal].append(item) %}
                  {% endif %}
                  {% endfor %}

                  {% set grupos_ordenados_despesas = [] %}
                  {% for categoria_principal, itens in categorias_agrupadas_despesas.items() %}
                  {% set _ = grupos_ordenados_despesas.append((itens[0].codigo[:7], categoria_principal, itens)) %}
                  {% endfor %}
                  {% set _ = grupos_ordenados_despesas.sort() %}

                  {% for codigo_ordenacao, categoria_principal, itens in grupos_ordenados_despesas %}
                  
                  {% if grupos_ordenados_despesas|length > 1 or itens|length > 1 %}
                  <tr class="bg-orange-lt">
                    <td class="ps-3 fw-medium py-2 text-orange border-0">
                      {{ categoria_principal }}
                    </td>
                    <td class="text-end fw-medium py-2 text-orange border-0">
                      -{{ (itens | sum(attribute='valor') ) | formatar_float_para_brl }}
                    </td>
                  </tr>
                  {% endif %}

                  {% for item in itens | sort(attribute='codigo') %}
                  <tr class="border-0">
                    <td
                      class="{% if grupos_ordenados_despesas|length > 1 or itens|length > 1 %}ps-5{% else %}ps-3 fw-medium text-orange{% endif %} py-2 border-0">
                      <a href="#" class="categoria-link text-decoration-none text-dark d-flex align-items-center"
                        data-categoria-id="{{ item.categoria_id }}" data-categoria-nome="{{ item.nome }}">
                        <span>{{ item.nome }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="ms-auto opacity-50">
                          <path d="M9 18l6-6-6-6" />
                        </svg>
                      </a>
                    </td>
                    <td
                      class="text-end py-2 border-0 {% if not (grupos_ordenados_despesas|length > 1 or itens|length > 1) %}fw-medium text-orange{% else %}text-dark{% endif %}">
                      -{{ (item.valor ) | formatar_float_para_brl }}</td>
                  </tr>
                  {% endfor %}
                  {% endfor %}

                  <tr class="border-top border-1" style="border-color: #e2e8f0 !important;">
                    <td class="fw-medium ps-3 py-3"
                      style="background: #f8fafc; color: #475569; border: 1px solid #e2e8f0;">TOTAL DE DESPESAS</td>
                    <td class="text-end fw-medium py-3"
                      style="background: #f8fafc; color: #475569; border: 1px solid #e2e8f0;">-{{
                      dre_dados.despesas.operacionais.total | formatar_float_para_brl }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

          {% if dre_dados.resultado.operacional is defined %}
          <div class="mb-4">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);">
              <div class="card-body text-center py-4 px-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div class="badge me-3 rounded-circle p-2" style="background: #334155; color: white;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 3v18h18" />
                        <path d="m19 9-5 5-4-4-3 3" />
                      </svg>
                    </div>
                    <h5 class="mb-0 fw-medium" style="color: #334155; letter-spacing: 0.3px;">RESULTADO OPERACIONAL</h5>
                  </div>
                  {% set resultado_operacional_filtrado = margem_contribuicao_filtrada -
                  dre_dados.despesas.operacionais.total %}
                  <h4 class="mb-0 fw-bold"
                    style="color: {% if resultado_operacional_filtrado >= 0 %}#334155{% else %}#dc2626{% endif %}; font-size: 1.4rem;">
                    {{ resultado_operacional_filtrado | formatar_float_para_brl }}
                  </h4>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {% set compra_floresta = [] %}
          {% for item in dre_dados.custos.operacionais.detalhes %}
          {% if item.codigo.startswith('2.01.11') and item.valor != 0 %}
          {% set _ = compra_floresta.append(item) %}
          {% endif %}
          {% endfor %}

          {% if compra_floresta|length > 0 %}
          <div class="mb-4">
            <div class="d-flex align-items-center mb-3 px-3">
              <div
                class="badge bg-orange-light text-orange-light me-2 rounded-pill px-3 py-2 border border-orange-light"
                style="font-weight: 500;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                  class="me-1 opacity-75">
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12,6 12,12 16,14" />
                </svg>
                ATIVIDADES DE INVESTIMENTO
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-borderless mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-start fw-semibold text-dark border-0 py-3">Descri√ß√£o</th>
                    <th class="text-end fw-semibold text-dark border-0 py-3" style="width: 200px;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% set categorias_agrupadas_inv = {} %}
                  {% for item in compra_floresta %}
                  {% set partes_hierarquia = item.hierarquia_completa.split(' > ') %}
                  {% set categoria_principal = partes_hierarquia[-2] if partes_hierarquia|length > 1 else
                  partes_hierarquia[0] %}
                  {% if categoria_principal not in categorias_agrupadas_inv %}
                  {% set _ = categorias_agrupadas_inv.update({categoria_principal: []}) %}
                  {% endif %}
                  {% set _ = categorias_agrupadas_inv[categoria_principal].append(item) %}
                  {% endfor %}

                  {% set grupos_ordenados_inv = [] %}
                  {% for categoria_principal, itens in categorias_agrupadas_inv.items() %}
                  {% set _ = grupos_ordenados_inv.append((itens[0].codigo[:7], categoria_principal, itens)) %}
                  {% endfor %}
                  {% set _ = grupos_ordenados_inv.sort() %}

                  {% for codigo_ordenacao, categoria_principal, itens in grupos_ordenados_inv %}
                  
                  {% if grupos_ordenados_inv|length > 1 or itens|length > 1 %}
                  <tr class="bg-orange-light">
                    <td class="ps-3 fw-medium py-2 text-orange border-0">
                      {{ categoria_principal }}
                    </td>
                    <td class="text-end fw-medium py-2 text-orange border-0">
                      -{{ (itens | sum(attribute='valor') ) | formatar_float_para_brl }}
                    </td>
                  </tr>
                  {% endif %}

                  {% for item in itens | sort(attribute='codigo') %}
                  <tr class="border-0">
                    <td
                      class="{% if grupos_ordenados_inv|length > 1 or itens|length > 1 %}ps-5{% else %}ps-3 fw-medium text-orange{% endif %} py-2 border-0">
                      <a href="#" class="categoria-link text-decoration-none text-dark d-flex align-items-center"
                        data-categoria-id="{{ item.categoria_id }}" data-categoria-nome="{{ item.nome }}">
                        <span>{{ item.nome }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="ms-auto opacity-50">
                          <path d="M9 18l6-6-6-6" />
                        </svg>
                      </a>
                    </td>
                    <td
                      class="text-end py-2 border-0 {% if not (grupos_ordenados_inv|length > 1 or itens|length > 1) %}fw-medium text-orange{% else %}text-dark{% endif %}">
                      -{{ (item.valor ) | formatar_float_para_brl }}</td>
                  </tr>
                  {% endfor %}
                  {% endfor %}

                  <tr class="border-top border-1" style="border-color: #cbd5e1 !important;">
                    <td class="fw-medium ps-3 py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">TOTAL ATIVIDADES DE
                      INVESTIMENTO</td>
                    <td class="text-end fw-medium py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">-{{ (compra_floresta |
                      sum(attribute='valor')) | formatar_float_para_brl }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

          {% set aplicacoes_financeiras = [] %}
          {% set retirada_capital = [] %}

          {% for item in dre_dados.receitas.nao_operacionais.detalhes %}
          {% if item.codigo.startswith('1.02.01') and item.valor != 0 %}
          {% set _ = aplicacoes_financeiras.append(item) %}
          {% endif %}
          {% endfor %}

          {% for item in dre_dados.custos.operacionais.detalhes %}
          {% if item.codigo.startswith('2.02.05') and item.valor != 0 %}
          {% set _ = retirada_capital.append(item) %}
          {% endif %}
          {% endfor %}

          {% if aplicacoes_financeiras|length > 0 or retirada_capital|length > 0 %}
          <div class="mb-4">
            <div class="d-flex align-items-center mb-3 px-3">
              <div class="badge bg-gray-lt text-gray me-2 rounded-pill px-3 py-2 border border-gray"
                style="font-weight: 500;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                  class="me-1 opacity-75">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
                ATIVIDADES DE FINANCIAMENTO
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-borderless mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-start fw-semibold text-dark border-0 py-3">Descri√ß√£o</th>
                    <th class="text-end fw-semibold text-dark border-0 py-3" style="width: 200px;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  
                  {% set categorias_agrupadas_fin = {} %}
                  {% for item in aplicacoes_financeiras %}
                  {% set partes_hierarquia = item.hierarquia_completa.split(' > ') %}
                  {% set categoria_principal = partes_hierarquia[-2] if partes_hierarquia|length > 1 else
                  partes_hierarquia[0] %}
                  {% if categoria_principal not in categorias_agrupadas_fin %}
                  {% set _ = categorias_agrupadas_fin.update({categoria_principal: []}) %}
                  {% endif %}
                  {% set _ = categorias_agrupadas_fin[categoria_principal].append(item) %}
                  {% endfor %}

                  {% for item in retirada_capital %}
                  {% set partes_hierarquia = item.hierarquia_completa.split(' > ') %}
                  {% set categoria_principal = partes_hierarquia[-2] if partes_hierarquia|length > 1 else
                  partes_hierarquia[0] %}
                  {% if categoria_principal not in categorias_agrupadas_fin %}
                  {% set _ = categorias_agrupadas_fin.update({categoria_principal: []}) %}
                  {% endif %}
                  {% set _ = categorias_agrupadas_fin[categoria_principal].append(item) %}
                  {% endfor %}

                  {% set grupos_ordenados_fin = [] %}
                  {% for categoria_principal, itens in categorias_agrupadas_fin.items() %}
                  {% set _ = grupos_ordenados_fin.append((itens[0].codigo[:7], categoria_principal, itens)) %}
                  {% endfor %}
                  {% set _ = grupos_ordenados_fin.sort() %}

                  {% for codigo_ordenacao, categoria_principal, itens in grupos_ordenados_fin %}
                  
                  {% if grupos_ordenados_fin|length > 1 or itens|length > 1 %}
                  <tr class="bg-gray-lt">
                    <td class="ps-3 fw-medium py-2 text-gray border-0">
                      {{ categoria_principal }}
                    </td>
                    <td class="text-end fw-medium py-2 text-gray border-0">
                      {% set total_categoria = 0 %}
                      {% for item in itens %}
                      {% if item.codigo.startswith('1.02') %}
                      {% set total_categoria = total_categoria + item.valor %}
                      {% else %}
                      {% set total_categoria = total_categoria - item.valor %}
                      {% endif %}
                      {% endfor %}
                      {{ total_categoria | formatar_float_para_brl }}
                    </td>
                  </tr>
                  {% endif %}

                  {% for item in itens | sort(attribute='codigo') %}
                  <tr class="border-0">
                    <td
                      class="{% if grupos_ordenados_fin|length > 1 or itens|length > 1 %}ps-5{% else %}ps-3 fw-medium text-gray{% endif %} py-2 border-0">
                      <a href="#" class="categoria-link text-decoration-none text-dark d-flex align-items-center"
                        data-categoria-id="{{ item.categoria_id }}" data-categoria-nome="{{ item.nome }}">
                        <span>{{ item.nome }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="ms-auto opacity-50">
                          <path d="M9 18l6-6-6-6" />
                        </svg>
                      </a>
                    </td>
                    <td
                      class="text-end py-2 border-0 {% if not (grupos_ordenados_fin|length > 1 or itens|length > 1) %}fw-medium text-gray{% else %}text-dark{% endif %}">
                      {% if item.codigo.startswith('1.02') %}
                      {{ item.valor | formatar_float_para_brl }}
                      {% else %}
                      -{{ item.valor | formatar_float_para_brl }}
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                  {% endfor %}

                  {% set total_financiamento = (aplicacoes_financeiras | sum(attribute='valor')) - (retirada_capital |
                  sum(attribute='valor')) %}
                  <tr class="border-top border-1" style="border-color: #cbd5e1 !important;">
                    <td class="fw-medium ps-3 py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">TOTAL ATIVIDADES DE
                      FINANCIAMENTO</td>
                    <td class="text-end fw-medium py-3"
                      style="background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1;">{{ total_financiamento |
                      formatar_float_para_brl }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

          {% if dre_dados.resultado.variacao_caixa is defined %}
          
          {% endif %}

        </div>
      </div>

      {% else %}
      
      <div class="card">
        <div class="card-body text-center p-5">
          <div class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none"
              stroke="#6c757d" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icon-tabler-report-off">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M8 5h-1a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" />
              <rect x="9" y="3" width="6" height="4" rx="2" />
              <path d="M3 3l18 18" />
            </svg>
          </div>
          <h3 class="text-muted mb-3">Nenhum dado encontrado</h3>
          <p class="text-muted mb-4">
            N√£o foram encontrados lan√ßamentos financeiros para o per√≠odo selecionado.<br>
            Tente ajustar os filtros de data ou verificar se existem lan√ßamentos categorizados no sistema.
          </p>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-filtros">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icon-tabler-filter me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
            </svg>
            Ajustar Per√≠odo
          </button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="modal modal-blur fade" id="modal-filtros" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="display: grid;">
      <form action="{{ url_for('dre_analitico') }}" method="POST">
        <div class="modal-content">
          <div class="modal-header bg-light border-0">
            <h5 class="modal-title text-dark fw-semibold">Filtros - DRE Anal√≠tico</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            
            <div class="mb-4">
              <label class="form-label fw-semibold">Filtrar por Exerc√≠cio</label>
              <div class="row">
                <div class="col-md-12">
                  <select name="exercicio" class="form-select" onchange="limparDatasPersonalizadas()">
                    <option value="">Selecione um exerc√≠cio ou use per√≠odo personalizado</option>
                    {% for exercicio in exercicios_disponiveis %}
                    <option value="{{ exercicio.valor }}" {% if dados_form.exercicio==exercicio.valor %}selected{% endif
                      %}>
                      {{ exercicio.texto }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <hr class="my-4">

            <div class="mb-3">
              <label class="form-label fw-semibold">Selecione um per√≠odo personalizado:</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Data In√≠cio</label>
                <input type="date" name="data_inicio" class="form-control" value="{{ dados_form.data_inicio }}">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Data Fim</label>
                <input type="date" name="data_fim" class="form-control" value="{{ dados_form.data_fim }}">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a href="{{ url_for('dre_analitico') }}" class="btn btn-link link-secondary">
              Limpar Filtros
            </a>
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icon-tabler-search me-2">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
              </svg>
              Gerar Relat√≥rio
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% include 'estrutura/footer.html' %}
</div>

<div class="modal fade" id="modalDetalhesCategoria" tabindex="-1" aria-labelledby="modalDetalhesCategoriaLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDetalhesCategoriaLabel">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14,2 14,8 20,8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <polyline points="10,9 9,9 8,9" />
          </svg>
          Detalhes da Categoria: <span id="nomeCategoria"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body text-center py-3">
                <h6 class="text-muted mb-1">Total de Registros</h6>
                <h4 class="mb-0 text-primary" id="totalRegistros">-</h4>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-primary text-white">
              <div class="card-body text-center py-3">
                <h6 class="text-white-50 mb-1">Valor Total</h6>
                <h4 class="mb-0" id="valorTotal">-</h4>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-3" id="subtotaisNfComplementar" style="display: none;">
          <div class="col-md-4">
            <div class="card border-success">
              <div class="card-body text-center py-2">
                <h6 class="text-success mb-1">NF Complementares Positivas</h6>
                <h5 class="mb-0 text-success" id="totalPositivas">-</h5>
                <small class="text-muted" id="qtdPositivas">0 registros</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-danger">
              <div class="card-body text-center py-2">
                <h6 class="text-danger mb-1">NF Complementares Negativas</h6>
                <h5 class="mb-0 text-danger" id="totalNegativas">-</h5>
                <small class="text-muted" id="qtdNegativas">0 registros</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-primary">
              <div class="card-body text-center py-2">
                <h6 class="text-primary mb-1">Total L√≠quido</h6>
                <h5 class="mb-0 text-primary" id="totalLiquido">-</h5>
                <small class="text-muted" id="qtdTotal">0 registros</small>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-warning d-flex align-items-start" id="alertaCategorizacaoIncompleta" style="display: none !important;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2 mt-1 flex-shrink-0">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <div>
            <strong>Categoriza√ß√£o Incompleta</strong>
            <div class="mt-1" id="alertaCategorizacaoTexto"></div>
          </div>
        </div>

        <div class="table-responsive" id="tabelaDetalhesContainer">
          <table class="table table-striped table-hover">
            <thead class="table-light">
              <tr>
                <th>Data</th>
                <th>Documento</th>
                <th>Origem</th>
                <th>Benefici√°rio</th>
                <th>Descri√ß√£o</th>
                <th class="text-end">Valor</th>
              </tr>
            </thead>
            <tbody id="tabelaDetalhes">
              
            </tbody>
          </table>
        </div>

        <div id="loadingDetalhes" class="text-center py-4" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p class="mt-2 text-muted">Carregando detalhes...</p>
        </div>

        <div id="erroDetalhes" class="alert alert-danger" style="display: none;">
          <strong>Erro:</strong> <span id="mensagemErro"></span>
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex w-100 justify-content-between align-items-center">
          <div class="btn-group" id="botoesExportacao" style="display: none;">
            <button type="button" class="btn btn-success" onclick="exportarDetalhesCategoriaExcel()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
              </svg>
              Excel
            </button>
            <button type="button" class="btn btn-danger" onclick="exportarDetalhesCategoriaExcel(true)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
              </svg>
              PDF
            </button>
          </div>
          <button type="button" class="btn btn-secondary ms-auto" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  
  let modalCategoriaId = null;
  let modalDataInicio = null;
  let modalDataFim = null;
  let modalTemDados = false;

  document.querySelectorAll('select.form-select').forEach(function (select) {
    new TomSelect(select, {
      create: false,
      allowEmptyOption: false,
    });
  });

  function limparDatasPersonalizadas() {
    const exercicio = document.querySelector('select[name="exercicio"]');
    if (exercicio.value) {
      document.querySelector('input[name="data_inicio"]').value = '';
      document.querySelector('input[name="data_fim"]').value = '';
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const dataInicio = document.querySelector('input[name="data_inicio"]');
    const dataFim = document.querySelector('input[name="data_fim"]');
    const exercicio = document.querySelector('select[name="exercicio"]');

    if (dataInicio && dataFim && exercicio) {
      dataInicio.addEventListener('change', function () {
        if (this.value) {
          exercicio.value = '';
        }
      });

      dataFim.addEventListener('change', function () {
        if (this.value) {
          exercicio.value = '';
        }
      });
    }

    document.querySelectorAll('.categoria-link').forEach(function (link) {
      link.addEventListener('click', function (e) {
        e.preventDefault();

        const categoriaId = this.getAttribute('data-categoria-id');
        const categoriaNome = this.getAttribute('data-categoria-nome');

        const dataInicio = '{{ dados_form.data_inicio }}';
        const dataFim = '{{ dados_form.data_fim }}';

        carregarDetalhesCategoria(categoriaId, categoriaNome, dataInicio, dataFim);
      });
    });
  });

  function carregarDetalhesCategoria(categoriaId, categoriaNome, dataInicio, dataFim) {
    
    modalCategoriaId = categoriaId;
    modalDataInicio = dataInicio;
    modalDataFim = dataFim;
    modalTemDados = false;
    
    document.getElementById('botoesExportacao').style.display = 'none';
    document.getElementById('subtotaisNfComplementar').style.display = 'none';
    document.getElementById('alertaCategorizacaoIncompleta').style.display = 'none';
    document.getElementById('alertaCategorizacaoIncompleta').style.cssText = 'display: none !important;';
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhesCategoria'));
    document.getElementById('nomeCategoria').textContent = categoriaNome;

    document.getElementById('loadingDetalhes').style.display = 'block';
    document.getElementById('tabelaDetalhesContainer').style.display = 'none';
    document.getElementById('erroDetalhes').style.display = 'none';
    document.getElementById('totalRegistros').textContent = '-';
    document.getElementById('valorTotal').textContent = '-';

    modal.show();

    const url = `/relatorios/relatorios-financeiros/dre-categoria-detalhes/${categoriaId}?data_inicio=${dataInicio}&data_fim=${dataFim}`;

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na requisi√ß√£o: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        
        document.getElementById('loadingDetalhes').style.display = 'none';

        document.getElementById('totalRegistros').textContent = data.quantidade;
        document.getElementById('valorTotal').textContent = data.total_formatado || new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(data.total);
        
        if (data.quantidade > 0 && data.permite_exportacao) {
          modalTemDados = true;
          document.getElementById('botoesExportacao').style.display = 'block';
        }

        if (data.subtotais_nfc) {
          const sub = data.subtotais_nfc;
          document.getElementById('totalPositivas').textContent = sub.total_positivas_fmt;
          document.getElementById('qtdPositivas').textContent = sub.qtd_positivas + ' registro(s)';
          document.getElementById('totalNegativas').textContent = sub.total_negativas_fmt;
          document.getElementById('qtdNegativas').textContent = sub.qtd_negativas + ' registro(s)';
          document.getElementById('totalLiquido').textContent = sub.total_liquido_fmt;
          document.getElementById('qtdTotal').textContent = data.quantidade + ' registro(s)';
          document.getElementById('subtotaisNfComplementar').style.display = 'flex';
        }

        if (data.categorizacao_incompleta && data.categorizacao_incompleta.tem_incompletos) {
          const alerta = document.getElementById('alertaCategorizacaoIncompleta');
          const textoAlerta = document.getElementById('alertaCategorizacaoTexto');
          const info = data.categorizacao_incompleta;
          textoAlerta.innerHTML = `<span>${info.quantidade} registro(s) com categoriza√ß√£o parcial. ` +
            `Valor total n√£o categorizado: <strong>R$ ${info.total_nao_categorizado_fmt}</strong>.</span>` +
            `<br><small class="text-muted">Os lan√ßamentos destacados em amarelo possuem valor total maior que o valor categorizado nesta conta. ` +
            `Acesse o fluxo financeiro para completar a categoriza√ß√£o.</small>`;
          alerta.style.cssText = 'display: flex !important;';
        }

        const tbody = document.getElementById('tabelaDetalhes');
        tbody.innerHTML = '';

        if (data.registros.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum registro encontrado</td></tr>';
        } else {
          data.registros.forEach(registro => {
            const row = document.createElement('tr');
            
            if (registro.tipo_nf_complementar === 'positiva') {
              row.style.borderLeft = '3px solid #2fb344';
            } else if (registro.tipo_nf_complementar === 'negativa') {
              row.style.borderLeft = '3px solid #d63939';
            }
            
            if (registro.categorizacao_incompleta) {
              row.style.backgroundColor = '#fff3cd';
              row.style.borderLeft = '3px solid #f59f00';
              row.title = `Categoriza√ß√£o incompleta: R$ ${new Intl.NumberFormat('pt-BR', {minimumFractionDigits: 2}).format(registro.valor_nao_categorizado)} n√£o categorizado(s) do total de R$ ${new Intl.NumberFormat('pt-BR', {minimumFractionDigits: 2}).format(registro.valor_total_original)}`;
            }
            
            let descricaoFormatada = '';
            if (registro.descricao) {
              
              const itens = registro.descricao.split(' ‚Ä¢ ');
              if (itens.length > 1) {
                descricaoFormatada = itens.map(item => `<div class="text-muted small">${item}</div>`).join('');
              } else {
                descricaoFormatada = `<div>${registro.descricao}</div>`;
              }
            } else {
              descricaoFormatada = '<span class="text-muted">-</span>';
            }
            
            row.innerHTML = `
              <td class="text-nowrap">${(() => {
                const [dia, mes, ano] = registro.data_competencia.split('/');
                return `${mes}/${ano}`;
              })()}
              </td>
              <td>
                <div class="badge bg-light text-dark">${registro.codigo_documento}</div>
              </td>
              <td>
                <span class="badge bg-primary-lt">${registro.origem}</span>
              </td>
              <td>${registro.beneficiario || '-'}</td>
              <td>
                ${descricaoFormatada}
                ${registro.referencia ? `<div class="small"><span class="badge bg-secondary-lt">Ref: ${registro.referencia}</span></div>` : ''}
              </td>
              <td class="text-end fw-medium text-nowrap ${registro.tipo_nf_complementar === 'positiva' ? 'text-success' : (registro.tipo_nf_complementar === 'negativa' ? 'text-danger' : '')}">
                ${registro.valor_formatado}
                ${registro.categorizacao_incompleta ? `<div class="small text-warning" style="font-size: 0.7rem;">de R$ ${new Intl.NumberFormat('pt-BR', {minimumFractionDigits: 2}).format(registro.valor_total_original)}</div>` : ''}
              </td>
            `;
            tbody.appendChild(row);
          });
        }

        const tableContainer = document.getElementById('tabelaDetalhesContainer');
        tableContainer.style.display = 'block';
        tableContainer.style.visibility = 'visible';
      })
      .catch(error => {
        
        document.getElementById('loadingDetalhes').style.display = 'none';

        document.getElementById('mensagemErro').textContent = error.message;
        document.getElementById('erroDetalhes').style.display = 'block';

        console.error('Erro ao carregar detalhes:', error);
      });
  }
  
  function exportarDetalhesCategoriaExcel(isPdf = false) {
    if (!modalCategoriaId || !modalDataInicio || !modalDataFim || !modalTemDados) {
      alert('N√£o h√° dados para exportar.');
      return;
    }
    
    const tipo = isPdf ? 'pdf' : 'excel';
    const url = `/relatorios/relatorios-financeiros/dre-categoria-detalhes/${modalCategoriaId}/${tipo}?data_inicio=${modalDataInicio}&data_fim=${modalDataFim}`;
    
    window.open(url, '_blank');
  }
</script>

{% endblock conteudo %}