{% include 'relatorios/estrutura/style.html' %}
<div class="page-wrapper">
  <div class="page body">
    <div class="container">
      <div class="content">
        <div class="header no-break">
          <img src="{{logo_path}}" alt="Logo Jaquirana Extração" />
          <div class="system-info">
            <div><strong>Sistema de Gestão Jaquirana</strong></div>
            <div><strong>Versão</strong> {{changelog.versao}}</div>
            <div><strong>Data:</strong> {{changelog.data_lancamento}}</div>
          </div>
        </div>

        <h2>Relatório de Cargas Gerais por Clientes</h2>

        <!-- Filtros aplicados -->
        {% if dados_corretos %}
        <div class="dados-registro no-break">
          <div class="filtros-title">Filtros Aplicados</div>
          <div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Data Início:</strong></span>
                {{ dados_corretos.get('dataInicio', '') | converte_data_para_datetime_converte_data_brl if dados_corretos.get('dataInicio') else '-' }}
              </p>
            </div>
            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Data Fim:</strong></span>
                {{ dados_corretos.get('dataFim', '') | converte_data_para_datetime_converte_data_brl if dados_corretos.get('dataFim') else '-' }}
              </p>
            </div>
            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Cliente:</strong></span>
                {{ dados_corretos.get('clienteCarga', 'Todos') or 'Todos' }}
              </p>
            </div>
            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Produto:</strong></span>
                {{ dados_corretos.get('produtoFiltro', 'Todos') or 'Todos' }}
              </p>
            </div>
            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Bitola:</strong></span>
                {{ dados_corretos.get('bitolaFiltro', 'Todos') or 'Todos' }}
              </p>
            </div>
            <div style="flex: 1 1 48%; margin-bottom: 10px;">
              <p><span class="label"><strong>Fornecedor:</strong></span>
                {{ dados_corretos.get('fornecedorCargaCliente', 'Todos') or 'Todos' }}
              </p>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Tabela de registros -->
        {% if registros_agrupados %}
        {% for grupo_cliente in registros_agrupados %}
        <!-- Seção do Cliente -->
        <div class="section-title no-break">
          Cliente: {{ grupo_cliente.cliente }}
          <span style="float: right; font-weight: normal; font-size: 12px;">
            Total de cargas: {{ grupo_cliente.registros|length }}
          </span>
        </div>
          
        <table>
          <thead>
            <tr>
              <th class="text-center">Placa</th>
              <th class="text-center">Origem</th>
              <th class="text-center">Cliente</th>
              <th class="text-center">Produto/Bitola</th>
              <th class="text-center">NF</th>
              <th class="text-center">Peso Líquido</th>
              <th class="text-center">Peso NFe</th>
              <th class="text-center">Preço NFe</th>
              <th class="text-center">Total NFe</th>
              <th class="text-center">Valor Complementar</th>
              <th class="text-center">Peso Complementar</th>
            </tr>
          </thead>
          <tbody>
            {% for registro in grupo_cliente.registros %}
            <tr>
              <td class="text-center">{{ registro.placa }}</td>
              <td class="text-center">{{ registro.origem }}</td>
              <td class="text-center">{{ registro.cliente }}</td>
              <td class="text-center">{{ registro.produto_bitola }}</td>
              <td class="text-center">{{ registro.nf }}</td>
              <td class="text-center">{{ "%.2f"|format(registro.peso_liquido) }} Ton.</td>
              <td class="text-center">{{ "%.2f"|format(registro.peso_nfe) }}</td>
              <td class="text-center">{{ registro.preco_nfe | formatar_float_para_brl }}</td>
              <td class="text-center">{{ registro.total_nfe | formatar_float_para_brl }}</td>
              <td class="text-center">{{ registro.valor_complementar | formatar_float_para_brl }}</td>
              <td class="text-center">{{ "%.2f"|format(registro.peso_complementar) }} Ton.</td>
            </tr>
            {% endfor %}
            
            <!-- Linha de totais -->
            <tr style="background-color: #e7f0e7; font-weight: 600;">
              <td colspan="5" class="text-center"><strong>Total {{grupo_cliente.cliente}}</strong></td>
              <td class="text-center"><strong>{{ "%.2f"|format(grupo_cliente.totais.peso_liquido) }} Ton.</strong></td>
              <td class="text-center"><strong>{{ "%.2f"|format(grupo_cliente.totais.peso_nfe) }}</strong></td>
              <td class="text-center"></td>
              <td class="text-center"><strong>{{ grupo_cliente.totais.total_nfe | formatar_float_para_brl }}</strong></td>
              <td class="text-center"><strong>{{ grupo_cliente.totais.valor_complementar | formatar_float_para_brl }}</strong></td>
              <td class="text-center"><strong>{{ "%.2f"|format(grupo_cliente.totais.peso_complementar) }} Ton.</strong></td>
            </tr>
          </tbody>
        </table>
        {% endfor %}
        {% else %}
        <div style="text-align: center; padding: 50px 0;">
          <h3 style="color: #666;">Nenhum registro encontrado</h3>
          <p style="color: #999;">Não há registros disponíveis para os filtros selecionados.</p>
        </div>
        {% endif %}

        <div class="footer">
          <p><strong>Jaquirana Extração &copy; 2025</strong> - Todos os direitos reservados</p>
        </div>
      </div>
    </div>
  </div>
</div>
