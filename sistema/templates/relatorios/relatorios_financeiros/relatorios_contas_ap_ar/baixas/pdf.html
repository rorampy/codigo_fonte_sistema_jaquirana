<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>{{ titulo_relatorio }}</title>
  <style>
    @page {
      size: landscape;
      margin: 15mm;
    }
    
    body {
      font-family: Arial, sans-serif;
      font-size: 11px;
      margin: 20px;
      color: #333;
      line-height: 1.3;
    }

    .header {
      border-bottom: 2px solid #1c5f20;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .header table {
      width: 100%;
      border: none;
    }

    .header img {
      width: 100px;
    }

    .system-info {
      text-align: right;
      font-size: 10px;
      color: #666;
    }

    .relatorio-title {
      text-align: center;
      font-size: 16px;
      color: #1c5f20;
      font-weight: bold;
      margin: 15px 0;
      text-transform: uppercase;
    }

    .info-box {
      background-color: #f8f9fa;
      padding: 10px 15px;
      margin: 10px 0 20px 0;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      font-size: 10px;
    }

    .info-box strong {
      color: #1c5f20;
    }

    /* Tabela de Resumo Geral */
    .resumo-geral {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
    }

    .resumo-geral th {
      background-color: #1c5f20;
      color: white;
      padding: 8px;
      font-size: 11px;
    }

    .resumo-geral td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 11px;
    }

    .resumo-geral .valor-destaque {
      color: #1c5f20;
      font-weight: bold;
    }

    .resumo-geral .total-row td {
      background-color: #1c5f20 !important;
      color: white !important;
      font-weight: bold;
    }

    /* Tabela de Faturamento */
    .faturamento-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: 1px solid #1c5f20;
      page-break-inside: avoid;
    }

    .faturamento-header {
      background-color: #1c5f20;
      color: white;
    }

    .faturamento-header td {
      padding: 10px 12px;
      font-size: 12px;
      font-weight: bold;
      border: none;
    }

    .faturamento-header .badge {
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 10px;
      margin-left: 10px;
    }

    .badge-pago {
      background-color: #d4edda;
      color: #155724;
    }

    .badge-parcial {
      background-color: #fff3cd;
      color: #856404;
    }

    .faturamento-info {
      background-color: #e8f5e8;
    }

    .faturamento-info td {
      padding: 6px 10px;
      font-size: 10px;
      border: 1px solid #cde7cd;
      text-align: center;
    }

    .faturamento-info strong {
      color: #1c5f20;
    }

    .cargas-header th {
      background-color: #2e7d32;
      color: white;
      padding: 6px 8px;
      font-size: 10px;
      text-align: center;
      border: 1px solid #1c5f20;
    }

    .carga-row td {
      padding: 5px 8px;
      font-size: 10px;
      text-align: center;
      border: 1px solid #ddd;
    }

    .carga-row:nth-child(even) {
      background-color: #f8f9fa;
    }

    .carga-row .valor {
      color: #1c5f20;
      font-weight: bold;
    }

    .tipo-fornecedor { color: black;}
    .tipo-transportadora { color: black;}
    .tipo-extrator { color: black;}
    .tipo-comissionado { color: black;}

    .total-row td {
      background-color: #1c5f20 !important;
      color: white !important;
      padding: 8px 10px;
      font-size: 11px;
      font-weight: bold;
      border: none;
    }

    .total-row .valor-total {
      color: #90EE90 !important;
      font-size: 12px;
    }

    .lancamento-avulso td {
      background-color: #f8f9fa;
      padding: 15px;
      text-align: center;
      color: #666;
      font-style: italic;
      border: 1px dashed #ccc;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      font-size: 9px;
      color: #777;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }

    .no-border td, .no-border th {
      border: none !important;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <table class="no-border">
      <tr>
        <td style="width: 150px; border: none;">
          <img src="{{ logo_path }}" alt="Logo Jaquirana Extração" />
        </td>
        <td class="system-info" style="border: none;">
          <div><strong>Sistema de Gestão Jaquirana</strong></div>
          <div><strong>Relatório gerado em:</strong> {{ data_geracao }}</div>
        </td>
      </tr>
    </table>
  </div>

  <div class="relatorio-title">{{ titulo_relatorio }}</div>

  <!-- Filtros Aplicados -->
  {% if dados_corretos %}
  <div class="info-box">
    <strong>Período:</strong> {{ dados_corretos.get('dataInicio', '') | converte_data_para_datetime_converte_data_brl if dados_corretos.get('dataInicio') else 'Início' }}
    até {{ dados_corretos.get('dataFim', '') | converte_data_para_datetime_converte_data_brl if dados_corretos.get('dataFim') else 'Fim' }}
    &nbsp;&nbsp;|&nbsp;&nbsp;
    <strong>{{ label_entidade }}:</strong> {{ dados_corretos.get('pessoa_nome', 'Todos') }}
    &nbsp;&nbsp;|&nbsp;&nbsp;
    <strong>Situação:</strong> {{ dados_corretos.get('situacao_nome', 'Todas') }}
  </div>
  {% endif %}

  <!-- Resumo Geral -->
  <table class="resumo-geral">
    <thead>
      <tr>
        <th style="text-align: left; width: 70%;">Descrição</th>
        <th style="text-align: center; width: 30%;">Valor</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="text-align: left;">Total de Títulos</td>
        <td class="valor-destaque" style="text-align: center;">{{ totais.quantidade }}</td>
      </tr>
      <tr>
        <td style="text-align: left;">Valor Original Total</td>
        <td class="valor-destaque" style="text-align: center;">{{ totais.total_original_100 | formatar_float_para_brl }}</td>
      </tr>
      <tr class="total-row">
        <td style="text-align: left;">TOTAL {{ 'PAGO' if direcao == 'ap' else 'RECEBIDO' }}</td>
        <td style="text-align: center;">{{ totais.total_pago_100 | formatar_float_para_brl }}</td>
      </tr>
    </tbody>
  </table>

  <!-- Detalhamento por Faturamento -->
  {% if grupos %}
  
  {% for grupo in grupos %}
  <table class="faturamento-table">
    <!-- Linha Cabeçalho do Faturamento -->
    <tr class="faturamento-header">
      <td colspan="8">
        {{ grupo.codigo_faturamento }} - {{ grupo.pessoa_nome | truncate(50, True, '...') }}
        {% if grupo.tem_parcial %}
        <span class="badge badge-parcial">{{ 'Pago Parcialmente' if direcao == 'ap' else 'Recebido Parcialmente' }}</span>
        {% else %}
        <span class="badge badge-pago">{{ 'Pago' if direcao == 'ap' else 'Recebido' }}</span>
        {% endif %}
      </td>
    </tr>
    
    <!-- Linha Info do Faturamento -->
    <tr class="faturamento-info">
      <td colspan="2"><strong>Tipo:</strong> {{ grupo.tipo_operacao }}</td>
      <td><strong>Títulos:</strong> {{ grupo.qtd_agendamentos }}</td>
      <td colspan="2"><strong>Data {{ 'Pag' if direcao == 'ap' else 'Rec' }}:</strong> {{ grupo.data_pagamento_mais_recente | formatar_data_para_brl if grupo.data_pagamento_mais_recente else '-' }}</td>
      <td colspan="3"><strong>Data Fat:</strong> {{ grupo.data_faturamento | formatar_data_para_brl if grupo.data_faturamento else '-' }}</td>
    </tr>

    {% if grupo.detalhes_cargas %}
    {% set detalhes = grupo.detalhes_cargas %}
    {% set total_cargas = (detalhes.fornecedores|length if detalhes.fornecedores else 0) + (detalhes.transportadoras|length if detalhes.transportadoras else 0) + (detalhes.extratores|length if detalhes.extratores else 0) + (detalhes.comissionados|length if detalhes.comissionados else 0) + (detalhes.cargas_a_receber|length if detalhes.cargas_a_receber else 0) %}
    
    {% if total_cargas > 0 %}
    <!-- Cabeçalho das Cargas -->
    <tr class="cargas-header">
      <th>Data</th>
      <th>Tipo</th>
      <th>Entidade</th>
      <th>Cliente</th>
      <th>Produto/Bitola</th>
      <th>NF</th>
      <th>Peso</th>
      <th>Valor</th>
    </tr>

    <!-- Fornecedores -->
    {% for f in detalhes.fornecedores %}
    <tr class="carga-row">
      <td>{{ f.data_entrega or '-' }}</td>
      <td class="tipo-fornecedor"><strong>Fornecedor</strong></td>
      <td style="text-align: left;">{{ f.fornecedor_identificacao | truncate(25, True, '...') or '-' }}</td>
      <td>{{ f.cliente | truncate(15, True, '...') or '-' }}</td>
      <td>{{ f.produto or '-' }} | {{ f.bitola or '-' }}</td>
      <td>{{ f.nota_fiscal or '-' }}</td>
      <td>{{ f.peso_ticket or '-' }}</td>
      <td class="valor">{{ f.valor_faturado | formatar_float_para_brl or '-' }}</td>
    </tr>
    {% endfor %}

    <!-- Transportadoras -->
    {% for t in detalhes.transportadoras %}
    <tr class="carga-row">
      <td>{{ t.data_entrega or '-' }}</td>
      <td class="tipo-transportadora"><strong>Transp.</strong></td>
      <td style="text-align: left;">{{ (t.transportadora_identificacao or t.nome) | truncate(25, True, '...') or '-' }}</td>
      <td>{{ t.cliente | truncate(15, True, '...') or '-' }}</td>
      <td>{{ t.produto or '-' }} | {{ t.bitola or '-' }}</td>
      <td>{{ t.nota_fiscal or '-' }}</td>
      <td>{{ t.peso_ticket or '-' }}</td>
      <td class="valor">{{ t.valor_faturado | formatar_float_para_brl or '-' }}</td>
    </tr>
    {% endfor %}

    <!-- Extratores -->
    {% for e in detalhes.extratores %}
    <tr class="carga-row">
      <td>{{ e.data_entrega or '-' }}</td>
      <td class="tipo-extrator"><strong>Extrator</strong></td>
      <td style="text-align: left;">{{ e.extrator_identificacao | truncate(25, True, '...') or '-' }}</td>
      <td>{{ e.cliente | truncate(15, True, '...') or '-' }}</td>
      <td>{{ e.produto or '-' }} | {{ e.bitola or '-' }}</td>
      <td>{{ e.nota_fiscal or '-' }}</td>
      <td>{{ e.peso_ticket or '-' }}</td>
      <td class="valor">{{ e.valor_faturado | formatar_float_para_brl or '-' }}</td>
    </tr>
    {% endfor %}

    <!-- Comissionados -->
    {% for c in detalhes.comissionados %}
    <tr class="carga-row">
      <td>{{ c.data_entrega or '-' }}</td>
      <td class="tipo-comissionado"><strong>Comiss.</strong></td>
      <td style="text-align: left;">{{ c.comissionado_identificacao | truncate(25, True, '...') or '-' }}</td>
      <td>{{ c.cliente | truncate(15, True, '...') or '-' }}</td>
      <td>{{ c.produto or '-' }} | {{ c.bitola or '-' }}</td>
      <td>{{ c.nota_fiscal or '-' }}</td>
      <td>{{ c.peso_ticket or '-' }}</td>
      <td class="valor">{{ c.valor_faturado | formatar_float_para_brl or '-' }}</td>
    </tr>
    {% endfor %}

    <!-- Cargas a Receber (Clientes) -->
    {% for car in detalhes.cargas_a_receber %}
    <tr class="carga-row">
      <td>{{ car.data_entrega or '-' }}</td>
      <td class="tipo-fornecedor"><strong>Cliente</strong></td>
      <td style="text-align: left;">{{ car.cliente | truncate(25, True, '...') or '-' }}</td>
      <td>-</td>
      <td>{{ car.produto or '-' }} | {{ car.bitola or '-' }}</td>
      <td>{{ car.nota_fiscal or '-' }}</td>
      <td>{{ car.peso_ticket or '-' }}</td>
      <td class="valor">{{ car.valor_faturado | formatar_float_para_brl or '-' }}</td>
    </tr>
    {% endfor %}
    {% endif %}
    {% endif %}

    {% if grupo.lancamento_descricao and not grupo.detalhes_cargas %}
    <tr class="lancamento-avulso">
      <td colspan="8"><strong>Lançamento Avulso:</strong> {{ grupo.lancamento_descricao }}</td>
    </tr>
    {% endif %}

    <!-- Linha de Total {{ 'Pago' if direcao == 'ap' else 'Recebido' }} -->
    <tr class="total-row">
      <td colspan="6" style="text-align: left;">TOTAL {{ 'PAGO' if direcao == 'ap' else 'RECEBIDO' }}</td>
      <td colspan="2" class="valor-total" style="text-align: right;">{{ grupo.total_pago_100 | formatar_float_para_brl }}</td>
    </tr>
  </table>
  {% endfor %}

  {% elif registros %}
  <!-- Fallback quando não há grupos -->
  <table class="faturamento-table">
    <tr class="cargas-header">
      <th>Código</th>
      <th>{{ label_entidade }}</th>
      <th>Descrição</th>
      <th>Vencimento</th>
      <th>{{ 'Pagamento' if direcao == 'ap' else 'Recebimento' }}</th>
      <th>Valor Original</th>
      <th>Valor {{ 'Pago' if direcao == 'ap' else 'Recebido' }}</th>
      <th>Situação</th>
    </tr>
    {% for item in registros %}
    <tr class="carga-row">
      <td>{{ item.codigo_faturamento }}</td>
      <td style="text-align: left;">{{ item.pessoa_nome | truncate(30, True, '...') }}</td>
      <td>{{ item.descricao | truncate(20, True, '...') }}</td>
      <td>{{ item.data_vencimento | formatar_data_para_brl if item.data_vencimento else '-' }}</td>
      <td>{{ item.data_pagamento | formatar_data_para_brl if item.data_pagamento else '-' }}</td>
      <td class="valor">{{ item.valor_original_100 | formatar_float_para_brl }}</td>
      <td style="color: #2b8a3e; font-weight: bold;">{{ item.valor_pago_100 | formatar_float_para_brl }}</td>
      <td>{{ item.situacao }}</td>
    </tr>
    {% endfor %}
    <tr class="total-row">
      <td colspan="6" style="text-align: left;">TOTAL {{ 'PAGO' if direcao == 'ap' else 'RECEBIDO' }}</td>
      <td colspan="2" class="valor-total" style="text-align: right;">{{ totais.total_pago_100 | formatar_float_para_brl }}</td>
    </tr>
  </table>

  {% else %}
  <div style="text-align: center; padding: 50px 0;">
    <h3 style="color: #666;">Nenhum registro encontrado</h3>
    <p style="color: #999;">Não há pagamentos para os filtros selecionados.</p>
  </div>
  {% endif %}

  <!-- Footer -->
  <div class="footer">
    <p><strong>Jaquirana Extração &copy; 2025</strong> - Todos os direitos reservados</p>
    <p><strong>Sistema de Gestão Jaquirana</strong></p>
  </div>
</body>

</html>
