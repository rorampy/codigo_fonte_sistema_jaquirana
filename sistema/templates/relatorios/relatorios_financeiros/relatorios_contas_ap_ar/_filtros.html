{# 
  Include reutilizável: modal de filtros para relatórios AP/AR.
  Variáveis esperadas:
    - url_filtro       : url_for do endpoint de listagem (GET)
    - dados_corretos   : request.args ou request.form
    - pessoas          : lista de PessoaFinanceiroModel
    - planos_contas    : lista de PlanoContaModel
    - centros_custo    : lista de CentroCustoModel
    - situacoes        : lista de SituacaoPagamentoModel
    - label_entidade   : "Fornecedor" ou "Cliente"
    - tipo_relatorio   : "emissoes", "baixas" ou "pendentes"
    - direcao          : "ap" ou "ar"
#}

{% set is_pendentes  = (tipo_relatorio == 'pendentes') %}
{% set ar_pendentes  = (direcao == 'ar' and tipo_relatorio == 'pendentes') %}

<div class="modal modal-blur fade" id="modal-report" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <form action="{{ url_filtro }}" method="GET">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Filtrar Relatório</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">

            {# --- Período --- #}
            <div class="col-md-6">
              <label class="form-label">Data Início</label>
              <input type="date" name="dataInicio" class="form-control"
                value="{{ dados_corretos.get('dataInicio', '') }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Data Fim</label>
              <input type="date" name="dataFim" class="form-control"
                value="{{ dados_corretos.get('dataFim', '') }}">
            </div>

            {# --- Pessoa (Fornecedor / Cliente) --- #}
            <div class="col-md-6">
              <label class="form-label">{{ label_entidade }}</label>
              <select id="filtro-pessoa" name="pessoaId" class="form-select">
                <option value="">Todos</option>
                {% for p in pessoas %}
                <option value="{{ p.id }}" {% if dados_corretos.get('pessoaId') == p.id|string %}selected{% endif %}>
                  {{ p.identificacao | truncate(50, True, '...') }}
                </option>
                {% endfor %}
              </select>
            </div>

            {# --- Situação --- #}
            <div class="col-md-6">
              <label class="form-label">Situação</label>
              <select id="filtro-situacao" name="situacaoId" class="form-select">
                <option value="">Todas</option>
                {% for s in situacoes %}
                <option value="{{ s.id }}" {% if dados_corretos.get('situacaoId') == s.id|string %}selected{% endif %}>
                  {{ s.situacao }}
                </option>
                {% endfor %}
              </select>
            </div>

            {# --- Código Faturamento --- #}
            <div class="col-md-4">
              <label class="form-label">Código Faturamento</label>
              <input type="text" name="codigoFaturamento" class="form-control" 
                     placeholder="Ex: FAT-001234"
                     value="{{ dados_corretos.get('codigoFaturamento', '') }}">
            </div>

            {# --- Nota Fiscal --- #}
            <div class="col-md-4">
              <label class="form-label">Nota Fiscal</label>
              <input type="text" name="notaFiscal" class="form-control" 
                     placeholder="Ex: 123456"
                     value="{{ dados_corretos.get('notaFiscal', '') }}">
            </div>

            {# --- Descrição (Lançamento Avulso) --- #}
            <div class="col-md-4">
              <label class="form-label">Descrição Avulso</label>
              <input type="text" name="descricaoAvulso" class="form-control" 
                     placeholder="Buscar descrição..."
                     value="{{ dados_corretos.get('descricaoAvulso', '') }}">
            </div>

            {# --- Plano de Contas --- #}
            {% if not ar_pendentes %}
            <div class="col-md-6">
              <label class="form-label">Plano de Contas</label>
              <select id="filtro-plano-contas" name="planoContasId" class="form-select">
                <option value="">Todos</option>
                {% for pc in planos_contas %}
                <option value="{{ pc.id }}" {% if dados_corretos.get('planoContasId') == pc.id|string %}selected{% endif %}>
                  {{ pc.codigo }} - {{ pc.nome | truncate(40, True, '...') }}
                </option>
                {% endfor %}
              </select>
            </div>
            {% endif %}

            {# --- Centro de Custo --- #}
            {% if not is_pendentes %}
            <div class="col-md-6">
              <label class="form-label">Centro de Custo</label>
              <select id="filtro-centro-custo" name="centroCustoId" class="form-select">
                <option value="">Todos</option>
                {% for cc in centros_custo %}
                <option value="{{ cc.id }}" {% if dados_corretos.get('centroCustoId') == cc.id|string %}selected{% endif %}>
                  {{ cc.nome }}
                </option>
                {% endfor %}
              </select>
            </div>
            {% endif %}

          </div>
        </div>

        <div class="modal-footer">
          <a href="{{ url_filtro }}" class="btn btn-link link-secondary">
            Limpar Filtros
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
            </svg>
            Filtrar
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{# --- Tom Select nos selects do modal de filtros --- #}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var tomSelectConfig = {
      create: false,
      allowEmptyOption: true,
      sortField: { field: "text", direction: "asc" }
    };

    var selectIds = [
      'filtro-pessoa',
      'filtro-plano-contas',
      'filtro-centro-custo',
      'filtro-situacao'
    ];

    selectIds.forEach(function (id) {
      var el = document.getElementById(id);
      if (el) {
        new TomSelect(el, tomSelectConfig);
      }
    });
  });
</script>
