{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}
<div class="page-wrapper">
  <!-- Page header -->
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Page pre-title -->
          <div class="page-pretitle">
            TICKET
          </div>
          <h2 class="page-title">
            Editar
          </h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Page body -->
  <div class="page-body">
    <div class="container-xl">

      {% include 'estrutura/mensagens_flash.html' %}

      {% if solicitacao %}
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card border border-primary shadow-sm">
            <div class="card-body">
              <h3 class="card-title mb-3 text-primary">Informações da
                Solicitação</h3>
              <div class="row">
                <div class="col-sm-12 col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Cliente</label>
                    <input type="text" class="form-control" value="{{ solicitacao.cliente.identificacao }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Produto</label>
                    <input type="text" class="form-control" value="{{ solicitacao.produto.nome }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Bitola</label>
                    <input type="text" class="form-control" value="{{ solicitacao.bitola.bitola }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Número NF</label>
                    <input type="text" class="form-control" value="{{ dados_nf.numero_nota_fiscal if dados_nf else '' }}"
                      disabled>
                  </div>
                </div>
              </div>
              <h3 class="card-title mb-3 text-primary">Informações da
                transportadora</h3>
              <div class="row">
                <div class="col-sm-12 col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Transportadora</label>
                    <input type="text" class="form-control"
                      value="{{ solicitacao.transportadora.identificacao }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">{%if
                      solicitacao.transportadora.numero_documento |
                      length == 11%}CPF{%else%}CNPJ{%endif%}</label>
                    <input type="text" class="form-control cpfCnpj"
                      value="{{ solicitacao.transportadora.numero_documento }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Telefone</label>
                    <input type="text"
                      class="form-control {% if solicitacao.transportadora.telefone | length == 11%} celular {%else%}telefone{%endif%}"
                      value="{{ solicitacao.transportadora.telefone }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Motorista</label>
                    <input type="text" class="form-control"
                      value="{{ solicitacao.motorista.nome_completo | truncate(15, true, '...') }}" disabled>
                  </div>
                </div>

                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Placa</label>
                    <input type="text" class="form-control" value="{{ solicitacao.veiculo.placa_veiculo }}" disabled>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="col-12">
        <form class="card" id="formTicket" action="{{ url_for('editar_ticket', id=pedido_venda.id) }}" method="POST"
          enctype="multipart/form-data">
          <!-- Campo hidden para enviar dados dos fornecedores -->
          <input type="hidden" name="fornecedoresData" id="fornecedoresData">
          <div class="card-body">
            <!-- Seção de Distribuição de Peso por Fornecedor -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border border-info">
                  <div class="card-header bg-info-lt">
                    <h3 class="card-title">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon me-2">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" />
                        <path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z" />
                        <path d="M9 12h6" />
                        <path d="M9 16h6" />
                      </svg>
                      Distribuição de Peso por Fornecedor/Floresta
                    </h3>
                  </div>
                  <div class="card-body">
                    <!-- Indicador de Peso -->
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <div class="alert alert-info mb-0 {% if 'pesoDistribuicao' in campos_erros %}border-danger{% endif %}">
                          <div class="row align-items-center">
                            <div class="col-md-3">
                              <strong>Peso Total:</strong> <span id="pesoTotalDisplay">0.00</span> Ton.
                            </div>
                            <div class="col-md-3">
                              <strong>Distribuído:</strong> <span id="pesoDistribuidoDisplay">0.00</span> Ton.
                            </div>
                            <div class="col-md-3">
                              <strong>Restante:</strong> <span id="pesoRestanteDisplay" class="text-primary">0.00</span>
                              Ton.
                            </div>
                            <div class="col-md-3">
                              <div class="progress">
                                <div id="progressBarDistribuicao" class="progress-bar bg-primary" role="progressbar"
                                  style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                              </div>
                            </div>
                          </div>
                          {% if 'pesoDistribuicao' in campos_erros %}
                          <div class="text-danger mt-2">
                            <small><strong>{{ campos_erros['pesoDistribuicao'] }}</strong></small>
                          </div>
                          {% endif %}
                          {% if 'fornecedores' in campos_erros %}
                          <div class="text-danger mt-2">
                            <small><strong>{{ campos_erros['fornecedores'] }}</strong></small>
                          </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>

                    <!-- Container dos Fornecedores -->
                    <div id="fornecedoresContainer">
                      <!-- Fornecedores serão adicionados aqui dinamicamente -->
                    </div>

                    <!-- Botão Adicionar Fornecedor -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <button type="button" id="btnAdicionarFornecedor" class="btn btn-primary">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M12 5l0 14" />
                            <path d="M5 12l14 0" />
                          </svg>
                          Adicionar Fornecedor/Floresta
                        </button>
                      </div>
                    </div>

                    <!-- Template de Fornecedor (escondido) -->
                    <div id="fornecedorTemplate" style="display: none;">
                      <div class="fornecedor-item border border-secondary rounded p-3 mb-3">
                        <div class="row align-items-end">
                          <div class="col-sm-12 col-md-5">
                            <div class="mb-3 mb-md-0">
                              <label class="form-label required">Fornecedor/Floresta</label>
                              <select class="form-select fornecedor-select" name="fornecedores[]">
                                <option value="">Selecione...</option>
                                <option value="0">NÃO IDENTIFICADA</option>
                                {% for f in fornecedores %}
                                <option value="{{f.id}}">{{f.identificacao}}</option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>
                          <div class="col-sm-12 col-md-4">
                            <div class="mb-3 mb-md-0">
                              <label class="form-label required">Peso Distribuído (Ton.)</label>
                              <input type="text" class="form-control campo-float peso-fornecedor"
                                name="pesosFornecedores[]" placeholder="0.00">
                            </div>
                          </div>
                          <div class="col-sm-12 col-md-3">
                            <div class="mb-3 mb-md-0">
                              <button type="button" class="btn btn-danger w-100 btn-remover-fornecedor">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round" class="icon">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <path d="M4 7l16 0" />
                                  <path d="M10 11l0 6" />
                                  <path d="M14 11l0 6" />
                                  <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                                  <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                                </svg>
                                Remover
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Dados Gerais do Ticket -->
            <div class="row">
              <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <label class="form-label required">Número NF Ticket</label>
                  <input type="text" name="numeroNf" id="numeroNf" value="{{ dados_corretos['numeroNf'] }}"
                    class="form-control {% if 'numeroNf' in campos_obrigatorios %}is-invalid{% endif %}">
                  <div class="invalid-feedback">
                    {% if 'numeroNf' in
                    campos_obrigatorios
                    %}
                    {{ campos_obrigatorios['numeroNf'] }}
                    {% elif 'numeroNf' in campos_erros %}
                    {{ campos_erros['numeroNf'] }}
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-sm-2 col-md-3">
                <div class="mb-3">
                  <label class="form-label required">Peso Total do Ticket (Ton.)</label>
                  <input type="text" name="pesoLiquido" id="pesoLiquido" value="{{ dados_corretos['pesoLiquido'] }}"
                    class="form-control campo-float {% if 'pesoLiquido' in campos_obrigatorios %}is-invalid{% endif %}">
                  <div class="invalid-feedback">
                    {% if 'pesoLiquido' in
                    campos_obrigatorios
                    %}
                    {{ campos_obrigatorios['pesoLiquido'] }}
                    {% elif 'pesoLiquido' in campos_erros %}
                    {{ campos_erros['pesoLiquido'] }}
                    {% endif %}
                  </div>
                  <p class="mb-0 text-warning" style="font-size: 0.8125rem;">
                    <strong>Importante:</strong> Este peso será distribuído entre os fornecedores.
                  </p>
                </div>
              </div>
              <div class="col-sm-3 col-md-3">
                <div class="mb-3">
                  <label class="form-label required">Placa</label>
                  <input type="text" name="placaVeiculo" value="{{ dados_corretos['placaVeiculo'] or solicitacao.veiculo.placa_veiculo }}"
                    class="form-control {% if 'placaVeiculo' in campos_obrigatorios %}is-invalid{% endif %}">
                  <div class="invalid-feedback">
                    {% if 'placaVeiculo' in
                    campos_obrigatorios
                    %}
                    {{ campos_obrigatorios['placaVeiculo'] }}
                    {% elif 'placaVeiculo' in campos_erros %}
                    {{ campos_erros['placaVeiculo'] }}
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-sm-3 col-md-2">
                <div class="mb-3">
                  <label class="form-label required">Motorista</label>
                  <input type="text" name="motoristaTicket" value="{{ dados_corretos['motoristaTicket'] or solicitacao.motorista.nome_completo }}"
                    class="form-control {% if 'motoristaTicket' in campos_obrigatorios %}is-invalid{% endif %}">
                  <div class="invalid-feedback">
                    {% if 'motoristaTicket' in
                    campos_obrigatorios
                    %}
                    {{ campos_obrigatorios['motoristaTicket'] }}
                    {% elif 'motoristaTicket' in campos_erros %}
                    {{ campos_erros['motoristaTicket'] }}
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <label class="form-label required">Data entrega</label>
                  <input type="date" name="dataEntregaTicket" value="{{ dados_corretos['dataEntregaTicket'] }}"
                    class="form-control {% if 'dataEntregaTicket' in campos_obrigatorios %}is-invalid{% endif %}">
                  <div class="invalid-feedback">
                    {% if 'dataEntregaTicket' in
                    campos_obrigatorios
                    %}
                    {{ campos_obrigatorios['dataEntregaTicket'] }}
                    {% elif 'dataEntregaTicket' in campos_erros %}
                    {{ campos_erros['dataEntregaTicket'] }}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-12 col-md-6">
                <div class="mb-3">
                  {% if dados_ticket_existentes and dados_ticket_existentes[0].arquivo_ticket_id %}
                  <!-- Ticket já possui arquivo - opção de manter ou alterar -->
                  <label class="form-label">Arquivo Ticket</label>
                  <div class="d-flex gap-4 mb-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio"
                        name="opcaoTicket"
                        value="manter"
                        id="opcaoTicketManterTicket" checked>
                      <label class="form-check-label"
                        for="opcaoTicketManterTicket">
                        Manter atual
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio"
                        name="opcaoTicket"
                        value="alterar"
                        id="opcaoTicketAlterarTicket">
                      <label class="form-check-label"
                        for="opcaoTicketAlterarTicket">
                        Enviar novo
                      </label>
                    </div>
                  </div>

                  <!-- Botão Visualizar -->
                  <a href="#" id="visualizar-ticket"
                    class="btn btn-visualizar-arquivo mb-3"
                    data-url="{{ url_for('diretorio_uploads_tickets', filename=dados_ticket_existentes[0].arquivo_ticket.caminho.split('/')[-1]) }}"
                    data-bs-toggle="modal"
                    data-bs-target="#modal-visualizar-arquivo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24"
                      height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-tabler icons-tabler-outline icon-tabler-receipt">
                      <path stroke="none" d="M0 0h24v24H0z"
                        fill="none"></path>
                      <path
                        d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16l-3 -2l-2 2l-2 -2l-2 2l-2 -2l-3 2m4 -14h6m-6 4h6m-2 4h2"></path>
                    </svg>
                    Visualizar Ticket Atual
                  </a>

                  <!-- Input de upload (oculto inicialmente) -->
                  <div id="inputUploadTicket" class="d-none">
                    <input type="file" name="arquivoTicket"
                      class="form-control {% if 'arquivoTicket' in campos_obrigatorios or 'arquivoTicket' in campos_erros %}is-invalid{% endif %}" 
                      accept=".jpg, .jpeg, .png">
                    <div class="invalid-feedback">
                      {% if 'arquivoTicket' in campos_obrigatorios %}
                      {{ campos_obrigatorios['arquivoTicket'] }}
                      {% elif 'arquivoTicket' in campos_erros %}
                      {{ campos_erros['arquivoTicket'] }}
                      {% endif %}
                    </div>
                  </div>
                  {% else %}
                  <!-- Ticket não possui arquivo - input normal -->
                  <label class="form-label">
                    Arquivo Ticket (JPG, JPEG ou PNG) - Opcional
                  </label>
                  <input type="file" name="arquivoTicket"
                    class="form-control {% if 'arquivoTicket' in campos_obrigatorios %}is-invalid{% endif %}"
                    accept=".jpg, .jpeg, .png">
                  <div class="invalid-feedback">
                    {% if 'arquivoTicket' in campos_obrigatorios %}
                    {{ campos_obrigatorios['arquivoTicket'] }}
                    {% elif 'arquivoTicket' in campos_erros %}
                    {{ campos_erros['arquivoTicket'] }}
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer text-center text-md-end">
            <a href="javascript:history.back()" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="24"
                height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M5 12l14 0"></path>
                <path d="M5 12l6 6"></path>
                <path d="M5 12l6 -6"></path>
              </svg>
              Voltar
            </a>
            <button type="submit" class="btn btn-success">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-device-floppy" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"></path>
                <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                <path d="M14 4l0 4l-6 0l0 -4"></path>
              </svg>
              Salvar Alterações
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Dados dos fornecedores existentes para preencher o formulário
  var fornecedoresExistentes = {{ fornecedores_ticket | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/pages/ticket-fornecedores.js') }}"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {    
    // === Alternância de manter/alterar ticket ===
    const radioManterTicket = document.getElementById("opcaoTicketManterTicket");
    const radioAlterarTicket = document.getElementById("opcaoTicketAlterarTicket");
    const inputUploadTicket = document.getElementById("inputUploadTicket");
    const linkVisualizarTicket = document.getElementById("visualizar-ticket");

    if (radioManterTicket && radioAlterarTicket && inputUploadTicket && linkVisualizarTicket) {
      function atualizarUploadTicket() {
        if (radioAlterarTicket.checked) {
          inputUploadTicket.classList.remove("d-none");
          linkVisualizarTicket.classList.add("d-none");
        } else {
          inputUploadTicket.classList.add("d-none");
          linkVisualizarTicket.classList.remove("d-none");
        }
      }

      radioManterTicket.addEventListener("change", atualizarUploadTicket);
      radioAlterarTicket.addEventListener("change", atualizarUploadTicket);

      atualizarUploadTicket();
    }

    // === Carregar fornecedores existentes ===
    if (typeof fornecedoresExistentes !== 'undefined' && fornecedoresExistentes.length > 0) {
      const container = document.getElementById('fornecedoresContainer');
      const template = document.getElementById('fornecedorTemplate');
      
      // Aguardar um pouco para garantir que o GerenciadorFornecedoresTicket foi inicializado
      setTimeout(function() {
        fornecedoresExistentes.forEach(function(fornecedor, index) {
          const clone = template.querySelector('.fornecedor-item').cloneNode(true);
          const fornecedorId = `fornecedor-edit-${index + 1}`;
          clone.setAttribute('data-fornecedor-id', fornecedorId);
          
          // Definir valor do select
          const select = clone.querySelector('.fornecedor-select');
          if (select) {
            select.value = fornecedor.fornecedor_id || '';
            select.setAttribute('required', 'required');
            
            // Inicializar TomSelect se disponível
            if (typeof TomSelect !== 'undefined') {
              try {
                new TomSelect(select, {
                  create: false,
                  allowEmptyOption: false,
                  sortField: { field: "text", direction: "asc" },
                  placeholder: "Selecione um fornecedor..."
                });
              } catch (e) {
                console.warn('Erro ao inicializar TomSelect:', e);
              }
            }
          }
          
          // Definir valor do peso
          const pesoInput = clone.querySelector('.peso-fornecedor');
          if (pesoInput) {
            pesoInput.value = fornecedor.peso ? fornecedor.peso.toFixed(2) : '';
            pesoInput.setAttribute('required', 'required');
          }
          
          // Configurar botão remover
          const btnRemover = clone.querySelector('.btn-remover-fornecedor');
          if (btnRemover) {
            btnRemover.addEventListener('click', function() {
              if (container.querySelectorAll('.fornecedor-item').length > 1) {
                clone.remove();
                atualizarPesoDisplayEdit();
                atualizarBotoesRemoverEdit();
              }
            });
          }
          
          container.appendChild(clone);
        });
        
        // Atualizar displays
        atualizarPesoDisplayEdit();
        atualizarBotoesRemoverEdit();
        
        // Configurar evento no peso total
        const pesoLiquido = document.getElementById('pesoLiquido');
        if (pesoLiquido) {
          pesoLiquido.addEventListener('input', atualizarPesoDisplayEdit);
          pesoLiquido.addEventListener('blur', atualizarPesoDisplayEdit);
        }
        
        // Configurar eventos nos inputs de peso existentes
        container.querySelectorAll('.peso-fornecedor').forEach(function(input) {
          input.addEventListener('input', atualizarPesoDisplayEdit);
          input.addEventListener('blur', atualizarPesoDisplayEdit);
        });
        
      }, 100);
    }
  });
  
  // Função para atualizar os botões de remover
  function atualizarBotoesRemoverEdit() {
    const container = document.getElementById('fornecedoresContainer');
    const fornecedoresElements = container.querySelectorAll('.fornecedor-item');
    const temApenasUm = fornecedoresElements.length === 1;

    fornecedoresElements.forEach(function(elemento) {
      const btnRemover = elemento.querySelector('.btn-remover-fornecedor');
      if (btnRemover) {
        btnRemover.disabled = temApenasUm;
        if (temApenasUm) {
          btnRemover.classList.add('disabled');
        } else {
          btnRemover.classList.remove('disabled');
        }
      }
    });
  }
  
  // Função para atualizar o display de pesos (modo edição)
  function atualizarPesoDisplayEdit() {
    const pesoLiquido = document.getElementById('pesoLiquido');
    const pesoTotalDisplay = document.getElementById('pesoTotalDisplay');
    const pesoDistribuidoDisplay = document.getElementById('pesoDistribuidoDisplay');
    const pesoRestanteDisplay = document.getElementById('pesoRestanteDisplay');
    const progressBar = document.getElementById('progressBarDistribuicao');
    const container = document.getElementById('fornecedoresContainer');
    
    const pesoTotal = parseFloat(pesoLiquido.value) || 0;
    let pesoDistribuido = 0;
    
    container.querySelectorAll('.peso-fornecedor').forEach(function(input) {
      pesoDistribuido += parseFloat(input.value) || 0;
    });
    
    const pesoRestante = pesoTotal - pesoDistribuido;
    const percentual = pesoTotal > 0 ? Math.min((pesoDistribuido / pesoTotal) * 100, 100) : 0;
    
    if (pesoTotalDisplay) pesoTotalDisplay.textContent = pesoTotal.toFixed(2);
    if (pesoDistribuidoDisplay) pesoDistribuidoDisplay.textContent = pesoDistribuido.toFixed(2);
    if (pesoRestanteDisplay) {
      pesoRestanteDisplay.textContent = pesoRestante.toFixed(2);
      if (Math.abs(pesoRestante) < 0.01) {
        pesoRestanteDisplay.className = 'text-success';
      } else if (pesoRestante < 0) {
        pesoRestanteDisplay.className = 'text-danger';
      } else {
        pesoRestanteDisplay.className = 'text-primary';
      }
    }
    
    if (progressBar) {
      progressBar.style.width = percentual + '%';
      progressBar.textContent = Math.round(percentual) + '%';
      progressBar.setAttribute('aria-valuenow', percentual);
      
      if (Math.abs(pesoRestante) < 0.01) {
        progressBar.className = 'progress-bar bg-success';
      } else if (pesoRestante < 0) {
        progressBar.className = 'progress-bar bg-danger';
      } else {
        progressBar.className = 'progress-bar bg-primary';
      }
    }
  }
  
  // Expor função globalmente para o GerenciadorFornecedoresTicket
  window.atualizarPesoDisplay = atualizarPesoDisplayEdit;
</script>

<!-- Modal de Aviso/Erro -->
<div class="modal modal-blur fade" id="modal-aviso" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-warning"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon mb-2 text-warning icon-lg">
          <path d="M12 9v4" />
          <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
          <path d="M12 16h.01" />
        </svg>
        <h3 id="modal-aviso-titulo">Atenção</h3>
        <div class="text-secondary" id="modal-aviso-mensagem"></div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <button type="button" class="btn btn-warning w-100" data-bs-dismiss="modal">
            Entendi
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal modal-blur fade" id="modal-confirmacao" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-primary"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon mb-2 text-primary icon-lg">
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M12 8v4" />
          <path d="M12 16h.01" />
        </svg>
        <h3 id="modal-confirmacao-titulo">Confirmação</h3>
        <div class="text-secondary" id="modal-confirmacao-mensagem"></div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <button type="button" class="btn w-100" data-bs-dismiss="modal" id="btn-confirmacao-cancelar">
                Cancelar
              </button>
            </div>
            <div class="col">
              <button type="button" class="btn btn-primary w-100" id="btn-confirmacao-confirmar">
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'estrutura/footer.html' %}

</div>

{% endblock conteudo %}
