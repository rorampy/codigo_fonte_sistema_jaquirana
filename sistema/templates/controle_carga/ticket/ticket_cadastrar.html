{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}
<div class="page-wrapper">
  <!-- Page header -->
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Page pre-title -->
          <div class="page-pretitle">
            TICKET
          </div>
          <h2 class="page-title">
            Cadastrar
          </h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Page body -->
  <div class="page-body">
    <div class="container-xl">

      {% include 'estrutura/mensagens_flash.html' %}

      {% if solicitacao %}
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card border border-primary shadow-sm">
            <div class="card-body">
              <h3 class="card-title mb-3 text-primary">Informações da
                Solicitação</h3>
              <div class="row">
                <div class="col-sm-12 col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Cliente</label>
                    <input type="text" class="form-control" value="{{ solicitacao.cliente.identificacao }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Produto</label>
                    <input type="text" class="form-control" value="{{ solicitacao.produto.nome }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Bitola</label>
                    <input type="text" class="form-control" value="{{ solicitacao.bitola.bitola }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Número NF</label>
                    <input type="text" class="form-control" value="{{ registroOperacional.numero_nota_fiscal }}"
                      disabled>
                  </div>
                </div>
              </div>
              <h3 class="card-title mb-3 text-primary">Informações da
                transportadora</h3>
              <div class="row">
                <div class="col-sm-12 col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Transportadora</label>
                    <input type="text" class="form-control"
                      value="{{ solicitacao.transportadora_exibicao.identificacao }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">{%if
                      solicitacao.transportadora_exibicao.numero_documento |
                      length == 11%}CPF{%else%}CNPJ{%endif%}</label>
                    <input type="text" class="form-control cpfCnpj"
                      value="{{ solicitacao.transportadora_exibicao.numero_documento }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Telefone</label>
                    <input type="text"
                      class="form-control {% if solicitacao.transportadora_exibicao.telefone | length == 11%} celular {%else%}telefone{%endif%}"
                      value="{{ solicitacao.transportadora_exibicao.telefone }}" disabled>
                  </div>
                </div>
                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Motorista</label>
                    <input type="text" class="form-control"
                      value="{{ solicitacao.motorista.nome_completo | truncate(15, true, '...') }}" disabled>
                  </div>
                </div>

                <div class="col-sm-12 col-md-2">
                  <div class="mb-3">
                    <label class="form-label">Placa</label>
                    <input type="text" class="form-control" value="{{ solicitacao.veiculo.placa_veiculo }}" disabled>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Card principal do formulário -->
      <div class="col-12">
        <form class="card" id="formTicket" action="{{ url_for('cadastrar_ticket', id=solicitacao.id) }}" method="POST"
          enctype="multipart/form-data">
          <div class="card-body">

            <!-- Área de Upload (exibida primeiro se não há imagem) -->
            <div id="areaUploadInicial" class="text-center py-5">
              <div class="mb-4">
                <span class="avatar avatar-xl bg-primary-lt text-primary">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="24" height="24"
                    viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M15 5l0 2" />
                    <path d="M15 11l0 2" />
                    <path d="M15 17l0 2" />
                    <path
                      d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-3a2 2 0 0 0 0 -4v-3a2 2 0 0 1 2 -2" />
                  </svg>
                </span>
              </div>
              <h3 class="mb-2">Lançar Ticket</h3>
              <p class="text-secondary mb-4">
                Para iniciar o lançamento, faça o upload da imagem do ticket.<br>
                O sistema extrairá automaticamente: <strong>Número NF</strong>, <strong>Peso</strong> e
                <strong>Data</strong>
              </p>
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalUpload">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                  <path d="M7 9l5 -5l5 5" />
                  <path d="M12 4l0 12" />
                </svg>
                Carregar Imagem do Ticket
              </button>
            </div>

            <!-- Formulário (oculto inicialmente, exibido após upload) -->
            <div id="areaFormulario" style="display: none;">

              <div class="row">
                <!-- Coluna do Formulário -->
                <div class="col-lg-7">
                  <!-- Seção: Fornecedor -->
                  <div class="mb-3">
                    <h4 class="subheader mb-3">
                      Fornecedor
                    </h4>
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label required">Selecione o Fornecedor</label>
                        <select type="text" name="fornecedorIdentificacao" id="fornecedorIdentificacao"
                          value="{{ dados_corretos['fornecedorIdentificacao'] }}"
                          class="form-select {% if 'fornecedorIdentificacao' in campos_obrigatorios or 'fornecedorIdentificacao' in campos_erros %}is-invalid{% endif %}">
                          <option value selected>Selecione...</option>
                          <option value="0">NÃO IDENTIFICADA</option>
                          {% for f in fornecedores %}
                          <option value="{{f.id}}">{{f.identificacao}}</option>
                          {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                          {% if 'fornecedorIdentificacao' in campos_obrigatorios %}
                          {{ campos_obrigatorios['fornecedorIdentificacao'] }}
                          {% elif 'fornecedorIdentificacao' in campos_erros %}
                          {{ campos_erros['fornecedorIdentificacao'] }}
                          {% endif %}
                        </div>
                      </div>

                      <!-- Extrator vinculado ao fornecedor (carregado via AJAX) -->
                      <div class="col-12" id="grupo-extrator-ticket" style="display: none;">
                        <label class="form-label">Extrator (quem fez o corte)</label>
                        <select name="extratorTicket" id="extratorTicket" class="form-select">
                          <option value="" selected>Selecione o extrator...</option>
                        </select>
                        <small class="text-muted">Selecione o extrator responsável pelo corte desta carga.</small>
                      </div>
                    </div>
                  </div>

                  <hr class="my-3">

                  <!-- Seção: Informações do Ticket -->
                  <div class="mb-3">
                    <h4 class="subheader mb-3">
                      Dados do Ticket
                    </h4>
                    <div class="row g-3">
                      <div class="col-6">
                        <label class="form-label required">Número NF Ticket</label>
                        <input type="text" name="numeroNf" id="numeroNf" value="{{ dados_corretos['numeroNf'] }}"
                          class="form-control {% if 'numeroNf' in campos_obrigatorios %}is-invalid{% endif %}"
                          placeholder="Ex: 12345">
                        <div class="invalid-feedback">
                          {% if 'numeroNf' in campos_obrigatorios %}
                          {{ campos_obrigatorios['numeroNf'] }}
                          {% elif 'numeroNf' in campos_erros %}
                          {{ campos_erros['numeroNf'] }}
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-6">
                        <label class="form-label required">Data Entrega</label>
                        <input type="date" name="dataEntregaTicket" id="dataEntregaTicket"
                          value="{{ dados_corretos['dataEntregaTicket'] }}"
                          class="form-control {% if 'dataEntregaTicket' in campos_obrigatorios %}is-invalid{% endif %}">
                        <div class="invalid-feedback">
                          {% if 'dataEntregaTicket' in campos_obrigatorios %}
                          {{ campos_obrigatorios['dataEntregaTicket'] }}
                          {% elif 'dataEntregaTicket' in campos_erros %}
                          {{ campos_erros['dataEntregaTicket'] }}
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-6">
                        <label class="form-label required">Peso Líquido</label>
                        <div class="input-group">
                          <input type="text" name="pesoLiquido" id="pesoLiquido"
                            value="{{ dados_corretos['pesoLiquido'] }}"
                            class="form-control campo-float {% if 'pesoLiquido' in campos_obrigatorios %}is-invalid{% endif %}"
                            placeholder="Ex: 25.50">
                          <span class="input-group-text">ton</span>
                        </div>
                        <div class="invalid-feedback">
                          {% if 'pesoLiquido' in campos_obrigatorios %}
                          {{ campos_obrigatorios['pesoLiquido'] }}
                          {% elif 'pesoLiquido' in campos_erros %}
                          {{ campos_erros['pesoLiquido'] }}
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-6">
                        <label class="form-label required">Placa</label>
                        <input type="text" name="placaVeiculo" value="{{ solicitacao.veiculo.placa_veiculo }}"
                          class="form-control text-uppercase {% if 'placaVeiculo' in campos_obrigatorios %}is-invalid{% endif %}"
                          placeholder="ABC-1234">
                        <div class="invalid-feedback">
                          {% if 'placaVeiculo' in campos_obrigatorios %}
                          {{ campos_obrigatorios['placaVeiculo'] }}
                          {% elif 'placaVeiculo' in campos_erros %}
                          {{ campos_erros['placaVeiculo'] }}
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-12">
                        <label class="form-label required">Motorista</label>
                        <input type="text" name="motoristaTicket" value="{{ solicitacao.motorista.nome_completo }}"
                          class="form-control {% if 'motoristaTicket' in campos_obrigatorios %}is-invalid{% endif %}">
                        <div class="invalid-feedback">
                          {% if 'motoristaTicket' in campos_obrigatorios %}
                          {{ campos_obrigatorios['motoristaTicket'] }}
                          {% elif 'motoristaTicket' in campos_erros %}
                          {{ campos_erros['motoristaTicket'] }}
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Input file oculto -->
                  <input type="file" name="arquivoTicket" id="arquivoTicket" class="d-none" accept=".jpg, .jpeg, .png">
                </div>

                <!-- Coluna da Imagem do Ticket -->
                <div class="col-lg-5">
                  <div class="card h-100 border-0 shadow-sm"
                    style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
                    <div class="card-header bg-transparent border-0 pb-0">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <h4 class="card-title mb-0">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2 text-primary" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M15 8h.01" />
                            <path d="M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z" />
                            <path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5" />
                            <path d="M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3" />
                          </svg>
                          Imagem do Ticket
                        </h4>
                        <div class="d-flex align-items-center gap-1">
                          <!-- Controles de Zoom -->
                          <div class="btn-group btn-group-sm me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomImagemTicket(-0.25)"
                              title="Diminuir (-)">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16"
                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                                <path d="M7 10l6 0" />
                                <path d="M21 21l-6 -6" />
                              </svg>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetZoomImagemTicket()"
                              title="Resetar (0)">
                              <span id="zoomLevelTicket"
                                style="font-size: 11px; min-width: 40px; display: inline-block;">100%</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomImagemTicket(0.25)"
                              title="Aumentar (+)">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16"
                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                                <path d="M7 10l6 0" />
                                <path d="M10 7l0 6" />
                                <path d="M21 21l-6 -6" />
                              </svg>
                            </button>
                          </div>
                          <button type="button" class="btn btn-sm btn-outline-warning" id="btnAlterarImagem">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="18" height="18"
                              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                              stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                              <path d="M7 9l5 -5l5 5" />
                              <path d="M12 4l0 12" />
                            </svg>
                            Trocar Imagem
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card-body p-2">
                      <!-- Container com scroll para zoom -->
                      <div id="containerImagemTicket"
                        style="width: 100%; height: 380px; overflow: auto; border-radius: 8px; background: #fff; cursor: grab; position: relative; user-select: none;">
                        <img id="imagemTicketDireta" src="" alt="Imagem do Ticket" draggable="false"
                          style="transform-origin: top left; transition: transform 0.15s ease; display: block; margin: auto; pointer-events: none; user-select: none;">
                      </div>
                      <p class="text-muted small mt-2 mb-0 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="14" height="14"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                          <path d="M21 21l-6 -6" />
                        </svg>
                        Scroll = Zoom | Arraste = Mover
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer text-end" id="rodapeFormulario" style="display: none;">
            <div class="d-flex justify-content-end gap-2">
              <a href="javascript:history.back()" class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="24"
                  height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M5 12l14 0"></path>
                  <path d="M5 12l6 6"></path>
                  <path d="M5 12l6 -6"></path>
                </svg>
                Voltar
              </a>
              <button type="button" class="btn btn-primary" id="btnConfirmar">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-device-floppy" width="24"
                  height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
                  <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                  <path d="M14 4l0 4l-6 0l0 -4" />
                </svg>
                Cadastrar Ticket
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Upload -->
<div class="modal modal-blur fade" id="modalUpload" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
            <path d="M7 9l5 -5l5 5" />
            <path d="M12 4l0 12" />
          </svg>
          Upload do Ticket
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="dropZone" class="dropzone-area text-center py-5 border border-2 border-dashed rounded-3"
          style="border-color: var(--tblr-primary) !important; background: var(--tblr-bg-surface-tertiary); cursor: pointer; transition: all 0.3s ease;">
          <div id="dropZoneConteudo">
            <span class="avatar avatar-xl bg-primary-lt text-primary mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                <path d="M7 9l5 -5l5 5" />
                <path d="M12 4l0 12" />
              </svg>
            </span>
            <h4 class="mb-2">Arraste a imagem aqui</h4>
            <p class="text-secondary mb-3">ou clique para selecionar</p>
            <p class="text-muted small mb-0">Formatos aceitos: JPG, JPEG, PNG (máx. 10MB)</p>
          </div>
          <div id="dropZonePreview" class="d-none">
            <img id="imagemPreview" src="" alt="Preview" class="img-fluid rounded" style="max-height: 300px;">
            <p class="mt-3 mb-0 text-success fw-bold">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M5 12l5 5l10 -10" />
              </svg>
              <span id="nomeArquivo">Imagem selecionada</span>
            </p>
          </div>
          <input type="file" id="inputUploadModal" class="d-none" accept=".jpg, .jpeg, .png">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnProcessarUpload" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 7v-1a2 2 0 0 1 2 -2h2" />
            <path d="M4 17v1a2 2 0 0 0 2 2h2" />
            <path d="M16 4h2a2 2 0 0 1 2 2v1" />
            <path d="M16 20h2a2 2 0 0 0 2 -2v-1" />
            <path d="M5 12l14 0" />
          </svg>
          Processar e Extrair Dados
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal modal-blur fade" id="modalConfirmacao" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Confirmar Cadastro do Ticket
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Alerta de confirmação -->
        <div class="alert alert-danger mb-3">
          <div class="d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12 9v4" />
              <path
                d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
              <path d="M12 16h.01" />
            </svg>
            <div class="ms-2">
              <strong>Revise as informações acima antes de confirmar o cadastro.</strong>
            </div>
          </div>
        </div>

        <!-- Card: Informações da Solicitação -->
        <div class="card border border-primary shadow-sm mb-4">
          <div class="card-body">
            <h3 class="card-title mb-3 text-primary">Informações da Solicitação</h3>
            <div class="row">
              <div class="col-sm-12 col-md-5">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Cliente</label>
                  <input type="text" class="form-control" id="confirma-cliente" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-2">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Produto</label>
                  <input type="text" class="form-control" id="confirma-produto" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-2">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Bitola</label>
                  <input type="text" class="form-control" id="confirma-bitola" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-12 col-md-3">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Número NF Venda</label>
                  <input type="text" class="form-control" id="confirma-nf-venda" value="-" disabled>
                </div>
              </div>
            </div>

            <h3 class="card-title mb-3 text-primary">Informações da Transportadora</h3>
            <div class="row">
              <div class="col-sm-12 col-md-4">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Transportadora</label>
                  <input type="text" class="form-control" id="confirma-transportadora" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-2">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">CPF/CNPJ</label>
                  <input type="text" class="form-control" id="confirma-documento" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-2">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Telefone</label>
                  <input type="text" class="form-control" id="confirma-telefone" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-2">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Motorista</label>
                  <input type="text" class="form-control" id="confirma-motorista" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-2">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Placa</label>
                  <input type="text" class="form-control" id="confirma-placa" value="-" disabled>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Card: Dados do Ticket (preenchidos pelo usuário) -->
        <div class="card border border-primary shadow-sm mb-4">
          <div class="card-body">
            <h3 class="card-title mb-3 text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-ticket me-2" width="24"
                height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M15 5l0 2" />
                <path d="M15 11l0 2" />
                <path d="M15 17l0 2" />
                <path
                  d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-3a2 2 0 0 0 0 -4v-3a2 2 0 0 1 2 -2" />
              </svg>
              Dados do Ticket
            </h3>
            <div class="row">
              <div class="col-sm-6 col-md-3">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Número NF Ticket</label>
                  <input type="text" class="form-control" id="confirma-nf" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-2">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Peso Líquido</label>
                  <input type="text" class="form-control" id="confirma-peso" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-6 col-md-3">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Data de Entrega</label>
                  <input type="text" class="form-control" id="confirma-data" value="-" disabled>
                </div>
              </div>
              <div class="col-sm-12 col-md-4">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Fornecedor</label>
                  <input type="text" class="form-control" id="confirma-fornecedor" value="-" disabled>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Card: Imagem do Ticket -->
        <div class="card border border-primary shadow-sm mb-4">
          <div class="card-body">
            <h3 class="card-title mb-3 text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M15 8h.01" />
                <path d="M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z" />
                <path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5" />
                <path d="M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3" />
              </svg>
              Imagem do Ticket
            </h3>
            <div class="text-center">
              <img id="confirma-imagem-ticket" src="" alt="Imagem do Ticket" class="img-fluid rounded shadow"
                draggable="false" style="max-height: 280px; max-width: 100%; pointer-events: none; user-select: none;">
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M9 14l-4 -4l4 -4" />
            <path d="M5 10h11a4 4 0 1 1 0 8h-1" />
          </svg>
          Voltar e Editar
        </button>
        <button type="button" class="btn btn-success" id="btnConfirmarCadastro">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M5 12l5 5l10 -10" />
          </svg>
          Confirmar Cadastro
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Recomendações -->
<div class="modal modal-blur fade" id="modalRecomendacoes" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          Recomendações para Extração Automática
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3 text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" />
            <path d="M16 3v4" />
            <path d="M8 3v4" />
            <path d="M4 11h16" />
            <path d="M7 14h.013" />
            <path d="M10.01 14h.005" />
            <path d="M13.01 14h.005" />
            <path d="M16.015 14h.005" />
            <path d="M13.015 17h.005" />
            <path d="M7.01 17h.005" />
            <path d="M10.01 17h.005" />
          </svg>
          Qualidade da Imagem
        </p>
        <ul class="list-unstyled mb-4">
          <li class="mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon text-success me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            <strong>Iluminação adequada:</strong> Evite sombras e reflexos sobre o documento
          </li>
          <li class="mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon text-success me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            <strong>Imagem nítida:</strong> Certifique-se de que o texto está legível e sem desfoque
          </li>
          <li class="mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon text-success me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            <strong>Documento completo:</strong> Capture todo o ticket na foto, sem cortes
          </li>
          <li class="mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon text-success me-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            <strong>Alinhamento correto:</strong> Mantenha o documento reto, evitando inclinações
          </li>
        </ul>

        <div class="alert alert-warning mb-0">
          <div class="d-flex">
            <div>
              <h4 class="alert-title">Atenção!</h4>
              <p class="mb-0">
                Mesmo com a extração automática, <strong>sempre confira os dados</strong> antes de finalizar o cadastro.
                O sistema pode não reconhecer corretamente alguns campos dependendo da qualidade da imagem.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M5 12l5 5l10 -10" />
          </svg>
          Entendi
        </button>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/pages/ticket-upload.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const fornecedorSelect = document.querySelector('#fornecedorIdentificacao');
    if (fornecedorSelect) {
      const tomSelectFornecedor = new TomSelect(fornecedorSelect, {
        create: false,
        allowEmptyOption: false,
        sortField: {
          field: "text",
          direction: "asc"
        },
        onChange: function(value) {
          carregarExtratoresFornecedor(value);
        }
      });
    }

    // Carregar extratores vinculados ao fornecedor selecionado via AJAX
    function carregarExtratoresFornecedor(fornecedorId) {
      const grupoExtrator = document.getElementById('grupo-extrator-ticket');
      const selectExtrator = document.getElementById('extratorTicket');

      if (!fornecedorId || fornecedorId === '' || fornecedorId === '0') {
        grupoExtrator.style.display = 'none';
        selectExtrator.innerHTML = '<option value="" selected>Selecione o extrator...</option>';
        return;
      }

      fetch('/api/extratores-fornecedor/' + fornecedorId)
        .then(response => response.json())
        .then(data => {
          selectExtrator.innerHTML = '<option value="" selected>Selecione o extrator...</option>';
          if (data.success && data.extratores.length > 0) {
            data.extratores.forEach(function(ext) {
              const option = document.createElement('option');
              option.value = ext.id;
              option.textContent = ext.identificacao;
              selectExtrator.appendChild(option);
            });
            grupoExtrator.style.display = 'block';
          } else {
            grupoExtrator.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Erro ao carregar extratores:', error);
          grupoExtrator.style.display = 'none';
        });
    }

    // Verifica se há dados extraídos no sessionStorage (vindo da listagem)
    const dadosExtraidos = sessionStorage.getItem('ticketDadosExtraidos');
    const arquivoBase64 = sessionStorage.getItem('ticketArquivoBase64');

    if (dadosExtraidos && arquivoBase64) {
      try {
        const dados = JSON.parse(dadosExtraidos);

        // Preenche campos
        const campoNf = document.getElementById('numeroNf');
        const campoPeso = document.getElementById('pesoLiquido');
        const campoData = document.getElementById('dataEntregaTicket');

        if (dados.numero_nf && campoNf) campoNf.value = dados.numero_nf;
        if (dados.peso_liquido && campoPeso) campoPeso.value = parseFloat(dados.peso_liquido).toFixed(2);
        if (dados.data_entrega && campoData) campoData.value = dados.data_entrega;

        // Recria o arquivo a partir do base64
        const nomeArquivo = sessionStorage.getItem('ticketArquivoNome') || 'ticket.jpg';
        const tipoArquivo = sessionStorage.getItem('ticketArquivoTipo') || 'image/jpeg';

        fetch(arquivoBase64)
          .then(res => res.blob())
          .then(blob => {
            const arquivo = new File([blob], nomeArquivo, { type: tipoArquivo });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(arquivo);

            const inputArquivo = document.getElementById('arquivoTicket');
            if (inputArquivo) {
              inputArquivo.files = dataTransfer.files;
            }

            // Armazena a imagem base64 globalmente para visualização
            window.imagemBase64 = arquivoBase64;

            // Atualiza a imagem direta na tela
            const imagemTicketDireta = document.getElementById('imagemTicketDireta');
            if (imagemTicketDireta) {
              imagemTicketDireta.src = arquivoBase64;
            }
          });

        // Mostra formulário e esconde área de upload inicial
        const areaUploadInicial = document.getElementById('areaUploadInicial');
        const areaFormulario = document.getElementById('areaFormulario');
        const rodapeFormulario = document.getElementById('rodapeFormulario');

        if (areaUploadInicial) areaUploadInicial.style.display = 'none';
        if (areaFormulario) areaFormulario.style.display = 'block';
        if (rodapeFormulario) rodapeFormulario.style.display = 'block';

        // Limpa sessionStorage
        sessionStorage.removeItem('ticketDadosExtraidos');
        sessionStorage.removeItem('ticketArquivoBase64');
        sessionStorage.removeItem('ticketArquivoNome');
        sessionStorage.removeItem('ticketArquivoTipo');

      } catch (e) {
        console.error('Erro ao processar dados do sessionStorage:', e);
      }
    }
  });
</script>

<!-- Script de Zoom Inline da Imagem do Ticket -->
<script>
  (function () {
    'use strict';

    let zoomTicket = 1;
    const zoomMin = 0.5;
    const zoomMax = 4;

    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;

    const container = document.getElementById('containerImagemTicket');
    const imagem = document.getElementById('imagemTicketDireta');
    const zoomDisplay = document.getElementById('zoomLevelTicket');

    // Função global para zoom
    window.zoomImagemTicket = function (delta) {
      const novoZoom = Math.max(zoomMin, Math.min(zoomMax, zoomTicket + delta));
      if (novoZoom !== zoomTicket) {
        zoomTicket = novoZoom;
        atualizarZoomTicket();
      }
    };

    // Função global para resetar zoom
    window.resetZoomImagemTicket = function () {
      zoomTicket = 1;
      atualizarZoomTicket();
      if (container) {
        container.scrollLeft = 0;
        container.scrollTop = 0;
      }
    };

    function atualizarZoomTicket() {
      if (imagem) {
        imagem.style.transform = `scale(${zoomTicket})`;
      }
      if (zoomDisplay) {
        zoomDisplay.textContent = Math.round(zoomTicket * 100) + '%';
      }
    }

    // Configurar eventos no container
    if (container) {
      // Zoom com scroll do mouse
      container.addEventListener('wheel', function (e) {
        e.preventDefault();
        const delta = e.deltaY < 0 ? 0.15 : -0.15;
        window.zoomImagemTicket(delta);
      }, { passive: false });

      // Arrastar para mover
      container.addEventListener('mousedown', function (e) {
        isDragging = true;
        container.style.cursor = 'grabbing';
        startX = e.clientX;
        startY = e.clientY;
        scrollLeft = container.scrollLeft;
        scrollTop = container.scrollTop;
        e.preventDefault();
      });

      container.addEventListener('mousemove', function (e) {
        if (!isDragging) return;
        e.preventDefault();
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        container.scrollLeft = scrollLeft - dx;
        container.scrollTop = scrollTop - dy;
      });

      container.addEventListener('mouseup', function () {
        isDragging = false;
        container.style.cursor = 'grab';
      });

      container.addEventListener('mouseleave', function () {
        isDragging = false;
        container.style.cursor = 'grab';
      });
    }
  })();
</script>

{% include 'estrutura/footer.html' %}

</div>

{% endblock conteudo %}