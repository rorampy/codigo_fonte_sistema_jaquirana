{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">Pedido de Venda</div>
          <h2 class="page-title">Cadastrar</h2>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">
      {% include 'estrutura/mensagens_flash.html' %}

      <div class="col-12">
        <form class="card" action="{{ url_for('cadastrar_solicitacao') }}" method="POST">
          <div class="card-body">
            <div class="row">

              <!-- Empresa Emissora-->
              <div class="col-sm-3 col-md-3">
                <div class="mb-3">
                  <label class="form-label required">Empresa Emissora</label>
                  <select name="empresaEmissora"
                    class="form-select {% if 'empresaEmissora' in campos_obrigatorios or 'empresaEmissora' in campos_erros %}is-invalid{% endif %}">
                    <option value selected>Selecione...</option>
                    {% for e in empresas %}
                    <option value="{{ e.id }}" {% if e.id==1
                      %}selected{% endif %}>
                      {{ e.identificacao }}
                    </option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">
                    {{ campos_obrigatorios.get('empresaEmissora') or
                    campos_erros.get('empresaEmissora') }}
                  </div>
                </div>
              </div>

              <!-- Cliente -->
              <div class="col-sm-3 col-md-3">
                <div class="mb-3">
                  <label class="form-label required">Cliente</label>
                  <select name="clienteSolicitacao"
                    class="form-select {% if 'clienteSolicitacao' in campos_obrigatorios or 'clienteSolicitacao' in campos_erros %}is-invalid{% endif %}">
                    <option value selected>Selecione...</option>
                    {% for c in cliente %}
                    <option value="{{ c.id }}">{{ c.identificacao }}</option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">
                    {{ campos_obrigatorios.get('clienteSolicitacao') or
                    campos_erros.get('clienteSolicitacao') }}
                  </div>
                </div>
              </div>

              <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <label class="form-label required">Produto</label>
                  <select id="selectProduto" name="produtoSolicitacao"
                    class="form-select {% if 'produtoSolicitacao' in campos_obrigatorios or 'produtoSolicitacao' in campos_erros %}is-invalid{% endif %}">
                    <option value selected>Selecione...</option>
                    {% for p in produtos %}
                    <option value="{{ p.id }}">{{ p.nome }}</option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">
                    {{ campos_obrigatorios.get('produtoSolicitacao') or
                    campos_erros.get('produtoSolicitacao') }}
                  </div>
                </div>
              </div>

              <!-- Bitola -->
              <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <label class="form-label required">Bitola</label>
                  <select id="selectBitola" name="bitolaSolicitacao"
                    class="form-select {% if 'bitolaSolicitacao' in campos_obrigatorios or 'bitolaSolicitacao' in campos_erros %}is-invalid{% endif %}">
                    <option value selected>Selecione...</option>
                  </select>
                  <div class="invalid-feedback">
                    {{ campos_obrigatorios.get('bitolaSolicitacao') or
                    campos_erros.get('bitolaSolicitacao') }}
                  </div>
                </div>
              </div>

              <!-- Grupo WhatsApp -->
              <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <label class="form-label">Nome grupo</label>
                  <select name="nomeGrupo"
                    class="form-select {% if 'nomeGrupo' in campos_obrigatorios or 'nomeGrupo' in campos_erros %}is-invalid{% endif %}">
                    <option value selected>Selecione...</option>
                    {% for g in grupo_whats %}
                    <option value="{{ g.id }}">{{ g.nome_grupo_whats }}</option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">
                    {{ campos_obrigatorios.get('nomeGrupo') or
                    campos_erros.get('nomeGrupo') }}
                  </div>
                </div>
              </div>
              
              <!-- Grupo Certificações -->
              <div class="col-sm-3 col-md-3">
                <div class="mb-3">
                  <label class="form-label required">Certificação</label>
                  <select name="certificacao_solicitacao"
                    class="form-select {% if 'certificacao_solicitacao' in campos_obrigatorios or 'certificacao_solicitacao' in campos_erros %}is-invalid{% endif %}">
                    <option value selected>Selecione...</option>
                    {% for c in certificacoes %}
                    <option value="{{ c.id }}">{{ c.nome }}</option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">
                    {{ campos_obrigatorios.get('certificacao_solicitacao') or
                    campos_erros.get('certificacao_solicitacao') }}
                  </div>
                </div>
              </div>

              <!-- Data e hora msg grupo-->
              <!-- <div class="col-sm-2 col-md-2">
                <div class="mb-3">
                  <label class="form-label">Data/hora MSG Grupo</label>
                  <input type="datetime-local" name="dataHoraSolicitacao"
                    value="{{ dados_corretos['dataHoraSolicitacao'] }}"
                    class="form-control {% if 'dataHoraSolicitacao' in campos_obrigatorios or 'dataHoraSolicitacao' in campos_erros %}is-invalid{% endif %}">
                  <div class="invalid-feedback">
                    {{ campos_obrigatorios.get('dataHoraSolicitacao') or
                    campos_erros.get('dataHoraSolicitacao') }}
                  </div>
                </div>
              </div> -->

              <div class="row">
                <h3 class="text-primary">Informações de transporte</h3>

                <!-- Veículo -->
                <div class="col-sm-2 col-md-2">
                  <div class="mb-3">
                    <label class="form-label required">Placa</label>
                    <select id="selectVeiculo" name="placaVeiculo"
                      class="form-select {% if 'placaVeiculo' in campos_obrigatorios or 'placaVeiculo' in campos_erros %}is-invalid{% endif %}">
                      <option value selected>Selecione...</option>
                      {% for v in veiculo %}
                      <option value="{{ v.id }}">{{ v.placa_veiculo }}</option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                      {{ campos_obrigatorios.get('placaVeiculo') or
                      campos_erros.get('placaVeiculo') }}
                    </div>
                  </div>
                </div>

                <div class="col-sm-3 col-md-3">
                  <div class="mb-3">
                    <label class="form-label required">Capacidade carga
                      (Ton.)</label>
                    <input type="text" name="capacidadeCarga" id="inputcapacidadeCarga" class="form-control campo-float"
                      disabled>
                    <input type="hidden" name="capacidadeCargaSolicitacao" id="inputVeiculoId">
                  </div>
                </div>

                <div class="col-sm-4 col-md-4">
                  <div class="mb-3">
                    <label class="form-label required">Transportadora</label>
                    <select name="transportadoraSolicitacao" id="selectTransportadora"
                      class="form-select {% if 'transportadoraSolicitacao' in campos_obrigatorios or 'transportadoraSolicitacao' in campos_erros %}is-invalid{% endif %}">
                      <option value selected>Selecione...</option>
                    </select>
                    <div class="invalid-feedback">
                      {{ campos_obrigatorios.get('transportadoraSolicitacao') or
                      campos_erros.get('transportadoraSolicitacao') }}
                    </div>

                  </div>
                </div>

                <!-- Motorista -->
                <div class="col-sm-3 col-md-3">
                  <div class="mb-3">
                    <label class="form-label required">Motorista</label>
                    <select id="selectMotorista" name="motoristaSolicitacao"
                      class="form-select {% if 'motoristaSolicitacao' in campos_obrigatorios or 'motoristaSolicitacao' in campos_erros %}is-invalid{% endif %}">
                      <option value selected>Selecione...</option>
                    </select>
                    <div class="invalid-feedback">
                      {{ campos_obrigatorios.get('motoristaSolicitacao') or
                      campos_erros.get('motoristaSolicitacao') }}
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="card-footer text-center text-md-end">
            <a href="javascript:history.back()" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="24"
                height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M5 12l14 0"></path>
                <path d="M5 12l6 6"></path>
                <path d="M5 12l6 -6"></path>
              </svg>
              Voltar
            </a>
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plus" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M12 5l0 14"></path>
                <path d="M5 12l14 0"></path>
              </svg>
              Cadastrar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% include 'estrutura/footer.html' %}

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const produtoSelect = document.getElementById('selectProduto');
      const bitolaSelect = document.getElementById('selectBitola');
      const veiculoSelect = document.getElementById('selectVeiculo');
      const transportadoraSelect = document.getElementById('selectTransportadora');
      const motoristaSelect = document.getElementById('selectMotorista');
      const capacidadeCargaInput = document.getElementById('inputcapacidadeCarga');
      const capacidadeCargaHidden = document.getElementById('inputVeiculoId');

      // Inicializar TomSelect para produto
      const tomProduto = new TomSelect(produtoSelect, {
        create: false,
        allowEmptyOption: false,
        sortField: {
          field: "text",
          direction: "asc"
        }
      });

      // Inicializar TomSelect para bitola
      let tomBitola = new TomSelect(bitolaSelect, {
        create: false,
        allowEmptyOption: false,
        sortField: {
          field: "text",
          direction: "asc"
        }
      });

      // Carregar bitolas quando produto for selecionado
      tomProduto.on('change', function(produtoId) {
        if (produtoId) {
          fetch(`/produto/${produtoId}/bitolas`)
            .then(response => response.json())
            .then(data => {
              // Destruir e recriar TomSelect de bitola
              tomBitola.destroy();
              
              // Limpar select de bitola
              bitolaSelect.innerHTML = '<option value selected>Selecione...</option>';
              
              // Adicionar bitolas do produto
              data.bitolas.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.text = b.nome;
                bitolaSelect.appendChild(opt);
              });

              // Recriar TomSelect
              tomBitola = new TomSelect(bitolaSelect, {
                create: false,
                allowEmptyOption: false,
                sortField: {
                  field: "text",
                  direction: "asc"
                }
              });
            })
            .catch(err => {
              console.error('Erro ao buscar bitolas do produto:', err);
              alert("Erro ao buscar bitolas do produto.");
            });
        } else {
          tomBitola.destroy();
          bitolaSelect.innerHTML = '<option value selected>Selecione...</option>';
          tomBitola = new TomSelect(bitolaSelect, {
            create: false,
            allowEmptyOption: false
          });
        }
      });

      veiculoSelect.addEventListener('change', function () {
        const veiculoId = this.value;

        if (veiculoId) {
          fetch(`/veiculo/${veiculoId}/dados`)
            .then(response => response.json())
            .then(data => {
              capacidadeCargaInput.value = data.capacidade_carga;
              capacidadeCargaHidden.value = veiculoId;

              // Preenche transportadoras
              transportadoraSelect.innerHTML = '<option value selected>Selecione...</option>';
              data.transportadoras.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.text = t.nome;
                transportadoraSelect.appendChild(opt);
              });

              // Preenche motoristas
              motoristaSelect.innerHTML = '<option value selected>Selecione...</option>';
              data.motoristas.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.text = m.nome;
                motoristaSelect.appendChild(opt);
              });
            })
            .catch(err => {
              console.error('Erro ao buscar dados do veículo:', err);
              alert("Erro ao buscar dados do veículo.");
            });
        } else {
          capacidadeCargaInput.value = '';
          capacidadeCargaHidden.value = '';
          transportadoraSelect.innerHTML = '<option value selected>Selecione...</option>';
          motoristaSelect.innerHTML = '<option value selected>Selecione...</option>';
        }
      });
    });

    document.addEventListener('DOMContentLoaded', function () {
      const transportadoraSelect = document.getElementById('selectTransportadora');
      const motoristaSelect = document.getElementById('selectMotorista');

      transportadoraSelect.addEventListener('change', function () {
        console.log('entrei aqui')
        const transportadoraId = this.value;

        if (transportadoraId) {
          fetch(`/motorista/${transportadoraId}/dados`)
            .then(response => response.json())
            .then(data => {

              // Preenche motoristas
              motoristaSelect.innerHTML = '<option value selected>Selecione...</option>';
              data.motoristas.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.text = m.nome;
                motoristaSelect.appendChild(opt);
              });
            })
            .catch(err => {
              console.error('Erro ao buscar dados do veículo:', err);
              alert("Erro ao buscar dados do veículo.");
            });
        } else {
          motoristaSelect.innerHTML = '<option value selected>Selecione...</option>';
        }
      });

      // Inicializa Tom Select nos outros selects
      document.querySelectorAll('select.form-select').forEach(function (select) {
        if (!['selectMotorista', 'selectTransportadora', 'selectBitola', 'selectProduto', 'selectVeiculo'].includes(select.id)) {
          new TomSelect(select, {
            create: false,
            allowEmptyOption: false,
            sortField: {
              field: "text",
              direction: "asc"
            }
          });
        }
      });
    });
  </script>


</div>
{% endblock conteudo %}