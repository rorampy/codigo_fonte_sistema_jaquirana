{% extends 'estrutura/base.html' %}
{% block conteudo %}
{% include 'estrutura/header.html' %}

<div class="page-wrapper">
  <!-- Cabeçalho da página -->
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Pré-título e título da página -->
          <div class="page-pretitle">
            PEDIDO DE COMPRA
          </div>
          <h2 class="page-title">
            Listagem de Escalas por Fornecedor
          </h2>
        </div>

        <!-- Botões de ação no canto direito -->
        <div class="col-12 col-md-auto ms-auto d-print-none">
          <div class="d-flex gap-2">
            <!-- Badge com total de cargas -->
            <span class="badge bg-blue-lt p-2 d-flex align-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                <path d="M5 17h-2v-11a1 1 0 0 1 1 -1h9v12m-4 0h6m4 0h2v-6h-8m0 -5h5l3 5" />
              </svg>
              {{ total_itens }} cargas no total
            </span>
            
            <!-- Botão: Cadastrar novo pedido -->
            <a href="{{ url_for('cadastrar_pedido_compra') }}" class="btn btn-primary">
              <!-- Ícone de + (adicionar) -->
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M12 5l0 14" />
                <path d="M5 12l14 0" />
              </svg>
              Lançar Nova Escala
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Corpo da página -->
  <div class="page-body">
    <div class="container-xl">

      <!-- Inclui componente de mensagens flash (sucesso, erro, etc) -->
      {% include 'estrutura/mensagens_flash.html' %}

      <div class="col-12">
        <div class="card" id="registrosOperacionais">
          <div class="card-body p-0">
            
            {% if itens_por_fornecedor and itens_por_fornecedor|length > 0 %}
            <!-- Accordion agrupado por fornecedor -->
            <div class="accordion" id="fornecedoresAccordion">
              
              {% for fornecedor_id, grupo in itens_por_fornecedor.items() %}
              {% set fornecedor = grupo.fornecedor %}
              {% set itens = grupo.itens %}
              
              <div class="accordion-item">
                <!-- Cabeçalho do accordion (nome do fornecedor) -->
                <h2 class="accordion-header" id="heading-fornecedor-{{ loop.index }}">
                  <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                          data-bs-toggle="collapse"
                          data-bs-target="#collapse-fornecedor-{{ loop.index }}" 
                          aria-expanded="{% if loop.first %}true{% else %}false{% endif %}">
                    <div class="d-flex align-items-center justify-content-between w-100 me-3">
                      <div class="d-flex align-items-center">
                        <!-- Ícone de caminhão -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2 text-primary" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                          <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                          <path d="M5 17h-2v-11a1 1 0 0 1 1 -1h9v12m-4 0h6m4 0h2v-6h-8m0 -5h5l3 5" />
                        </svg>
                        <strong>{{ fornecedor.identificacao if fornecedor else 'Sem Fornecedor Definido' }}</strong>
                      </div>
                      <!-- Badge com quantidade de cargas -->
                      <span class="badge bg-azure-lt ms-2">{{ itens|length }} cargas</span>
                    </div>
                  </button>
                </h2>
                
                <!-- Corpo do accordion (tabela de itens) -->
                <div id="collapse-fornecedor-{{ loop.index }}"
                     class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                     data-bs-parent="#fornecedoresAccordion">
                  <div class="accordion-body p-0">
                    
                    <div class="table-responsive">
                      <table class="table table-vcenter table-hover table-striped mb-0">
                        <thead class="bg-light">
                          <tr>
                            <th class="text-center" style="width: 100px;">Data Carga</th>
                            <th class="text-center" style="width: 100px;">Data Entrega</th>
                            <th class="text-center">Transportadora</th>
                            <th class="text-center">Motorista</th>
                            <th class="text-center" style="width: 100px;">Placa</th>
                            <th class="text-center">Corte/Extrator</th>
                            <th class="text-center" style="width: 120px;">Escala</th>
                            <th class="text-center" style="width: 100px;">Ações</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in itens %}
                          <tr>
                            <!-- Data Carga -->
                            <td class="text-center fw-bold text-primary">
                              {{ item.data_carga.strftime('%d/%m/%Y') if item.data_carga else '-' }}
                            </td>
                            
                            <!-- Data Entrega -->
                            <td class="text-center">
                              {{ item.data_entrega.strftime('%d/%m/%Y') if item.data_entrega else '-' }}
                            </td>
                            
                            <!-- Transportadora -->
                            <td class="text-center">
                              {{ item.obter_nome_transportadora() | truncate(25, True, '...') }}
                            </td>
                            
                            <!-- Motorista -->
                            <td class="text-center">
                              {{ item.obter_nome_motorista() | truncate(20, True, '...') }}
                            </td>
                            
                            <!-- Placa -->
                            <td class="text-center">
                              {% if item.veiculo %}
                              <span class="badge bg-yellow-lt">{{ item.obter_placa_veiculo() }}</span>
                              {% else %}
                              <span class="text-muted">-</span>
                              {% endif %}
                            </td>
                            
                            <!-- Extrator -->
                            <td class="text-center">
                              {{ item.obter_nome_extrator() | truncate(20, True, '...') }}
                            </td>
                            
                            <!-- Código do Pedido (Escala) -->
                            <td class="text-center">
                              <a href="{{ url_for('editar_pedido_compra', id=item.pedido_compra.id) }}" 
                                 class="badge bg-blue-lt text-decoration-none"
                                 title="Clique para ver/editar a escala completa">
                                {{ item.pedido_compra.codigo_transacao if item.pedido_compra else '-' }}
                              </a>
                            </td>
                            
                            <!-- Botões de ação -->
                            <td class="text-center">
                              <div class="btn-list flex-nowrap justify-content-center">
                                <!-- Botão: Editar pedido -->
                                <a href="{{ url_for('editar_pedido_compra', id=item.pedido_compra.id) }}" 
                                   class="btn btn-icon btn-outline-warning"
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Editar escala">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
                                    <path d="M13.5 6.5l4 4" />
                                  </svg>
                                </a>

                                <!-- Botão: Excluir item (abre modal de confirmação) -->
                                <a href="#"
                                   class="btn btn-icon btn-outline-danger"
                                   data-bs-toggle="modal" 
                                   data-bs-target="#modal-excluir-item-{{ item.id }}"
                                   title="Excluir esta carga">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M4 7l16 0" />
                                    <path d="M10 11l0 6" />
                                    <path d="M14 11l0 6" />
                                    <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                                    <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                                  </svg>
                                </a>
                              </div>
                            </td>
                          </tr>
                          
                          <!-- Modal de confirmação de exclusão do item -->
                          <div class="modal modal-blur fade" id="modal-excluir-item-{{ item.id }}" tabindex="-1" role="dialog" aria-hidden="true">
                            <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                              <div class="modal-content">
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                <div class="modal-status bg-danger"></div>
                                <div class="modal-body text-center py-4">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="icon mb-2 text-danger icon-lg">
                                    <path d="M12 9v4" />
                                    <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
                                    <path d="M12 16h.01" />
                                  </svg>
                                  <div class="text-secondary">
                                    Deseja excluir esta carga?<br>
                                    <strong>{{ item.data_carga.strftime('%d/%m/%Y') if item.data_carga else '' }}</strong> - 
                                    <strong>{{ item.obter_placa_veiculo() }}</strong>
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <div class="w-100">
                                    <div class="row">
                                      <div class="col">
                                        <a href="#" class="btn btn-3 w-100" data-bs-dismiss="modal">Cancelar</a>
                                      </div>
                                      <div class="col">
                                        <button type="button" class="btn btn-danger btn-4 w-100 btn-excluir-item" 
                                                data-item-id="{{ item.id }}">
                                          Excluir
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- Fim do modal -->
                          {% endfor %}
                        </tbody>
                        <!-- Rodapé da tabela com total -->
                        <tfoot class="bg-light">
                          <tr>
                            <td colspan="8" class="text-end pe-3">
                              <strong>Total de cargas deste fornecedor: {{ itens|length }}</strong>
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                    
                  </div>
                </div>
              </div>
              {% endfor %}
              
            </div>
            <!-- Fim do accordion -->
            
            {% else %}
            <!-- Mensagem quando não há itens cadastrados -->
            <div class="text-center text-muted py-5">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg mb-2" width="48" height="48" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" />
                <path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z" />
              </svg>
              <h3>Nenhuma carga cadastrada</h3>
              <p>Não há pedidos de compra ou escalas cadastradas no sistema.</p>
              <a href="{{ url_for('cadastrar_pedido_compra') }}" class="btn btn-primary mt-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M12 5l0 14" />
                  <path d="M5 12l14 0" />
                </svg>
                Cadastrar primeira escala
              </a>
            </div>
            {% endif %}
            
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * Script para gerenciar exclusão de itens via AJAX
 */
document.addEventListener('DOMContentLoaded', function() {
    // Adiciona evento de clique nos botões de excluir
    document.querySelectorAll('.btn-excluir-item').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const modal = this.closest('.modal');
            
            // Faz requisição AJAX para excluir o item
            fetch(`/pedido-compra/item/excluir/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    // Fecha o modal e recarrega a página
                    bootstrap.Modal.getInstance(modal).hide();
                    window.location.reload();
                } else {
                    alert('Erro ao excluir: ' + data.mensagem);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir item.');
            });
        });
    });
});
</script>

{% endblock %}
